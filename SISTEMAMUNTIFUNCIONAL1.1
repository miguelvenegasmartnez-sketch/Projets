import sys
import os
import threading
import time
import json
import copy
from datetime import datetime
from PyQt6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, 
                             QHBoxLayout, QLabel, QLineEdit, QPushButton, 
                             QTableWidget, QTableWidgetItem, QHeaderView, 
                             QMessageBox, QComboBox, QStackedWidget, QFrame, 
                             QDialog, QInputDialog, QFileDialog, QPlainTextEdit,
                             QAbstractItemView, QDateEdit, QScrollArea, QGridLayout, 
                             QGraphicsOpacityEffect, QCheckBox, QSpinBox, QDoubleSpinBox, QGroupBox, QGraphicsDropShadowEffect,
                             QFormLayout, QTabWidget, QListWidget, QRadioButton)
from PyQt6.QtCore import Qt, QSize, QDate, QPropertyAnimation, QEasingCurve, QPoint, QParallelAnimationGroup, pyqtSignal, QObject
from PyQt6.QtGui import QIcon, QFont, QColor, QPixmap
from mercado_pago_pos import MercadoPagoPoint

# Intentar importar m√≥dulos locales
try:
    import database as db
    import utils
except ImportError:
    print("Error: No se encuentran 'database.py' o 'utils.py'.")
    sys.exit(1)
    
# Estilo CSS para Di√°logos Modernos
ESTILO_DIALOGO = """
    QDialog { background-color: #1e1e1e; border-radius: 15px; border: 1px solid #333; }
    QLabel { color: white; font-size: 14px; font-weight: bold; }
    QLineEdit { 
        background-color: #2d2d2d; color: white; border: 1px solid #444; 
        border-radius: 8px; padding: 10px; font-size: 16px; 
    }
    QLineEdit:focus { border: 1px solid #007aff; }
    QPushButton {
        background-color: #3a3a3a; color: white; border-radius: 8px; 
        padding: 10px; font-weight: bold; font-size: 14px;
    }
    QPushButton:hover { background-color: #444; }
    QPushButton#BtnAzul { background-color: #007aff; }
    QPushButton#BtnAzul:hover { background-color: #006ce6; }
    QPushButton#BtnRojo { background-color: #ff3b30; }
    QPushButton#BtnVerde { background-color: #28a745; }
    QFrame#Container { background-color: #252526; border-radius: 10px; }
"""

# ==========================================
# üé® MOTOR DE TEMAS (LIGHT / DARK)
# ==========================================
THEMES = {
    "Dark": {
        "bg_main": "#1e1e1e", "bg_sidebar": "#252526", "bg_card": "#2d2d30",
        "text_main": "#ffffff", "text_sec": "#aaaaaa", "input_bg": "#333337",
        "border": "#3e3e42", "accent": "#007aff", "success": "#28c840", "danger": "#ff453a",
        "table_head": "#454545", "hover": "#3a3a3e"
    },
    "Light": {
        "bg_main": "#f5f5f7", "bg_sidebar": "#ffffff", "bg_card": "#ffffff",
        "text_main": "#1d1d1f", "text_sec": "#86868b", "input_bg": "#f5f5f7",
        "border": "#d2d2d7", "accent": "#007aff", "success": "#34c759", "danger": "#ff3b30",
        "table_head": "#e5e5e5", "hover": "#f5f5f7"
    }
}

def aplicar_estilos(app, theme_name="Dark"):
    t = THEMES[theme_name]
    stylesheet = f"""
        QMainWindow {{ background-color: {t['bg_main']}; }}
        QWidget {{ background-color: {t['bg_main']}; color: {t['text_main']}; font-family: 'Segoe UI', sans-serif; font-size: 14px; }}
        
        QFrame#Sidebar {{ background-color: {t['bg_sidebar']}; border-right: 1px solid {t['border']}; }}
        QFrame#Card {{ 
            background-color: {t['bg_card']}; 
            border: 1px solid {t['border']}; 
            border-radius: 12px; 
        }}
        
        QLineEdit, QComboBox, QPlainTextEdit, QDateEdit {{
            background-color: {t['input_bg']}; 
            border: 1px solid {t['border']}; 
            color: {t['text_main']}; 
            padding: 8px 12px; 
            border-radius: 8px;
            selection-background-color: {t['accent']};
        }}
        QLineEdit:focus {{ border: 2px solid {t['accent']}; }}
        
        /* TABLAS */
        QTableWidget {{ 
            background-color: {t['bg_card']}; color: {t['text_main']}; border: none; outline: none;
        }}
        QHeaderView::section {{ 
            background-color: {t['table_head']}; color: {t['text_main']}; border: none;
            border-bottom: 2px solid {t['border']}; font-weight: bold; padding: 8px;
        }}
        QTableWidget::item {{ padding: 8px; border-bottom: 1px solid {t['border']}; }}
        QTableWidget::item:selected {{ background-color: {t['accent']}; color: white; border: none; }}
        QTableWidget::item:hover {{ background-color: {t['hover']}; }}

        /* BOTONES BASE */
        QPushButton {{ 
            background-color: {t['accent']}; color: white; border: none; 
            padding: 8px 16px; border-radius: 8px; font-weight: 600;
        }}
        QPushButton:hover {{ opacity: 0.9; }}
        QPushButton:pressed {{ background-color: {t['text_main']}; }}

        /* Sidebar */
        QPushButton#SidebarBtn {{ 
            background-color: transparent; color: {t['text_sec']}; text-align: left; 
            padding: 12px 20px; font-size: 15px; border-radius: 8px;
        }}
        QPushButton#SidebarBtn:hover {{ background-color: {t['input_bg']}; color: {t['text_main']}; }}
        QPushButton#SidebarBtn:checked {{ background-color: {t['accent']}; color: white; }}

        /* Botones Especiales del Tema */
        QPushButton#DangerBtn {{ background-color: {t['danger']}; }}
        QPushButton#SuccessBtn {{ background-color: {t['success']}; }}
        
        QPushButton#GhostBtn {{ 
            background-color: transparent; border: 1px solid {t['text_sec']}; color: {t['text_sec']}; 
        }}
        QPushButton#GhostBtn:hover {{ border: 1px solid {t['text_main']}; color: {t['text_main']}; }}

        /* Textos */
        QLabel#Title {{ font-size: 24px; font-weight: bold; color: {t['text_main']}; }}
        QLabel#Subtitle {{ font-size: 14px; color: {t['text_sec']}; }}
    """
    app.setStyleSheet(stylesheet)

# ==========================================
# ‚ú® ANIMACIONES (macOS Style)
# ==========================================
def animar_entrada(widget):
    """Efecto Fade-In + Slide Up suave"""
    # Opacidad
    opacidad = QGraphicsOpacityEffect(widget)
    widget.setGraphicsEffect(opacidad)
    
    anim_fade = QPropertyAnimation(opacidad, b"opacity")
    anim_fade.setDuration(400)
    anim_fade.setStartValue(0)
    anim_fade.setEndValue(1)
    anim_fade.setEasingCurve(QEasingCurve.Type.OutCubic)
    
    # Movimiento (Slide Up peque√±o)
    pos_orig = widget.pos()
    anim_move = QPropertyAnimation(widget, b"pos")
    anim_move.setDuration(400)
    anim_move.setStartValue(QPoint(pos_orig.x(), pos_orig.y() + 20))
    anim_move.setEndValue(pos_orig)
    anim_move.setEasingCurve(QEasingCurve.Type.OutCubic)
    
    # Grupo
    group = QParallelAnimationGroup(widget)
    group.addAnimation(anim_fade)
    group.addAnimation(anim_move)
    group.start()

# ==========================================
# WIDGETS
# ==========================================

class SetupDialog(QDialog):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Bienvenido a NEXUS POS")
        self.setFixedSize(500, 450)
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint)
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground)

        layout = QVBoxLayout(self)
        
        # --- TARJETA DE CONTENIDO ---
        self.card = QFrame()
        self.card.setStyleSheet("""
            QFrame {
                background-color: #1e1e1e;
                border-radius: 15px;
                border: 1px solid #333;
                color: white;
            }
            QLabel { background: transparent; color: white; }
            QLineEdit, QComboBox {
                background-color: #2d2d2d;
                border: 1px solid #444;
                padding: 10px;
                border-radius: 5px;
                color: white;
                font-size: 14px;
            }
            QPushButton {
                background-color: #007aff;
                color: white;
                font-weight: bold;
                padding: 12px;
                border-radius: 5px;
                font-size: 14px;
            }
            QPushButton:hover { background-color: #006ce6; }
        """)
        
        l_card = QVBoxLayout(self.card)
        l_card.setContentsMargins(40, 40, 40, 40)
        l_card.setSpacing(20)

        # T√≠tulo
        lbl_titulo = QLabel("üöÄ Configuraci√≥n Inicial")
        lbl_titulo.setAlignment(Qt.AlignmentFlag.AlignCenter)
        lbl_titulo.setStyleSheet("font-size: 22px; font-weight: bold; margin-bottom: 10px;")
        l_card.addWidget(lbl_titulo)
        
        l_card.addWidget(QLabel("Nombre de tu Negocio:"))
        self.txt_nombre = QLineEdit()
        self.txt_nombre.setPlaceholderText("Ej. Abarrotes La Esquina")
        l_card.addWidget(self.txt_nombre)

        l_card.addWidget(QLabel("Giro del Negocio:"))
        self.combo_giro = QComboBox()
        self.combo_giro.addItems(["GENERAL", "ABARROTES", "ROPA", "FARMACIA", "FERRETERIA", "TELEFONIA"])
        l_card.addWidget(self.combo_giro)

        l_card.addStretch()

        btn_guardar = QPushButton("GUARDAR Y COMENZAR")
        btn_guardar.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_guardar.clicked.connect(self.guardar)
        l_card.addWidget(btn_guardar)

        layout.addWidget(self.card)

        # Sombra
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(20); shadow.setColor(QColor(0,0,0,150)); shadow.setOffset(0,0)
        self.card.setGraphicsEffect(shadow)

    def guardar(self):
        nombre = self.txt_nombre.text().strip()
        if not nombre:
            QMessageBox.warning(self, "Atenci√≥n", "Escribe el nombre de tu negocio.")
            return
            
        # Crear configuraci√≥n inicial
        config = {
            "nombre_negocio": nombre,
            "giro": self.combo_giro.currentText(),
            "tema": "Light",
            "logo_path": "",
            "ticket_mensaje": "¬°Gracias por su compra!"
        }
        
        # --- CORRECCI√ìN AQU√ç: USAR RUTA ABSOLUTA ---
        import os
        carpeta_actual = os.path.dirname(os.path.abspath(__file__))
        ruta_absoluta = os.path.join(carpeta_actual, "config.json")
        
        try:
            with open(ruta_absoluta, "w") as f: # Guardamos en la ruta exacta
                json.dump(config, f)
            self.accept() # Cerrar di√°logo y continuar
        except Exception as e:
            QMessageBox.critical(self, "Error", f"No se pudo guardar config: {e}")

class LoginDialog(QDialog):
    def __init__(self, config):
        super().__init__()
        self.config = config
        self.usuario_logueado = None 
        
        self.setWindowTitle("Iniciar Sesi√≥n")
        self.setFixedSize(400, 550)
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint)
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground)

        # 1. DETECTAR TEMA ACTUALIZADO
        tema = self.config.get("tema", "Light")
        
        # 2. COLORES SEG√öN TEMA
        if tema == "Dark":
            bg_card = "#1e1e1e"
            text_color = "white"
            text_sec = "#aaaaaa"
            input_bg = "#2d2d2d"
            input_border = "#444"
        else:
            bg_card = "#ffffff"
            text_color = "#1d1d1f"
            text_sec = "#86868b"
            input_bg = "#f5f5f7"
            input_border = "#d2d2d7"

        layout = QVBoxLayout(self)
        layout.setContentsMargins(10, 10, 10, 10)

        # 3. TARJETA
        self.card = QFrame()
        self.card.setObjectName("LoginCard")
        
        # --- AQU√ç EST√Å LA CORRECCI√ìN VISUAL ---
        # Agregamos "background-color: transparent" a los QLabel para quitar las cajas negras
        self.card.setStyleSheet(f"""
            QFrame#LoginCard {{
                background-color: {bg_card};
                border-radius: 20px;
                border: 1px solid {input_border};
            }}
            QLabel {{ 
                color: {text_color}; 
                background-color: transparent; /* <--- ESTO ARREGLA LAS CAJAS NEGRAS */
                border: none;
            }}
            QLineEdit {{ 
                background-color: {input_bg}; 
                color: {text_color}; 
                border: 1px solid {input_border}; 
                border-radius: 8px; 
                padding: 12px; 
                font-size: 16px;
            }}
            QLineEdit:focus {{ border: 2px solid #007aff; }}
        """)
        
        card_layout = QVBoxLayout(self.card)
        card_layout.setSpacing(20)
        card_layout.setContentsMargins(40, 50, 40, 50)

        # LOGO
        self.lbl_logo = QLabel()
        self.lbl_logo.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.lbl_logo.setMinimumHeight(80)
        
        path_logo = self.config.get("logo_path", "")
        if path_logo and os.path.exists(path_logo):
             pix = QPixmap(path_logo).scaledToHeight(80, Qt.TransformationMode.SmoothTransformation)
             self.lbl_logo.setPixmap(pix)
        else:
             self.lbl_logo.setText("NEXUS POS")
             self.lbl_logo.setStyleSheet(f"font-size: 28px; font-weight: 900; color: {text_color};")
        
        card_layout.addWidget(self.lbl_logo)

        # T√çTULO
        lbl_title = QLabel("Bienvenido")
        lbl_title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        lbl_title.setStyleSheet(f"font-size: 22px; font-weight: bold; margin-bottom: 10px;")
        card_layout.addWidget(lbl_title)

        # INPUTS
        self.txt_user = QLineEdit()
        self.txt_user.setPlaceholderText("üë§ Usuario")
        
        self.txt_pass = QLineEdit()
        self.txt_pass.setPlaceholderText("üîí Contrase√±a")
        self.txt_pass.setEchoMode(QLineEdit.EchoMode.Password)
        self.txt_pass.returnPressed.connect(self.validar_login)

        # BOTONES
        btn_login = QPushButton("ENTRAR")
        btn_login.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_login.setFixedHeight(50)
        btn_login.setStyleSheet("""
            QPushButton { background-color: #007aff; color: white; border-radius: 8px; font-weight: bold; font-size: 16px; border: none; }
            QPushButton:hover { background-color: #006ce6; }
        """)
        btn_login.clicked.connect(self.validar_login)

        btn_salir = QPushButton("Salir")
        btn_salir.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_salir.setStyleSheet(f"""
            QPushButton {{ background: transparent; color: {text_sec}; border: none; font-weight: bold; }}
            QPushButton:hover {{ color: {text_color}; }}
        """)
        btn_salir.clicked.connect(self.reject)

        card_layout.addWidget(self.txt_user)
        card_layout.addWidget(self.txt_pass)
        card_layout.addSpacing(10)
        card_layout.addWidget(btn_login)
        card_layout.addWidget(btn_salir)

        layout.addWidget(self.card)

        # Sombra
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(30)
        shadow.setColor(QColor(0,0,0,80))
        shadow.setOffset(0,5)
        self.card.setGraphicsEffect(shadow)

    def validar_login(self):
        u = self.txt_user.text().strip()
        p = self.txt_pass.text().strip()
        user = db.validar_usuario(u, p) # Aseg√∫rate de que db est√© importado
        if user:
            self.usuario_logueado = user
            self.accept()
        else:
            self.txt_pass.setStyleSheet(self.txt_pass.styleSheet() + "border: 1px solid #ff3b30;")
            QMessageBox.warning(self, "Acceso Denegado", "Usuario o contrase√±a incorrectos")
        
# ==========================================
# VENTANAS EMERGENTES (DIALOGOS)
# ==========================================
class VentanaCobro(QDialog):
    # 1. DEFINIMOS SE√ëALES (Puentes seguros entre hilos)
    senal_estado = pyqtSignal(str)      # Para actualizar el texto del status
    senal_resultado = pyqtSignal(str)   # Para avisar si se aprob√≥ o rechaz√≥

    def __init__(self, total, on_confirmar, tema="Dark"):
        super().__init__()
        self.setWindowTitle("Procesar Pago")
        self.setFixedSize(400, 550)
        self.total = total
        self.on_confirmar = on_confirmar
        self.metodo = "EFECTIVO"
        self.tema = tema 

        # --- CONECTAR SE√ëALES A FUNCIONES ---
        self.senal_estado.connect(self.actualizar_texto_status)
        self.senal_resultado.connect(self.manejar_resultado_pago)
        
        layout = QVBoxLayout(self)
        layout.setSpacing(20)
        layout.setContentsMargins(30,30,30,30)

        # Total Grande
        self.lbl_total = QLabel(f"${self.total:.2f}")
        self.lbl_total.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(self.lbl_total)

        # Selector M√©todo
        btn_box = QHBoxLayout()
        self.btn_efectivo = QPushButton("EFECTIVO"); self.btn_efectivo.setCheckable(True); self.btn_efectivo.setChecked(True)
        self.btn_tarjeta = QPushButton("TARJETA"); self.btn_tarjeta.setCheckable(True)
        self.btn_transf = QPushButton("TRANSFERENCIA"); self.btn_transf.setCheckable(True)
        
        for b in [self.btn_efectivo, self.btn_tarjeta, self.btn_transf]:
            b.setCursor(Qt.CursorShape.PointingHandCursor)
            b.clicked.connect(self.cambiar_metodo)
            btn_box.addWidget(b)
        layout.addLayout(btn_box)

        # Stack de inputs
        self.stack = QStackedWidget()
        
        # 1. Panel Efectivo
        p_efec = QWidget(); l_efec = QVBoxLayout(p_efec)
        self.txt_recibido = QLineEdit(); self.txt_recibido.setPlaceholderText("Monto Recibido")
        self.txt_recibido.textChanged.connect(self.calc_cambio)
        self.lbl_cambio = QLabel("Cambio: $0.00")
        self.lbl_cambio.setAlignment(Qt.AlignmentFlag.AlignCenter)
        l_efec.addWidget(QLabel("Dinero recibido:")); l_efec.addWidget(self.txt_recibido); l_efec.addWidget(self.lbl_cambio); l_efec.addStretch()
        
        # 2. Panel Tarjeta (MODIFICADO)
        p_tar = QWidget(); l_tar = QVBoxLayout(p_tar)
        # Conectamos al nuevo m√©todo real
        self.btn_term = QPushButton("AHORA SI ESTOY CONECTADO")
        
        self.lbl_status = QLabel("Esperando conexi√≥n...")
        self.lbl_status.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.lbl_status.setWordWrap(True) # Para que el texto baje si es largo
        l_tar.addWidget(QLabel("Procesar cobro con terminal:")); l_tar.addWidget(self.btn_term); l_tar.addWidget(self.lbl_status); l_tar.addStretch()

        # 3. Panel Transferencia
        p_trans = QWidget(); l_trans = QVBoxLayout(p_trans)
        self.txt_ref = QLineEdit(); self.txt_ref.setPlaceholderText("N√∫mero de Folio / Rastreo")
        l_trans.addWidget(QLabel("Referencia del Banco:")); l_trans.addWidget(self.txt_ref); l_trans.addStretch()

        self.stack.addWidget(p_efec); self.stack.addWidget(p_tar); self.stack.addWidget(p_trans)
        layout.addWidget(self.stack)

        # Bot√≥n Confirmar
        self.btn_ok = QPushButton("CONFIRMAR PAGO")
        self.btn_ok.setMinimumHeight(55)
        self.btn_ok.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_ok.clicked.connect(self.confirmar)
        layout.addWidget(self.btn_ok)

        self.referencia = ""
        self.aplicar_tema()

    # --- FUNCIONES QUE RECIBEN LAS SE√ëALES (Corren en el hilo principal UI) ---
    def actualizar_texto_status(self, texto):
        self.lbl_status.setText(texto)

    def manejar_resultado_pago(self, resultado):
        # Reactivar bot√≥n de terminal por si quiere reintentar
        self.btn_term.setEnabled(True)
        self.btn_term.setText("Reintentar Terminal")

        if resultado == "APROBADO":
            self.lbl_status.setText("‚úÖ ¬°PAGO APROBADO!")
            self.lbl_status.setStyleSheet("color: #28c840; font-weight: bold; font-size: 16px;")
            self.aprobar("TARJETA") # Llamamos a tu funci√≥n original para desbloquear el bot√≥n CONFIRMAR
            
        elif resultado == "RECHAZADO":
            self.lbl_status.setText("‚õî TARJETA RECHAZADA")
            self.lbl_status.setStyleSheet("color: #ff453a; font-weight: bold;")
            QMessageBox.warning(self, "Rechazado", "El banco rechaz√≥ la tarjeta.\nIntente con otra.")
            
        elif resultado == "TIMEOUT":
            self.lbl_status.setText("‚ö†Ô∏è TIEMPO AGOTADO")
            QMessageBox.information(self, "Tiempo Agotado", "Se cancel√≥ la operaci√≥n por inactividad.")
            
        else:
            self.lbl_status.setText("‚ùå ERROR DE SISTEMA")

    # --- (EL RESTO DE TU C√ìDIGO SIGUE IGUAL ABAJO) ---
    def aplicar_tema(self):
        # Definir paleta de colores seg√∫n el modo
        if self.tema == "Dark":
            bg = "#1e1e1e"; text = "white"
            input_bg = "#333"; input_border = "#444"
            btn_bg = "#333"; btn_hover = "#444"
            lbl_cambio_color = "#888"
        else:
            bg = "#ffffff"; text = "black"
            input_bg = "#f0f0f0"; input_border = "#ccc"
            btn_bg = "#e0e0e0"; btn_hover = "#d0d0d0"
            lbl_cambio_color = "#666"

        self.setStyleSheet(f"""
            QDialog {{ background-color: {bg}; color: {text}; }}
            QLabel {{ color: {text}; font-size: 14px; font-weight: bold; }}
            QLineEdit {{ 
                background-color: {input_bg}; color: {text}; padding: 12px; 
                border-radius: 8px; border: 1px solid {input_border}; font-size: 16px;
            }}
            QPushButton {{ 
                padding: 10px; border-radius: 8px; font-weight: bold; 
                background-color: {btn_bg}; color: {text}; border: 1px solid {input_border};
            }}
            QPushButton:checked {{ background-color: #007aff; color: white; border: none; }}
            QPushButton:hover {{ background-color: {btn_hover}; }}
        """)
        
        self.lbl_total.setStyleSheet("font-size: 48px; font-weight: 900; color: #28c840;")
        self.lbl_cambio.setStyleSheet(f"font-size: 20px; color: {lbl_cambio_color}; margin-top: 10px;")
        self.btn_ok.setStyleSheet("background-color: #28c840; color: white; font-size: 16px; border: none; font-weight: bold;")

    def cambiar_metodo(self):
        s = self.sender()
        self.btn_efectivo.setChecked(False); self.btn_tarjeta.setChecked(False); self.btn_transf.setChecked(False)
        s.setChecked(True)
        self.metodo = s.text()
        idx = 0 if self.metodo == "EFECTIVO" else 1 if self.metodo == "TARJETA" else 2
        self.stack.setCurrentIndex(idx)
        
        if self.metodo == "TARJETA": 
            self.btn_ok.setEnabled(False)
            self.btn_ok.setStyleSheet("background-color: #555; color: #aaa; border-radius: 8px; font-weight: bold;")
        else: 
            self.btn_ok.setEnabled(True)
            self.btn_ok.setStyleSheet("background-color: #28c840; color: white; border-radius: 8px; font-weight: bold;")

    def calc_cambio(self, txt):
        try:
            val = float(txt); cambio = val - self.total
            self.lbl_cambio.setText(f"Cambio: ${cambio:.2f}")
            if cambio >= 0:
                self.lbl_cambio.setStyleSheet("font-size: 20px; color: #28c840; font-weight: bold; margin-top: 10px;")
                self.btn_ok.setEnabled(True)
                self.btn_ok.setStyleSheet("background-color: #28c840; color: white; border-radius: 8px; font-weight: bold;")
            else:
                self.lbl_cambio.setStyleSheet("font-size: 20px; color: #ff453a; margin-top: 10px;")
                self.btn_ok.setEnabled(False)
                self.btn_ok.setStyleSheet("background-color: #555; color: #aaa; border-radius: 8px; font-weight: bold;")
        except: 
            self.btn_ok.setEnabled(False)
            self.btn_ok.setStyleSheet("background-color: #555; color: #aaa; border-radius: 8px; font-weight: bold;")

    def aprobar(self, tipo):
        self.referencia = f"AUTH-{datetime.now().strftime('%H%M%S')}"
        self.btn_ok.setEnabled(True)
        self.btn_ok.setStyleSheet("background-color: #28c840; color: white; border-radius: 8px; font-weight: bold;")

    def confirmar(self):
        ref = self.referencia
        if self.metodo == "EFECTIVO": ref = f"Efec: {self.txt_recibido.text()}"
        elif self.metodo == "TRANSFERENCIA": ref = self.txt_ref.text()
        self.on_confirmar(self.metodo, ref)
        self.accept()

class DialogoCapturaIMEI(QDialog):
    # NOTA: Ahora pedimos "tema" como argumento obligatorio
    def __init__(self, nombre_producto, cantidad_disponible, parent=None, tema="Dark"):
        super().__init__(parent)
        
        self.tema = tema # Guardamos el tema que nos mandan
        
        # Configuraci√≥n de Ventana
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.Dialog)
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground)
        self.setFixedSize(450, 320)
        
        self.imei_resultado = None
        
        # --- UI SETUP ---
        layout_master = QVBoxLayout(self)
        layout_master.setContentsMargins(0,0,0,0)
        
        # Frame Principal
        self.frame = QWidget()
        self.frame.setObjectName("FrameIMEI")
        layout_frame = QVBoxLayout(self.frame)
        layout_frame.setContentsMargins(30, 30, 30, 30)
        layout_frame.setSpacing(15)
        
        # Widgets
        self.lbl_icon = QLabel("üõ°Ô∏è")
        self.lbl_icon.setStyleSheet("font-size: 40px; border: none;")
        self.lbl_icon.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        self.lbl_titulo = QLabel("Validaci√≥n de Seguridad")
        self.lbl_titulo.setFont(QFont("Arial", 14, QFont.Weight.Bold))
        self.lbl_titulo.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        self.lbl_info = QLabel(f"Escanee el IMEI para:\n<b>{nombre_producto}</b>")
        self.lbl_info.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.lbl_info.setWordWrap(True)
        self.lbl_info.setFont(QFont("Arial", 11))
        
        self.lbl_stock = QLabel(f"Disponibles en sistema: {cantidad_disponible}")
        self.lbl_stock.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        self.txt_imei = QLineEdit()
        self.txt_imei.setPlaceholderText("Escanee c√≥digo aqu√≠...")
        self.txt_imei.setFixedHeight(45)
        self.txt_imei.returnPressed.connect(self.validar)
        
        # Botones
        h_btn = QHBoxLayout()
        self.btn_cancel = QPushButton("Cancelar")
        self.btn_cancel.setFixedSize(120, 40)
        self.btn_cancel.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_cancel.clicked.connect(self.reject)
        
        self.btn_ok = QPushButton("Validar")
        self.btn_ok.setFixedSize(120, 40)
        self.btn_ok.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_ok.clicked.connect(self.validar)
        
        h_btn.addStretch()
        h_btn.addWidget(self.btn_cancel)
        h_btn.addSpacing(15)
        h_btn.addWidget(self.btn_ok)
        h_btn.addStretch()
        
        # Agregar al layout
        layout_frame.addWidget(self.lbl_icon)
        layout_frame.addWidget(self.lbl_titulo)
        layout_frame.addWidget(self.lbl_info)
        layout_frame.addWidget(self.lbl_stock)
        layout_frame.addWidget(self.txt_imei)
        layout_frame.addLayout(h_btn)
        
        layout_master.addWidget(self.frame)
        
        # Sombra
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(25)
        shadow.setColor(QColor(0,0,0, 80))
        self.frame.setGraphicsEffect(shadow)
        
        self.aplicar_estilos()
        self.centrar_en_pantalla()

    def aplicar_estilos(self):
        # DEFINICI√ìN EXACTA DE COLORES
        if self.tema == "Dark":
            bg_color = "#1e1e1e"     # Fondo Oscuro
            text_color = "#ffffff"   # Texto Blanco
            input_bg = "#333333"     # Input Gris Oscuro
            border_color = "#444444"
            btn_cancel_bg = "#444444"
            btn_cancel_txt = "#ffffff"
            stock_color = "#aaaaaa"
        else:
            bg_color = "#ffffff"     # Fondo Blanco (Light)
            text_color = "#000000"   # Texto Negro
            input_bg = "#f0f0f0"     # Input Gris Muy Claro
            border_color = "#cccccc"
            btn_cancel_bg = "#e0e0e0"
            btn_cancel_txt = "#000000"
            stock_color = "#666666"

        # Aplicar al Frame Principal
        self.frame.setStyleSheet(f"""
            QWidget#FrameIMEI {{
                background-color: {bg_color};
                border-radius: 16px;
                border: 1px solid {border_color};
            }}
            QLabel {{
                color: {text_color};
                background-color: transparent; /* Importante para que no herede */
            }}
        """)
        
        # Aplicar a Inputs
        self.txt_imei.setStyleSheet(f"""
            QLineEdit {{
                background-color: {input_bg};
                color: {text_color};
                border-radius: 8px;
                padding: 0 10px;
                border: 1px solid {border_color};
                font-size: 14px;
            }}
            QLineEdit:focus {{
                border: 2px solid #007aff;
            }}
        """)
        
        # Aplicar a Botones
        self.btn_cancel.setStyleSheet(f"""
            QPushButton {{
                background-color: {btn_cancel_bg};
                color: {btn_cancel_txt};
                border-radius: 8px;
                font-weight: bold;
                border: none;
            }}
            QPushButton:hover {{ background-color: #d1d1d1; }}
        """)
        
        self.btn_ok.setStyleSheet("""
            QPushButton {
                background-color: #007aff;
                color: white;
                border-radius: 8px;
                font-weight: bold;
                border: none;
            }
            QPushButton:hover { background-color: #005bb5; }
        """)
        
        # Colores espec√≠ficos
        self.lbl_stock.setStyleSheet(f"color: {stock_color}; font-size: 11px;")

    def centrar_en_pantalla(self):
        if self.parent():
            geo_parent = self.parent().geometry()
            geo_self = self.geometry()
            x = geo_parent.x() + (geo_parent.width() - geo_self.width()) // 2
            y = geo_parent.y() + (geo_parent.height() - geo_self.height()) // 2
            self.move(x, y)

    def validar(self):
        texto = self.txt_imei.text().strip().upper()
        if texto:
            self.imei_resultado = texto
            self.accept()
        else:
            self.txt_imei.setPlaceholderText("¬°Ingrese un valor!")

class DialogoRecargas(QDialog):
    def __init__(self, modo_oscuro=True):
        super().__init__()
        self.setWindowTitle("Recarga Electr√≥nica")
        self.setFixedSize(400, 650)  # Aument√© un poco la altura

        # --- 0. VARIABLES DE ESTADO (MEMORIA) ---
        self.monto_seleccionado = None
        self.metodo_pago = "EFECTIVO"
        
        # --- 1. DEFINICI√ìN DE COLORES ---
        if modo_oscuro:
            self.c = { # Lo hice self.c para usarlo en las funciones
                "bg": "#2b2b2b", "text": "#ffffff",
                "input_bg": "#3a3a3a", "btn_bg": "#404040",
                "btn_hover": "#505050", "accent": "#0078d4",
                "success": "#28a745", "btn_text": "#ffffff"
            }
        else:
            self.c = {
                "bg": "#f3f3f3", "text": "#000000",
                "input_bg": "#ffffff", "btn_bg": "#e0e0e0",
                "btn_hover": "#d0d0d0", "accent": "#0078d4",
                "success": "#28a745", "btn_text": "#000000"
            }

        # --- 2. ESTILOS CSS GENERALES ---
        self.setStyleSheet(f"""
            QDialog {{ background-color: {self.c['bg']}; color: {self.c['text']}; }}
            QLabel {{ color: {self.c['text']}; font-weight: bold; font-size: 14px; margin-top: 5px; }}
            QLineEdit, QComboBox {{
                background-color: {self.c['input_bg']};
                color: {self.c['text']};
                border: 1px solid #555;
                border-radius: 8px;
                padding: 10px;
                font-size: 14px;
            }}
            QComboBox::drop-down {{ border: none; }}
            QPushButton {{
                background-color: {self.c['btn_bg']};
                color: {self.c['btn_text']};
                border-radius: 8px;
                padding: 10px;
                font-weight: bold;
                border: none;
            }}
            QPushButton:hover {{ background-color: {self.c['btn_hover']}; }}
        """)

        # --- 3. CONSTRUCCI√ìN DE LA INTERFAZ ---
        layout_principal = QVBoxLayout()
        layout_principal.setSpacing(15)
        layout_principal.setContentsMargins(20, 20, 20, 20)

        # T√≠tulo
        lbl_titulo = QLabel("üì± Recarga Electr√≥nica")
        lbl_titulo.setStyleSheet(f"color: {self.c['accent']}; font-size: 18px;")
        lbl_titulo.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout_principal.addWidget(lbl_titulo)

        # Campo: Compa√±√≠a (CAMBIO: Ahora es un ComboBox)
        layout_principal.addWidget(QLabel("Compa√±√≠a:"))
        self.combo_compania = QComboBox()
        self.combo_compania.addItems(["TELCEL", "MOVISTAR", "AT&T", "UNEFON", "BAIT"])
        layout_principal.addWidget(self.combo_compania)

        # Campo: N√∫mero
        layout_principal.addWidget(QLabel("N√∫mero (10 d√≠gitos):"))
        self.txt_numero = QLineEdit()
        self.txt_numero.setPlaceholderText("5512345678")
        self.txt_numero.setMaxLength(10) # Limitar a 10 caracteres
        layout_principal.addWidget(self.txt_numero)

        # Secci√≥n: Monto
        layout_principal.addWidget(QLabel("Monto:"))
        grid_montos = QGridLayout()
        grid_montos.setSpacing(10)

        # Lista de montos (n√∫meros reales, no strings con signo de pesos para facilitar l√≥gica)
        montos_data = [20, 30, 50, 100, 200, 500]
        positions = [(i, j) for i in range(2) for j in range(3)]
        
        self.botones_montos = [] # Lista para guardar referencias a los botones

        for position, cantidad in zip(positions, montos_data):
            texto_btn = f"${cantidad}"
            btn = QPushButton(texto_btn)
            btn.setFixedHeight(40)
            
            # CONEXI√ìN DE LA L√ìGICA (Usamos lambda para pasar el valor)
            # check=False es necesario por defecto en PyQt buttons
            btn.clicked.connect(lambda checked=False, m=cantidad: self.seleccionar_monto(m))
            
            grid_montos.addWidget(btn, *position)
            self.botones_montos.append(btn) # Guardar en lista para cambiar color despu√©s
        
        layout_principal.addLayout(grid_montos)

        # Secci√≥n: M√©todo de Pago
        layout_principal.addWidget(QLabel("M√©todo de Pago:"))
        layout_pago = QHBoxLayout()
        
        self.btn_efectivo = QPushButton("üíµ EFECTIVO")
        self.btn_tarjeta = QPushButton("üí≥ TARJETA")
        
        # Conectar botones de pago
        self.btn_efectivo.clicked.connect(lambda: self.cambiar_metodo_pago("EFECTIVO"))
        self.btn_tarjeta.clicked.connect(lambda: self.cambiar_metodo_pago("TARJETA"))

        layout_pago.addWidget(self.btn_efectivo)
        layout_pago.addWidget(self.btn_tarjeta)
        layout_principal.addLayout(layout_pago)

        layout_principal.addStretch()

        # Botones Acci√≥n
        layout_botones = QHBoxLayout()
        btn_cancelar = QPushButton("Cancelar")
        btn_cancelar.setStyleSheet("background-color: #555; color: white;")
        btn_cancelar.clicked.connect(self.close)

        btn_recargar = QPushButton("RECARGAR AHORA")
        btn_recargar.setStyleSheet(f"background-color: {self.c['success']}; color: white; padding: 12px;")
        btn_recargar.clicked.connect(self.procesar_recarga) # <--- CONEXI√ìN FINAL
        
        layout_botones.addWidget(btn_cancelar)
        layout_botones.addWidget(btn_recargar)
        layout_principal.addLayout(layout_botones)

        self.setLayout(layout_principal)
        
        # Seleccionar valores por defecto al iniciar
        self.cambiar_metodo_pago("EFECTIVO")
        # Opcional: Seleccionar 50 por defecto
        # self.seleccionar_monto(50) 

    # --- 4. L√ìGICA DEL PROGRAMA ---

    def seleccionar_monto(self, monto):
        """ Actualiza la variable y pinta el bot√≥n seleccionado """
        self.monto_seleccionado = monto
        print(f"Monto seleccionado: {monto}")
        
        # Actualizar colores visualmente
        for btn in self.botones_montos:
            if btn.text() == f"${monto}":
                # Estilo seleccionado
                btn.setStyleSheet(f"background-color: {self.c['accent']}; color: white;")
            else:
                # Estilo normal
                btn.setStyleSheet(f"background-color: {self.c['btn_bg']}; color: {self.c['btn_text']};")

    def cambiar_metodo_pago(self, metodo):
        self.metodo_pago = metodo
        estilo_activo = f"background-color: {self.c['accent']}; color: white;"
        estilo_inactivo = f"background-color: {self.c['btn_bg']}; color: {self.c['btn_text']};"

        if metodo == "EFECTIVO":
            self.btn_efectivo.setStyleSheet(estilo_activo)
            self.btn_tarjeta.setStyleSheet(estilo_inactivo)
        else:
            self.btn_efectivo.setStyleSheet(estilo_inactivo)
            self.btn_tarjeta.setStyleSheet(estilo_activo)

    def procesar_recarga(self):
        # 1. Obtener datos
        compania = self.combo_compania.currentText()
        numero = self.txt_numero.text()
        
        # 2. Validaciones
        if not numero.isdigit() or len(numero) != 10:
            QMessageBox.warning(self, "Error", "El n√∫mero debe tener 10 d√≠gitos num√©ricos.")
            return

        if self.monto_seleccionado is None:
            QMessageBox.warning(self, "Error", "Selecciona un monto para recargar.")
            return

        # 3. Confirmaci√≥n (Simulaci√≥n de cobro)
        mensaje = (f"¬øConfirmar recarga?\n\n"
                   f"Compa√±√≠a: {compania}\n"
                   f"N√∫mero: {numero}\n"
                   f"Monto: ${self.monto_seleccionado}\n"
                   f"Pago: {self.metodo_pago}")
                   
        respuesta = QMessageBox.question(self, "Confirmar", mensaje, 
                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
        
        if respuesta == QMessageBox.StandardButton.Yes:
            print("Enviando petici√≥n de recarga al sistema...")
            # AQUI VA TU C√ìDIGO DE BASE DE DATOS O API
            QMessageBox.information(self, "√âxito", "Recarga exitosa.")
            self.accept() # Cierra la ventana devolviendo "True"

class DialogoNuevoCliente(QDialog):
    def __init__(self, tema="Dark", parent=None):
        super().__init__(parent)
        self.setWindowTitle("Nuevo Cliente - Registro R√°pido")
        self.setFixedSize(400, 320)
        
        layout = QFormLayout(self)
        layout.setSpacing(15)
        layout.setContentsMargins(20, 20, 20, 20)
        
        self.txt_nombre = QLineEdit()
        self.txt_nombre.setPlaceholderText("Ej. Juan P√©rez")
        
        self.txt_telefono = QLineEdit()
        self.txt_telefono.setPlaceholderText("10 d√≠gitos")
        
        self.txt_direccion = QLineEdit()
        self.txt_direccion.setPlaceholderText("Calle, Colonia...")
        
        self.spin_limite = QDoubleSpinBox()
        self.spin_limite.setRange(0, 100000)
        self.spin_limite.setPrefix("$")
        self.spin_limite.setValue(2000)

        # Etiquetas (Las guardamos para cambiarles el color si hace falta)
        self.labels = []
        l1 = QLabel("Nombre (*):"); layout.addRow(l1, self.txt_nombre); self.labels.append(l1)
        l2 = QLabel("Tel√©fono:"); layout.addRow(l2, self.txt_telefono); self.labels.append(l2)
        l3 = QLabel("Direcci√≥n:"); layout.addRow(l3, self.txt_direccion); self.labels.append(l3)
        l4 = QLabel("L√≠mite Cr√©dito:"); layout.addRow(l4, self.spin_limite); self.labels.append(l4)

        self.btn_guardar = QPushButton("GUARDAR CLIENTE")
        self.btn_guardar.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_guardar.clicked.connect(self.accept)
        layout.addRow(self.btn_guardar)

        # Aplicar el tema recibido al iniciar
        self.aplicar_tema(tema)

    def aplicar_tema(self, tema):
        if tema == "Dark":
            c = {"bg": "#333", "fg": "white", "input": "#444", "border": "#555"}
        else:
            c = {"bg": "#f3f3f3", "fg": "black", "input": "white", "border": "#ccc"}

        self.setStyleSheet(f"""
            QDialog {{ background-color: {c['bg']}; color: {c['fg']}; }}
            QLabel {{ color: {c['fg']}; font-weight: bold; font-size: 14px; background-color: transparent; }}
            QLineEdit, QDoubleSpinBox {{ 
                background-color: {c['input']}; color: {c['fg']}; 
                border: 1px solid {c['border']}; padding: 8px; border-radius: 4px;
            }}
            QPushButton {{ 
                background-color: #28a745; color: white; 
                padding: 10px; border-radius: 5px; font-weight: bold; border: none;
            }}
            QPushButton:hover {{ background-color: #218838; }}
        """)
        
    def get_data(self):
        return (self.txt_nombre.text().strip(), 
                self.txt_telefono.text().strip(), 
                self.txt_direccion.text().strip(), 
                self.spin_limite.value())

# ==========================================
# CLASES DE GESTI√ìN DE CLIENTES Y ABONOS
# ==========================================

class DialogoAbonar(QDialog):
    def __init__(self, nombre, deuda_actual, tema="Dark", parent=None):
        super().__init__(parent)
        self.setWindowTitle(f"Abonar - {nombre}")
        self.setFixedSize(350, 280)
        self.monto_pagar = 0.0
        
        # Definir colores seg√∫n tema
        if tema == "Dark":
            bg, fg, inp = "#333", "white", "#444"
            btn_bg = "#555"
        else:
            bg, fg, inp = "#f5f5f7", "black", "white"
            btn_bg = "#e0e0e0"

        self.setStyleSheet(f"""
            QDialog {{ background-color: {bg}; color: {fg}; }}
            QLabel {{ font-size: 14px; color: {fg}; }}
            QDoubleSpinBox {{ 
                background-color: {inp}; color: {fg}; 
                padding: 5px; font-size: 16px; border: 1px solid #888; border-radius: 4px;
            }}
            QPushButton {{ padding: 10px; font-weight: bold; border-radius: 5px; }}
        """)

        layout = QVBoxLayout(self)
        
        layout.addWidget(QLabel(f"Cliente: {nombre}\nDeuda Actual:"))
        
        lbl_deuda = QLabel(f"${deuda_actual:,.2f}")
        lbl_deuda.setStyleSheet("font-size: 28px; font-weight: bold; color: #ff4d4d;") # Siempre rojo
        lbl_deuda.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(lbl_deuda)
        
        layout.addWidget(QLabel("Monto a Abonar:"))
        self.spin_monto = QDoubleSpinBox()
        self.spin_monto.setPrefix("$")
        self.spin_monto.setRange(0.0, deuda_actual)
        self.spin_monto.setValue(0.0)
        layout.addWidget(self.spin_monto)
        
        # Espacio
        layout.addSpacing(10)

        hbox = QHBoxLayout()
        btn_cancel = QPushButton("Cancelar")
        btn_cancel.setStyleSheet(f"background-color: {btn_bg}; color: {fg};")
        btn_cancel.clicked.connect(self.reject)

        btn_pagar = QPushButton("CONFIRMAR")
        btn_pagar.setStyleSheet("background-color: #28a745; color: white;")
        btn_pagar.clicked.connect(self.confirmar)
        
        hbox.addWidget(btn_cancel)
        hbox.addWidget(btn_pagar)
        layout.addLayout(hbox)

    def confirmar(self):
        self.monto_pagar = self.spin_monto.value()
        if self.monto_pagar <= 0:
            # Usamos QMessageBox est√°tico para simplificar estilos
            QMessageBox.warning(self, "Error", "El monto debe ser mayor a 0")
            return
        self.accept()
        
# =======================================================
# 2. CLASE PRINCIPAL: VENTAS WIDGET (MODIFICADA)
# =======================================================
class VentasWidget(QWidget):
    def __init__(self, main):
        super().__init__()
        self.main = main
        self.carrito = {}
        self.total = 0.0
        self.items_finales = [] 
        
        # Layout Principal (Horizontal)
        layout = QHBoxLayout(self)
        
        # ==========================================
        # PANEL IZQUIERDO (lp) - B√öSQUEDA Y PRODUCTOS
        # ==========================================
        lp = QVBoxLayout()
        lp.setSpacing(10)
        
        # --- CLIENTE (MODIFICADO: CON BOT√ìN "+") ---
        h_cliente = QHBoxLayout()
        h_cliente.setSpacing(5)
        
        # 1. Campo ID (Peque√±o)
        self.txt_id_cliente = QLineEdit()
        self.txt_id_cliente.setPlaceholderText("ID")
        self.txt_id_cliente.setFixedWidth(60)
        self.txt_id_cliente.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.txt_id_cliente.setToolTip("Ingresa el N¬∞ de Cliente y presiona Enter")
        self.txt_id_cliente.returnPressed.connect(self.buscar_cliente_por_id) 
        
        # 2. Campo Nombre (Grande)
        self.txt_cliente = QLineEdit()
        self.txt_cliente.setPlaceholderText("üë§ Cliente (Vac√≠o para 'P√∫blico General')")
        self.txt_cliente.setFixedHeight(40)
        self.txt_id_cliente.setFixedHeight(40)
        
        # 3. [NUEVO] Bot√≥n de Agregar Cliente R√°pido
        self.btn_add_cliente = QPushButton("+")
        self.btn_add_cliente.setFixedSize(40, 40)
        self.btn_add_cliente.setToolTip("Registrar Nuevo Cliente para Cr√©dito")
        self.btn_add_cliente.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_add_cliente.setStyleSheet("""
            QPushButton { background-color: #28a745; color: white; font-size: 20px; font-weight: bold; border-radius: 5px; }
            QPushButton:hover { background-color: #218838; }
        """)
        self.btn_add_cliente.clicked.connect(self.abrir_registro_rapido) # <--- CONEXI√ìN
        
        h_cliente.addWidget(self.txt_id_cliente)
        h_cliente.addWidget(self.txt_cliente)
        h_cliente.addWidget(self.btn_add_cliente) # <--- A√ëADIDO AL LAYOUT
        
        lp.addLayout(h_cliente)
        
        # --- Barra de B√∫squeda Productos ---
        self.txt_bus = QLineEdit()
        self.txt_bus.setPlaceholderText("üîç Buscar producto (Nombre o C√≥digo)...")
        self.txt_bus.textChanged.connect(self.buscar)
        lp.addWidget(self.txt_bus)
        
        # --- Tabla de Resultados ---
        self.grid_res = QTableWidget()
        self.grid_res.setColumnCount(3)
        self.grid_res.setHorizontalHeaderLabels(["Producto", "Precio", "Stock"])
        self.grid_res.verticalHeader().hide()
        self.grid_res.setShowGrid(False)
        self.grid_res.setAlternatingRowColors(True)
        self.grid_res.setFrameShape(QFrame.Shape.NoFrame)
        self.grid_res.setSelectionBehavior(QAbstractItemView.SelectionBehavior.SelectRows)
        self.grid_res.setSelectionMode(QAbstractItemView.SelectionMode.SingleSelection)
        self.grid_res.setEditTriggers(QAbstractItemView.EditTrigger.NoEditTriggers)
        self.grid_res.setFocusPolicy(Qt.FocusPolicy.NoFocus)

        header = self.grid_res.horizontalHeader()
        header.setSectionResizeMode(0, QHeaderView.ResizeMode.Stretch)
        header.setSectionResizeMode(1, QHeaderView.ResizeMode.ResizeToContents)
        header.setSectionResizeMode(2, QHeaderView.ResizeMode.ResizeToContents)
        
        self.grid_res.cellDoubleClicked.connect(self.add_cart)
        lp.addWidget(self.grid_res)
        
        layout.addLayout(lp, stretch=6)
        
        # ==========================================
        # PANEL DERECHO (rp) - TICKET ACTUAL
        # ==========================================
        rp = QVBoxLayout()
        rp.setSpacing(10)
        
        lbl_ticket = QLabel("Ticket Actual")
        lbl_ticket.setObjectName("Title")
        rp.addWidget(lbl_ticket)
        
        # Tabla del Carrito
        self.grid_cart = QTableWidget()
        self.grid_cart.setColumnCount(4)
        self.grid_cart.setHorizontalHeaderLabels(["Prod", "Cant", "Total", ""]) 
        self.grid_cart.verticalHeader().hide()
        self.grid_cart.setShowGrid(False)
        self.grid_cart.setFrameShape(QFrame.Shape.NoFrame)
        self.grid_cart.setFocusPolicy(Qt.FocusPolicy.NoFocus)
        self.grid_cart.setSelectionMode(QAbstractItemView.SelectionMode.NoSelection)
        
        h_cart = self.grid_cart.horizontalHeader()
        h_cart.setSectionResizeMode(0, QHeaderView.ResizeMode.Stretch)
        h_cart.setSectionResizeMode(1, QHeaderView.ResizeMode.Fixed); self.grid_cart.setColumnWidth(1, 120) 
        h_cart.setSectionResizeMode(2, QHeaderView.ResizeMode.Fixed); self.grid_cart.setColumnWidth(2, 80)
        h_cart.setSectionResizeMode(3, QHeaderView.ResizeMode.Fixed); self.grid_cart.setColumnWidth(3, 50)
        
        rp.addWidget(self.grid_cart)
        
        # Totales y Botones
        vr = QVBoxLayout()
        self.lbl_tot = QLabel("$0.00")
        self.lbl_tot.setAlignment(Qt.AlignmentFlag.AlignRight)
        self.lbl_tot.setStyleSheet("font-size: 30px; font-weight: bold; color: #28a745;")
        vr.addWidget(self.lbl_tot)
        
        # Bot√≥n Recargas
        self.btn_recargas = QPushButton("üì± RECARGA T.A.")
        self.btn_recargas.setMinimumHeight(45)
        self.btn_recargas.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_recargas.setStyleSheet("background-color: #007aff; color: white; font-weight: bold; border-radius: 8px;")
        self.btn_recargas.clicked.connect(self.abrir_recargas)
        vr.addWidget(self.btn_recargas)
        
        vr.addSpacing(10)
        
        # Bot√≥n Cobrar
        self.btn_cobrar = QPushButton("Cobrar")
        self.btn_cobrar.setObjectName("SuccessBtn") 
        self.btn_cobrar.setMinimumHeight(55)
        self.btn_cobrar.clicked.connect(self.iniciar_cobro)
        vr.addWidget(self.btn_cobrar)
        
        rp.addLayout(vr)
        layout.addLayout(rp, stretch=4)
        
        self.buscar()

    # --- [NUEVA FUNCI√ìN] REGISTRO R√ÅPIDO DE CLIENTE ---
    def abrir_registro_rapido(self):
        """Abre ventana modal, guarda en BD y pone los datos en la venta"""
        tema_actual = self.main.config.get("tema", "Dark")
        dlg = DialogoNuevoCliente(tema=tema_actual, parent=self)
        if dlg.exec():
            nombre, tel, direc, limite = dlg.get_data()
            
            if not nombre:
                return QMessageBox.warning(self, "Error", "El nombre es obligatorio")
            
            # Guardamos en BD usando tu funci√≥n de database.py
            exito, resultado = db.agregar_cliente(nombre, tel, direc, limite)
            
            if exito:
                nuevo_id = resultado
                # Auto-rellenamos los campos
                self.txt_id_cliente.setText(str(nuevo_id))
                self.txt_cliente.setText(nombre)
                
                QMessageBox.information(self, "Registrado", 
                                      f"‚úÖ Cliente Registrado.\n\n"
                                      f"ID GENERADO: {nuevo_id}\n"
                                      f"L√≠mite Cr√©dito: ${limite:,.2f}")
                self.txt_bus.setFocus()
            else:
                QMessageBox.critical(self, "Error", f"No se pudo guardar: {resultado}")

    # --- L√ìGICA DE B√öSQUEDA ---
    def buscar(self):
        txt = self.txt_bus.text().strip()
        if not txt: 
            self.grid_res.setRowCount(0)
            return

        res = db.buscar_productos(txt)
        
        self.grid_res.setRowCount(0)
        for p in res:
            r = self.grid_res.rowCount()
            self.grid_res.insertRow(r)
            item_nom = QTableWidgetItem(p.nombre)
            item_nom.setData(Qt.ItemDataRole.UserRole, p) 
            self.grid_res.setItem(r, 0, item_nom)
            self.grid_res.setItem(r, 1, QTableWidgetItem(f"${p.precio}"))
            self.grid_res.setItem(r, 2, QTableWidgetItem(str(p.stock)))

    def buscar_cliente_por_id(self):
        id_str = self.txt_id_cliente.text().strip()
        if not id_str: return
        if not id_str.isdigit():
            self.txt_id_cliente.clear()
            return QMessageBox.warning(self, "Error", "El n√∫mero de cliente debe ser num√©rico.")
            
        cliente = db.buscar_cliente_por_id(int(id_str))
        if cliente:
            self.txt_cliente.setText(cliente['nombre'])
            self.txt_bus.setFocus() 
            if cliente['saldo'] > 0:
                QMessageBox.information(self, "Aviso", f"El cliente {cliente['nombre']} tiene un saldo pendiente de: ${cliente['saldo']:,.2f}")
        else:
            QMessageBox.warning(self, "No encontrado", "No existe ning√∫n cliente con ese n√∫mero.")
            self.txt_cliente.clear()
            self.txt_id_cliente.selectAll()

    # --- L√ìGICA CARRITO ---
    def add_cart(self, r, c):
        item = self.grid_res.item(r, 0) 
        if not item: return

        prod_obj = item.data(Qt.ItemDataRole.UserRole)
        if not prod_obj: return

        try:
            talla_elegida = None
            stock_limite = int(prod_obj.stock) 
            
            detalles = json.loads(prod_obj.detalles_json or "{}")
            if "tallas_stock" in detalles:
                tema_actual = self.main.config.get("tema", "Light")
                dlg = DialogoSeleccionTalla(detalles["tallas_stock"], tema=tema_actual, parent=self.main)
                if dlg.exec():
                    talla_elegida = dlg.talla_seleccionada
                    try:
                        stock_limite = int(detalles["tallas_stock"].get(talla_elegida, 0))
                    except: stock_limite = 0
                else:
                    return 

            cart_key = f"{prod_obj.id}_{talla_elegida}" if talla_elegida else prod_obj.id
            
            if cart_key in self.carrito:
                if self.carrito[cart_key]['cant'] + 1 > stock_limite:
                    return QMessageBox.warning(self, "Stock", f"Solo hay {stock_limite} disponibles.")
                self.carrito[cart_key]['cant'] += 1
            else:
                if stock_limite < 1:
                    return QMessageBox.warning(self, "Agotado", "Producto sin stock.")
                self.carrito[cart_key] = {
                    'obj': prod_obj, 'cant': 1, 'talla': talla_elegida, 'stock_max': stock_limite
                }
            self.upd_cart()
        except Exception as e:
            print(f"Error add_cart: {e}")

    def upd_cart(self):
        self.grid_cart.setRowCount(0)
        self.total = 0.0
        
        for key, val in self.carrito.items():
            prod = val['obj']
            cant = val['cant']
            talla = val.get('talla', '')
            subtotal = prod.precio * cant
            self.total += subtotal
            
            r = self.grid_cart.rowCount()
            self.grid_cart.insertRow(r)
            
            nom_str = prod.nombre
            if talla: nom_str += f" [{talla}]"
            item_nom = QTableWidgetItem(nom_str)
            item_nom.setFlags(Qt.ItemFlag.NoItemFlags)
            self.grid_cart.setItem(r, 0, item_nom)
            
            # Widget Cantidad
            widget_qty = QWidget()
            lq = QHBoxLayout(widget_qty)
            lq.setContentsMargins(0,0,0,0); lq.setSpacing(4); lq.setAlignment(Qt.AlignmentFlag.AlignCenter)
            
            b_min = QPushButton("-")
            b_min.setFixedSize(28,28)
            b_min.setStyleSheet("background-color: #007aff; color: white; border-radius: 6px; font-weight: bold;")
            b_min.clicked.connect(lambda _, k=key: self.mod_qty(k, -1))
            
            lbl_c = QLabel(str(cant))
            lbl_c.setStyleSheet("font-weight: bold;")
            lbl_c.setFixedWidth(20); lbl_c.setAlignment(Qt.AlignmentFlag.AlignCenter)

            b_mas = QPushButton("+")
            b_mas.setFixedSize(28,28)
            b_mas.setStyleSheet("background-color: #007aff; color: white; border-radius: 6px; font-weight: bold;")
            b_mas.clicked.connect(lambda _, k=key: self.mod_qty(k, 1))
            
            lq.addWidget(b_min); lq.addWidget(lbl_c); lq.addWidget(b_mas)
            self.grid_cart.setCellWidget(r, 1, widget_qty)
            
            # Total
            lbl_st = QLabel(f"${subtotal:,.0f}")
            lbl_st.setAlignment(Qt.AlignmentFlag.AlignCenter)
            self.grid_cart.setCellWidget(r, 2, lbl_st)
            
            # Borrar
            w_del = QWidget(); ld = QHBoxLayout(w_del); ld.setContentsMargins(0,0,0,0); ld.setAlignment(Qt.AlignmentFlag.AlignCenter)
            b_del = QPushButton("‚úï")
            b_del.setFixedSize(28,28)
            b_del.setStyleSheet("background-color: #ff3b30; color: white; border-radius: 6px; font-weight: bold;")
            b_del.clicked.connect(lambda _, k=key: self.del_item(k))
            ld.addWidget(b_del)
            self.grid_cart.setCellWidget(r, 3, w_del)
            
        self.lbl_tot.setText(f"${self.total:,.2f}")

    def mod_qty(self, key, d):
        if key in self.carrito:
            if d > 0 and self.carrito[key]['cant'] + d > self.carrito[key]['stock_max']:
                 return QMessageBox.warning(self, "Stock", "No hay m√°s stock disponible.")
            self.carrito[key]['cant'] += d
            if self.carrito[key]['cant'] <= 0: del self.carrito[key]
            self.upd_cart()

    def del_item(self, key):
        if key in self.carrito:
            del self.carrito[key]
            self.upd_cart()

    def abrir_recargas(self):
        # Detectar brillo para modo oscuro
        bg_color = self.palette().color(self.palette().ColorRole.Window)
        es_modo_oscuro = bg_color.lightness() < 128
        
        dialogo = DialogoRecargas(modo_oscuro=es_modo_oscuro)
        dialogo.exec()

    def seleccionar_imei_disponible(self, producto):
        try:
            raw_json = producto.detalles_json
            detalles = json.loads(raw_json) if raw_json else {}
            lista_imeis = detalles.get("imei", [])
            
            if not lista_imeis: 
                QMessageBox.warning(self, "Stock Error", f"El producto '{producto.nombre}' no tiene IMEIs registrados.")
                return None
            
            tema = self.main.config.get("tema", "Dark")
            dlg = DialogoCapturaIMEI(producto.nombre, len(lista_imeis), self.main, tema=tema)
            
            while True:
                if dlg.exec(): 
                    imei = dlg.imei_resultado
                    if imei in lista_imeis: return imei
                    else:
                        QMessageBox.warning(self, "Error", "El IMEI escaneado no pertenece a este lote.")
                        dlg.txt_imei.clear(); dlg.txt_imei.setFocus()
                else: return None
        except: return None

    # --- COBRO Y FINALIZACI√ìN ---
    def iniciar_cobro(self):
        if not self.carrito: return QMessageBox.warning(self, "!", "Carrito vac√≠o")
        
        try:
            self.items_finales = []
            for key, val in self.carrito.items():
                prod_obj = val['obj']
                cantidad = val['cant']
                talla = val.get('talla')
                
                es_celular = False
                try:
                    if prod_obj.categoria == "TELEFONIA": es_celular = True
                    elif "imei" in json.loads(prod_obj.detalles_json or "{}"): es_celular = True
                except: pass

                for _ in range(cantidad):
                    copia = copy.copy(prod_obj)
                    if talla:
                        copia.talla_vendida_temp = talla
                        copia.nombre = f"{copia.nombre} [{talla}]"
                    if es_celular:
                        imei = self.seleccionar_imei_disponible(copia)
                        if not imei: return 
                        copia.imei_seleccionado = imei
                        copia.nombre = f"{copia.nombre} [IMEI: {imei}]"
                    self.items_finales.append(copia)
            
            tema = self.main.config.get("tema", "Light")
            dialogo = DialogoPago(self.total, tema=tema, parent=self.main)
            
            if dialogo.exec():
                metodo = dialogo.metodo_seleccionado
                referencia = dialogo.referencia_pago
                cliente_id_credito = None
                
                # Validaci√≥n Cr√©dito
                if metodo == "CREDITO":
                    nombre_cliente = self.txt_cliente.text().strip()
                    id_txt = self.txt_id_cliente.text().strip()
                    cliente_db = None
                    
                    if id_txt.isdigit(): cliente_db = db.buscar_cliente_por_id(int(id_txt))
                    if not cliente_db: cliente_db = db.buscar_cliente_nombre(nombre_cliente)
                    
                    if not cliente_db:
                        return QMessageBox.warning(self, "Error", "Cliente no encontrado. Reg√≠stralo primero con el bot√≥n (+).")
                    
                    nueva_deuda = cliente_db['saldo'] + self.total
                    if nueva_deuda > cliente_db['limite']:
                        return QMessageBox.critical(self, "L√≠mite Excedido", f"L√≠mite: ${cliente_db['limite']}\nSaldo Nuevo ser√≠a: ${nueva_deuda}")
                    
                    cliente_id_credito = cliente_db['id']
                    if QMessageBox.question(self, "Confirmar", f"¬øFiar a {cliente_db['nombre']}?", QMessageBox.StandardButton.Yes|QMessageBox.StandardButton.No) != QMessageBox.StandardButton.Yes:
                        return

                self.procesar_pago_confirmado(metodo, referencia, cliente_id_credito)
                
        except Exception as e:
            print(f"Error cobro: {e}")
            import traceback; traceback.print_exc()

    def procesar_pago_confirmado(self, metodo, referencia, cliente_id_credito=None):
        cliente_nombre = self.txt_cliente.text().strip() or "P√∫blico General"
        try:
            exito, res = db.realizar_venta(
                self.items_finales, self.total, self.main.usuario_actual.id, 
                cliente_nombre, metodo, referencia
            )
            
            if exito:
                venta_id = res
                if metodo == "CREDITO" and cliente_id_credito:
                    # Registramos el cargo en la cuenta del cliente
                    db.cargar_venta_credito(cliente_id_credito, self.total)
                
                try:
                    # Generaci√≥n de Ticket (Asumiendo que utils existe)
                    import utils 
                    ruta_pdf = utils.generar_ticket_pdf(
                        venta_id, self.items_finales, self.total, self.total, 0, 
                        cliente_nombre, self.main.usuario_actual.username, metodo, self.main.config
                    )
                    if ruta_pdf and os.path.exists(ruta_pdf): os.startfile(ruta_pdf)
                except: pass
                
                # Limpiar todo
                self.carrito = {}
                self.upd_cart()
                self.txt_cliente.clear(); self.txt_id_cliente.clear()
                self.txt_bus.clear(); self.buscar(); self.txt_bus.setFocus()
                QMessageBox.information(self, "Venta Exitosa", f"Venta #{venta_id} registrada.")
            else:
                QMessageBox.warning(self, "Error", f"Fallo al guardar: {res}")
        except Exception as e:
            QMessageBox.critical(self, "Error", str(e))
            
class DialogoPago(QDialog):
    def __init__(self, total, tema="Dark", parent=None):
        super().__init__(parent)
        self.setWindowTitle("Cobrar")
        self.setFixedSize(400, 550) # Aumentamos un poco el alto
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.Dialog)
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground)
        
        self.total_pagar = total
        self.metodo_seleccionado = "EFECTIVO"
        self.referencia_pago = ""
        self.tema = tema
        
        layout = QVBoxLayout(self)
        self.frame = QFrame()
        layout.addWidget(self.frame)
        
        l = QVBoxLayout(self.frame)
        l.setContentsMargins(30,30,30,30)
        l.setSpacing(15)
        
        # Total Gigante
        lbl_tot = QLabel(f"${total:,.2f}")
        lbl_tot.setAlignment(Qt.AlignmentFlag.AlignCenter)
        lbl_tot.setStyleSheet("font-size: 40px; font-weight: bold; color: #28a745; border: none;")
        l.addWidget(lbl_tot)
        
        l.addWidget(QLabel("Seleccione M√©todo de Pago:", styleSheet="font-weight: bold; border: none;"))
        
        # Opciones
        self.rb_efectivo = QRadioButton("üíµ EFECTIVO")
        self.rb_efectivo.setChecked(True)
        self.rb_efectivo.toggled.connect(self.cambio_metodo)
        
        self.rb_tarjeta = QRadioButton("üí≥ TARJETA (D√©bito/Cr√©dito)")
        self.rb_tarjeta.toggled.connect(self.cambio_metodo)
        
        self.rb_transf = QRadioButton("üè¶ TRANSFERENCIA")
        self.rb_transf.toggled.connect(self.cambio_metodo)

        # --- NUEVA OPCI√ìN: CR√âDITO ---
        self.rb_credito = QRadioButton("üìù A CR√âDITO (Fiado)")
        self.rb_credito.setStyleSheet("font-weight: bold; color: #ff9800;") # Naranja para resaltar
        self.rb_credito.toggled.connect(self.cambio_metodo)
        
        l.addWidget(self.rb_efectivo)
        l.addWidget(self.rb_tarjeta)
        l.addWidget(self.rb_transf)
        l.addWidget(self.rb_credito) # <--- AGREGAR AL LAYOUT
        
        # Campos Din√°micos
        self.lbl_extra = QLabel("Recibido:")
        self.lbl_extra.setStyleSheet("border: none;")
        l.addWidget(self.lbl_extra)
        
        self.txt_extra = QLineEdit()
        self.txt_extra.setPlaceholderText("Monto recibido")
        self.txt_extra.textChanged.connect(self.calc_cambio)
        l.addWidget(self.txt_extra)
        
        self.lbl_cambio = QLabel("Cambio: $0.00")
        self.lbl_cambio.setStyleSheet("font-size: 18px; font-weight: bold; color: #ff9800; border: none;")
        self.lbl_cambio.setAlignment(Qt.AlignmentFlag.AlignRight)
        l.addWidget(self.lbl_cambio)
        
        l.addStretch()
        
        # Botones
        h = QHBoxLayout()
        btn_cancel = QPushButton("Cancelar")
        btn_cancel.clicked.connect(self.reject)
        
        self.btn_cobrar = QPushButton("COBRAR")
        self.btn_cobrar.setStyleSheet("background-color: #28a745; color: white; font-weight: bold; font-size: 16px; padding: 12px;")
        self.btn_cobrar.clicked.connect(self.procesar)
        
        h.addWidget(btn_cancel)
        h.addWidget(self.btn_cobrar)
        l.addLayout(h)
        
        self.aplicar_tema()

    def cambio_metodo(self):
        if self.rb_efectivo.isChecked():
            self.metodo_seleccionado = "EFECTIVO"
            self.lbl_extra.setText("Dinero Recibido:")
            self.txt_extra.setPlaceholderText("$")
            self.txt_extra.setEnabled(True)
            self.lbl_cambio.show()
        elif self.rb_credito.isChecked():
            self.metodo_seleccionado = "CREDITO"
            self.lbl_extra.setText("Referencia / Nota:")
            self.txt_extra.setPlaceholderText("Ej. Autoriz√≥ Gerente...")
            self.txt_extra.setEnabled(True)
            self.lbl_cambio.hide()
        else:
            self.metodo_seleccionado = "TARJETA" if self.rb_tarjeta.isChecked() else "TRANSFERENCIA"
            self.lbl_extra.setText("N¬∞ Autorizaci√≥n:")
            self.txt_extra.setPlaceholderText("Opcional")
            self.txt_extra.setEnabled(True)
            self.lbl_cambio.hide()

    def calc_cambio(self):
        if self.metodo_seleccionado != "EFECTIVO": return
        try:
            recibido = float(self.txt_extra.text())
            cambio = recibido - self.total_pagar
            if cambio < 0:
                self.lbl_cambio.setStyleSheet("color: #f44336; font-size: 18px; font-weight: bold; border: none;")
                self.lbl_cambio.setText(f"Falta: ${abs(cambio):.2f}")
                self.btn_cobrar.setEnabled(False)
            else:
                self.lbl_cambio.setStyleSheet("color: #28a745; font-size: 18px; font-weight: bold; border: none;")
                self.lbl_cambio.setText(f"Cambio: ${cambio:.2f}")
                self.btn_cobrar.setEnabled(True)
        except:
            self.lbl_cambio.setText("Cambio: $0.00")
            self.btn_cobrar.setEnabled(False)

    def procesar(self):
        if self.metodo_seleccionado != "EFECTIVO":
            self.referencia_pago = self.txt_extra.text().strip()
        self.accept()

    def aplicar_tema(self):
        bg = "#212121" if self.tema == "Dark" else "#ffffff"
        fg = "white" if self.tema == "Dark" else "black"
        inp = "#333" if self.tema == "Dark" else "#f5f5f7"
        
        self.frame.setStyleSheet(f"""
            QFrame {{ background-color: {bg}; border: 1px solid #555; border-radius: 15px; }}
            QLabel, QRadioButton {{ color: {fg}; font-size: 14px; }}
            QLineEdit {{ background-color: {inp}; color: {fg}; padding: 8px; border-radius: 5px; border: 1px solid #777; font-size: 16px; }}
            QPushButton {{ padding: 8px; border-radius: 5px; }}
        """)

# ==========================================
# INVENTARIO & FORMULARIO (Dise√±o Oscuro)
# ==========================================

class WidgetTallas(QWidget):
    def __init__(self):
        super().__init__()
        self.layout = QVBoxLayout(self)
        self.layout.setContentsMargins(0,0,0,0)
        
        # --- √Årea de Captura ---
        h = QHBoxLayout()
        self.txt_talla = QLineEdit()
        self.txt_talla.setPlaceholderText("Talla (ej. S, M, 32, 34)")
        
        self.spin_cant = QSpinBox()
        self.spin_cant.setRange(0, 9999)
        self.spin_cant.setPrefix("Cant: ")
        
        btn_add = QPushButton("+")
        btn_add.setFixedSize(40, 30)
        btn_add.setStyleSheet("background-color: #28a745; color: white; font-weight: bold;")
        btn_add.clicked.connect(self.agregar_fila)
        
        h.addWidget(self.txt_talla)
        h.addWidget(self.spin_cant)
        h.addWidget(btn_add)
        self.layout.addLayout(h)
        
        # --- Tabla Visual ---
        self.tabla = QTableWidget()
        self.tabla.setColumnCount(3)
        self.tabla.setHorizontalHeaderLabels(["Talla", "Cant", ""])
        self.tabla.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeMode.Stretch)
        self.tabla.verticalHeader().hide()
        self.tabla.setFixedHeight(150) # Altura fija peque√±a
        self.layout.addWidget(self.tabla)

    def agregar_fila(self):
        talla = self.txt_talla.text().strip().upper()
        cant = self.spin_cant.value()
        
        if not talla or cant <= 0:
            return # No agregar vac√≠os
            
        # Revisar si ya existe para sumar
        for r in range(self.tabla.rowCount()):
            if self.tabla.item(r, 0).text() == talla:
                cant_actual = int(self.tabla.item(r, 1).text())
                self.tabla.setItem(r, 1, QTableWidgetItem(str(cant_actual + cant)))
                self.txt_talla.clear(); self.spin_cant.setValue(0)
                return

        # Agregar nueva fila
        row = self.tabla.rowCount()
        self.tabla.insertRow(row)
        self.tabla.setItem(row, 0, QTableWidgetItem(talla))
        self.tabla.setItem(row, 1, QTableWidgetItem(str(cant)))
        
        btn_del = QPushButton("x")
        btn_del.setStyleSheet("background-color: #dc3545; color: white;")
        btn_del.setFixedSize(30, 25)
        btn_del.clicked.connect(lambda: self.tabla.removeRow(self.tabla.currentRow())) # Borrar fila actual
        self.tabla.setCellWidget(row, 2, btn_del)
        
        self.txt_talla.clear(); self.spin_cant.setValue(0)
        self.txt_talla.setFocus()

    def obtener_datos_json(self):
        """Devuelve un diccionario con las tallas y cantidades"""
        datos = {}
        for r in range(self.tabla.rowCount()):
            t = self.tabla.item(r, 0).text()
            c = int(self.tabla.item(r, 1).text())
            datos[t] = c
        return datos

    def obtener_total_stock(self):
        """Devuelve la suma total de todas las tallas"""
        total = 0
        for r in range(self.tabla.rowCount()):
            total += int(self.tabla.item(r, 1).text())
        return total

    def cargar_datos(self, datos_dict):
        """Carga datos desde el JSON guardado al editar"""
        self.tabla.setRowCount(0)
        for talla, cant in datos_dict.items():
            row = self.tabla.rowCount()
            self.tabla.insertRow(row)
            self.tabla.setItem(row, 0, QTableWidgetItem(talla))
            self.tabla.setItem(row, 1, QTableWidgetItem(str(cant)))
            
            btn_del = QPushButton("x")
            btn_del.setStyleSheet("background-color: #dc3545; color: white;")
            btn_del.setFixedSize(30, 25)
            # Truco para borrar la fila correcta
            btn_del.clicked.connect(lambda ch, r=row: self.tabla.removeRow(r)) 
            self.tabla.setCellWidget(row, 2, btn_del)

class WidgetIMEI(QWidget):
    def __init__(self):
        super().__init__()
        self.layout = QVBoxLayout(self)
        self.layout.setContentsMargins(0,0,0,0)
        
        # --- √Årea de Captura ---
        h = QHBoxLayout()
        self.txt_imei = QLineEdit()
        self.txt_imei.setPlaceholderText("Escanear o escribir IMEI y presionar Enter")
        self.txt_imei.returnPressed.connect(self.agregar_imei) # Al dar Enter se agrega
        
        btn_add = QPushButton("+")
        btn_add.setFixedSize(40, 30)
        btn_add.setStyleSheet("background-color: #007aff; color: white; font-weight: bold;")
        btn_add.clicked.connect(self.agregar_imei)
        
        h.addWidget(self.txt_imei)
        h.addWidget(btn_add)
        self.layout.addLayout(h)
        
        # --- Tabla Visual ---
        self.tabla = QTableWidget()
        self.tabla.setColumnCount(2)
        self.tabla.setHorizontalHeaderLabels(["IMEI Registrado", ""])
        self.tabla.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeMode.Stretch)
        self.tabla.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.Fixed)
        self.tabla.setColumnWidth(1, 50)
        self.tabla.verticalHeader().hide()
        self.tabla.setFixedHeight(150)
        self.layout.addWidget(self.tabla)
        
        # Etiqueta de conteo
        self.lbl_conteo = QLabel("Total Equipos: 0")
        self.lbl_conteo.setStyleSheet("font-weight: bold; color: #555;")
        self.lbl_conteo.setAlignment(Qt.AlignmentFlag.AlignRight)
        self.layout.addWidget(self.lbl_conteo)

    def agregar_imei(self):
        imei = self.txt_imei.text().strip().upper()
        
        if not imei: return
            
        # 1. Validar duplicados en la lista actual
        for r in range(self.tabla.rowCount()):
            if self.tabla.item(r, 0).text() == imei:
                QMessageBox.warning(self, "Duplicado", "Este IMEI ya est√° en la lista.")
                self.txt_imei.clear()
                return

        # 2. Agregar fila
        row = self.tabla.rowCount()
        self.tabla.insertRow(row)
        self.tabla.setItem(row, 0, QTableWidgetItem(imei))
        
        btn_del = QPushButton("x")
        btn_del.setStyleSheet("background-color: #dc3545; color: white; border-radius: 4px;")
        btn_del.setFixedSize(30, 25)
        btn_del.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_del.clicked.connect(lambda: self.borrar_fila(btn_del)) # Truco para borrar
        self.tabla.setCellWidget(row, 1, btn_del)
        
        self.txt_imei.clear()
        self.txt_imei.setFocus()
        self.actualizar_conteo()

    def borrar_fila(self, btn):
        # Obtener la posici√≥n del bot√≥n presionado
        index = self.tabla.indexAt(btn.pos())
        if index.isValid():
            self.tabla.removeRow(index.row())
            self.actualizar_conteo()

    def actualizar_conteo(self):
        cant = self.tabla.rowCount()
        self.lbl_conteo.setText(f"Total Equipos: {cant}")

    def obtener_lista_imeis(self):
        """Retorna una lista limpia de strings ['IMEI1', 'IMEI2']"""
        lista = []
        for r in range(self.tabla.rowCount()):
            lista.append(self.tabla.item(r, 0).text())
        return lista

    def cargar_datos(self, lista_imeis):
        """Carga una lista de IMEIs (ej. al editar)"""
        self.tabla.setRowCount(0)
        if not lista_imeis: return
        
        # Validamos que sea una lista real, no el string corrupto de antes
        if isinstance(lista_imeis, str):
            # Intento de correcci√≥n si viene sucio
            lista_imeis = [lista_imeis] 
            
        for imei in lista_imeis:
            # Limpieza extra por si acaso
            imei_limpio = str(imei).strip().replace("'", "").replace("[", "").replace("]", "")
            if imei_limpio:
                self.txt_imei.setText(imei_limpio)
                self.agregar_imei()

class DialogoPago(QDialog):
    def __init__(self, total, tema="Dark", parent=None):
        super().__init__(parent)
        self.setWindowTitle("Procesar Pago")
        self.setFixedSize(400, 450)
        self.metodo_seleccionado = None
        self.referencia_pago = ""
        
        # Colores seg√∫n tema
        bg = "#333" if tema == "Dark" else "#f5f5f7"
        fg = "white" if tema == "Dark" else "black"
        btn_bg = "#444" if tema == "Dark" else "#e0e0e0"

        self.setStyleSheet(f"""
            QDialog {{ background-color: {bg}; color: {fg}; }}
            QPushButton {{ background-color: {btn_bg}; color: {fg}; border-radius: 8px; padding: 15px; font-size: 14px; font-weight: bold; }}
            QPushButton:hover {{ background-color: #007aff; color: white; }}
            QLineEdit {{ padding: 10px; border-radius: 5px; border: 1px solid #555; background-color: {btn_bg}; color: {fg}; }}
            QLabel {{ color: {fg}; }}
        """)

        layout = QVBoxLayout(self)
        layout.setSpacing(15)
        layout.setContentsMargins(30, 30, 30, 30)

        # Etiqueta Total
        lbl_total = QLabel(f"Total a Pagar:\n${total:,.2f}")
        lbl_total.setAlignment(Qt.AlignmentFlag.AlignCenter)
        lbl_total.setStyleSheet("font-size: 24px; font-weight: bold; color: #28a745; margin-bottom: 20px;")
        layout.addWidget(lbl_total)

        # Botones de M√©todo de Pago
        self.btn_efectivo = QPushButton("üíµ  EFECTIVO")
        self.btn_efectivo.clicked.connect(lambda: self.finalizar("EFECTIVO"))
        
        self.btn_tarjeta = QPushButton("üí≥  TARJETA")
        self.btn_tarjeta.clicked.connect(lambda: self.pedir_referencia("TARJETA"))
        
        self.btn_trans = QPushButton("üè¶  TRANSFERENCIA")
        self.btn_trans.clicked.connect(lambda: self.pedir_referencia("TRANSFERENCIA"))

        self.btn_credito = QPushButton("ü§ù  CR√âDITO (Fiar)")
        self.btn_credito.setStyleSheet("background-color: #d63384; color: white; border-radius: 8px; padding: 15px; font-size: 14px; font-weight: bold;")
        self.btn_credito.clicked.connect(lambda: self.finalizar("CREDITO"))

        layout.addWidget(self.btn_efectivo)
        layout.addWidget(self.btn_tarjeta)
        layout.addWidget(self.btn_trans)
        layout.addWidget(self.btn_credito)

        btn_cancelar = QPushButton("Cancelar")
        btn_cancelar.setStyleSheet("background-color: transparent; border: 1px solid #555; color: #888; padding: 10px;")
        btn_cancelar.clicked.connect(self.reject)
        layout.addWidget(btn_cancelar)

    def pedir_referencia(self, metodo):
        ref, ok = self.input_dialog("Referencia", f"Ingresa referencia de {metodo}:")
        if ok:
            self.referencia_pago = ref
            self.finalizar(metodo)

    def finalizar(self, metodo):
        self.metodo_seleccionado = metodo
        self.accept()

    def input_dialog(self, title, label):
        d = QDialog(self)
        d.setWindowTitle(title)
        l = QVBoxLayout(d)
        l.addWidget(QLabel(label))
        txt = QLineEdit()
        l.addWidget(txt)
        btn = QPushButton("OK")
        btn.clicked.connect(d.accept)
        l.addWidget(btn)
        if d.exec(): return txt.text(), True
        return "", False

class DialogoSeleccionTalla(QDialog):
    def __init__(self, tallas_stock, tema="Dark", parent=None):
        super().__init__(parent)
        self.setWindowTitle("Seleccionar Talla")
        self.setFixedSize(350, 400)
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.Dialog)
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground)
        
        self.talla_seleccionada = None
        self.tema = tema
        
        # Layout Principal
        layout = QVBoxLayout(self)
        self.frame = QFrame()
        layout.addWidget(self.frame)
        
        l = QVBoxLayout(self.frame)
        l.setSpacing(15)
        l.setContentsMargins(20, 20, 20, 20)
        
        l.addWidget(QLabel("üëï Elige una talla disponible:", styleSheet="font-size: 16px; font-weight: bold; border: none;"))
        
        # Grid de Botones
        grid = QGridLayout()
        row, col = 0, 0
        
        # Ordenar tallas (S, M, L, XL...)
        orden = ["XS", "S", "M", "L", "XL", "XXL"]
        lista_tallas = sorted(tallas_stock.keys(), key=lambda x: orden.index(x) if x in orden else 99)
        
        for t in lista_tallas:
            # --- CORRECCI√ìN AQU√ç: Convertimos a int() para evitar el error 'str' > 'int' ---
            try:
                cant = int(tallas_stock[t]) 
            except (ValueError, TypeError):
                cant = 0 # Si hay un error en el dato, asumimos 0
            # -------------------------------------------------------------------------------

            txt = f"{t}\n({cant})"
            btn = QPushButton(txt)
            btn.setFixedSize(80, 60)
            btn.setCursor(Qt.CursorShape.PointingHandCursor)
            
            # Si no hay stock, deshabilitar
            if cant <= 0:
                btn.setEnabled(False)
                # Estilo deshabilitado
                btn.setStyleSheet("background-color: #555; color: #aaa; border: 1px solid #666; border-radius: 8px;")
            else:
                # Estilo habilitado (Azul)
                btn.setStyleSheet("""
                    QPushButton { background-color: #007aff; color: white; border-radius: 8px; font-weight: bold; font-size: 14px; }
                    QPushButton:hover { background-color: #005bb5; }
                """)
                # Usamos lambda para pasar el valor de 't'
                btn.clicked.connect(lambda _, x=t: self.seleccionar(x))
                
            grid.addWidget(btn, row, col)
            col += 1
            if col > 2: col=0; row+=1
            
        l.addLayout(grid)
        l.addStretch()
        
        btn_cancel = QPushButton("Cancelar")
        btn_cancel.clicked.connect(self.reject)
        l.addWidget(btn_cancel)
        
        self.aplicar_tema()

    def seleccionar(self, talla):
        self.talla_seleccionada = talla
        self.accept()

    def aplicar_tema(self):
        bg = "#2d2d30" if self.tema == "Dark" else "#ffffff"
        fg = "white" if self.tema == "Dark" else "black"
        border = "#444" if self.tema == "Dark" else "#ccc"
        
        self.frame.setStyleSheet(f"""
            QFrame {{ background-color: {bg}; border: 1px solid {border}; border-radius: 15px; }}
            QLabel {{ color: {fg}; }}
            QPushButton {{ padding: 10px; border-radius: 5px; }}
        """)

class FormularioProducto(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.parent_widget = parent
        self.producto_actual = None
        
        # --- LAYOUT PRINCIPAL ---
        self.main_layout = QVBoxLayout(self)
        self.main_layout.setContentsMargins(30, 20, 30, 20)
        self.main_layout.setSpacing(10)
        
        # 1. HEADER
        h_header = QHBoxLayout()
        self.btn_volver = QPushButton("Volver")
        self.btn_volver.setFixedSize(80, 30)
        self.btn_volver.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_volver.setStyleSheet("background-color: #f8f9fa; border: 1px solid #ddd; color: #333; border-radius: 4px;")
        self.btn_volver.clicked.connect(self.cancelar)
        h_header.addWidget(self.btn_volver)
        h_header.addStretch()
        self.main_layout.addLayout(h_header)
        
        self.lbl_titulo = QLabel("Nuevo Producto")
        self.lbl_titulo.setStyleSheet("font-size: 20px; font-weight: bold; color: #333; margin-top: 5px;")
        self.main_layout.addWidget(self.lbl_titulo)
        
        # 2. SCROLL AREA
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setFrameShape(QFrame.Shape.NoFrame)
        self.content_widget = QWidget()
        
        # Estilos
        self.content_widget.setStyleSheet("""
            QLineEdit, QSpinBox, QDoubleSpinBox, QComboBox, QDateEdit {
                border: 1px solid #ced4da; border-radius: 4px; padding: 6px; background-color: white; font-size: 13px;
            }
            QLineEdit:focus, QSpinBox:focus { border: 1px solid #80bdff; }
            QLabel { color: #495057; font-weight: 500; margin-bottom: 2px; }
            QTableWidget, QListWidget { border: 1px solid #ced4da; background-color: #f8f9fa; }
        """)
        
        self.layout_form = QVBoxLayout(self.content_widget)
        self.layout_form.setSpacing(15)
        self.layout_form.setContentsMargins(0,10,10,10)
        
        # --- DATOS GENERALES (GRID) ---
        grid = QGridLayout()
        grid.setSpacing(15)
        
        grid.addWidget(QLabel("C√≥digo / SKU:"), 0, 0)
        grid.addWidget(QLabel("Nombre del Producto:"), 0, 1)
        self.txt_codigo = QLineEdit()
        self.txt_nombre = QLineEdit()
        grid.addWidget(self.txt_codigo, 1, 0)
        grid.addWidget(self.txt_nombre, 1, 1)
        
        grid.addWidget(QLabel("Precio Venta:"), 2, 0)
        grid.addWidget(QLabel("Costo Compra:"), 2, 1)
        self.txt_precio = QDoubleSpinBox(); self.txt_precio.setRange(0, 999999); self.txt_precio.setPrefix("$ ")
        self.txt_costo = QDoubleSpinBox(); self.txt_costo.setRange(0, 999999); self.txt_costo.setPrefix("$ ")
        grid.addWidget(self.txt_precio, 3, 0)
        grid.addWidget(self.txt_costo, 3, 1)
        
        grid.addWidget(QLabel("Stock Total (Info):"), 4, 0)
        grid.addWidget(QLabel("Giro / Categor√≠a:"), 4, 1)
        
        self.txt_stock_total = QLineEdit()
        self.txt_stock_total.setPlaceholderText("0")
        self.txt_stock_total.setReadOnly(True)
        self.txt_stock_total.setStyleSheet("background-color: #e9ecef;")
        
        self.combo_giro = QComboBox()
        self.combo_giro.addItems(["GENERAL", "ABARROTES", "PAPELERIA", "ROPA", "TELEFONIA", "FARMACIA"])
        self.combo_giro.currentTextChanged.connect(self.cambiar_giro)
        
        grid.addWidget(self.txt_stock_total, 5, 0)
        grid.addWidget(self.combo_giro, 5, 1)
        
        self.layout_form.addLayout(grid)
        
        # --- SECCI√ìN DIN√ÅMICA (STACKED) ---
        self.lbl_detalles = QLabel("Detalles Espec√≠ficos del Giro")
        self.lbl_detalles.setStyleSheet("font-weight: bold; margin-top: 15px; color: #007aff; border-bottom: 1px solid #ddd; padding-bottom: 5px;")
        self.layout_form.addWidget(self.lbl_detalles)
        
        self.stack_detalles = QStackedWidget()
        
        # P√ÅGINAS
        self.page_general = QWidget(); self.setup_page_general(); self.stack_detalles.addWidget(self.page_general)
        self.page_ropa = QWidget(); self.setup_page_ropa(); self.stack_detalles.addWidget(self.page_ropa)
        self.page_telefonia = QWidget(); self.setup_page_telefonia(); self.stack_detalles.addWidget(self.page_telefonia)
        self.page_farmacia = QWidget(); self.setup_page_farmacia(); self.stack_detalles.addWidget(self.page_farmacia)
        
        self.layout_form.addWidget(self.stack_detalles)
        
        scroll.setWidget(self.content_widget)
        self.main_layout.addWidget(scroll)
        
        # 3. FOOTER
        self.btn_guardar = QPushButton("Guardar Producto")
        self.btn_guardar.setFixedHeight(45)
        self.btn_guardar.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_guardar.setStyleSheet("""
            QPushButton { background-color: #28a745; color: white; font-weight: bold; border-radius: 5px; font-size: 14px; border: none; }
            QPushButton:hover { background-color: #218838; }
            QPushButton:disabled { background-color: #ccc; }
        """)
        self.btn_guardar.clicked.connect(self.guardar)
        self.main_layout.addWidget(self.btn_guardar)
        
        # --- üîí BLOQUEO AUTOM√ÅTICO DE GIRO ---
        self.aplicar_configuracion_giro()

    def aplicar_configuracion_giro(self):
        """Lee config.json y bloquea el combo si hay un giro definido"""
        import json
        try:
            with open('config.json', 'r') as f:
                data = json.load(f)
                giro_config = data.get("giro", "GENERAL").strip().upper()
                
                # Seleccionar el giro
                index = self.combo_giro.findText(giro_config)
                if index >= 0:
                    self.combo_giro.setCurrentIndex(index)
                
                # Si NO es GENERAL, bloqueamos el combo para que no mezclen cosas
                if giro_config != "GENERAL":
                    self.combo_giro.setEnabled(False) 
                    self.combo_giro.setStyleSheet("background-color: #e9ecef; color: #555;")
        except:
            pass # Si falla, se queda habilitado por defecto

    # --- CONFIGURACI√ìN DE P√ÅGINAS ---
    
    def setup_page_general(self):
        """Para Abarrotes, Papeler√≠a y General"""
        l = QVBoxLayout(self.page_general); l.setContentsMargins(0,10,0,0)
        l.addWidget(QLabel("Cantidad en Stock:"))
        self.spin_stock_manual = QSpinBox(); self.spin_stock_manual.setRange(0, 999999)
        self.spin_stock_manual.valueChanged.connect(lambda v: self.txt_stock_total.setText(str(v)))
        l.addWidget(self.spin_stock_manual)
        l.addStretch()

    def setup_page_ropa(self):
        """Para Ropa: Tallas y Colores"""
        l = QVBoxLayout(self.page_ropa); l.setContentsMargins(0,10,0,0)
        
        h = QHBoxLayout()
        self.txt_talla_in = QLineEdit(); self.txt_talla_in.setPlaceholderText("Talla (S, M, 32)")
        self.spin_talla_cant = QSpinBox(); self.spin_talla_cant.setRange(1, 999); self.spin_talla_cant.setPrefix("Cant: ")
        btn_add = QPushButton("+"); btn_add.setFixedSize(30,30); btn_add.clicked.connect(self.agregar_talla_ropa)
        btn_add.setStyleSheet("background-color: #007aff; color: white; border-radius: 4px;")
        h.addWidget(self.txt_talla_in); h.addWidget(self.spin_talla_cant); h.addWidget(btn_add)
        l.addLayout(h)
        
        self.tabla_tallas = QTableWidget(0, 2); self.tabla_tallas.setHorizontalHeaderLabels(["Talla", "Cantidad"])
        self.tabla_tallas.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.tabla_tallas.setFixedHeight(100)
        l.addWidget(self.tabla_tallas)
        
        l.addWidget(QLabel("Color / Variante:"))
        self.txt_color_ropa = QLineEdit()
        l.addWidget(self.txt_color_ropa)

    def setup_page_telefonia(self):
        """Para Telefon√≠a: Lista de IMEIs"""
        l = QVBoxLayout(self.page_telefonia); l.setContentsMargins(0,10,0,0)
        l.addWidget(QLabel("Escanear IMEI (Uno por uno):"))
        h = QHBoxLayout()
        self.txt_imei_in = QLineEdit(); self.txt_imei_in.setPlaceholderText("Escanea o escribe IMEI...")
        self.txt_imei_in.returnPressed.connect(self.agregar_imei)
        btn_add = QPushButton("Agregar"); btn_add.clicked.connect(self.agregar_imei)
        btn_add.setStyleSheet("background-color: #007aff; color: white; border-radius: 4px;")
        h.addWidget(self.txt_imei_in); h.addWidget(btn_add)
        l.addLayout(h)
        
        self.lista_imeis = QListWidget(); self.lista_imeis.setFixedHeight(100)
        l.addWidget(self.lista_imeis)
        
        l.addWidget(QLabel("Marca / Modelo:"))
        self.txt_marca_tel = QLineEdit()
        l.addWidget(self.txt_marca_tel)

    def setup_page_farmacia(self):
        """Para Farmacia: Caducidad"""
        l = QVBoxLayout(self.page_farmacia); l.setContentsMargins(0,10,0,0)
        l.addWidget(QLabel("Cantidad en Stock:"))
        self.spin_stock_farma = QSpinBox(); self.spin_stock_farma.setRange(0, 999999)
        self.spin_stock_farma.valueChanged.connect(lambda v: self.txt_stock_total.setText(str(v)))
        l.addWidget(self.spin_stock_farma)
        
        l.addWidget(QLabel("Fecha de Caducidad:"))
        self.date_caducidad = QDateEdit()
        self.date_caducidad.setCalendarPopup(True)
        self.date_caducidad.setDate(QDate.currentDate().addDays(365))
        l.addWidget(self.date_caducidad)
        
        l.addWidget(QLabel("Ingrediente Activo / Laboratorio:"))
        self.txt_ingrediente = QLineEdit()
        l.addWidget(self.txt_ingrediente)
        l.addStretch()

    # --- L√ìGICA DE INTERFAZ ---

    def cambiar_giro(self, texto):
        self.txt_stock_total.setText("0")
        
        if texto == "ROPA":
            self.stack_detalles.setCurrentWidget(self.page_ropa)
            self.actualizar_total_ropa()
        elif texto == "TELEFONIA":
            self.stack_detalles.setCurrentWidget(self.page_telefonia)
            self.actualizar_total_imeis()
        elif texto == "FARMACIA":
            self.stack_detalles.setCurrentWidget(self.page_farmacia)
            self.txt_stock_total.setText(str(self.spin_stock_farma.value()))
        else: # General, Abarrotes, Papeleria
            self.stack_detalles.setCurrentWidget(self.page_general)
            self.txt_stock_total.setText(str(self.spin_stock_manual.value()))

    # --- FUNCIONES ROPA ---
    def agregar_talla_ropa(self):
        t = self.txt_talla_in.text().strip().upper(); c = self.spin_talla_cant.value()
        if not t: return
        r = self.tabla_tallas.rowCount(); self.tabla_tallas.insertRow(r)
        self.tabla_tallas.setItem(r, 0, QTableWidgetItem(t)); self.tabla_tallas.setItem(r, 1, QTableWidgetItem(str(c)))
        self.txt_talla_in.clear(); self.spin_talla_cant.setValue(1); self.txt_talla_in.setFocus()
        self.actualizar_total_ropa()

    def actualizar_total_ropa(self):
        total = 0
        for r in range(self.tabla_tallas.rowCount()):
            try: total += int(self.tabla_tallas.item(r, 1).text())
            except: pass
        self.txt_stock_total.setText(str(total))

    # --- FUNCIONES TELEFONIA ---
    def agregar_imei(self):
        imei = self.txt_imei_in.text().strip().upper()
        if not imei: return
        # Validar duplicados en lista
        items = [self.lista_imeis.item(i).text() for i in range(self.lista_imeis.count())]
        if imei in items: return QMessageBox.warning(self, "!", "IMEI ya en lista")
        
        self.lista_imeis.addItem(imei)
        self.txt_imei_in.clear(); self.txt_imei_in.setFocus()
        self.actualizar_total_imeis()

    def actualizar_total_imeis(self):
        self.txt_stock_total.setText(str(self.lista_imeis.count()))

    # --- GUARDAR ---
    def guardar(self):
        c = self.txt_codigo.text().strip()
        n = self.txt_nombre.text().strip()
        p = self.txt_precio.value()
        cost = self.txt_costo.value()
        cat = self.combo_giro.currentText()
        
        if not c or not n: return QMessageBox.warning(self, "!", "Faltan datos b√°sicos")
        
        stock_final = 0
        detalles = {}
        
        # Recolectar datos seg√∫n giro
        if cat == "ROPA":
            stock_final = int(self.txt_stock_total.text() or 0)
            tallas = {}
            for r in range(self.tabla_tallas.rowCount()):
                tallas[self.tabla_tallas.item(r, 0).text()] = self.tabla_tallas.item(r, 1).text()
            detalles["tallas_stock"] = tallas
            detalles["color"] = self.txt_color_ropa.text().strip()
            
        elif cat == "TELEFONIA":
            stock_final = self.lista_imeis.count()
            imeis = [self.lista_imeis.item(i).text() for i in range(stock_final)]
            detalles["imei"] = imeis
            detalles["marca"] = self.txt_marca_tel.text().strip()
            
        elif cat == "FARMACIA":
            stock_final = self.spin_stock_farma.value()
            detalles["caducidad"] = self.date_caducidad.date().toString("yyyy-MM-dd")
            detalles["ingrediente"] = self.txt_ingrediente.text().strip()
            
        else: # General
            stock_final = self.spin_stock_manual.value()

        import json
        detalles_json = json.dumps(detalles)
        
        if self.producto_actual: # Editar
             ok, msg = db.actualizar_producto_db(self.producto_actual.id, c, n, p, cost, stock_final, cat) # Nota: Update deber√≠a soportar detalles si no lo hace ya
        else: # Nuevo
             ok, msg = db.agregar_producto_db(c, n, p, cost, stock_final, cat, detalles_json)
             
        if ok:
            QMessageBox.information(self, "OK", "Producto Guardado")
            self.limpiar_formulario()
            if self.parent_widget: self.parent_widget.load(); self.parent_widget.show_list()
        else:
            QMessageBox.warning(self, "Error", msg)

    def cargar_datos_edicion(self, prod):
        self.producto_actual = prod
        self.lbl_titulo.setText(f"Editar: {prod.nombre}")
        self.btn_guardar.setText("Guardar Cambios")
        
        self.txt_codigo.setText(str(prod.codigo)); self.txt_nombre.setText(str(prod.nombre))
        self.txt_precio.setValue(float(prod.precio)); self.txt_costo.setValue(float(prod.costo))
        self.combo_giro.setCurrentText(str(prod.categoria))
        
        # Aqu√≠ podr√≠as cargar detalles JSON si quisieras edici√≥n completa
        # Por simplicidad cargamos el stock total en los manuales
        if prod.categoria not in ["ROPA", "TELEFONIA"]:
            self.spin_stock_manual.setValue(int(prod.stock))
            self.spin_stock_farma.setValue(int(prod.stock))
        
        # Bloquear giro en edici√≥n suele ser buena idea para no romper consistencia
        self.combo_giro.setEnabled(False)

    def limpiar_formulario(self):
        self.producto_actual = None
        self.lbl_titulo.setText("Nuevo Producto")
        self.btn_guardar.setText("Guardar Producto")
        self.txt_codigo.clear(); self.txt_nombre.clear()
        self.txt_precio.setValue(0); self.txt_costo.setValue(0)
        
        self.spin_stock_manual.setValue(0); self.spin_stock_farma.setValue(0)
        self.tabla_tallas.setRowCount(0); self.lista_imeis.clear()
        
        # Restaurar bloqueo de config
        self.combo_giro.setEnabled(True)
        self.aplicar_configuracion_giro()

    def cancelar(self):
        self.limpiar_formulario()
        if self.parent_widget: self.parent_widget.show_list()
            
class WidgetRecepcionMercancia(QWidget):
    def __init__(self, main):
        super().__init__()
        self.main = main
        self.producto_seleccionado = None
        
        # Layout Principal
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)
        
        # T√≠tulo
        lbl = QLabel("üöõ Recepci√≥n de Mercanc√≠a")
        lbl.setStyleSheet("font-size: 20px; font-weight: bold; color: #007aff;")
        layout.addWidget(lbl)
        
        # --- BUSCADOR ---
        box_search = QGroupBox("1. Buscar Producto Existente")
        lb = QHBoxLayout(box_search)
        
        self.txt_busqueda = QLineEdit()
        self.txt_busqueda.setPlaceholderText("Escanear c√≥digo de barras o escribir nombre...")
        self.txt_busqueda.returnPressed.connect(self.buscar_producto)
        
        btn_buscar = QPushButton("üîç")
        btn_buscar.setFixedSize(40, 30)
        btn_buscar.clicked.connect(self.buscar_producto)
        
        lb.addWidget(self.txt_busqueda)
        lb.addWidget(btn_buscar)
        layout.addWidget(box_search)
        
        # --- INFO PRODUCTO ---
        self.lbl_info = QLabel("Ning√∫n producto seleccionado")
        self.lbl_info.setStyleSheet("font-size: 16px; font-weight: bold; padding: 10px; background-color: rgba(0,0,0,0.05); border-radius: 5px;")
        self.lbl_info.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(self.lbl_info)
        
        # --- ZONA DIN√ÅMICA (STACK) ---
        # Aqu√≠ cambiamos la interfaz seg√∫n el tipo de producto
        self.stack_entrada = QStackedWidget()
        self.stack_entrada.setFixedHeight(250) # Altura fija para mantener orden
        
        # P√ÅGINA 0: VAC√çA (Inicio)
        self.stack_entrada.addWidget(QWidget())
        
        # P√ÅGINA 1: GENERAL (Solo cantidad)
        p_gen = QWidget(); l_gen = QVBoxLayout(p_gen)
        l_gen.addWidget(QLabel("Cantidad a Sumar:"))
        self.spin_general = QSpinBox()
        self.spin_general.setRange(1, 10000)
        self.spin_general.setFixedHeight(40)
        self.spin_general.setStyleSheet("font-size: 18px;")
        l_gen.addWidget(self.spin_general)
        l_gen.addStretch()
        self.stack_entrada.addWidget(p_gen)
        
        # P√ÅGINA 2: ROPA (Tabla peque√±a para agregar tallas)
        p_ropa = QWidget(); l_ropa = QVBoxLayout(p_ropa)
        h_ropa = QHBoxLayout()
        self.txt_talla_ropa = QLineEdit(); self.txt_talla_ropa.setPlaceholderText("Talla (S, M, 32...)")
        self.spin_cant_ropa = QSpinBox(); self.spin_cant_ropa.setRange(1, 1000)
        btn_add_talla = QPushButton("Agregar Talla"); btn_add_talla.clicked.connect(self.add_talla_lista)
        h_ropa.addWidget(self.txt_talla_ropa); h_ropa.addWidget(self.spin_cant_ropa); h_ropa.addWidget(btn_add_talla)
        
        self.tabla_ropa = QTableWidget(0, 2)
        self.tabla_ropa.setHorizontalHeaderLabels(["Talla", "Cant. a Sumar"])
        self.tabla_ropa.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        
        l_ropa.addLayout(h_ropa)
        l_ropa.addWidget(self.tabla_ropa)
        self.stack_entrada.addWidget(p_ropa)
        
        # P√ÅGINA 3: TELEFON√çA (Escanear IMEIs)
        p_imei = QWidget(); l_imei = QVBoxLayout(p_imei)
        h_imei = QHBoxLayout()
        self.txt_imei_scan = QLineEdit(); self.txt_imei_scan.setPlaceholderText("Escanear IMEI...")
        self.txt_imei_scan.returnPressed.connect(self.add_imei_lista)
        btn_add_imei = QPushButton("Agregar"); btn_add_imei.clicked.connect(self.add_imei_lista)
        h_imei.addWidget(self.txt_imei_scan); h_imei.addWidget(btn_add_imei)
        
        self.lista_imeis = QPlainTextEdit()
        self.lista_imeis.setReadOnly(True)
        self.lista_imeis.setPlaceholderText("Los IMEIs escaneados aparecer√°n aqu√≠...")
        
        l_imei.addLayout(h_imei)
        l_imei.addWidget(self.lista_imeis)
        self.stack_entrada.addWidget(p_imei)
        
        layout.addWidget(self.stack_entrada)
        
        # --- BOT√ìN CONFIRMAR ---
        self.btn_confirmar = QPushButton("üì• RECIBIR MERCANC√çA")
        self.btn_confirmar.setObjectName("SuccessBtn") # Verde
        self.btn_confirmar.setFixedHeight(50)
        self.btn_confirmar.setEnabled(False)
        self.btn_confirmar.clicked.connect(self.guardar_recepcion)
        layout.addWidget(self.btn_confirmar)
        
        layout.addStretch()

    def buscar_producto(self):
        texto = self.txt_busqueda.text().strip()
        if not texto: return
        
        # Usamos la b√∫squeda de DB
        prods = db.buscar_productos(texto)
        if not prods:
            QMessageBox.warning(self, "No encontrado", "No se encontr√≥ el producto.")
            return
            
        # Si hay varios, tomamos el primero (o podr√≠as abrir un di√°logo de selecci√≥n)
        self.producto_seleccionado = prods[0]
        p = self.producto_seleccionado
        
        self.lbl_info.setText(f"üì¶ {p.nombre}\nSKU: {p.codigo} | Stock Actual: {p.stock}")
        self.lbl_info.setStyleSheet("font-size: 16px; font-weight: bold; padding: 10px; background-color: #e3f2fd; color: #0d47a1; border-radius: 5px;")
        
        self.configurar_formulario(p)
        self.btn_confirmar.setEnabled(True)

    def configurar_formulario(self, p):
        # Reiniciar campos
        self.spin_general.setValue(1)
        self.tabla_ropa.setRowCount(0)
        self.lista_imeis.clear()
        self.txt_imei_scan.clear()
        
        # Detectar tipo
        detalles = json.loads(p.detalles_json or "{}")
        
        if "tallas_stock" in detalles or p.categoria == "ROPA":
            self.stack_entrada.setCurrentIndex(2) # P√°gina Ropa
            self.txt_talla_ropa.setFocus()
        elif "imei" in detalles or p.categoria in ["TELEFONIA", "CELULARES"]:
            self.stack_entrada.setCurrentIndex(3) # P√°gina IMEI
            self.txt_imei_scan.setFocus()
        else:
            self.stack_entrada.setCurrentIndex(1) # P√°gina General
            self.spin_general.setFocus()

    def add_talla_lista(self):
        t = self.txt_talla_ropa.text().strip().upper()
        c = self.spin_cant_ropa.value()
        if not t: return
        
        r = self.tabla_ropa.rowCount()
        self.tabla_ropa.insertRow(r)
        self.tabla_ropa.setItem(r, 0, QTableWidgetItem(t))
        self.tabla_ropa.setItem(r, 1, QTableWidgetItem(str(c)))
        self.txt_talla_ropa.clear()
        self.txt_talla_ropa.setFocus()

    def add_imei_lista(self):
        imei = self.txt_imei_scan.text().strip().upper()
        if not imei: return
        
        contenido_actual = self.lista_imeis.toPlainText()
        if imei in contenido_actual:
            QMessageBox.warning(self, "Duplicado", "Este IMEI ya est√° en la lista de entrada.")
            self.txt_imei_scan.clear()
            return
            
        self.lista_imeis.appendPlainText(imei)
        self.txt_imei_scan.clear()
        self.txt_imei_scan.setFocus()

    def guardar_recepcion(self):
        if not self.producto_seleccionado: return
        
        p = self.producto_seleccionado
        idx = self.stack_entrada.currentIndex()
        
        cant_gen = 0
        tallas = {}
        imeis = []
        
        if idx == 1: # General
            cant_gen = self.spin_general.value()
            
        elif idx == 2: # Ropa
            if self.tabla_ropa.rowCount() == 0:
                return QMessageBox.warning(self, "Error", "Agrega al menos una talla.")
            for r in range(self.tabla_ropa.rowCount()):
                t = self.tabla_ropa.item(r, 0).text()
                c = int(self.tabla_ropa.item(r, 1).text())
                tallas[t] = c
                
        elif idx == 3: # IMEI
            texto = self.lista_imeis.toPlainText().strip()
            if not texto:
                return QMessageBox.warning(self, "Error", "Escanea al menos un IMEI.")
            imeis = texto.split('\n')

        # --- GUARDAR EN DB ---
        exito, msg = db.recibir_mercancia_db(p.codigo, cant_gen, tallas, imeis)
        
        if exito:
            QMessageBox.information(self, "√âxito", f"Mercanc√≠a recibida correctamente.\n{msg}")
            # Limpiar todo
            self.producto_seleccionado = None
            self.lbl_info.setText("Ning√∫n producto seleccionado")
            self.lbl_info.setStyleSheet("font-size: 16px; font-weight: bold; padding: 10px; background-color: rgba(0,0,0,0.05); border-radius: 5px;")
            self.stack_entrada.setCurrentIndex(0)
            self.btn_confirmar.setEnabled(False)
            self.txt_busqueda.clear()
            self.txt_busqueda.setFocus()
        else:
            QMessageBox.critical(self, "Error", f"No se pudo actualizar el stock:\n{msg}")

class InventarioWidget(QWidget):
    def __init__(self, main):
        super().__init__()
        self.main = main
        
        layout_main = QVBoxLayout(self)
        layout_main.setContentsMargins(0,0,0,0)
        
        # Tabs
        self.tabs = QTabWidget()
        self.tabs.setStyleSheet("""
            QTabWidget::pane { border: 0; }
            QTabBar::tab { font-weight: bold; padding: 10px 20px; }
            QTabBar::tab:selected { color: #007aff; border-bottom: 2px solid #007aff; }
        """)
        
        self.pestana_lista = QWidget()
        self.setup_lista_inventario()
        self.pestana_recepcion = WidgetRecepcionMercancia(self.main)
        
        self.tabs.addTab(self.pestana_lista, "üì¶ Lista de Productos")
        self.tabs.addTab(self.pestana_recepcion, "üöõ Recepci√≥n de Mercanc√≠a")
        
        layout_main.addWidget(self.tabs)
        
        self.load()
        self.aplicar_seguridad()

    def setup_lista_inventario(self):
        self.stack = QStackedWidget(self.pestana_lista)
        l = QVBoxLayout(self.pestana_lista); l.setContentsMargins(0,0,0,0); l.addWidget(self.stack)
        
        # Vista Lista
        self.p_list = QWidget()
        vl = QVBoxLayout(self.p_list); vl.setContentsMargins(20,20,20,20)
        
        self.tab = QTableWidget()
        self.tab.setColumnCount(5)
        self.tab.setHorizontalHeaderLabels(["SKU","Nombre","Precio","Stock","Giro"])
        self.tab.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.Stretch)
        self.tab.verticalHeader().hide(); self.tab.setShowGrid(False)
        self.tab.setSelectionBehavior(QAbstractItemView.SelectionBehavior.SelectRows)
        vl.addWidget(self.tab)
        
        # Botones Coloridos
        hb = QHBoxLayout()
        
        self.btn_nuevo = QPushButton("+ Nuevo")
        self.btn_nuevo.setStyleSheet("background-color: #28a745; color: white; font-weight: bold; border-radius: 8px; padding: 8px;")
        self.btn_nuevo.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_nuevo.clicked.connect(self.nuevo_producto)
        
        self.btn_editar = QPushButton("‚úèÔ∏è Editar")
        self.btn_editar.setStyleSheet("background-color: #ff9800; color: white; font-weight: bold; border-radius: 8px; padding: 8px;")
        self.btn_editar.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_editar.clicked.connect(self.editar_producto)
        
        self.btn_eliminar = QPushButton("üóëÔ∏è Eliminar")
        self.btn_eliminar.setStyleSheet("background-color: #dc3545; color: white; font-weight: bold; border-radius: 8px; padding: 8px;")
        self.btn_eliminar.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_eliminar.clicked.connect(self.eliminar_producto)
        
        self.btn_pdf = QPushButton("üìÑ PDF")
        self.btn_pdf.setStyleSheet("background-color: #007aff; color: white; font-weight: bold; border-radius: 8px; padding: 8px;")
        self.btn_pdf.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_pdf.clicked.connect(self.exportar_pdf)
        
        self.btn_etq = QPushButton("üè∑Ô∏è Etiquetas")
        self.btn_etq.setStyleSheet("background-color: #5856d6; color: white; font-weight: bold; border-radius: 8px; padding: 8px;")
        self.btn_etq.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_etq.clicked.connect(self.etiquetas)
        
        b_refresh = QPushButton("Refrescar")
        b_refresh.setStyleSheet("background-color: #17a2b8; color: white; font-weight: bold; border-radius: 8px; padding: 8px;")
        b_refresh.setCursor(Qt.CursorShape.PointingHandCursor)
        b_refresh.clicked.connect(self.load)
        
        hb.addWidget(self.btn_nuevo); hb.addWidget(self.btn_editar); hb.addWidget(self.btn_eliminar)
        hb.addSpacing(20)
        hb.addWidget(self.btn_pdf); hb.addWidget(self.btn_etq); hb.addStretch(); hb.addWidget(b_refresh)
        vl.addLayout(hb)
        
        # Vista Formulario (Usando la nueva clase corregida)
        self.p_form = FormularioProducto(self)
        self.stack.addWidget(self.p_list)
        self.stack.addWidget(self.p_form)

    def load(self):
        # 1. Recuperar giro del archivo config
        import json
        giro_permitido = ""
        try:
            with open('config.json', 'r') as f:
                data = json.load(f)
                giro_permitido = data.get("giro", "").strip().upper()
        except: pass

        if hasattr(db, 'obtener_todos_productos'):
            ps = db.obtener_todos_productos()
            self.tab.setRowCount(0)
            
            for p in ps:
                # 2. Obtener categor√≠a del producto
                cat_prod = str(p.categoria if p.categoria else "GENERAL").strip().upper()
                
                # 3. FILTRO ESTRICTO:
                # Si el negocio NO es General, y la categor√≠a del producto NO coincide, lo saltamos.
                if giro_permitido and giro_permitido != "GENERAL":
                    if cat_prod != giro_permitido:
                        continue 
                
                # Si pasa el filtro, lo agregamos
                r = self.tab.rowCount()
                self.tab.insertRow(r)
                self.tab.setItem(r, 0, QTableWidgetItem(str(p.codigo)))
                item_nombre = QTableWidgetItem(p.nombre)
                item_nombre.setData(Qt.ItemDataRole.UserRole, p)
                self.tab.setItem(r, 1, item_nombre)
                self.tab.setItem(r, 2, QTableWidgetItem(f"${p.precio}"))
                self.tab.setItem(r, 3, QTableWidgetItem(str(p.stock)))
                self.tab.setItem(r, 4, QTableWidgetItem(str(p.categoria)))

    def aplicar_seguridad(self):
        if not self.main.verificar_permiso("GESTIONAR_INVENTARIO"):
            self.btn_nuevo.hide(); self.btn_editar.hide(); self.btn_eliminar.hide()
        else:
            self.btn_nuevo.show(); self.btn_editar.show(); self.btn_eliminar.show()

    def show_list(self): self.stack.setCurrentWidget(self.p_list)
    def nuevo_producto(self): self.p_form.limpiar_formulario(); self.stack.setCurrentWidget(self.p_form)
    
    def editar_producto(self):
        r = self.tab.currentRow()
        if r < 0: return QMessageBox.warning(self, "!", "Selecciona un producto.")
        p = self.tab.item(r, 1).data(Qt.ItemDataRole.UserRole)
        self.p_form.cargar_datos_edicion(p); self.stack.setCurrentWidget(self.p_form)
        
    def eliminar_producto(self):
        r = self.tab.currentRow()
        if r < 0: return QMessageBox.warning(self, "!", "Selecciona un producto.")
        sku = self.tab.item(r, 0).text()
        if QMessageBox.question(self, "?", "¬øEliminar?", QMessageBox.StandardButton.Yes|QMessageBox.StandardButton.No)==QMessageBox.StandardButton.Yes:
            if db.eliminar_producto_db(sku): self.load()

    def exportar_pdf(self):
        try:
            items = []
            # Exportamos solo lo que se ve en la tabla (respetando el filtro)
            for fila in range(self.tab.rowCount()):
                sku = self.tab.item(fila, 0).text()
                # Buscamos el objeto original en DB o usamos los datos de la celda
                # Para simpleza, usamos los datos visuales
                items.append((
                    self.tab.item(fila, 0).text(), # SKU
                    self.tab.item(fila, 1).text(), # Nombre
                    self.tab.item(fila, 2).text(), # Precio
                    self.tab.item(fila, 3).text()  # Stock
                ))
            if not items: return
            # Nota: Tu funci√≥n utils.exportar espera objetos o tuplas, ad√°ptalo seg√∫n necesites
            # Si utils espera objetos DB, mejor usa db.obtener_todos_productos() y filtra igual que en load()
            import utils
            # Por seguridad, llamamos directo a DB y filtramos igual
            all_prods = db.obtener_todos_productos()
            filtered_prods = []
            
            # Repetir logica de filtro para el PDF
            import json
            giro = ""
            try: 
                with open('config.json') as f: giro = json.load(f).get("giro","").upper()
            except: pass
            
            for p in all_prods:
                cat = str(p.categoria).upper()
                if giro and giro != "GENERAL" and cat != giro: continue
                filtered_prods.append(p)

            ruta = utils.exportar_inventario_pdf(filtered_prods, self.main.config)
            os.startfile(ruta)
        except Exception as e: QMessageBox.warning(self,"Error",str(e))

    def etiquetas(self):
        t = self.main.config.get("tema", "Dark")
        if 'VentanaEtiquetas' in globals(): VentanaEtiquetas(self, tema=t).exec()

class VentanaEtiquetas(QDialog):
    def __init__(self, parent=None, tema="Dark"):
        super().__init__(parent)
        self.setWindowTitle("Generador de C√≥digos de Barras")
        self.resize(700, 500)
        self.tema = tema 

        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)

        # --- TABLA DE SELECCI√ìN ---
        self.tabla = QTableWidget()
        self.tabla.setColumnCount(3)
        self.tabla.setHorizontalHeaderLabels(["Producto", "Seleccionar", "Copias"])
        self.tabla.verticalHeader().hide()
        
        header = self.tabla.horizontalHeader()
        header.setSectionResizeMode(0, QHeaderView.ResizeMode.Stretch)
        header.setSectionResizeMode(1, QHeaderView.ResizeMode.ResizeToContents)
        header.setSectionResizeMode(2, QHeaderView.ResizeMode.Fixed)
        self.tabla.setColumnWidth(2, 100)
        
        self.tabla.setSelectionBehavior(QAbstractItemView.SelectionBehavior.SelectRows)
        self.tabla.setFocusPolicy(Qt.FocusPolicy.NoFocus)
        layout.addWidget(self.tabla)

        # --- BOTONES ---
        h_btn = QHBoxLayout()
        
        self.btn_sel_todo = QPushButton("Seleccionar Todo")
        self.btn_sel_todo.setFixedHeight(40)
        self.btn_sel_todo.clicked.connect(lambda: self.toggle_seleccion(True))
        
        self.btn_des_todo = QPushButton("Quitar Selecci√≥n")
        self.btn_des_todo.setFixedHeight(40)
        self.btn_des_todo.clicked.connect(lambda: self.toggle_seleccion(False))
        
        self.btn_generar = QPushButton("Generar PDF")
        self.btn_generar.setFixedHeight(40)
        # CONECTAMOS A LA NUEVA FUNCI√ìN CORREGIDA
        self.btn_generar.clicked.connect(self.generar_pdf)

        h_btn.addWidget(self.btn_sel_todo)
        h_btn.addWidget(self.btn_des_todo)
        h_btn.addStretch()
        h_btn.addWidget(self.btn_generar)
        
        layout.addLayout(h_btn)

        self.cargar_productos()
        self.aplicar_tema()

    def aplicar_tema(self):
        # ... (Tu c√≥digo de estilos anterior se mantiene igual aqu√≠) ...
        # Solo aseg√∫rate de copiar la l√≥gica de colores que te pas√© antes
        if self.tema == "Dark":
            bg_window = "#212121"; table_bg = "#2b2b2b"; text_color = "white"
            header_bg = "#1f1f1f"; border_color = "#3e3e42"; btn_bg = "#444"; spin_bg="#3e3e42"
        else:
            bg_window = "#f5f5f7"; table_bg = "#ffffff"; text_color = "black"
            header_bg = "#e0e0e0"; border_color = "#d0d0d0"; btn_bg = "#e0e0e0"; spin_bg="#ffffff"

        self.setStyleSheet(f"background-color: {bg_window}; color: {text_color};")
        self.tabla.setStyleSheet(f"""
            QTableWidget {{ background-color: {table_bg}; border: 1px solid {border_color}; gridline-color: {border_color}; }}
            QHeaderView::section {{ background-color: {header_bg}; color: {text_color}; padding: 8px; border: none; font-weight: bold; }}
            QTableWidget::item {{ padding: 5px; border-bottom: 1px solid {border_color}; }}
        """)
        # Estilos botones...
        btn_style = f"QPushButton {{ background-color: {btn_bg}; color: {text_color}; border-radius: 5px; border: 1px solid {border_color}; }}"
        self.btn_sel_todo.setStyleSheet(btn_style)
        self.btn_des_todo.setStyleSheet(btn_style)
        self.btn_generar.setStyleSheet("QPushButton { background-color: #007aff; color: white; border-radius: 5px; font-weight: bold; }")
        
        self.setStyleSheet(self.styleSheet() + f"""
            QSpinBox {{ background-color: {spin_bg}; color: {text_color}; border: 1px solid {border_color}; }}
        """)

    def cargar_productos(self):
        # Obtenemos objetos reales de la base de datos (SQLAlchemy)
        productos = db.obtener_todos_productos() 
        self.tabla.setRowCount(0)
        
        for p in productos:
            r = self.tabla.rowCount()
            self.tabla.insertRow(r)
            
            # --- CAMBIO IMPORTANTE ---
            # Guardamos el objeto completo 'p' dentro del item de la tabla
            texto = f"{p.nombre} [{p.codigo}]"
            item = QTableWidgetItem(texto)
            item.setData(Qt.ItemDataRole.UserRole, p) # <--- AQU√ç GUARDAMOS EL OBJETO OCULTO
            self.tabla.setItem(r, 0, item)
            
            # Checkbox
            chk_widget = QWidget()
            chk = QCheckBox()
            chk.setStyleSheet("margin-left: 50%; margin-right: 50%;")
            layout_chk = QHBoxLayout(chk_widget); layout_chk.addWidget(chk); layout_chk.setAlignment(Qt.AlignmentFlag.AlignCenter); layout_chk.setContentsMargins(0,0,0,0)
            self.tabla.setCellWidget(r, 1, chk_widget)
            
            # SpinBox
            spin = QSpinBox()
            spin.setRange(1, 100); spin.setValue(1); spin.setAlignment(Qt.AlignmentFlag.AlignCenter)
            self.tabla.setCellWidget(r, 2, spin)

    def toggle_seleccion(self, estado):
        for r in range(self.tabla.rowCount()):
            w = self.tabla.cellWidget(r, 1)
            if w: w.findChild(QCheckBox).setChecked(estado)

    def generar_pdf(self):
        lista_solicitud = [] # Esta lista se enviar√° a utils
        
        for fila in range(self.tabla.rowCount()):
            # Revisar checkbox
            widget_chk = self.tabla.cellWidget(fila, 1)
            chk = widget_chk.findChild(QCheckBox)
            
            if chk and chk.isChecked():
                # --- RECUPERAR EL OBJETO COMPLETO ---
                item_producto = self.tabla.item(fila, 0)
                objeto_producto = item_producto.data(Qt.ItemDataRole.UserRole) # Recuperamos el objeto 'p'
                
                # Cantidad
                spinbox = self.tabla.cellWidget(fila, 2)
                cantidad = spinbox.value()
                
                if cantidad > 0:
                    # Tu funci√≥n utils espera una tupla: (objeto, cantidad)
                    lista_solicitud.append((objeto_producto, cantidad))

        if not lista_solicitud:
            return QMessageBox.warning(self, "Atenci√≥n", "Seleccione al menos un producto.")

        # --- LLAMADA A UTILS ---
        try:
            import utils
            import os
            
            # Llamamos a la funci√≥n con el nombre CORRECTO que me mostraste
            ruta_pdf = utils.generar_pdf_etiquetas_multiples(lista_solicitud)
            
            if ruta_pdf and os.path.exists(ruta_pdf):
                os.startfile(ruta_pdf)
            else:
                QMessageBox.information(self, "Info", "PDF generado (verifique carpeta reportes).")

        except Exception as e:
            QMessageBox.critical(self, "Error", f"Error generando etiquetas:\n{e}")
# ==========================================
# CLASE HISTORIAL (VENTAS PASADAS)
# ==========================================
class HistorialWidget(QWidget):
    def __init__(self, main):
        super().__init__()
        self.main = main
        
        # Layout Principal
        self.layout_principal = QVBoxLayout(self)
        self.layout_principal.setContentsMargins(30, 30, 30, 30)
        self.layout_principal.setSpacing(20)

        # 1. T√çTULO
        self.titulo = QLabel("Historial de Ventas")
        # El estilo se define abajo en aplicar_tema
        self.layout_principal.addWidget(self.titulo)

        # 2. BARRA DE FILTROS
        self.filter_frame = QFrame()
        self.filter_frame.setObjectName("FilterFrame") # ID para estilo
        fl = QHBoxLayout(self.filter_frame)
        fl.setContentsMargins(20, 15, 20, 15)
        fl.setSpacing(15)
        
        self.lbl_desde = QLabel("Desde:")
        self.lbl_hasta = QLabel("Hasta:")

        self.date_ini = QDateEdit(QDate.currentDate())
        self.date_ini.setCalendarPopup(True)
        self.date_ini.setDisplayFormat("yyyy-MM-dd")
        self.date_ini.setFixedWidth(120)
        
        self.date_fin = QDateEdit(QDate.currentDate())
        self.date_fin.setCalendarPopup(True)
        self.date_fin.setDisplayFormat("yyyy-MM-dd")
        self.date_fin.setFixedWidth(120)
        
        self.btn_filtro = QPushButton("üîç Filtrar por Fechas")
        self.btn_filtro.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_filtro.clicked.connect(self.filtrar)
        
        self.btn_todo = QPushButton("Ver Todo")
        self.btn_todo.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_todo.clicked.connect(lambda: self.cargar_datos(None))

        fl.addWidget(self.lbl_desde)
        fl.addWidget(self.date_ini)
        fl.addWidget(self.lbl_hasta)
        fl.addWidget(self.date_fin)
        fl.addWidget(self.btn_filtro)
        fl.addWidget(self.btn_todo)
        fl.addStretch()
        
        self.layout_principal.addWidget(self.filter_frame)

        # 3. TABLA
        self.tabla = QTableWidget()
        cols = ["Folio", "Fecha", "Cliente", "Total", "M√©todo", "Acci√≥n"]
        self.tabla.setColumnCount(len(cols))
        self.tabla.setHorizontalHeaderLabels(cols)
        
        self.tabla.verticalHeader().hide()
        self.tabla.setShowGrid(False)
        self.tabla.setSelectionBehavior(QAbstractItemView.SelectionBehavior.SelectRows)
        self.tabla.setEditTriggers(QAbstractItemView.EditTrigger.NoEditTriggers)
        self.tabla.setFocusPolicy(Qt.FocusPolicy.NoFocus)
        self.tabla.verticalHeader().setDefaultSectionSize(50)

        # Configuraci√≥n de anchos
        header = self.tabla.horizontalHeader()
        header.setSectionResizeMode(0, QHeaderView.ResizeMode.ResizeToContents) 
        header.setSectionResizeMode(1, QHeaderView.ResizeMode.ResizeToContents) 
        header.setSectionResizeMode(2, QHeaderView.ResizeMode.Stretch)           
        header.setSectionResizeMode(3, QHeaderView.ResizeMode.ResizeToContents) 
        header.setSectionResizeMode(4, QHeaderView.ResizeMode.ResizeToContents) 
        header.setSectionResizeMode(5, QHeaderView.ResizeMode.Fixed)
        self.tabla.setColumnWidth(5, 140)
        
        self.layout_principal.addWidget(self.tabla)

        # Cargar datos iniciales
        self.cargar_datos(None)

        # --- CORRECCI√ìN CLAVE: LEER EL TEMA REAL DE LA CONFIGURACI√ìN ---
        tema_inicial = self.main.config.get("tema", "Dark") 
        self.aplicar_tema(tema_inicial)

    def aplicar_tema(self, modo):
        """ Cambia los colores de toda la ventana seg√∫n el modo """
        
        if modo == "Dark":
            # --- PALETA MODO OSCURO ---
            bg_main = "#1e1e1e"      # Fondo principal oscuro
            bg_card = "#2d2d30"      # Fondo de tarjetas/filtros
            text_main = "white"      # Texto blanco
            text_sec = "#aaaaaa"     # Texto secundario gris
            input_bg = "#3e3e42"     # Fondo inputs
            border_c = "#3e3e42"     # Bordes
            table_head = "#252526"   # Cabecera tabla
            table_row_alt = "#2d2d30" # Color alterno (opcional)
            btn_todo_bg = "#444"
            btn_todo_fg = "white"
        else:
            # --- PALETA MODO CLARO (Estilo Apple/Clean) ---
            bg_main = "#f5f5f7"      # Fondo gris muy claro
            bg_card = "#ffffff"      # Fondo blanco puro
            text_main = "#1d1d1f"    # Texto casi negro
            text_sec = "#86868b"     # Texto gris
            input_bg = "#ffffff"     # Fondo inputs blanco
            border_c = "#d2d2d7"     # Bordes grises suaves
            table_head = "#f5f5f7"   # Cabecera gris claro
            table_row_alt = "#fafafa"
            btn_todo_bg = "#e5e5e5"
            btn_todo_fg = "#1d1d1f"

        # 1. Aplicar al Widget Principal
        self.setStyleSheet(f"background-color: {bg_main}; color: {text_main};")
        self.titulo.setStyleSheet(f"color: {text_main}; font-size: 24px; font-weight: bold; border: none;")

        # 2. Frame de Filtros (Tarjeta)
        self.filter_frame.setStyleSheet(f"""
            QFrame#FilterFrame {{
                background-color: {bg_card};
                border-radius: 12px;
                border: 1px solid {border_c};
            }}
            QLabel {{
                background-color: transparent;
                color: {text_main};
                font-weight: bold;
                border: none;
            }}
        """)

        # 3. Inputs de Fecha
        date_style = f"""
            QDateEdit {{
                background-color: {input_bg};
                color: {text_main};
                border: 1px solid {border_c};
                border-radius: 6px;
                padding: 5px;
            }}
            QDateEdit::drop-down {{
                subcontrol-origin: padding;
                subcontrol-position: top right;
                width: 25px;
                border-left-width: 0px;
            }}
        """
        self.date_ini.setStyleSheet(date_style)
        self.date_fin.setStyleSheet(date_style)

        # 4. Botones
        self.btn_filtro.setStyleSheet("""
            QPushButton {
                background-color: #007aff; 
                color: white; 
                border: none; 
                border-radius: 6px; 
                padding: 6px 12px; 
                font-weight: bold;
            }
            QPushButton:hover { background-color: #005bb5; }
        """)
        
        self.btn_todo.setStyleSheet(f"""
            QPushButton {{
                background-color: {btn_todo_bg};
                color: {btn_todo_fg};
                border: 1px solid {border_c};
                border-radius: 6px;
                padding: 6px 12px;
            }}
            QPushButton:hover {{ opacity: 0.8; }}
        """)

        # 5. Tabla (La parte m√°s importante visualmente)
        self.tabla.setStyleSheet(f"""
            QTableWidget {{
                background-color: {bg_card};
                color: {text_main};
                border-radius: 10px;
                border: 1px solid {border_c};
                gridline-color: {border_c};
                outline: 0;
            }}
            QHeaderView::section {{
                background-color: {table_head};
                color: {text_main};
                padding: 10px;
                border: none;
                border-bottom: 1px solid {border_c};
                font-weight: bold;
            }}
            QTableWidget::item {{
                padding: 5px;
                border-bottom: 1px solid {border_c};
            }}
            QTableWidget::item:selected {{
                background-color: #007aff;
                color: white;
            }}
        """)

    def cargar_datos(self, datos_filtrados=None):
        ventas = datos_filtrados if datos_filtrados is not None else db.obtener_historial_ventas()
        
        self.tabla.setRowCount(0)
        for v in ventas:
            r = self.tabla.rowCount()
            self.tabla.insertRow(r)
            
            # Celdas normales
            self.tabla.setItem(r, 0, QTableWidgetItem(str(v.id)))
            fecha_str = v.fecha.strftime("%d/%m/%Y %H:%M") if v.fecha else "--"
            self.tabla.setItem(r, 1, QTableWidgetItem(fecha_str))
            self.tabla.setItem(r, 2, QTableWidgetItem(v.cliente))
            
            # Total (Color Verde siempre, se ve bien en ambos temas)
            item_total = QTableWidgetItem(f"${v.total:.2f}")
            item_total.setForeground(QColor("#28a745"))
            item_total.setFont(QFont("Arial", 10, QFont.Weight.Bold))
            self.tabla.setItem(r, 3, item_total)
            
            self.tabla.setItem(r, 4, QTableWidgetItem(v.metodo_pago))
            
            # Bot√≥n Ticket
            btn = QPushButton("üñ®Ô∏è Ticket")
            btn.setFixedSize(100, 30)
            btn.setCursor(Qt.CursorShape.PointingHandCursor)
            # Estilo morado que combina bien con Dark y Light
            btn.setStyleSheet("""
                QPushButton { background-color: #5856d6; color: white; border-radius: 5px; font-weight: bold; font-size: 12px; border: none; }
                QPushButton:hover { background-color: #4a47c1; }
            """)
            btn.clicked.connect(lambda _, vid=v.id: self.reimprimir(vid))
            
            w = QWidget()
            hl = QHBoxLayout(w)
            hl.setContentsMargins(5, 2, 5, 2)
            hl.setAlignment(Qt.AlignmentFlag.AlignCenter)
            hl.addWidget(btn)
            self.tabla.setCellWidget(r, 5, w)

    def filtrar(self):
        f1 = self.date_ini.date().toString("yyyy-MM-dd")
        f2 = self.date_fin.date().toString("yyyy-MM-dd")
        res = db.buscar_ventas_por_rango(f1, f2)
        if not res: QMessageBox.information(self, "Info", "No se encontraron ventas.")
        self.cargar_datos(res)

    def reimprimir(self, venta_id):
        # L√≥gica de reimpresi√≥n (sin cambios)
        venta, detalles = db.obtener_info_venta(venta_id)
        if not venta: return
        
        class ItemAdaptador:
            def __init__(self, nombre, precio):
                self.nombre = nombre
                self.precio = precio
        
        items_para_ticket = [ItemAdaptador(d.nombre_producto, d.precio_unitario) for d in detalles]
        
        try:
            ruta = utils.generar_ticket_pdf(
                venta.id, 
                items_para_ticket, 
                venta.total, 
                venta.cliente, 
                f"{self.main.usuario_actual.username} (COPIA)", 
                venta.metodo_pago, 
                self.main.config
            )
            os.startfile(ruta)
        except Exception as e:
            QMessageBox.warning(self, "Error", f"No se pudo generar el ticket: {str(e)}")

class DevolucionesWidget(QWidget):
    def __init__(self, main, tema="Dark"): # <--- Aceptamos el tema aqu√≠
        super().__init__()
        self.main = main
        self.tema = tema
        self.venta_actual = None 
        
        # --- LAYOUT PRINCIPAL ---
        self.layout_principal = QVBoxLayout(self)
        self.layout_principal.setContentsMargins(30, 30, 30, 30)
        self.layout_principal.setSpacing(15)
        
        # T√≠tulo
        self.lbl_titulo = QLabel("Gesti√≥n de Devoluciones")
        self.layout_principal.addWidget(self.lbl_titulo)

        # --- BARRA DE B√öSQUEDA ---
        self.search_frame = QFrame()
        hl = QHBoxLayout(self.search_frame)
        hl.setContentsMargins(15, 10, 15, 10)
        
        self.lbl_folio = QLabel("Folio:")
        
        self.txt_folio = QLineEdit()
        self.txt_folio.setPlaceholderText("Ingresa el Folio de Venta (Ej: 5)")
        
        self.btn_buscar = QPushButton("üîç Buscar Venta")
        self.btn_buscar.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_buscar.clicked.connect(self.buscar_venta)
        
        hl.addWidget(self.lbl_folio)
        hl.addWidget(self.txt_folio)
        hl.addWidget(self.btn_buscar)
        self.layout_principal.addWidget(self.search_frame)

        # --- INFORMACI√ìN Y ALERTA DE FECHA ---
        self.info_frame = QFrame()
        self.info_frame.setVisible(False) 
        il = QVBoxLayout(self.info_frame)
        il.setContentsMargins(15, 10, 15, 10)
        
        self.lbl_datos_venta = QLabel()
        self.lbl_alerta = QLabel()
        self.lbl_alerta.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        il.addWidget(self.lbl_datos_venta)
        il.addWidget(self.lbl_alerta)
        self.layout_principal.addWidget(self.info_frame)

        # --- TABLA DE PRODUCTOS ---
        self.tabla = QTableWidget()
        cols = ["ID", "Producto", "Cant. Comprada", "Precio", "Devolver Cant."]
        self.tabla.setColumnCount(len(cols))
        self.tabla.setHorizontalHeaderLabels(cols)
        self.tabla.verticalHeader().hide()
        self.tabla.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.Stretch)
        self.layout_principal.addWidget(self.tabla)

        # --- BOT√ìN DE ACCI√ìN ---
        self.btn_procesar = QPushButton("üîÑ PROCESAR DEVOLUCI√ìN")
        self.btn_procesar.setFixedHeight(50)
        self.btn_procesar.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_procesar.setEnabled(False) 
        self.btn_procesar.clicked.connect(self.procesar_devolucion)
        self.layout_principal.addWidget(self.btn_procesar)

        # APLICAR TEMA INICIAL
        self.aplicar_tema(self.tema)

    def aplicar_tema(self, modo):
        """Cambia los colores de la interfaz"""
        self.tema = modo
        
        if modo == "Dark":
            bg_main = "#212121"; text_color = "white"
            bg_card = "#2b2b2b"; border_color = "#3e3e42"
            input_bg = "#3e3e42"; input_text = "white"
            table_bg = "#2b2b2b"; header_bg = "#1f1f1f"
            btn_process_dis = "#555"
        else:
            bg_main = "#f5f5f7"; text_color = "black"
            bg_card = "#ffffff"; border_color = "#d0d0d0"
            input_bg = "#ffffff"; input_text = "black"
            table_bg = "#ffffff"; header_bg = "#e0e0e0"
            btn_process_dis = "#e0e0e0"

        # 1. Fondo General y T√≠tulo
        self.setStyleSheet(f"background-color: {bg_main}; color: {text_color};")
        self.lbl_titulo.setStyleSheet("font-size: 24px; font-weight: bold; border: none;")

        # 2. Barra de B√∫squeda
        self.search_frame.setStyleSheet(f"background-color: {bg_card}; border-radius: 10px; border: 1px solid {border_color};")
        self.lbl_folio.setStyleSheet("font-weight: bold; border: none; background: transparent;")
        
        self.txt_folio.setStyleSheet(f"""
            QLineEdit {{ background-color: {input_bg}; color: {input_text}; border: 1px solid {border_color}; border-radius: 5px; padding: 5px; }}
        """)
        
        self.btn_buscar.setStyleSheet("QPushButton { background-color: #007aff; color: white; border-radius: 5px; font-weight: bold; border: none; padding: 5px; }")

        # 3. Frame de Informaci√≥n
        self.info_frame.setStyleSheet(f"background-color: {bg_card}; border-radius: 10px; margin-top: 10px; border: 1px solid {border_color};")
        self.lbl_datos_venta.setStyleSheet("font-size: 14px; border: none; background: transparent;")

        # 4. Tabla
        self.tabla.setStyleSheet(f"""
            QTableWidget {{ background-color: {table_bg}; color: {text_color}; border: 1px solid {border_color}; gridline-color: {border_color}; }}
            QHeaderView::section {{ background-color: {header_bg}; color: {text_color}; padding: 5px; border: none; font-weight: bold; }}
            QTableWidget::item {{ padding: 5px; border-bottom: 1px solid {border_color}; }}
        """)

        # 5. SpinBox (Los cuadritos de n√∫meros dentro de la tabla)
        # Esto aplica un estilo global a los SpinBox dentro de este widget
        self.setStyleSheet(self.styleSheet() + f"""
            QSpinBox {{ background-color: {input_bg}; color: {text_color}; border: 1px solid {border_color}; }}
        """)

        # 6. Bot√≥n Procesar (Estado Base)
        # Nota: El color verde/rojo se maneja en la l√≥gica, aqu√≠ solo definimos el estilo base
        self.btn_procesar_style_base = f"border-radius: 8px; font-weight: bold; font-size: 16px; border: none;"

    def buscar_venta(self):
        folio = self.txt_folio.text().strip()
        if not folio: return
        
        venta = db.obtener_venta_por_folio(folio)
        
        if not venta:
            QMessageBox.warning(self, "Error", "Venta no encontrada.")
            return

        self.venta_actual = venta
        self.info_frame.setVisible(True)
        self.llenar_tabla(venta.items)
        
        # --- NUEVA VALIDACI√ìN DE ESTADO ---
        # Si la venta ya est√° marcada como devuelta o tiene devoluci√≥n parcial
        if venta.estado in ["DEVUELTA", "CON DEVOLUCION"]:
            self.lbl_alerta.setText(f"‚ö†Ô∏è ESTA VENTA YA FUE DEVUELTA (Estado: {venta.estado})")
            self.lbl_alerta.setStyleSheet("background-color: #ff9800; color: white; font-weight: bold; border-radius: 5px; padding: 5px;")
            
            self.btn_procesar.setEnabled(False)
            self.btn_procesar.setText("TICKET YA DEVUELTO")
            # Opcional: Bloquear la tabla para que no puedan editar nada
            self.tabla.setEnabled(False) 
            
            # Mostramos info b√°sica pero salimos de la funci√≥n aqu√≠
            fecha_str = venta.fecha.strftime("%d/%m/%Y")
            self.lbl_datos_venta.setText(f"üìÖ Fecha: {fecha_str} | üë§ Cliente: {venta.cliente}")
            return 
        # ----------------------------------

        # SI NO EST√Å DEVUELTA, CONTINUAMOS CON LA VALIDACI√ìN DE 30 D√çAS...
        self.tabla.setEnabled(True) # Reactivar tabla por si acaso
        
        dias_pasados = (datetime.now() - venta.fecha).days
        fecha_str = venta.fecha.strftime("%d/%m/%Y")
        
        texto_info = f"üìÖ Fecha: {fecha_str} | üë§ Cliente: {venta.cliente} | ‚è≥ D√≠as: {dias_pasados}"
        self.lbl_datos_venta.setText(texto_info)

        if dias_pasados > 30:
            self.lbl_alerta.setText(f"üö´ NO PROCEDE: LA COMPRA EXCEDE LOS 30 D√çAS")
            self.lbl_alerta.setStyleSheet("background-color: #ff4444; color: white; font-weight: bold; border-radius: 5px; padding: 5px;")
            self.btn_procesar.setEnabled(False)
            self.btn_procesar.setText("PLAZO VENCIDO")
            self.tabla.setEnabled(False)
        else:
            self.lbl_alerta.setText("‚úÖ TICKET V√ÅLIDO PARA DEVOLUCI√ìN")
            self.lbl_alerta.setStyleSheet("background-color: #28a745; color: white; font-weight: bold; border-radius: 5px; padding: 5px;")
            self.btn_procesar.setEnabled(True)
            self.btn_procesar.setText("üîÑ PROCESAR DEVOLUCI√ìN")
            self.tabla.setEnabled(True)

    def llenar_tabla(self, items):
        self.tabla.setRowCount(0)
        for row, item in enumerate(items):
            self.tabla.insertRow(row)
            
            # --- CORRECCI√ìN AQU√ç: USAMOS CORCHETES ['clave'] ---
            # Antes dec√≠a item.id (Error), ahora dice item['id'] (Correcto)
            self.tabla.setItem(row, 0, QTableWidgetItem(str(item['id'])))
            self.tabla.setItem(row, 1, QTableWidgetItem(item['nombre']))
            self.tabla.setItem(row, 2, QTableWidgetItem(str(item['cantidad'])))
            self.tabla.setItem(row, 3, QTableWidgetItem(f"${item['precio']:.2f}"))
            
            spin = QSpinBox()
            # Aqu√≠ tambi√©n corregimos para usar corchetes
            spin.setRange(0, item['cantidad']) 
            spin.setAlignment(Qt.AlignmentFlag.AlignCenter)
            
            # (El resto del c√≥digo de centrado se queda igual)
            container = QWidget()
            layout = QHBoxLayout(container)
            layout.setContentsMargins(0,0,0,0)
            layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
            layout.addWidget(spin)
            self.tabla.setCellWidget(row, 4, container)

    def procesar_devolucion(self):
        items_a_devolver = []
        
        for r in range(self.tabla.rowCount()):
            widget_conteiner = self.tabla.cellWidget(r, 4)
            spinbox = widget_conteiner.findChild(QSpinBox)
            cantidad = spinbox.value()
            
            if cantidad > 0:
                id_prod = self.tabla.item(r, 0).text()
                items_a_devolver.append({"id": id_prod, "cantidad": cantidad})

        if not items_a_devolver:
            return QMessageBox.warning(self, "Atenci√≥n", "Seleccione al menos un producto.")

        # --- CORRECCI√ìN AQU√ç: Capturamos el resultado ---
        exito, mensaje = db.registrar_devolucion(self.venta_actual.id, items_a_devolver)
        
        if exito:
            QMessageBox.information(self, "√âxito", f"{mensaje}")
            
            # Limpiamos la b√∫squeda
            self.buscar_venta() 
            
            # TRUCO: Intentamos refrescar el inventario autom√°ticamente si existe
            if hasattr(self.main, 'inventario_w'):
                self.main.inventario_w.load()
        else:
            QMessageBox.critical(self, "Error", f"Hubo un problema: {mensaje}")
            
class DialogoGestorUsuario(QDialog):
    def __init__(self, parent=None, tema="Dark", usuario_a_editar=None):
        super().__init__(parent)
        self.usuario_editar = usuario_a_editar # Si es None, estamos creando. Si tiene datos, editamos.
        
        titulo = "Editar Usuario" if usuario_a_editar else "Nuevo Usuario"
        self.setWindowTitle(titulo)
        self.setFixedSize(450, 580)
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.Dialog)
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground)
        
        self.resultado = None 
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0,0,0,0)
        
        self.frame = QFrame()
        layout.addWidget(self.frame)
        
        l_frame = QVBoxLayout(self.frame)
        l_frame.setContentsMargins(30,30,30,30)
        l_frame.setSpacing(15)
        
        # T√≠tulo
        lbl_titulo = QLabel(f"üë§ {titulo}")
        lbl_titulo.setAlignment(Qt.AlignmentFlag.AlignCenter)
        lbl_titulo.setStyleSheet("font-size: 22px; font-weight: bold; border: none;")
        l_frame.addWidget(lbl_titulo)
        
        # Inputs
        self.txt_user = QLineEdit()
        self.txt_user.setPlaceholderText("Nombre de Usuario")
        
        self.txt_pass = QLineEdit()
        placeholder_pass = "Nueva Contrase√±a (Dejar vac√≠o para no cambiar)" if usuario_a_editar else "Contrase√±a"
        self.txt_pass.setPlaceholderText(placeholder_pass)
        self.txt_pass.setEchoMode(QLineEdit.EchoMode.Password)
        
        l_frame.addWidget(QLabel("Datos de Acceso:"))
        l_frame.addWidget(self.txt_user)
        l_frame.addWidget(self.txt_pass)
        
        # Rol
        l_frame.addWidget(QLabel("Rol:"))
        self.combo_rol = QComboBox()
        self.combo_rol.addItems(["ADMIN", "CAJERO"])
        self.combo_rol.currentTextChanged.connect(self.cambiar_rol)
        l_frame.addWidget(self.combo_rol)
        
        # --- √ÅREA DE PERMISOS (Con estilo visual) ---
        self.group_permisos = QGroupBox("Permisos del Cajero")
        l_perm = QVBoxLayout(self.group_permisos)
        l_perm.setSpacing(8)
        
        # Checkboxes
        # 1. El permiso nuevo que pediste para Inventario
        self.chk_inventario = QCheckBox("üì¶ GESTIONAR INVENTARIO (Agregar/Editar/Borrar)")
        
        # 2. Otros permisos
        self.chk_devoluciones = QCheckBox("‚Ü©Ô∏è Realizar Devoluciones")
        self.chk_historial = QCheckBox("üìú Ver Historial de Ventas")
        self.chk_corte = QCheckBox("üí∞ Realizar Corte de Caja")
        
        l_perm.addWidget(self.chk_inventario)
        l_perm.addWidget(self.chk_devoluciones)
        l_perm.addWidget(self.chk_historial)
        l_perm.addWidget(self.chk_corte)
        
        l_frame.addWidget(self.group_permisos)
        
        # Botones
        h_btn = QHBoxLayout()
        btn_cancel = QPushButton("Cancelar")
        btn_cancel.clicked.connect(self.reject)
        
        btn_save = QPushButton("Guardar Cambios" if usuario_a_editar else "Crear Usuario")
        btn_save.setObjectName("BtnAzul")
        btn_save.clicked.connect(self.validar_y_guardar)
        
        h_btn.addWidget(btn_cancel)
        h_btn.addWidget(btn_save)
        l_frame.addLayout(h_btn)
        
        # --- ESTILOS VISUALES (Checkboxes con relleno) ---
        accent_color = "#007aff" if tema == "Dark" else "#007aff"
        bg_chk = "#2d2d2d" if tema == "Dark" else "#f0f0f0"
        
        if tema == "Dark":
            bg="#1e1e1e"; fg="white"; inp="#2d2d2d"; bord="#444"; btn="#3a3a3a"
        else:
            bg="white"; fg="#333"; inp="#f0f0f0"; bord="#ccc"; btn="#e0e0e0"

        self.frame.setStyleSheet(f"""
            QFrame {{ background-color: {bg}; border-radius: 15px; border: 1px solid {bord}; }}
            QLabel {{ color: {fg}; background: transparent; font-weight: bold; }}
            QLineEdit, QComboBox {{ background-color: {inp}; color: {fg}; border: 1px solid {bord}; border-radius: 8px; padding: 8px; }}
            QPushButton {{ background-color: {btn}; color: {fg}; border-radius: 8px; padding: 8px; font-weight: bold; }}
            QPushButton#BtnAzul {{ background-color: {accent_color}; color: white; }}
            
            /* ESTILO PARA CHECKBOX CON RELLENO */
            QCheckBox {{
                color: {fg}; font-weight: bold; spacing: 10px; padding: 5px;
            }}
            QCheckBox::indicator {{
                width: 20px; height: 20px;
                border-radius: 4px;
                border: 2px solid {bord};
                background-color: {inp};
            }}
            QCheckBox::indicator:checked {{
                background-color: #28a745; /* VERDE RELLENO AL MARCAR */
                border: 2px solid #28a745;
                image: url(none); /* Aqu√≠ podr√≠as poner un icono de palomita si tuvieras */
            }}
        """)
        
        # Sombra
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(20); shadow.setColor(QColor(0,0,0,100))
        self.frame.setGraphicsEffect(shadow)
        
        # SI ESTAMOS EDITANDO, CARGAR DATOS
        if self.usuario_editar:
            self.cargar_datos_existentes()
        else:
            self.cambiar_rol("CAJERO") 

    def cargar_datos_existentes(self):
        # usuario_editar viene como tupla: (id, username, rol, permisos_json)
        self.txt_user.setText(self.usuario_editar[1])
        self.txt_user.setReadOnly(True) # No permitir cambiar nombre de usuario (es llave √∫nica)
        self.txt_user.setStyleSheet("opacity: 0.5; color: gray;")
        
        rol_actual = self.usuario_editar[2]
        self.combo_rol.setCurrentText(rol_actual)
        
        # Cargar Permisos
        import json
        try:
            perms = json.loads(self.usuario_editar[3])
        except:
            perms = []
            
        if rol_actual == "CAJERO":
            self.chk_inventario.setChecked("GESTIONAR_INVENTARIO" in perms)
            self.chk_devoluciones.setChecked("HACER_DEVOLUCIONES" in perms)
            self.chk_historial.setChecked("VER_HISTORIAL" in perms)
            self.chk_corte.setChecked("HACER_CORTE" in perms)
            self.group_permisos.setEnabled(True)
        else:
            self.cambiar_rol("ADMIN")

    def cambiar_rol(self, rol):
        if rol == "ADMIN":
            self.group_permisos.setEnabled(False)
            self.group_permisos.setTitle("Permisos (ADMIN tiene acceso total)")
            self.chk_inventario.setChecked(True)
            self.chk_devoluciones.setChecked(True)
            self.chk_historial.setChecked(True)
            self.chk_corte.setChecked(True)
        else:
            self.group_permisos.setEnabled(True)
            self.group_permisos.setTitle("Configurar Permisos")
            # Si estamos creando uno nuevo, desmarcar peligrosos por defecto
            if not self.usuario_editar:
                self.chk_inventario.setChecked(False) 
                self.chk_devoluciones.setChecked(False)
                self.chk_historial.setChecked(False)
                self.chk_corte.setChecked(True) 

    def validar_y_guardar(self):
        u = self.txt_user.text().strip()
        p = self.txt_pass.text().strip()
        r = self.combo_rol.currentText()
        
        # Validaci√≥n: Si es nuevo, requerimos pass. Si editamos, pass puede estar vac√≠o.
        if not self.usuario_editar and (not u or not p): 
            return
        
        # Construir permisos
        permisos = []
        if r == "ADMIN":
            permisos = ["TODO"]
        else:
            if self.chk_inventario.isChecked(): permisos.append("GESTIONAR_INVENTARIO")
            if self.chk_devoluciones.isChecked(): permisos.append("HACER_DEVOLUCIONES")
            if self.chk_historial.isChecked(): permisos.append("VER_HISTORIAL")
            if self.chk_corte.isChecked(): permisos.append("HACER_CORTE")
        
        import json
        permisos_json = json.dumps(permisos)
        
        self.resultado = (u, p, r, permisos_json)
        self.accept()

# ==========================================
# CLASE GESTI√ìN DE USUARIOS (CON TEMA)
# ==========================================
class WidgetUsuarios(QWidget):
    def __init__(self, main, tema_inicial="Dark"):
        super().__init__()
        self.main = main
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        
        # --- Encabezado ---
        header = QHBoxLayout()
        self.lbl_tit = QLabel("üë• Administraci√≥n de Usuarios")
        self.lbl_tit.setStyleSheet("font-size: 24px; font-weight: bold;")
        
        self.btn_nuevo = QPushButton("+ Nuevo Usuario")
        self.btn_nuevo.setFixedSize(150, 40)
        self.btn_nuevo.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_nuevo.clicked.connect(self.nuevo_usuario)
        
        header.addWidget(self.lbl_tit)
        header.addStretch()
        header.addWidget(self.btn_nuevo)
        layout.addLayout(header)
        
        # --- Tabla ---
        self.tabla = QTableWidget()
        self.tabla.setColumnCount(4)
        self.tabla.setHorizontalHeaderLabels(["ID", "Usuario", "Rol", "Permisos"])
        self.tabla.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.Stretch)
        self.tabla.setSelectionBehavior(QAbstractItemView.SelectionBehavior.SelectRows)
        self.tabla.setEditTriggers(QAbstractItemView.EditTrigger.NoEditTriggers)
        layout.addWidget(self.tabla)
        
        # --- Botones Acci√≥n ---
        hbox = QHBoxLayout()
        hbox.addStretch()
        
        self.btn_eliminar = QPushButton("üóëÔ∏è Eliminar Usuario")
        self.btn_eliminar.setFixedSize(160, 45)
        self.btn_eliminar.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_eliminar.clicked.connect(self.eliminar_usuario)
        
        hbox.addWidget(self.btn_eliminar)
        layout.addLayout(hbox)

        # Cargar datos y aplicar tema inicial
        self.cargar_datos()
        self.aplicar_tema(tema_inicial) # <--- ESTO FALTABA

    def aplicar_tema(self, tema):
        """Cambia los colores de la pantalla de usuarios"""
        if tema == "Dark":
            c = {
                "bg": "#2b2b2b", "text": "#ffffff", 
                "table_bg": "#333333", "grid": "#555555",
                "head_bg": "#444444", "head_text": "#ffffff",
                "btn_main": "#007aff", "btn_danger": "#dc3545"
            }
        else:
            c = {
                "bg": "#f3f3f3", "text": "#000000", 
                "table_bg": "#ffffff", "grid": "#cccccc",
                "head_bg": "#e0e0e0", "head_text": "#000000",
                "btn_main": "#007aff", "btn_danger": "#dc3545"
            }

        # Aplicar estilos
        self.setStyleSheet(f"background-color: {c['bg']}; color: {c['text']};")
        self.lbl_tit.setStyleSheet(f"font-size: 24px; font-weight: bold; color: {c['text']};")
        
        self.btn_nuevo.setStyleSheet(f"background-color: {c['btn_main']}; color: white; font-weight: bold; border-radius: 5px; border: none;")
        self.btn_eliminar.setStyleSheet(f"background-color: {c['btn_danger']}; color: white; font-weight: bold; border-radius: 5px; border: none;")

        # Estilo Tabla
        self.tabla.setStyleSheet(f"""
            QTableWidget {{
                background-color: {c['table_bg']};
                color: {c['text']};
                gridline-color: {c['grid']};
                border: 1px solid {c['grid']};
            }}
            QHeaderView::section {{
                background-color: {c['head_bg']};
                color: {c['head_text']};
                padding: 5px;
                border: 1px solid {c['grid']};
            }}
            QTableCornerButton::section {{ background-color: {c['head_bg']}; }}
        """)
    
    def cargar_datos(self):
        self.tabla.setRowCount(0)
        users = db.obtener_todos_usuarios()
        for u in users:
            row = self.tabla.rowCount()
            self.tabla.insertRow(row)
            self.tabla.setItem(row, 0, QTableWidgetItem(str(u[0])))
            self.tabla.setItem(row, 1, QTableWidgetItem(u[1]))
            self.tabla.setItem(row, 2, QTableWidgetItem(u[2]))
            self.tabla.setItem(row, 3, QTableWidgetItem(u[3])) # Permisos (JSON)

    def nuevo_usuario(self):
        # Aqu√≠ puedes implementar un di√°logo similar al de Clientes
        QMessageBox.information(self, "Info", "Funci√≥n para crear usuario pendiente de implementar di√°logo.")

    def eliminar_usuario(self):
        row = self.tabla.currentRow()
        if row < 0: return QMessageBox.warning(self, "Error", "Selecciona un usuario")
        
        uid = int(self.tabla.item(row, 0).text())
        uname = self.tabla.item(row, 1).text()
        
        if uname == "admin":
            return QMessageBox.warning(self, "Error", "No puedes eliminar al administrador principal.")
            
        if QMessageBox.question(self, "Confirmar", f"¬øEliminar a {uname}?") == QMessageBox.StandardButton.Yes:
            if db.eliminar_usuario_db(uid):
                self.cargar_datos()
            else:
                QMessageBox.warning(self, "Error", "No se pudo eliminar.")

class DialogoApertura(QDialog):
    def __init__(self, modo_oscuro=True):
        super().__init__()
        self.setWindowTitle("Apertura de Caja")
        self.setFixedSize(400, 350)
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint) # Sin bordes, estilo moderno
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground) # Fondo transparente para bordes redondeados
        
        self.modo_oscuro = modo_oscuro
        self.monto_inicial = 0.0

        # Layout Principal
        layout = QVBoxLayout(self)
        layout.setContentsMargins(10, 10, 10, 10)

        # Contenedor visual (Frame)
        self.container = QLabel(self)
        self.container.setObjectName("container")
        layout_container = QVBoxLayout(self.container)
        layout_container.setSpacing(20)
        layout_container.setContentsMargins(30, 40, 30, 40)

        # 1. Icono y T√≠tulo
        lbl_titulo = QLabel("üí∞ INICIAR TURNO")
        lbl_titulo.setAlignment(Qt.AlignmentFlag.AlignCenter)
        lbl_titulo.setFont(QFont("Segoe UI", 16, QFont.Weight.Bold))
        # Color azul corporativo de tu logo
        lbl_titulo.setStyleSheet("color: #007aff;") 

        lbl_subtitulo = QLabel("Ingresa el monto de efectivo inicial en caja:")
        lbl_subtitulo.setAlignment(Qt.AlignmentFlag.AlignCenter)
        lbl_subtitulo.setWordWrap(True)
        self.lbl_subtitulo = lbl_subtitulo # Guardamos referencia para el tema

        # 2. Input de Dinero
        self.spin_monto = QDoubleSpinBox()
        self.spin_monto.setPrefix("$ ")
        self.spin_monto.setRange(0, 100000)
        self.spin_monto.setDecimals(2)
        self.spin_monto.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.spin_monto.setButtonSymbols(QDoubleSpinBox.ButtonSymbols.NoButtons) # Sin flechitas
        self.spin_monto.setFixedHeight(60)
        self.spin_monto.setFont(QFont("Segoe UI", 20))

        # 3. Bot√≥n de Acci√≥n
        btn_abrir = QPushButton("Abrir Caja")
        btn_abrir.setFixedHeight(50)
        btn_abrir.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_abrir.clicked.connect(self.confirmar)
        
        # Estilo fijo del bot√≥n (siempre verde)
        btn_abrir.setStyleSheet("""
            QPushButton {
                background-color: #28a745;
                color: white;
                font-size: 16px;
                font-weight: bold;
                border-radius: 8px;
            }
            QPushButton:hover { background-color: #218838; }
        """)

        # Agregar widgets al container
        layout_container.addWidget(lbl_titulo)
        layout_container.addWidget(lbl_subtitulo)
        layout_container.addWidget(self.spin_monto)
        layout_container.addWidget(btn_abrir)
        
        layout.addWidget(self.container)

        # Sombra para efecto flotante
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(20)
        shadow.setXOffset(0)
        shadow.setYOffset(0)
        shadow.setColor(QColor(0, 0, 0, 100))
        self.container.setGraphicsEffect(shadow)

        # Aplicar tema inicial
        self.aplicar_tema()

    def aplicar_tema(self):
        if self.modo_oscuro:
            bg_color = "#1e1e1e"
            text_color = "#dddddd"
            input_bg = "#2d2d2d"
            input_text = "white"
        else:
            bg_color = "#ffffff"
            text_color = "#333333"
            input_bg = "#f0f0f0"
            input_text = "#333333"

        # Aplicamos CSS al contenedor
        self.container.setStyleSheet(f"""
            QLabel#container {{
                background-color: {bg_color};
                border-radius: 15px;
                border: 1px solid {input_bg};
            }}
        """)
        
        self.lbl_subtitulo.setStyleSheet(f"color: {text_color}; font-size: 14px;")
        
        self.spin_monto.setStyleSheet(f"""
            QDoubleSpinBox {{
                background-color: {input_bg};
                color: {input_text};
                border-radius: 8px;
                padding: 5px;
            }}
        """)

    def confirmar(self):
        self.monto_inicial = self.spin_monto.value()
        self.accept() # Cierra el di√°logo y retorna True en exec()
        
class CorteCajaWidget(QWidget):
    def __init__(self, main, tema="Dark"):
        super().__init__()
        self.main = main
        self.tema = tema
        self.datos_corte = None 
        
        # Layout Principal
        self.layout = QVBoxLayout(self)
        self.layout.setContentsMargins(20, 20, 20, 20)
        self.layout.setSpacing(10)

        # T√≠tulo
        self.lbl_titulo = QLabel("Corte de Caja y Arqueo")
        self.layout.addWidget(self.lbl_titulo)

        # --- SECCI√ìN 1: DETALLE DE EFECTIVO ---
        self.frame_efectivo = QFrame()
        l_efectivo = QHBoxLayout(self.frame_efectivo)
        l_efectivo.setContentsMargins(0,0,0,0)
        l_efectivo.setSpacing(10)
        
        self.card_apertura = self.crear_card("Monto Apertura", "$0.00", "#007aff")
        self.card_ventas_efectivo = self.crear_card("(+) Ventas Efectivo", "$0.00", "#28a745")
        self.card_gastos = self.crear_card("(-) Gastos/Retiros", "$0.00", "#d32f2f") # Tarjeta Roja
        self.card_devoluciones = self.crear_card("(-) Devoluciones", "$0.00", "#c62828")
        self.card_esperado = self.crear_card("= TOTAL EN CAJA", "$0.00", "#ff9800", grande=True)
        
        l_efectivo.addWidget(self.card_apertura)
        l_efectivo.addWidget(self.card_ventas_efectivo)
        l_efectivo.addWidget(self.card_gastos)
        l_efectivo.addWidget(self.card_devoluciones)
        l_efectivo.addWidget(self.card_esperado)
        self.layout.addWidget(self.frame_efectivo)

        # --- SECCI√ìN 2: BANCOS ---
        self.frame_bancos = QFrame()
        l_bancos = QHBoxLayout(self.frame_bancos)
        l_bancos.setContentsMargins(0,0,0,0)
        l_bancos.setSpacing(10)

        self.card_tarjeta = self.crear_card("Ventas Tarjeta", "$0.00", "#6f42c1")
        self.card_num_tarjeta = self.crear_card("N¬∞ Cobros Tarjeta", "0", "#5a32a3")
        self.card_transferencia = self.crear_card("Transferencias", "$0.00", "#17a2b8")
        
        l_bancos.addWidget(self.card_tarjeta)
        l_bancos.addWidget(self.card_num_tarjeta)
        l_bancos.addWidget(self.card_transferencia)
        self.layout.addWidget(self.frame_bancos)

        # --- SECCI√ìN 3: ARQUEO ---
        group_arqueo = QGroupBox("üíµ Arqueo de Efectivo")
        # (Estilos se aplican en aplicar_tema)
        
        layout_arqueo = QGridLayout(group_arqueo)
        layout_arqueo.setContentsMargins(15, 15, 15, 15)
        layout_arqueo.setSpacing(10)

        self.inputs_billetes = {}
        denominaciones = [1000, 500, 200, 100, 50, 20]
        
        row, col = 0, 0
        for denom in denominaciones:
            lbl = QLabel(f"Billetes ${denom}:")
            spin = QSpinBox()
            spin.setRange(0, 5000)
            spin.setStyleSheet("font-size: 14px; padding: 4px;")
            spin.valueChanged.connect(self.calcular_total_contado)
            self.inputs_billetes[denom] = spin
            layout_arqueo.addWidget(lbl, row, col)
            layout_arqueo.addWidget(spin, row, col+1)
            col += 2
            if col >= 4: col = 0; row += 1

        lbl_mon = QLabel("Monedas (Total):")
        self.spin_monedas = QDoubleSpinBox()
        self.spin_monedas.setRange(0, 10000)
        self.spin_monedas.setPrefix("$ ")
        self.spin_monedas.valueChanged.connect(self.calcular_total_contado)
        
        layout_arqueo.addWidget(lbl_mon, row + 1, 0)
        layout_arqueo.addWidget(self.spin_monedas, row + 1, 1)

        self.lbl_total_contado = QLabel("Total Contado: $0.00")
        self.lbl_total_contado.setAlignment(Qt.AlignmentFlag.AlignRight)
        
        self.lbl_diferencia = QLabel("Diferencia: $0.00")
        self.lbl_diferencia.setAlignment(Qt.AlignmentFlag.AlignRight)

        layout_arqueo.addWidget(self.lbl_total_contado, row, 2, 1, 2)
        layout_arqueo.addWidget(self.lbl_diferencia, row + 1, 2, 1, 2)
        self.layout.addWidget(group_arqueo)

        # --- SECCI√ìN 4: BOTONES DE ACCI√ìN (NUEVO LAYOUT HORIZONTAL) ---
        h_botones = QHBoxLayout()
        h_botones.setSpacing(15)

        # BOT√ìN 1: REGISTRAR GASTO (NUEVO)
        self.btn_gasto = QPushButton("üìâ REGISTRAR GASTO")
        self.btn_gasto.setFixedHeight(50)
        self.btn_gasto.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_gasto.clicked.connect(self.abrir_gastos) # Conecta a la funci√≥n
        
        # BOT√ìN 2: REALIZAR CORTE
        self.btn_realizar_corte = QPushButton("‚úÇÔ∏è REALIZAR CORTE")
        self.btn_realizar_corte.setFixedHeight(50)
        self.btn_realizar_corte.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_realizar_corte.clicked.connect(self.accion_realizar_corte)
        
        h_botones.addWidget(self.btn_gasto)         # Agregamos bot√≥n gasto
        h_botones.addWidget(self.btn_realizar_corte) # Agregamos bot√≥n corte
        
        self.layout.addLayout(h_botones)

        self.aplicar_tema(self.tema)

    # --- M√âTODO NUEVO PARA ABRIR GASTOS ---
    def abrir_gastos(self):
        if not DialogoGastos:
            return QMessageBox.critical(self, "Error", "Falta dialogo_gastos.py")
            
        # Abrimos el di√°logo pas√°ndole el tema actual
        dlg = DialogoGastos(self.main, tema=self.tema)
        if dlg.exec():
            # Si guard√≥ un gasto, RECARGAMOS LOS DATOS para que se reste
            self.cargar_datos()
            QMessageBox.information(self, "Actualizado", "El corte se ha actualizado con el nuevo gasto.")

    def crear_card(self, titulo, valor, color, grande=False):
        card = QFrame()
        card.setStyleSheet(f"background-color: {color}; border-radius: 8px; color: white;")
        l = QVBoxLayout(card)
        lbl_t = QLabel(titulo); lbl_t.setAlignment(Qt.AlignmentFlag.AlignCenter)
        lbl_t.setStyleSheet("font-size: 11px;") 
        lbl_v = QLabel(valor); lbl_v.setAlignment(Qt.AlignmentFlag.AlignCenter)
        size = "22px" if grande else "18px"
        lbl_v.setStyleSheet(f"font-size: {size}; font-weight: bold;")
        card.lbl_valor = lbl_v 
        l.addWidget(lbl_t); l.addWidget(lbl_v)
        return card

    def cargar_datos(self):
        if not self.main.usuario_actual: return
        self.datos_corte = db.obtener_datos_corte(self.main.usuario_actual.id)
        
        if self.datos_corte:
            # Calcular Gastos
            ahora = datetime.now()
            inicio_dia = ahora.replace(hour=0, minute=0, second=0, microsecond=0)
            str_inicio = inicio_dia.strftime("%Y-%m-%d %H:%M:%S")
            str_fin = ahora.strftime("%Y-%m-%d %H:%M:%S")

            if hasattr(db, 'obtener_total_gastos_corte'):
                total_gastos = db.obtener_total_gastos_corte(str_inicio, str_fin)
            else:
                total_gastos = 0.0

            # Recalcular Total Esperado
            nuevo_total_esperado = self.datos_corte['total_esperado'] - total_gastos
            self.datos_corte['total_esperado'] = nuevo_total_esperado
            self.datos_corte['total_gastos'] = total_gastos

            # Actualizar Labels
            self.card_apertura.lbl_valor.setText(f"${self.datos_corte['monto_inicial']:.2f}")
            self.card_ventas_efectivo.lbl_valor.setText(f"${self.datos_corte['ventas_efectivo']:.2f}")
            self.card_gastos.lbl_valor.setText(f"${total_gastos:.2f}") # Actualizar tarjeta gastos
            self.card_devoluciones.lbl_valor.setText(f"${self.datos_corte['devoluciones']:.2f}")
            self.card_esperado.lbl_valor.setText(f"${nuevo_total_esperado:.2f}")
            
            self.card_tarjeta.lbl_valor.setText(f"${self.datos_corte['ventas_tarjeta']:.2f}")
            self.card_num_tarjeta.lbl_valor.setText(f"{self.datos_corte['num_cobros_tarjeta']}")
            self.card_transferencia.lbl_valor.setText(f"${self.datos_corte['ventas_transferencia']:.2f}")

            self.btn_realizar_corte.setEnabled(True)
            self.calcular_total_contado() 
        else:
            self.btn_realizar_corte.setEnabled(False)

    def calcular_total_contado(self):
        if not self.datos_corte: return
        total = 0.0
        for denom, spin in self.inputs_billetes.items():
            total += (denom * spin.value())
        total += self.spin_monedas.value()
        
        self.lbl_total_contado.setText(f"Total Contado: ${total:.2f}")
        esperado = self.datos_corte['total_esperado']
        dif = total - esperado
        
        if dif == 0: txt = "‚úÖ EXACTO"; col = "#28a745"
        elif dif > 0: txt = f"‚ö†Ô∏è SOBRANTE: +${dif:.2f}"; col = "#ffeb3b"
        else: txt = f"‚ùå FALTANTE: -${abs(dif):.2f}"; col = "#f44336"
            
        self.lbl_diferencia.setText(txt)
        self.lbl_diferencia.setStyleSheet(f"font-size: 16px; font-weight: bold; color: {col};")
        return total, dif

    def accion_realizar_corte(self):
        total_fisico, diferencia = self.calcular_total_contado()
        msg = f"¬øCerrar turno?\nSistema: ${self.datos_corte['total_esperado']:.2f}\nF√≠sico: ${total_fisico:.2f}"
        if QMessageBox.question(self, "Confirmar", msg, QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No) == QMessageBox.StandardButton.Yes:
            
            db.finalizar_corte_db(self.datos_corte['sesion_id'], total_fisico, diferencia)
            
            # Datos para el ticket
            desglose = {d: s.value() for d, s in self.inputs_billetes.items()}
            desglose["monedas"] = self.spin_monedas.value()
            try:
                import utils
                import os, sys
                ruta = utils.generar_ticket_corte(self.datos_corte, desglose, self.main.usuario_actual.username)
                if os.path.exists(ruta): os.startfile(ruta)
                QMessageBox.information(self, "√âxito", "Corte realizado.")
                sys.exit()
            except Exception as e:
                QMessageBox.critical(self, "Error", f"Error ticket: {e}")

    def aplicar_tema(self, modo):
        self.tema = modo
        if modo == "Dark":
            bg = "#212121"; text = "white"; input_bg = "#333"; input_border = "#555"; group_border = "#555"
        else:
            bg = "#f5f5f7"; text = "black"; input_bg = "white"; input_border = "#ccc"; group_border = "#ccc"
        
        self.setStyleSheet(f"""
            QWidget {{ background-color: {bg}; color: {text}; }}
            QLabel {{ border: none; }}
            QGroupBox {{ font-weight: bold; border: 1px solid {group_border}; border-radius: 5px; margin-top: 10px; background-color: transparent; }}
            QGroupBox::title {{ subcontrol-origin: margin; left: 10px; padding: 0 5px; background-color: {bg}; }}
            QSpinBox, QDoubleSpinBox {{ background-color: {input_bg}; color: {text}; border: 1px solid {input_border}; border-radius: 4px; padding: 5px; font-size: 14px; }}
            
            /* ESTILO BOTONES DE ACCI√ìN */
            QPushButton {{ border-radius: 10px; font-size: 16px; font-weight: bold; border: none; }}
            QPushButton:disabled {{ background-color: #555; color: #aaa; }}
        """)
        
        # Bot√≥n Gasto (Naranja/Rojo)
        self.btn_gasto.setStyleSheet("background-color: #ff9800; color: white;") 
        # Bot√≥n Corte (Verde/Rojo seg√∫n l√≥gica, aqu√≠ verde default)
        self.btn_realizar_corte.setStyleSheet("background-color: #d32f2f; color: white;")

        self.lbl_titulo.setStyleSheet(f"font-size: 24px; font-weight: bold; color: {text}; border: none;")
        
class ConfiguracionWidget(QWidget):
    def __init__(self, main):
        super().__init__()
        self.main = main
        
        # Layout Principal
        self.layout = QVBoxLayout(self)
        self.layout.setContentsMargins(30,30,30,30)
        self.layout.setSpacing(20)
        
        self.lbl_titulo = QLabel("‚öôÔ∏è Configuraci√≥n del Sistema")
        self.lbl_titulo.setObjectName("Title")
        self.layout.addWidget(self.lbl_titulo)

        # --- SECCI√ìN 1: APARIENCIA ---
        self.group_app = QGroupBox("üé® Apariencia y Marca")
        l_app = QGridLayout(self.group_app)
        
        self.ruta_logo = self.main.config.get("logo_path", "")
        self.lbl_logo_status = QLabel("Sin logo seleccionado" if not self.ruta_logo else "Logo cargado")
        
        self.btn_logo = QPushButton("Cargar Logo del Negocio")
        self.btn_logo.setObjectName("BtnAzul")
        self.btn_logo.clicked.connect(self.seleccionar_logo)
        
        l_app.addWidget(QLabel("Logo (Ticket):"), 0, 0)
        l_app.addWidget(self.btn_logo, 0, 1)
        l_app.addWidget(self.lbl_logo_status, 0, 2)
        
        self.layout.addWidget(self.group_app)

        # --- SECCI√ìN 2: DATOS DEL TICKET ---
        self.group_ticket = QGroupBox("üßæ Personalizaci√≥n del Ticket")
        l_tick = QVBoxLayout(self.group_ticket)
        
        l_tick.addWidget(QLabel("Nombre del Negocio (Encabezado):"))
        self.txt_nombre = QLineEdit(self.main.config.get("nombre_negocio", ""))
        l_tick.addWidget(self.txt_nombre)
        
        l_tick.addWidget(QLabel("Direcci√≥n / Tel√©fono (Subt√≠tulo):"))
        self.txt_direccion = QLineEdit(self.main.config.get("ticket_direccion", ""))
        l_tick.addWidget(self.txt_direccion)
        
        l_tick.addWidget(QLabel("Mensaje de Despedida (Pie de P√°gina):"))
        self.txt_mensaje = QLineEdit(self.main.config.get("ticket_mensaje", "¬°Gracias por su compra!"))
        l_tick.addWidget(self.txt_mensaje)
        
        self.layout.addWidget(self.group_ticket)
        
        # --- SECCI√ìN 3: MERCADO PAGO (NUEVO) ---
        self.layout.addWidget(QLabel("üí≥ Terminal Mercado Pago", objectName="Subtitle"))
        card_mp = QFrame(); card_mp.setObjectName("Card")
        l_mp = QFormLayout(card_mp)
        l_mp.setVerticalSpacing(15)
        
        # Campo Token (Con m√°scara de contrase√±a para seguridad)
        self.txt_mp_token = QLineEdit(self.main.config.get("mp_token", ""))
        self.txt_mp_token.setEchoMode(QLineEdit.EchoMode.Password) 
        self.txt_mp_token.setPlaceholderText("Pegar Access Token de Mercado Pago")
        
        # Campo Device ID
        self.txt_mp_device = QLineEdit(self.main.config.get("mp_device_id", ""))
        self.txt_mp_device.setPlaceholderText("Ej. PAX0000...")
        
        l_mp.addRow("Access Token (Integraci√≥n):", self.txt_mp_token)
        l_mp.addRow("ID Dispositivo (Serial):", self.txt_mp_device)
        self.layout.addWidget(card_mp)

        # --- BOT√ìN GUARDAR ---
        self.btn_save = QPushButton("üíæ GUARDAR CAMBIOS")
        self.btn_save.setObjectName("SuccessBtn")
        self.btn_save.setMinimumHeight(45)
        self.btn_save.clicked.connect(self.guardar_configuracion)
        self.layout.addWidget(self.btn_save)
        
        self.layout.addStretch()
        
        # --- ZONA DE PELIGRO ---
        linea = QFrame(); linea.setFrameShape(QFrame.Shape.HLine); linea.setFrameShadow(QFrame.Shadow.Sunken)
        self.layout.addWidget(linea)
        
        self.lbl_danger = QLabel("‚ö†Ô∏è ZONA DE PELIGRO")
        self.lbl_danger.setStyleSheet("color: #dc3545; font-weight: bold; margin-top: 10px;")
        self.layout.addWidget(self.lbl_danger)
        
        self.btn_reset = QPushButton("‚ôªÔ∏è RESTAURAR VALORES DE F√ÅBRICA")
        self.btn_reset.setStyleSheet("""
            QPushButton { background-color: #dc3545; color: white; font-weight: bold; border-radius: 5px; padding: 10px; }
            QPushButton:hover { background-color: #c82333; }
        """)
        self.btn_reset.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_reset.clicked.connect(self.restaurar_fabrica)
        self.layout.addWidget(self.btn_reset)
        
        # Aplicar tema inicial
        self.aplicar_tema(self.main.config.get("tema", "Light"))

    # --- ESTA ES LA FUNCI√ìN QUE FALTABA Y CAUSABA EL ERROR ---
    def aplicar_tema(self, modo):
        if modo == "Dark":
            bg_main = "#1e1e1e"; fg_main = "white"; bg_card = "#2d2d2d"; border = "#444"
            fg_sec = "#aaaaaa"
        else:
            bg_main = "#f5f5f7"; fg_main = "#1d1d1f"; bg_card = "white"; border = "#d2d2d7"
            fg_sec = "#666"

        self.setStyleSheet(f"background-color: {bg_main}; color: {fg_main};")
        
        # Estilo para los grupos
        style_group = f"""
            QGroupBox {{ 
                font-weight: bold; border: 1px solid {border}; border-radius: 8px; margin-top: 10px; padding-top: 15px; background-color: {bg_card}; color: {fg_main};
            }}
            QGroupBox::title {{ subcontrol-origin: margin; subcontrol-position: top left; padding: 0 5px; left: 10px; }}
            QLabel {{ background: transparent; color: {fg_main}; }}
            QLineEdit {{ background-color: {bg_main if modo=='Dark' else '#f0f0f0'}; color: {fg_main}; border: 1px solid {border}; padding: 5px; border-radius: 4px; }}
        """
        self.group_app.setStyleSheet(style_group)
        self.group_ticket.setStyleSheet(style_group)
        self.lbl_titulo.setStyleSheet(f"font-size: 24px; font-weight: bold; color: {fg_main};")

    def seleccionar_logo(self):
        ruta, _ = QFileDialog.getOpenFileName(self, "Seleccionar Logo", "", "Im√°genes (*.png *.jpg *.jpeg)")
        if ruta:
            self.ruta_logo = ruta
            self.lbl_logo_status.setText(f"...{ruta[-20:]}")

    def guardar_configuracion(self):
        self.main.config["nombre_negocio"] = self.txt_nombre.text()
        self.main.config["ticket_nombre"] = self.txt_nombre.text()
        self.main.config["ticket_direccion"] = self.txt_direccion.text()
        self.main.config["ticket_mensaje"] = self.txt_mensaje.text()
        self.main.config["logo_path"] = self.ruta_logo
        
        import os, json
        try:
            carpeta_actual = os.path.dirname(os.path.abspath(__file__))
            ruta_absoluta = os.path.join(carpeta_actual, "config.json")
            with open(ruta_absoluta, "w") as f: json.dump(self.main.config, f)
            QMessageBox.information(self, "Guardado", "Configuraci√≥n actualizada.")
            self.main.actualizar_apariencia()
        except Exception as e: QMessageBox.critical(self, "Error", f"No se pudo guardar: {e}")
    
    def guardar_datos_mercadopago(self):
        # 1. Obtener lo que escribi√≥ el usuario en las cajas de texto
        # (Aseg√∫rate de que tus inputs se llamen as√≠ o c√°mbiales el nombre aqu√≠)
        nuevo_token = self.input_token_mp.text().strip() 
        nuevo_device = self.input_device_mp.text().strip()

        if not nuevo_token or not nuevo_device:
            QMessageBox.warning(self, "Atenci√≥n", "Por favor llene ambos campos de Mercado Pago")
            return

        try:
            # 2. Leer el archivo config.json actual (para no borrar lo dem√°s)
            with open('config.json', 'r') as f:
                data = json.load(f)

            # 3. Actualizar SOLO la secci√≥n de Mercado Pago
            # Si no existe la secci√≥n, la crea
            if "mercado_pago" not in data:
                data["mercado_pago"] = {}
                
            data["mercado_pago"]["access_token"] = nuevo_token
            data["mercado_pago"]["device_id"] = nuevo_device

            # 4. Guardar los cambios en el archivo
            with open('config.json', 'w') as f:
                json.dump(data, f, indent=4)

            QMessageBox.showinfo(self, "√âxito", "Datos de Mercado Pago actualizados correctamente")
            
        except Exception as e:
            QMessageBox.critical(self, "Error", f"No se pudo guardar la configuraci√≥n: {e}")

    def restaurar_fabrica(self):
        confirm = QMessageBox.warning(self, "‚ö†Ô∏è PELIGRO CR√çTICO", 
            "ESTA ACCI√ìN ES IRREVERSIBLE.\n\n"
            "1. Se borrar√°n todos los productos, ventas y usuarios.\n"
            "2. Se reiniciar√° la configuraci√≥n (modo claro/oscuro).\n"
            "3. El programa se cerrar√° autom√°ticamente.\n\n"
            "¬øRealmente deseas continuar?", 
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
            
        if confirm == QMessageBox.StandardButton.Yes:
            import os, sys
            import database as db # Importamos para poder desconectar
            
            try:
                # 1. INTENTAR LIBERAR LA BASE DE DATOS (IMPORTANTE)
                # Esto cierra la conexi√≥n para que Windows permita borrar el archivo
                try:
                    if hasattr(db, 'engine'):
                        db.engine.dispose()
                    if hasattr(db, 'Session'):
                        db.Session.remove()
                except Exception as e:
                    print(f"Advertencia al desconectar DB: {e}")

                # 2. BORRAR ARCHIVOS
                carpeta = os.path.dirname(os.path.abspath(__file__))
                archivos_a_borrar = ["config.json", "nexus.db", "pos.db"]
                
                borrados = []
                errores = []

                for archivo in archivos_a_borrar:
                    ruta = os.path.join(carpeta, archivo)
                    if os.path.exists(ruta):
                        try:
                            os.remove(ruta)
                            borrados.append(archivo)
                        except PermissionError:
                            errores.append(f"{archivo} (Est√° en uso/bloqueado)")
                        except Exception as e:
                            errores.append(f"{archivo} ({str(e)})")

                # 3. RESULTADO
                if errores:
                    # Si algo fall√≥ (com√∫nmente la DB en Windows), avisamos
                    mensaje = f"Se borraron: {', '.join(borrados)}\n\nNO SE PUDO BORRAR:\n{chr(10).join(errores)}\n\nSOLUCI√ìN: Cierra el programa y borra 'nexus.db' manualmente en la carpeta."
                    QMessageBox.warning(self, "Restauraci√≥n Parcial", mensaje)
                else:
                    QMessageBox.information(self, "√âxito", "Sistema restaurado correctamente.\nEl programa se cerrar√°.")
                
                # Cerrar forzosamente
                sys.exit()
                
            except Exception as e:
                QMessageBox.critical(self, "Error", f"Error general: {e}")

class ClientesWidget(QWidget):
    def __init__(self, main, tema="Dark"):
        super().__init__()
        self.main = main
        self.tema = tema
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        
        # Encabezado
        h_header = QHBoxLayout()
        self.lbl_titulo = QLabel("üë• Gesti√≥n de Clientes y Cr√©ditos")
        self.lbl_titulo.setStyleSheet("font-size: 24px; font-weight: bold;")
        
        self.btn_nuevo = QPushButton("+ Nuevo Cliente")
        self.btn_nuevo.setFixedSize(150, 40)
        self.btn_nuevo.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_nuevo.clicked.connect(self.abrir_nuevo_cliente)
        
        h_header.addWidget(self.lbl_titulo)
        h_header.addStretch()
        h_header.addWidget(self.btn_nuevo)
        layout.addLayout(h_header)
        
        # Tabla
        self.tabla = QTableWidget()
        self.tabla.setColumnCount(5)
        self.tabla.setHorizontalHeaderLabels(["ID", "Nombre", "Tel√©fono", "L√≠mite Cr√©dito", "Deuda Actual"])
        self.tabla.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.Stretch)
        self.tabla.setSelectionBehavior(QAbstractItemView.SelectionBehavior.SelectRows)
        self.tabla.setEditTriggers(QAbstractItemView.EditTrigger.NoEditTriggers)
        layout.addWidget(self.tabla)
        
        # Botones de Acci√≥n (Abonar)
        h_actions = QHBoxLayout()
        self.btn_abonar = QPushButton("üí∞ Abonar a Deuda")
        self.btn_abonar.setFixedSize(180, 45)
        self.btn_abonar.clicked.connect(self.abonar_deuda)
        
        h_actions.addStretch()
        h_actions.addWidget(self.btn_abonar)
        layout.addLayout(h_actions)
        
        self.aplicar_tema(tema)
        self.cargar_tabla()

    def cargar_tabla(self):
        self.tabla.setRowCount(0)
        clientes = db.obtener_clientes()
        
        for c in clientes:
            row = self.tabla.rowCount()
            self.tabla.insertRow(row)
            
            self.tabla.setItem(row, 0, QTableWidgetItem(str(c['id'])))
            self.tabla.setItem(row, 1, QTableWidgetItem(c['nombre']))
            self.tabla.setItem(row, 2, QTableWidgetItem(c['telefono']))
            self.tabla.setItem(row, 3, QTableWidgetItem(f"${c['limite']:,.2f}"))
            
            item_saldo = QTableWidgetItem(f"${c['saldo']:,.2f}")
            # Si debe dinero, poner en rojo
            if c['saldo'] > 0:
                item_saldo.setForeground(Qt.GlobalColor.red)
            
            self.tabla.setItem(row, 4, item_saldo)

    def abrir_nuevo_cliente(self):
        # 1. Abrir la ventana de registro
        tema_actual = self.main.config.get("tema", "Dark")
        dlg = DialogoNuevoCliente(tema=tema_actual, parent=self)
        
        if dlg.exec(): # Si el usuario dio click en "GUARDAR"
            # 2. Recolectar datos
            nombre = dlg.txt_nombre.text().strip()
            tel = dlg.txt_telefono.text().strip()
            direc = dlg.txt_direccion.text().strip()
            limite = dlg.spin_limite.value()

            # 3. Guardar en Base de Datos
            import database as db  # Aseg√∫rate de importar tu db
            exito, resultado = db.agregar_cliente(nombre, tel, direc, limite)

            if exito:
                # 'resultado' aqu√≠ ES EL ID GENERADO (el n√∫mero de cliente)
                msg = f"""
                ‚úÖ Cliente registrado exitosamente.
                
                üÜî N√öMERO DE CLIENTE:  {resultado}
                
                L√≠mite de cr√©dito: ${limite:,.2f}
                """
                QMessageBox.information(self, "Registro Exitoso", msg)
                
                # 4. Recargar la tabla para que aparezca el nuevo
                self.cargar_tabla() 
            else:
                QMessageBox.critical(self, "Error", f"No se pudo registrar: {resultado}")

    def abonar_deuda(self):
        row = self.tabla.currentRow()
        if row < 0: return QMessageBox.warning(self, "Aviso", "Selecciona un cliente para abonar.")
        
        cid = int(self.tabla.item(row, 0).text())
        nombre = self.tabla.item(row, 1).text()
        saldo_str = self.tabla.item(row, 4).text().replace("$", "").replace(",", "")
        saldo = float(saldo_str)
        
        if saldo <= 0:
            return QMessageBox.information(self, "Sin Deuda", "Este cliente no tiene deuda pendiente.")
            
        # Di√°logo simple para monto
        from PyQt6.QtWidgets import QInputDialog
        monto, ok = QInputDialog.getDouble(self, "Abonar", 
                                         f"Cliente: {nombre}\nDeuda: ${saldo:.2f}\n\nIngrese monto a abonar:", 
                                         0, 0, 100000, 2)
        
        if ok and monto > 0:
            if monto > saldo:
                return QMessageBox.warning(self, "Error", "No puedes abonar m√°s de lo que debe.")
            
            uid = self.main.usuario_actual.id
            exito, msg = db.registrar_abono_cliente(cid, monto, uid)
            if exito:
                QMessageBox.information(self, "√âxito", "Abono registrado.")
                self.cargar_tabla()

    def aplicar_tema(self, tema):
        self.tema = tema
        if tema == "Dark":
            bg = "#212121"; fg = "white"; btn = "#007aff"
        else:
            bg = "#f5f5f7"; fg = "black"; btn = "#007aff"
            
        self.setStyleSheet(f"QWidget {{ background-color: {bg}; color: {fg}; }}")
        self.btn_nuevo.setStyleSheet(f"background-color: {btn}; color: white; border-radius: 5px; font-weight: bold;")
        self.btn_abonar.setStyleSheet("background-color: #28a745; color: white; border-radius: 5px; font-weight: bold;")

# CLASE FORMULARIO CLIENTE
class DialogoCliente(QDialog):
    def __init__(self, tema, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Nuevo Cliente")
        self.setFixedSize(400, 350)
        
        layout = QFormLayout(self)
        self.txt_nombre = QLineEdit()
        self.txt_tel = QLineEdit()
        self.txt_dir = QLineEdit()
        self.spin_limite = QDoubleSpinBox()
        self.spin_limite.setRange(0, 50000)
        self.spin_limite.setValue(1000) # Default
        
        layout.addRow("Nombre Completo:", self.txt_nombre)
        layout.addRow("Tel√©fono:", self.txt_tel)
        layout.addRow("Direcci√≥n:", self.txt_dir)
        layout.addRow("L√≠mite de Cr√©dito ($):", self.spin_limite)
        
        btn_ok = QPushButton("Guardar")
        btn_ok.clicked.connect(self.validar)
        layout.addRow(btn_ok)
        
        if tema == "Dark": 
            self.setStyleSheet("background-color: #333; color: white; QLineEdit { background-color: #444; }")
        
    def validar(self):
        self.nombre = self.txt_nombre.text().strip()
        self.telefono = self.txt_tel.text().strip()
        self.direccion = self.txt_dir.text().strip()
        self.limite = self.spin_limite.value()
        
        if not self.nombre: return QMessageBox.warning(self, "Error", "El nombre es obligatorio")
        self.accept()
                
class DialogoGastos(QDialog):
    def __init__(self, parent=None, tema="Dark"):
        super().__init__(parent)
        self.setWindowTitle("Registrar Gasto / Retiro")
        self.setFixedSize(400, 450)
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.Dialog)
        self.setAttribute(Qt.WidgetAttribute.WA_TranslucentBackground)
        
        self.tema = tema
        
        # --- LAYOUT ---
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0,0,0,0) # Margen 0 para el borde
        self.frame = QFrame()
        layout.addWidget(self.frame)
        
        l = QVBoxLayout(self.frame)
        l.setSpacing(15)
        l.setContentsMargins(30, 30, 30, 30)

        # T√≠tulo
        lbl_titulo = QLabel("üìâ Registrar Salida de Efectivo")
        lbl_titulo.setAlignment(Qt.AlignmentFlag.AlignCenter)
        # Estilo inline para asegurar visibilidad
        lbl_titulo.setStyleSheet("font-size: 18px; font-weight: bold; color: #ff3b30; border: none;") 
        l.addWidget(lbl_titulo)

        # 1. Monto
        l.addWidget(QLabel("Monto a retirar:"))
        self.spin_monto = QDoubleSpinBox()
        self.spin_monto.setPrefix("$ ")
        self.spin_monto.setRange(0.01, 100000.00)
        self.spin_monto.setDecimals(2)
        self.spin_monto.setFixedHeight(40)
        l.addWidget(self.spin_monto)

        # 2. Categor√≠a
        l.addWidget(QLabel("Motivo / Categor√≠a:"))
        self.combo_cat = QComboBox()
        self.combo_cat.addItems([
            "Pago a Proveedor", 
            "Pago de Servicios (Luz/Internet)", 
            "Comida de Empleados", 
            "Insumos / Papeler√≠a",
            "Retiro de Efectivo (Due√±o)",
            "Otro"
        ])
        self.combo_cat.setFixedHeight(35)
        l.addWidget(self.combo_cat)

        # 3. Descripci√≥n
        l.addWidget(QLabel("Descripci√≥n / Notas:"))
        self.txt_desc = QLineEdit()
        self.txt_desc.setPlaceholderText("Ej. Coca-cola para repartidor...")
        self.txt_desc.setFixedHeight(35)
        l.addWidget(self.txt_desc)

        # Botones
        l.addSpacing(20)
        h_btns = QHBoxLayout()
        
        btn_cancelar = QPushButton("Cancelar")
        btn_cancelar.setFixedSize(100, 40)
        btn_cancelar.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_cancelar.clicked.connect(self.reject)
        
        btn_guardar = QPushButton("REGISTRAR RETIRO")
        btn_guardar.setFixedHeight(40)
        btn_guardar.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_guardar.clicked.connect(self.guardar_gasto)
        
        h_btns.addWidget(btn_cancelar)
        h_btns.addWidget(btn_guardar)
        l.addLayout(h_btns)

        self.aplicar_estilo()

    def aplicar_estilo(self):
        if self.tema == "Dark":
            bg = "#2d2d30"; fg = "white"; inp = "#333"; border = "#444"
        else:
            bg = "white"; fg = "black"; inp = "#f0f0f0"; border = "#ccc"
            
        self.frame.setStyleSheet(f"""
            QFrame {{ background-color: {bg}; border: 1px solid {border}; border-radius: 15px; }}
            QLabel {{ color: {fg}; font-weight: bold; border: none; }}
            QLineEdit, QComboBox, QDoubleSpinBox {{ 
                background-color: {inp}; color: {fg}; border: 1px solid {border}; border-radius: 5px; padding: 5px; font-size: 14px;
            }}
            QPushButton {{ background-color: {inp}; color: {fg}; border: 1px solid {border}; border-radius: 5px; font-weight: bold; }}
            QPushButton:hover {{ background-color: #ddd; color: black; }}
        """)
        # Forzar estilo bot√≥n guardar (siempre rojo)
        self.findChild(QPushButton, "").nextInFocusChain().setStyleSheet("background-color: #d32f2f; color: white; border-radius: 5px; font-weight: bold;")

    def guardar_gasto(self):
        monto = self.spin_monto.value()
        desc = self.txt_desc.text().strip()
        cat = self.combo_cat.currentText()

        if monto <= 0:
            return QMessageBox.warning(self, "Error", "El monto debe ser mayor a 0.")
        if not desc:
            return QMessageBox.warning(self, "Error", "Escribe una descripci√≥n breve.")

        if QMessageBox.question(self, "Confirmar", f"¬øRetirar ${monto:.2f}?\nMotivo: {cat}", QMessageBox.StandardButton.Yes|QMessageBox.StandardButton.No) != QMessageBox.StandardButton.Yes:
            return

        # Guardar en BD
        # Intentamos obtener usuario del parent
        uid = 1
        if self.parent() and hasattr(self.parent(), 'usuario_actual'):
             uid = self.parent().usuario_actual.id

        exito, msg = db.registrar_gasto(monto, desc, cat, uid)
        
        if exito:
            QMessageBox.information(self, "Registrado", "Gasto registrado correctamente.")
            self.accept()
        else:
            QMessageBox.critical(self, "Error", f"No se pudo guardar: {msg}")

# ==========================================
# MAIN WINDOW
# ==========================================
class MainWindow(QMainWindow):
    def __init__(self, usuario, monto_inicial):
        super().__init__()
        
        # 1. RECIBIMOS Y GUARDAMOS LOS DATOS DEL LOGIN/APERTURA
        self.usuario_actual = usuario
        self.caja_inicial = monto_inicial
        
        # Bandera para controlar el ciclo en main.py
        self.cerrar_sesion_solicitado = False 

        self.setWindowTitle(f"NEXUS POS 3.0 - Usuario: {self.usuario_actual.username}")
        self.resize(1200, 800)
        
        # 2. CARGAR CONFIGURACI√ìN
        self.config = self.cargar_config()
        tema_inicial = self.config.get("tema", "Dark")

        # 3. INTERFAZ PRINCIPAL
        self.widget_sistema = QWidget()
        self.setCentralWidget(self.widget_sistema)
        
        layout_sistema = QHBoxLayout(self.widget_sistema)
        layout_sistema.setContentsMargins(0, 0, 0, 0)
        layout_sistema.setSpacing(0)

        # --- A. Sidebar (Men√∫ Lateral) ---
        sb = QFrame()
        sb.setObjectName("Sidebar")
        sb.setFixedWidth(240)
        sl = QVBoxLayout(sb)
        sl.setContentsMargins(10, 30, 10, 20)
        sl.setSpacing(5)
        
        # Logo del Sidebar
        self.lbl_sidebar_logo = QLabel()
        self.lbl_sidebar_logo.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.lbl_sidebar_logo.setStyleSheet("margin-bottom: 20px;")
        sl.addWidget(self.lbl_sidebar_logo)

        self.btns_nav = []
        
        # === AQU√ç AGREGAMOS "CLIENTES" EN LA LISTA ===
        # El orden ahora es: 
        # 0: Ventas, 1: Inventario, 2: Clientes, 3: Historial...
        menu_items = [
            ("Ventas", "üõí"), 
            ("Inventario", "üì¶"), 
            ("Clientes", "üë•"),      # <--- NUEVO BOT√ìN
            ("Historial", "üìú"), 
            ("Devoluciones", "‚Ü©Ô∏è"),
            ("Corte Caja", "üí∞"),
            ("Usuarios", "üîê"),      # Cambi√© icono para distinguir de Clientes
            ("Configuraci√≥n", "‚öôÔ∏è")
        ]
        
        for i, (t, icon) in enumerate(menu_items):
            b = QPushButton(f"  {icon}   {t}")
            b.setCheckable(True)
            b.setObjectName("NavBtn")
            b.setCursor(Qt.CursorShape.PointingHandCursor)
            b.setFixedHeight(50) 
            
            # Estilo CSS para los botones del men√∫
            b.setStyleSheet("""
                QPushButton {
                    background-color: transparent; 
                    color: #888888;
                    border: none;
                    text-align: left;
                    padding-left: 20px;
                    font-size: 16px;
                }
                QPushButton:hover {
                    color: #007aff; 
                    background-color: rgba(0, 0, 0, 0.05);
                }
                QPushButton:checked {
                    background-color: transparent; 
                    color: #007aff; 
                    font-weight: bold;
                    border-left: 4px solid #007aff;
                }
            """)
            
            b.clicked.connect(lambda _, x=i: self.nav(x))
            sl.addWidget(b)
            self.btns_nav.append(b)
            
        sl.addStretch()
        
        # Checkbox Modo Oscuro
        self.chk_tema = QCheckBox("Modo Oscuro")
        self.chk_tema.setChecked(tema_inicial == "Dark")
        self.chk_tema.toggled.connect(self.cambiar_tema)
        sl.addWidget(self.chk_tema)

        # Bot√≥n Cerrar Sesi√≥n
        btn_logout = QPushButton("Cerrar Sesi√≥n")
        btn_logout.setObjectName("DangerBtn")
        btn_logout.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_logout.clicked.connect(self.logout)
        sl.addWidget(btn_logout)
        
        layout_sistema.addWidget(sb) 

        # --- B. Contenido (P√°ginas) ---
        self.content = QStackedWidget()
        
        # Instanciar Widgets (Aseg√∫rate de que ClientesWidget exista en tu archivo)
        self.ventas_w = VentasWidget(self)
        self.inventario_w = InventarioWidget(self)
        self.clientes_w = ClientesWidget(self)       # <--- INSTANCIA NUEVA
        self.historial_w = HistorialWidget(self)
        self.devoluciones_w = DevolucionesWidget(self, tema=tema_inicial)
        self.corte_w = CorteCajaWidget(self, tema=tema_inicial)
        self.usuarios_w = WidgetUsuarios(self, tema_inicial=tema_inicial)
        self.config_w = ConfiguracionWidget(self)
        
        # Agregar al Stack EN EL MISMO ORDEN QUE EL MEN√ö
        self.content.addWidget(self.ventas_w)       # √çndice 0
        self.content.addWidget(self.inventario_w)   # √çndice 1
        self.content.addWidget(self.clientes_w)     # √çndice 2 (NUEVO)
        self.content.addWidget(self.historial_w)    # √çndice 3
        self.content.addWidget(self.devoluciones_w) # √çndice 4
        self.content.addWidget(self.corte_w)        # √çndice 5
        self.content.addWidget(self.usuarios_w)     # √çndice 6
        self.content.addWidget(self.config_w)       # √çndice 7
        
        layout_sistema.addWidget(self.content) 

        # 4. INICIALIZACI√ìN FINAL
        aplicar_estilos(QApplication.instance(), tema_inicial)
        self.actualizar_apariencia()
        
        # --- PERMISOS Y OCULTACI√ìN DE BOTONES ---
        # NOTA: Los √≠ndices cambiaron porque agregamos "Clientes" en la posici√≥n 2
        
        # Historial (Ahora es √çndice 3)
        if not self.verificar_permiso("VER_HISTORIAL"):
            self.btns_nav[3].hide() 
            
        # Devoluciones (Ahora es √çndice 4)
        if not self.verificar_permiso("HACER_DEVOLUCIONES"):
            self.btns_nav[4].hide()

        # Corte Caja (Ahora es √çndice 5)
        if not self.verificar_permiso("HACER_CORTE"):
            self.btns_nav[5].hide()

        # Usuarios (6) y Configuraci√≥n (7) - Solo Admin
        if self.usuario_actual.rol != "ADMIN":
            self.btns_nav[6].hide() 
            self.btns_nav[7].hide() 
        
        # Ir a Ventas por defecto
        self.nav(0) 
        
    def verificar_permiso(self, permiso_requerido):
        """Verifica si el usuario actual tiene el permiso solicitado"""
        if self.usuario_actual.rol == "ADMIN":
            return True
            
        import json
        try:
            permisos = json.loads(self.usuario_actual.permisos)
        except:
            permisos = [] 
            
        if "TODO" in permisos:
            return True
            
        return permiso_requerido in permisos

    # --- M√âTODOS DE NAVEGACI√ìN ---
    def nav(self, i):
        for b in self.btns_nav: b.setChecked(False)
        self.btns_nav[i].setChecked(True)
        self.content.setCurrentIndex(i)
        
        # Refrescar datos si entramos a Corte o Clientes
        w_actual = self.content.currentWidget()
        
        if w_actual == self.corte_w:
            self.corte_w.cargar_datos()
            
        elif w_actual == self.clientes_w:
            # CORRECCI√ìN: Usamos 'cargar_tabla' que es el nombre real en tu clase
            self.clientes_w.cargar_tabla()
            
    def logout(self):
        reply = QMessageBox.question(self, "Salir", "¬øCerrar sesi√≥n?", 
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
        
        if reply == QMessageBox.StandardButton.Yes:
            self.cerrar_sesion_solicitado = True 
            self.close() 

    # --- CONFIGURACI√ìN Y TEMAS ---
    def cargar_config(self):
        import os
        import json
        carpeta_actual = os.path.dirname(os.path.abspath(__file__))
        ruta_absoluta = os.path.join(carpeta_actual, "config.json")
        
        if os.path.exists(ruta_absoluta):
            try:
                with open(ruta_absoluta, "r") as f:
                    return json.load(f)
            except:
                return {}
        return {}

    def cambiar_tema(self, checked):
        tema = "Dark" if checked else "Light"
        self.config["tema"] = tema
        
        with open("config.json", "w") as f:
            import json
            json.dump(self.config, f)
            
        aplicar_estilos(QApplication.instance(), tema)
        
        # Actualizar temas de widgets hijos
        if hasattr(self, 'clientes_w'): self.clientes_w.aplicar_tema(tema)
        if hasattr(self, 'corte_w'): self.corte_w.aplicar_tema(tema)
        if hasattr(self, 'devoluciones_w'): self.devoluciones_w.aplicar_tema(tema)
        if hasattr(self, 'config_w'): self.config_w.aplicar_tema(tema)
        if hasattr(self, 'historial_w'): self.historial_w.aplicar_tema(tema)
        if hasattr(self, 'usuarios_w'): self.usuarios_w.aplicar_tema(tema)

    def actualizar_apariencia(self):
        path_logo = self.config.get("logo_path", "")
        if path_logo and os.path.exists(path_logo):
            pix = QPixmap(path_logo)
            scaled_sidebar = pix.scaledToWidth(180, Qt.TransformationMode.SmoothTransformation)
            self.lbl_sidebar_logo.setPixmap(scaled_sidebar)
            self.lbl_sidebar_logo.setText("") 
        else:
            self.lbl_sidebar_logo.setText("NEXUS")
            self.lbl_sidebar_logo.setStyleSheet("font-size: 28px; font-weight: 900; color: #007aff; margin-bottom: 20px;")

# --- BLOQUE DE EJECUCI√ìN CON CAPTURA DE ERRORES ---
if __name__ == "__main__":
    app = QApplication(sys.argv)
    
    carpeta_actual = os.path.dirname(os.path.abspath(__file__))
    archivo_config = os.path.join(carpeta_actual, "config.json")

    # -----------------------------------------------------------
    # PASO PREVIO: CONFIGURACI√ìN INICIAL (PRIMERA VEZ)
    # -----------------------------------------------------------
    # Ahora preguntamos por la ruta exacta
    if not os.path.exists(archivo_config):
        # Si no existe, lanzamos el asistente
        wizard = SetupDialog()
        if not wizard.exec():
            sys.exit() # Si cierra sin guardar, adi√≥s.
    # -----------------------------------------------------------

    while True:
        # Cargar configuraci√≥n usando la ruta absoluta
        config_temp = {}
        if os.path.exists(archivo_config):
            try: 
                with open(archivo_config, "r") as f:
                    config_temp = json.load(f)
            except: pass

        # ---------------------------------------------------
        # 1. LOGIN
        # ---------------------------------------------------
        login_dialog = LoginDialog(config_temp)
        if not login_dialog.exec():
            break 
        usuario_actual = login_dialog.usuario_logueado

        # ---------------------------------------------------
        # 2. VERIFICACI√ìN DE SESI√ìN
        # ---------------------------------------------------
        sesion_existente = db.obtener_sesion_activa(usuario_actual.id)
        monto_inicial = 0.0
        
        if sesion_existente:
            print(f"üîÑ Sesi√≥n recuperada. ID: {sesion_existente.id}")
            monto_inicial = sesion_existente.monto_inicial
        else:
            modo_oscuro = config_temp.get("tema", "Dark") == "Dark"
            apertura_dialog = DialogoApertura(modo_oscuro=modo_oscuro)
            
            if not apertura_dialog.exec():
                break
                
            monto_inicial = apertura_dialog.monto_inicial
            try:
                db.registrar_apertura_caja(usuario_actual.id, 1, monto_inicial)
            except Exception as e:
                print(f"Error BD: {e}")

        # ---------------------------------------------------
        # 3. SISTEMA PRINCIPAL
        # ---------------------------------------------------
        window = MainWindow(usuario_actual, monto_inicial)
        window.show()
        
        app.exec()

        # ---------------------------------------------------
        # 4. AL SALIR...
        # ---------------------------------------------------
        if window.cerrar_sesion_solicitado:
            continue
        else:
            break

    sys.exit()
