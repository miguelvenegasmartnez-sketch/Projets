import sys
import sqlite3
import datetime
import traceback
import os 
import tempfile
import requests
from decimal import Decimal, ROUND_HALF_UP 
import secrets 
import json 
from PIL import Image as PILImage, ImageOps, ImageDraw

def resource_path(relative_path):
    """ Obtiene la ruta absoluta al recurso, funciona para desarrollo y para PyInstaller """
    try:
        # PyInstaller crea una carpeta temporal y guarda la ruta en _MEIPASS
        base_path = sys._MEIPASS
    except Exception:
        # Si no se est√° ejecutando como .exe, usa la ruta normal
        base_path = os.path.dirname(os.path.abspath(__file__))
    
    return os.path.join(base_path, relative_path)

# --- Importar bibliotecas de PyQt6 (Fusionadas) ---
try:
    from PyQt6.QtWidgets import (
        QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
        QGridLayout, QLabel, QLineEdit, QPushButton, QComboBox, QTabWidget,
        QTableWidget, QTableWidgetItem, QMessageBox, QGroupBox, QFormLayout,
        QDoubleSpinBox, QHeaderView, QFileDialog, QGraphicsDropShadowEffect,
        QStackedWidget, QFrame, QScrollArea, QCheckBox, QTextEdit, QInputDialog,
        QMenu, QSizePolicy, QSpacerItem, QListWidget, QListWidgetItem, QDialog # Necesario para el nuevo men√∫
    )
    # --- A√ëADIDO QLocale ---
    from PyQt6.QtCore import Qt, QDate, QTimer, QDateTime, QSize, QUrl, QLocale, QPoint, QPropertyAnimation, QEasingCurve, QParallelAnimationGroup # Necesario para QPoint
    from PyQt6.QtGui import QFont, QIcon, QPixmap, QColor, QDesktopServices
except ImportError as e:
    print(f"Error: Faltan bibliotecas de PyQt6. Ejecuta: pip install PyQt6\nDetalle: {e}")
    sys.exit(1)

# Esta es la versi√≥n de tu .exe actual. DEBES incrementarla cada vez que compiles.
APP_CURRENT_VERSION = "1.0.0" 

# Esta es la URL RAW (cruda) de tu archivo version_escuela.json en GitHub
# ¬°DEBES REEMPLAZAR ESTA URL POR LA TUYA!
APP_VERSION_URL = "https://raw.githubusercontent.com/miguelvenegasmartnez-sketch/Projets/main/version_escuela.json"

# --- Importar ReportLab para PDF ---
try:
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import letter
    from reportlab.lib.units import inch, mm # Aseg√∫rate de tener 'mm' aqu√≠ tambi√©n
    from reportlab.platypus import Frame
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.platypus import Paragraph, Image, Spacer, Table, TableStyle, Frame
    from reportlab.lib.enums import TA_CENTER, TA_LEFT
    from reportlab.lib.units import mm
    from reportlab.lib import colors
    FONT_NAME = 'Helvetica'
    FONT_BOLD_NAME = 'Helvetica-Bold'
except ImportError as e:
    print(f"Error: Falta la biblioteca ReportLab. Ejecuta: pip install reportlab\nDetalle: {e}")
    sys.exit(1)

import shutil
import cv2
import tempfile

try:
    # Renombramos a PILImage para no causar conflicto con 'Image' de ReportLab
    from PIL import Image as PILImage
except ImportError:
     print("Advertencia: Pillow no est√° instalado. Funciones de imagen limitadas.")

try:
    # Intenta importar la librer√≠a para manejar el esc√°ner en Windows
    import win32com.client
    WIA_AVAILABLE = True
except ImportError:
    WIA_AVAILABLE = False
    print("Advertencia: pywin32 no est√° instalado. La funci√≥n de escaneo directo no estar√° disponible.")

# ---- Configuraci√≥n de la Base de Datos y Archivos ----
# ---- Configuraci√≥n de Rutas Absolutas ----
# Obtiene la ruta donde est√° guardado este archivo .py
BASE_DIR = os.path.dirname(os.path.abspath(__file__))

if getattr(sys, 'frozen', False):
    # Corriendo como .EXE: El directorio base es donde est√° el .exe
    BASE_DIR = os.path.dirname(sys.executable)
else:
    # Corriendo como .PY: El directorio base es donde est√° el script
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))

# Usa esa ruta para encontrar siempre los archivos correctos
DB_NAME = os.path.join(BASE_DIR, "gestion_escolar.db")
LOGO_PATH = os.path.join(BASE_DIR, "logo.png")
CONFIG_FILE = os.path.join(BASE_DIR, "config.json")
FOTOS_DIR = os.path.join(BASE_DIR, "fotos_alumnos")
FOTOS_PERSONAL_DIR = os.path.join(BASE_DIR, "fotos_personal")
DOCS_DIR = os.path.join(BASE_DIR, "documentos_alumnos")
DOCS_PERSONAL_DIR = os.path.join(BASE_DIR, "documentos_personal")
if not os.path.exists(DOCS_DIR):
    os.makedirs(DOCS_DIR)
if not os.path.exists(FOTOS_DIR):
    os.makedirs(FOTOS_DIR)
if not os.path.exists(FOTOS_PERSONAL_DIR):
    os.makedirs(FOTOS_PERSONAL_DIR)
if not os.path.exists(DOCS_PERSONAL_DIR):
    os.makedirs(DOCS_PERSONAL_DIR)
# Si usas background.jpg, a√±√°delo tambi√©n:
BACKGROUND_PATH = os.path.join(BASE_DIR, "background.jpg")

# --- FUNCI√ìN DE CONEXI√ìN GLOBAL ---
def get_db_connection():
    """Establece conexi√≥n a la BD y activa las claves for√°neas."""
    conn = sqlite3.connect(DB_NAME)
    # --- ASEGURARSE QUE SIEMPRE EST√â ACTIVO ---
    conn.execute("PRAGMA foreign_keys = ON")
    conn.row_factory = sqlite3.Row 
    return conn

def inicializar_db():
    """Crea las tablas de la base de datos si no existen."""
    conn = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute("PRAGMA foreign_keys = ON")

        # --- Tabla de Alumnos ---
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS alumnos (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            apellido_paterno TEXT NOT NULL,
            apellido_materno TEXT,
            nombres TEXT NOT NULL,
            escuela_procedencia TEXT,
            escuela_ingresar TEXT,
            edad INTEGER,
            telefono TEXT,
            email TEXT UNIQUE,
            turno TEXT,
            tutor_ap_paterno TEXT,
            tutor_ap_materno TEXT,
            tutor_nombres TEXT,
            dom_calle TEXT,
            dom_num_int TEXT,
            dom_num_ext TEXT,
            dom_colonia TEXT,
            dom_municipio TEXT,
            dom_estado TEXT,
            dom_cp TEXT,
            tutor_telefono TEXT,
            emerg_1_nombre TEXT,
            emerg_1_telefono TEXT,
            emerg_1_parentesco TEXT,
            emerg_2_nombre TEXT,
            emerg_2_telefono TEXT,
            emerg_2_parentesco TEXT,
            autoriza_salida_solo INTEGER DEFAULT 0,
            foto_ruta TEXT
        )
        """)
        
        # --- Alteraciones (Para que las bases de datos viejas funcionen sin borrar) ---
        try:
             cursor.execute("ALTER TABLE alumnos ADD COLUMN IF NOT EXISTS autoriza_salida_solo INTEGER DEFAULT 0")
             cursor.execute("ALTER TABLE alumnos ADD COLUMN IF NOT EXISTS foto_ruta TEXT")
             conn.commit()
        except sqlite3.OperationalError:
            pass # Ignorar si la columna ya existe

        # --- Tabla de Cursos (Incluyendo costos Bisemanal y Mensual 4) ---
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS cursos (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            nombre_curso TEXT NOT NULL UNIQUE,
            costo_exhibicion REAL DEFAULT 0.0,
            costo_sem_15 REAL DEFAULT 0.0,
            costo_sem_12 REAL DEFAULT 0.0,
            costo_mensual_3 REAL DEFAULT 0.0,
            costo_bi_semanal REAL DEFAULT 0.0, 
            costo_mensual_4 REAL DEFAULT 0.0,
            costo_mensualidad REAL DEFAULT 0.0
        )
        """)
        
        # --- Alteraciones para Cursos (Si la tabla ya exist√≠a sin los nuevos campos) ---
        try:
             cursor.execute("ALTER TABLE cursos ADD COLUMN IF NOT EXISTS costo_bi_semanal REAL DEFAULT 0.0")
             cursor.execute("ALTER TABLE cursos ADD COLUMN IF NOT EXISTS costo_mensual_4 REAL DEFAULT 0.0")
             cursor.execute("ALTER TABLE cursos ADD COLUMN IF NOT EXISTS costo_mensualidad REAL DEFAULT 0.0")
             conn.commit()
        except sqlite3.OperationalError:
            pass 
        # ---------------------------------------------------------------------------------

        # --- Tabla de Inscripciones ---
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS inscripciones (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            alumno_id INTEGER NOT NULL,
            curso_id INTEGER NOT NULL,
            fecha_inscripcion TEXT NOT NULL,
            monto_original REAL DEFAULT 0.0,
            descuento_aplicado_pct REAL DEFAULT 0.0,
            monto_total REAL NOT NULL,
            monto_pagado REAL DEFAULT 0.0,
            estado TEXT DEFAULT 'Pendiente',
            tipo_pago_seleccionado TEXT,
            FOREIGN KEY (alumno_id) REFERENCES alumnos(id) ON DELETE CASCADE,
            FOREIGN KEY (curso_id) REFERENCES cursos(id) ON DELETE RESTRICT
        )
        """)
        
        try:
             cursor.execute("ALTER TABLE inscripciones ADD COLUMN IF NOT EXISTS monto_original REAL DEFAULT 0.0")
             cursor.execute("ALTER TABLE inscripciones ADD COLUMN IF NOT EXISTS descuento_aplicado_pct REAL DEFAULT 0.0")
             conn.commit()
        except sqlite3.OperationalError:
            pass
        
        # --- Tabla de Pagos ---
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS pagos (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            inscripcion_id INTEGER NOT NULL,
            monto REAL NOT NULL,
            fecha_pago TEXT NOT NULL,
            metodo_pago TEXT,
            FOREIGN KEY (inscripcion_id) REFERENCES inscripciones(id) ON DELETE CASCADE
        )
        """)
        
        # --- Tabla de Usuarios ---
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS usuarios (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            nombre_completo TEXT NOT NULL,
            telefono TEXT,
            email TEXT NOT NULL UNIQUE,
            permisos TEXT NOT NULL,
            password TEXT NOT NULL
        )
        """)

        # --- Tabla de Documentos (LA QUE ESTABA FALTANDO) ---
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS documentos (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            alumno_id INTEGER NOT NULL,
            tipo_doc TEXT NOT NULL,
            ruta_archivo TEXT NOT NULL,
            FOREIGN KEY (alumno_id) REFERENCES alumnos(id) ON DELETE CASCADE
        )
        """)
        
        # --- Insertar usuario admin por defecto ---
        try:
            # ... (c√≥digo para insertar admin) ...
            admin_permissions = {
                "is_admin": True, "can_register_students": True, "can_register_payments": True,
                "can_view_all_students": True, "can_manage_courses": True, "can_manage_users": True,
                "can_manage_subjects": True, "can_assign_grades": True, "can_access_settings": True
            }
            admin_permisos_json = json.dumps(admin_permissions)
            
            cursor.execute("""
            INSERT OR IGNORE INTO usuarios (id, nombre_completo, email, permisos, password)
            VALUES (1, 'Administrador', 'admin@sistema.com', ?, 'admin123')
            """, (admin_permisos_json,))
        except Exception:
             pass 

        # --- Tablas de Materias y Calificaciones ---
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS materias (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            curso_id INTEGER NOT NULL,
            nombre_materia TEXT NOT NULL,
            FOREIGN KEY (curso_id) REFERENCES cursos(id) ON DELETE CASCADE
        )
        """)

        cursor.execute("""
        CREATE TABLE IF NOT EXISTS calificaciones (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            inscripcion_id INTEGER NOT NULL,
            materia_id INTEGER NOT NULL,
            parcial_1 REAL DEFAULT 0.0,
            obs_1 TEXT DEFAULT '',
            parcial_2 REAL DEFAULT 0.0,
            obs_2 TEXT DEFAULT '',
            FOREIGN KEY (inscripcion_id) REFERENCES inscripciones(id) ON DELETE CASCADE,
            FOREIGN KEY (materia_id) REFERENCES materias(id) ON DELETE CASCADE
        )
        """)
        
        # --- Tabla de Personal (NUEVA) ---
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS personal (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            num_empleado TEXT NOT NULL UNIQUE,
            nombre TEXT NOT NULL,
            apellido_paterno TEXT NOT NULL,
            apellido_materno TEXT,
            fecha_nacimiento TEXT,
            curp TEXT,
            rfc TEXT,
            nss TEXT,
            direccion TEXT,
            estado_civil TEXT,
            email TEXT,
            telefono TEXT,
            escolaridad TEXT,
            puesto TEXT,
            foto_ruta TEXT,
            emerg_1_nombre TEXT,
            emerg_1_telefono TEXT,
            emerg_2_nombre TEXT,
            emerg_2_telefono TEXT
        )
        """)

        # --- Tabla de Documentos del Personal (NUEVA) ---
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS documentos_personal (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            personal_id INTEGER NOT NULL,
            tipo_doc TEXT NOT NULL,
            ruta_archivo TEXT NOT NULL,
            FOREIGN KEY (personal_id) REFERENCES personal(id) ON DELETE CASCADE
        )
        """)
        
        conn.commit()
    except sqlite3.Error as e:
        # Si falla algo cr√≠tico, mostrarlo
        err_msg = f"CRITICAL: Error al inicializar la base de datos: {e}"
        print(err_msg)
        try:
             QMessageBox.critical(None, "Error Fatal de Base de Datos", err_msg)
        except:
             pass
    finally:
        if conn:
            conn.close()

# Funciones globales de mensajes (deben estar definidas antes de usarse)
def mostrar_error(mensaje):
    """Muestra un di√°logo de error cr√≠tico."""
    msg_box = QMessageBox()
    msg_box.setIcon(QMessageBox.Icon.Critical)
    msg_box.setWindowTitle("Error")
    msg_box.setText(str(mensaje))
    msg_box.exec()

def mostrar_info(mensaje):
    """Muestra un di√°logo de informaci√≥n."""
    msg_box = QMessageBox()
    msg_box.setIcon(QMessageBox.Icon.Information)
    msg_box.setWindowTitle("Informaci√≥n")
    msg_box.setText(str(mensaje))
    msg_box.exec()

class VentanaDocumentos(QDialog):
    def __init__(self, alumno_id, nombre_alumno, parent=None):
        super().__init__(parent)
        self.alumno_id = alumno_id
        self.nombre_alumno = nombre_alumno  # <--- GUARDAR EL NOMBRE AQU√ç
        self.setWindowTitle(f"Expediente Digital - {nombre_alumno}")
        self.setMinimumSize(750, 500) # Un poco m√°s ancha para los nuevos botones
        self.tipos_documentos = ["Acta de Nacimiento Alumno", "Acta de Nacimiento Tutor", "CURP Alumno", "CURP Tutor", "Comprobante de Domicilio", "Certificado M√©dico Alumno", "INE Tutor"]
        self.layout = QVBoxLayout(self)
        self.init_ui()
        self.cargar_estado_documentos()

    def init_ui(self):
        info_label = QLabel("Gestione los documentos digitales. Puede cargarlos desde archivos o escanearlos directamente.")
        info_label.setStyleSheet("color: gray; margin-bottom: 10px;")
        self.layout.addWidget(info_label)

        # Ajustamos las columnas: Tipo, Estado, Acciones (ahora m√°s ancha)
        self.tabla_docs = QTableWidget(len(self.tipos_documentos), 3)
        self.tabla_docs.setHorizontalHeaderLabels(["Tipo de Documento", "Estado", "Acciones"])
        self.tabla_docs.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeMode.Stretch)
        self.tabla_docs.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.ResizeToContents)
        self.tabla_docs.horizontalHeader().setSectionResizeMode(2, QHeaderView.ResizeMode.ResizeToContents) # Acciones ajustada al contenido
        self.tabla_docs.verticalHeader().setVisible(False)

        for i, tipo in enumerate(self.tipos_documentos):
            self.tabla_docs.setItem(i, 0, QTableWidgetItem(tipo))
            
            item_estado = QTableWidgetItem("Pendiente ‚ùå")
            item_estado.setForeground(QColor("red"))
            item_estado.setTextAlignment(Qt.AlignmentFlag.AlignCenter)
            self.tabla_docs.setItem(i, 1, item_estado)
            
            # --- Widget contenedor para los botones de acci√≥n ---
            widget_acciones = QWidget()
            layout_acciones = QHBoxLayout(widget_acciones)
            layout_acciones.setContentsMargins(5, 2, 5, 2)
            layout_acciones.setSpacing(5)

            btn_cargar = QPushButton("üìÇ Cargar")
            btn_cargar.setToolTip("Seleccionar un archivo ya existente en la computadora")
            btn_cargar.clicked.connect(lambda checked, t=tipo: self.cargar_documento(t))
            
            btn_escanear = QPushButton("üñ®Ô∏è Escanear")
            btn_escanear.setToolTip("Conectar al esc√°ner para digitalizar ahora")
            # Deshabilitar si no hay soporte WIA
            if not WIA_AVAILABLE:
                btn_escanear.setEnabled(False)
                btn_escanear.setToolTip("Instale 'pywin32' para habilitar el escaneo")
            else:
                btn_escanear.clicked.connect(lambda checked, t=tipo: self.escanear_documento(t))

            layout_acciones.addWidget(btn_cargar)
            layout_acciones.addWidget(btn_escanear)
            self.tabla_docs.setCellWidget(i, 2, widget_acciones)

        self.layout.addWidget(self.tabla_docs)

        btn_cerrar = QPushButton("Cerrar Expediente")
        btn_cerrar.clicked.connect(self.accept)
        self.layout.addWidget(btn_cerrar)

    def cargar_estado_documentos(self):
        """Revisa en la BD qu√© documentos ya existen."""
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT tipo_doc, ruta_archivo FROM documentos WHERE alumno_id = ?", (self.alumno_id,))
                docs_registrados = {row['tipo_doc']: row['ruta_archivo'] for row in cursor.fetchall()}

            for i, tipo in enumerate(self.tipos_documentos):
                if tipo in docs_registrados and os.path.exists(docs_registrados[tipo]):
                    self.tabla_docs.item(i, 1).setText("Cargado ‚úÖ")
                    self.tabla_docs.item(i, 1).setForeground(QColor("green"))
                    
                    # Reemplazar botones de carga/escaneo con bot√≥n de "Ver"
                    btn_ver = QPushButton("üëÅÔ∏è Ver Documento")
                    btn_ver.setStyleSheet("background-color: #4CAF50; color: white; font-weight: bold;")
                    ruta = docs_registrados[tipo]
                    btn_ver.clicked.connect(lambda checked, r=ruta: QDesktopServices.openUrl(QUrl.fromLocalFile(r)))
                    self.tabla_docs.setCellWidget(i, 2, btn_ver)
        except Exception as e:
            # Evitar ciclos de error si algo falla al abrir
            print(f"Error al cargar estado: {e}")

    def procesar_y_guardar_archivo(self, ruta_origen, tipo_doc, es_escaneo_temporal=False):
        """Funci√≥n centralizada para guardar el documento en la carpeta final y la BD."""
        try:
            # 1. Preparar directorios con NOMBRE DEL ALUMNO
            # Limpiamos el nombre para que sea seguro como nombre de carpeta
            nombre_seguro = "".join([c for c in self.nombre_alumno if c.isalnum() or c in (' ', '-', '_')]).strip()
            nombre_carpeta = f"{self.alumno_id}_{nombre_seguro}" # Ej: "123_JUAN_PEREZ"
            
            carpeta_alumno = os.path.join(DOCS_DIR, nombre_carpeta)
            if not os.path.exists(carpeta_alumno):
                os.makedirs(carpeta_alumno)

            # 2. Definir ruta destino y procesar
            nombre_base = f"{tipo_doc.replace(' ', '_')}"
            
            # Si es una imagen escaneada, la convertimos a PDF
            if es_escaneo_temporal:
                 ruta_destino = os.path.join(carpeta_alumno, nombre_base + ".pdf")
                 
                 # --- CORRECCI√ìN CLAVE: USAR PILImage EN LUGAR DE Image ---
                 image = PILImage.open(ruta_origen) 
                 
                 # Convertir a RGB si es necesario (para que la conversi√≥n a PDF sea exitosa)
                 if image.mode == 'RGBA':
                     image = image.convert('RGB')
                 
                 image.save(ruta_destino, "PDF", resolution=100.0)
                 image.close()
                 try: os.remove(ruta_origen) # Borrar el temporal
                 except: pass
            else:
                # Si es carga directa, mantenemos la extensi√≥n original
                extension = os.path.splitext(ruta_origen)[1]
                ruta_destino = os.path.join(carpeta_alumno, nombre_base + extension)
                shutil.copy2(ruta_origen, ruta_destino)

            # 3. Guardar en BD
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("DELETE FROM documentos WHERE alumno_id = ? AND tipo_doc = ?", (self.alumno_id, tipo_doc))
                cursor.execute("INSERT INTO documentos (alumno_id, tipo_doc, ruta_archivo) VALUES (?, ?, ?)", 
                               (self.alumno_id, tipo_doc, ruta_destino))
                conn.commit()

            self.cargar_estado_documentos()
            QMessageBox.information(self, "√âxito", f"Documento '{tipo_doc}' guardado correctamente.")

        except Exception as e:
            QMessageBox.critical(self, "Error", f"No se pudo guardar el documento: {e}\n{traceback.format_exc()}")

    def cargar_documento(self, tipo_doc):
        """Carga desde archivo existente."""
        ruta_origen, _ = QFileDialog.getOpenFileName(self, f"Seleccionar {tipo_doc}", "", "Documentos (*.pdf *.jpg *.png *.jpeg)")
        if ruta_origen:
            self.procesar_y_guardar_archivo(ruta_origen, tipo_doc, es_escaneo_temporal=False)

    def escanear_documento(self, tipo_doc):
        """Conecta con el esc√°ner usando WIA (Windows)."""
        if not WIA_AVAILABLE:
            QMessageBox.warning(self, "Error", "Librer√≠a 'pywin32' no instalada.")
            return

        try:
            # Crear el di√°logo WIA
            wia_dialog = win32com.client.Dispatch("WIA.CommonDialog")
            
            # Mostrar la interfaz nativa de escaneo de Windows
            # DeviceType=1 (Scanner), Intent=1 (Color Intent - mejor para documentos oficiales)
            imagen_wia = wia_dialog.ShowAcquireImage(
                DeviceType=1,
                Intent=1, 
                FormatID="{B96B3CAE-0728-11D3-9D7B-0000F81EF32E}" # Formato JPEG (m√°s compatible)
            )

            if imagen_wia:
                # Guardar la imagen escaneada temporalmente
                ruta_temporal = os.path.join(tempfile.gettempdir(), "temp_scan.jpg")
                if os.path.exists(ruta_temporal):
                    os.remove(ruta_temporal)
                imagen_wia.SaveFile(ruta_temporal)
                
                # Procesarla (convertir a PDF y guardar en carpeta final)
                self.procesar_y_guardar_archivo(ruta_temporal, tipo_doc, es_escaneo_temporal=True)
            
        except Exception as e:
            # El error "COM Error -2145320959" suele significar que el usuario cancel√≥ el di√°logo.
            if "-2145320959" in str(e): 
                pass # Usuario cancel√≥, no hacemos nada
            else:
                QMessageBox.critical(self, "Error de Esc√°ner", f"No se pudo conectar al esc√°ner.\nAseg√∫rese de que est√° encendido y conectado.\nDetalle: {e}")

    def cargar_estado_documentos(self):
        """Revisa en la BD qu√© documentos ya existen."""
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT tipo_doc, ruta_archivo FROM documentos WHERE alumno_id = ?", (self.alumno_id,))
                docs_registrados = {row['tipo_doc']: row['ruta_archivo'] for row in cursor.fetchall()}

            for i, tipo in enumerate(self.tipos_documentos):
                if tipo in docs_registrados and os.path.exists(docs_registrados[tipo]):
                    item_estado = QTableWidgetItem("Cargado ‚úÖ")
                    item_estado.setForeground(QColor("green"))
                    item_estado.setTextAlignment(Qt.AlignmentFlag.AlignCenter)
                    self.tabla_docs.setItem(i, 1, item_estado)
                    
                    # Cambiar bot√≥n a "Ver/Abrir"
                    btn_ver = QPushButton("üëÅÔ∏è Ver Doc")
                    ruta = docs_registrados[tipo]
                    btn_ver.clicked.connect(lambda checked, r=ruta: QDesktopServices.openUrl(QUrl.fromLocalFile(r)))
                    self.tabla_docs.setCellWidget(i, 2, btn_ver)
        except Exception as e:
            QMessageBox.critical(self, "Error", f"No se pudo cargar el estado de los documentos: {e}")

    def cargar_documento(self, tipo_doc):
        """Abre un di√°logo para seleccionar y guardar un documento."""
        ruta_origen, _ = QFileDialog.getOpenFileName(self, f"Seleccionar {tipo_doc}", "", "Documentos (*.pdf *.jpg *.png *.jpeg)")
        if ruta_origen:
            try:
                # 1. Crear carpeta especifica para el alumno si no existe
                carpeta_alumno = os.path.join(DOCS_DIR, str(self.alumno_id))
                if not os.path.exists(carpeta_alumno):
                    os.makedirs(carpeta_alumno)

                # 2. Definir ruta destino con nombre estandarizado
                extension = os.path.splitext(ruta_origen)[1]
                nombre_archivo = f"{tipo_doc.replace(' ', '_')}{extension}"
                ruta_destino = os.path.join(carpeta_alumno, nombre_archivo)

                # 3. Copiar archivo
                import shutil
                shutil.copy2(ruta_origen, ruta_destino)

                # 4. Guardar en BD (Insertar o Actualizar si ya exist√≠a)
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    # Borrar registro previo si existe para ese tipo
                    cursor.execute("DELETE FROM documentos WHERE alumno_id = ? AND tipo_doc = ?", (self.alumno_id, tipo_doc))
                    # Insertar nuevo
                    cursor.execute("INSERT INTO documentos (alumno_id, tipo_doc, ruta_archivo) VALUES (?, ?, ?)", 
                                   (self.alumno_id, tipo_doc, ruta_destino))
                    conn.commit()

                self.cargar_estado_documentos() # Recargar la tabla
                QMessageBox.information(self, "√âxito", f"{tipo_doc} cargado correctamente.")

            except Exception as e:
                QMessageBox.critical(self, "Error", f"No se pudo guardar el documento: {e}")

# --- (A√±adir esta clase cerca de VentanaDocumentos) ---
# (Aseg√∫rate de que esto est√© cerca de tu otra clase VentanaDocumentos)

class VentanaDocumentosPersonal(QDialog):
    def __init__(self, personal_id, nombre_personal, parent=None):
        super().__init__(parent)
        self.personal_id = personal_id
        self.nombre_personal = nombre_personal
        self.setWindowTitle(f"Expediente Digital - {nombre_personal}")
        self.setMinimumSize(750, 500)
        
        # --- LISTA DE DOCUMENTOS DE PERSONAL ---
        self.tipos_documentos = [
            "Acta de Nacimiento", "CURP", "RFC", "Asignaci√≥n de NSS",
            "INE (Anverso)", "INE (Reverso)", "Comprobante de Estudios",
            "Comprobante de Domicilio", "Carta de Recomendaci√≥n 1", "Carta de Recomendaci√≥n 2"
        ]
        
        # --- ESTAS L√çNEAS SON CRUCIALES ---
        self.layout = QVBoxLayout(self)
        self.init_ui() # Dibuja la ventana
        self.cargar_estado_documentos() # Carga los datos
        # ------------------------------------

    def init_ui(self):
        """ Dibuja los componentes de la ventana (botones, tabla, etc.) """
        info_label = QLabel("Gestione los documentos digitales del personal. Puede cargarlos desde archivos o escanearlos directamente.")
        info_label.setStyleSheet("color: gray; margin-bottom: 10px;")
        self.layout.addWidget(info_label)

        # Ajustamos las columnas: Tipo, Estado, Acciones
        self.tabla_docs = QTableWidget(len(self.tipos_documentos), 3)
        self.tabla_docs.setHorizontalHeaderLabels(["Tipo de Documento", "Estado", "Acciones"])
        self.tabla_docs.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeMode.Stretch)
        self.tabla_docs.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.ResizeToContents)
        self.tabla_docs.horizontalHeader().setSectionResizeMode(2, QHeaderView.ResizeMode.ResizeToContents) 
        self.tabla_docs.verticalHeader().setVisible(False)

        for i, tipo in enumerate(self.tipos_documentos):
            self.tabla_docs.setItem(i, 0, QTableWidgetItem(tipo))
            
            item_estado = QTableWidgetItem("Pendiente ‚ùå")
            item_estado.setForeground(QColor("red"))
            item_estado.setTextAlignment(Qt.AlignmentFlag.AlignCenter)
            self.tabla_docs.setItem(i, 1, item_estado)
    
            # --- Widget contenedor para los botones de acci√≥n ---
            widget_acciones = QWidget()
            layout_acciones = QHBoxLayout(widget_acciones)
            layout_acciones.setContentsMargins(5, 2, 5, 2)
            layout_acciones.setSpacing(5)

            btn_cargar = QPushButton("üìÇ Cargar")
            btn_cargar.setToolTip("Seleccionar un archivo ya existente en la computadora")
            btn_cargar.clicked.connect(lambda checked, t=tipo: self.cargar_documento(t))
            
            btn_escanear = QPushButton("üñ®Ô∏è Escanear")
            btn_escanear.setToolTip("Conectar al esc√°ner para digitalizar ahora")
            # Deshabilitar si no hay soporte WIA
            if not WIA_AVAILABLE:
                btn_escanear.setEnabled(False)
                btn_escanear.setToolTip("Instale 'pywin32' para habilitar el escaneo")
            else:
                btn_escanear.clicked.connect(lambda checked, t=tipo: self.escanear_documento(t))

            layout_acciones.addWidget(btn_cargar)
            layout_acciones.addWidget(btn_escanear)
            self.tabla_docs.setCellWidget(i, 2, widget_acciones)

        self.layout.addWidget(self.tabla_docs)

        btn_cerrar = QPushButton("Cerrar Expediente")
        btn_cerrar.clicked.connect(self.accept)
        self.layout.addWidget(btn_cerrar)

    def cargar_estado_documentos(self):
        """ Revisa la BD (tabla documentos_personal) y actualiza la UI. """
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                # --- CAMBIO DE TABLA ---
                cursor.execute("SELECT tipo_doc, ruta_archivo FROM documentos_personal WHERE personal_id = ?", (self.personal_id,))
                docs_registrados = {row['tipo_doc']: row['ruta_archivo'] for row in cursor.fetchall()}

            for i, tipo in enumerate(self.tipos_documentos):
                if tipo in docs_registrados and os.path.exists(docs_registrados[tipo]):
                    self.tabla_docs.item(i, 1).setText("Cargado ‚úÖ")
                    self.tabla_docs.item(i, 1).setForeground(QColor("green"))
                    btn_ver = QPushButton("üëÅÔ∏è Ver Documento")
                    btn_ver.setStyleSheet("background-color: #4CAF50; color: white; font-weight: bold;")
                    ruta = docs_registrados[tipo]
                    btn_ver.clicked.connect(lambda checked, r=ruta: QDesktopServices.openUrl(QUrl.fromLocalFile(r)))
                    self.tabla_docs.setCellWidget(i, 2, btn_ver)
                else:
                    # (L√≥gica para resetear a "Pendiente" si el archivo fue borrado, si es necesario)
                    pass 
        except Exception as e:
            print(f"Error al cargar estado de docs de personal: {e}")

    def procesar_y_guardar_archivo(self, ruta_origen, tipo_doc, es_escaneo_temporal=False):
        """ Guarda el archivo en la carpeta correcta (DOCS_PERSONAL_DIR) y en la BD (documentos_personal). """
        try:
            # 1. Preparar directorios
            nombre_seguro = "".join([c for c in self.nombre_personal if c.isalnum() or c in (' ', '-', '_')]).strip()
            nombre_carpeta = f"P-{self.personal_id}_{nombre_seguro}"
            
            # --- CAMBIO DE DIRECTORIO ---
            carpeta_personal = os.path.join(DOCS_PERSONAL_DIR, nombre_carpeta)
            if not os.path.exists(carpeta_personal):
                os.makedirs(carpeta_personal)

            # 2. Definir ruta destino y procesar
            nombre_base = f"{tipo_doc.replace(' ', '_')}"
            if es_escaneo_temporal:
                 ruta_destino = os.path.join(carpeta_personal, nombre_base + ".pdf")
                 image = PILImage.open(ruta_origen) 
                 if image.mode == 'RGBA':
                     image = image.convert('RGB')
                 image.save(ruta_destino, "PDF", resolution=100.0)
                 image.close()
                 try: os.remove(ruta_origen)
                 except: pass
            else:
                extension = os.path.splitext(ruta_origen)[1]
                ruta_destino = os.path.join(carpeta_personal, nombre_base + extension)
                shutil.copy2(ruta_origen, ruta_destino)

            # 3. Guardar en BD
            with get_db_connection() as conn:
                cursor = conn.cursor()
                # --- CAMBIO DE TABLA ---
                cursor.execute("DELETE FROM documentos_personal WHERE personal_id = ? AND tipo_doc = ?", (self.personal_id, tipo_doc))
                cursor.execute("INSERT INTO documentos_personal (personal_id, tipo_doc, ruta_archivo) VALUES (?, ?, ?)", 
                               (self.personal_id, tipo_doc, ruta_destino))
                conn.commit()

            self.cargar_estado_documentos() # Recargar la tabla
            QMessageBox.information(self, "√âxito", f"Documento '{tipo_doc}' guardado correctamente.")
        except Exception as e:
            QMessageBox.critical(self, "Error", f"No se pudo guardar el documento: {e}\n{traceback.format_exc()}")

    def cargar_documento(self, tipo_doc):
        """ Carga un archivo existente. """
        ruta_origen, _ = QFileDialog.getOpenFileName(self, f"Seleccionar {tipo_doc}", "", "Documentos (*.pdf *.jpg *.png *.jpeg)")
        if ruta_origen:
            self.procesar_y_guardar_archivo(ruta_origen, tipo_doc, es_escaneo_temporal=False)

    def escanear_documento(self, tipo_doc):
        """ Inicia el proceso de escaneo WIA. """
        if not WIA_AVAILABLE:
            QMessageBox.warning(self, "Error", "Librer√≠a 'pywin32' no instalada.")
            return
        try:
            wia_dialog = win32com.client.Dispatch("WIA.CommonDialog")
            imagen_wia = wia_dialog.ShowAcquireImage(DeviceType=1, Intent=1, FormatID="{B96B3CAE-0728-11D3-9D7B-0000F81EF32E}")
            if imagen_wia:
                ruta_temporal = os.path.join(tempfile.gettempdir(), "temp_scan.jpg")
                if os.path.exists(ruta_temporal):
                    os.remove(ruta_temporal)
                imagen_wia.SaveFile(ruta_temporal)
                # Procesar (convertir a PDF y guardar en carpeta final)
                self.procesar_y_guardar_archivo(ruta_temporal, tipo_doc, es_escaneo_temporal=True)
        except Exception as e:
            if "-2145320959" in str(e): 
                pass # Usuario cancel√≥
            else:
                QMessageBox.critical(self, "Error de Esc√°ner", f"No se pudo conectar al esc√°ner.\nAseg√∫rese de que est√° encendido y conectado.\nDetalle: {e}")

# --- (Fin de la clase VentanaDocumentosPersonal) ---

# --- (A√±adir esta clase cerca de VentanaDocumentos) ---
class DialogGestionPersonal(QDialog):
    """Di√°logo para registrar o editar personal."""
    def __init__(self, personal_id=None, parent=None):
        super().__init__(parent)
        self.personal_id = personal_id
        self.ruta_foto_temporal = None
        self.setWindowTitle("Gesti√≥n de Personal")
        self.setMinimumSize(800, 600)

        self.layout_principal = QVBoxLayout(self)
        self.scroll_area = QScrollArea()
        self.scroll_area.setWidgetResizable(True)
        
        self.scroll_content = QWidget()
        self.layout_scroll = QVBoxLayout(self.scroll_content)

        # --- Layout Superior (Foto y Datos Personales) ---
        layout_superior = QHBoxLayout()
        
        # Panel de Foto (Copiado de crear_pagina_nueva_inscripcion)
        panel_foto = QVBoxLayout()
        self.lbl_foto_registro = QLabel("Sin Foto")
        self.lbl_foto_registro.setFixedSize(150, 200)
        self.lbl_foto_registro.setStyleSheet("background-color: #E0E0E0; border: 1px solid #A0A0A0;")
        self.lbl_foto_registro.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        btn_tomar_foto = QPushButton("üì∏ Tomar Foto")
        btn_tomar_foto.clicked.connect(self.tomar_foto)
        btn_cargar_foto = QPushButton("üìÇ Cargar Foto")
        btn_cargar_foto.clicked.connect(self.cargar_foto)
        
        panel_foto.addWidget(self.lbl_foto_registro)
        panel_foto.addWidget(btn_tomar_foto)
        panel_foto.addWidget(btn_cargar_foto)
        panel_foto.addStretch()
        layout_superior.addLayout(panel_foto)

        # Panel de Datos Personales
        group_personales = QGroupBox("Datos Personales")
        form_personales = QFormLayout(group_personales)
        self.entry_nombre = QLineEdit()
        self.entry_ap_paterno = QLineEdit()
        self.entry_ap_materno = QLineEdit()
        self.entry_fecha_nac = QLineEdit() # Puedes usar QDateEdit si prefieres
        self.entry_fecha_nac.setPlaceholderText("YYYY-MM-DD")
        self.entry_curp = QLineEdit()
        self.entry_rfc = QLineEdit()
        self.entry_nss = QLineEdit()
        self.combo_estado_civil = QComboBox()
        self.combo_estado_civil.addItems(["Soltero(a)", "Casado(a)", "Viudo(a)", "Divorciado(a)", "Uni√≥n Libre"])
        self.combo_escolaridad = QComboBox()
        self.combo_escolaridad.addItems(["Primaria", "Secundaria", "Bachillerato", "Licenciatura", "Maestr√≠a", "Doctorado"])
        self.combo_puesto = QComboBox()
        self.combo_puesto.addItems(["Administrativo", "Docente", "Director General", "Intendencia", "Otro"])

        form_personales.addRow("Nombre(s):", self.entry_nombre)
        form_personales.addRow("Apellido Paterno:", self.entry_ap_paterno)
        form_personales.addRow("Apellido Materno:", self.entry_ap_materno)
        form_personales.addRow("Fecha Nacimiento:", self.entry_fecha_nac)
        form_personales.addRow("CURP:", self.entry_curp)
        form_personales.addRow("RFC:", self.entry_rfc)
        form_personales.addRow("NSS:", self.entry_nss)
        form_personales.addRow("Estado Civil:", self.combo_estado_civil)
        form_personales.addRow("Escolaridad:", self.combo_escolaridad)
        form_personales.addRow("Puesto:", self.combo_puesto)
        
        layout_superior.addWidget(group_personales)
        self.layout_scroll.addLayout(layout_superior)

        # --- Grupo Contacto y Domicilio ---
        group_contacto = QGroupBox("Contacto y Domicilio")
        form_contacto = QFormLayout(group_contacto)
        self.entry_direccion = QLineEdit()
        self.entry_email = QLineEdit()
        self.entry_telefono = QLineEdit()
        form_contacto.addRow("Direcci√≥n Completa:", self.entry_direccion)
        form_contacto.addRow("Correo Electr√≥nico:", self.entry_email)
        form_contacto.addRow("Tel√©fono:", self.entry_telefono)
        self.layout_scroll.addWidget(group_contacto)

        # --- Grupo Emergencia (Copiado de crear_pagina_nueva_inscripcion) ---
        group_emergencia = QGroupBox("Contactos de Emergencia")
        layout_emergencia = QGridLayout(group_emergencia)
        self.entry_emerg_1_nombre = QLineEdit()
        self.entry_emerg_1_telefono = QLineEdit()
        self.entry_emerg_2_nombre = QLineEdit()
        self.entry_emerg_2_telefono = QLineEdit()
        layout_emergencia.addWidget(QLabel("Nombre 1:"), 0, 0)
        layout_emergencia.addWidget(self.entry_emerg_1_nombre, 0, 1)
        layout_emergencia.addWidget(QLabel("Tel√©fono 1:"), 0, 2)
        layout_emergencia.addWidget(self.entry_emerg_1_telefono, 0, 3)
        layout_emergencia.addWidget(QLabel("Nombre 2:"), 1, 0)
        layout_emergencia.addWidget(self.entry_emerg_2_nombre, 1, 1)
        layout_emergencia.addWidget(QLabel("Tel√©fono 2:"), 1, 2)
        layout_emergencia.addWidget(self.entry_emerg_2_telefono, 1, 3)
        self.layout_scroll.addWidget(group_emergencia)

        self.layout_scroll.addStretch()
        self.scroll_area.setWidget(self.scroll_content)
        self.layout_principal.addWidget(self.scroll_area)

        # --- Botones Guardar/Cancelar ---
        layout_botones = QHBoxLayout()
        self.btn_guardar = QPushButton("Guardar")
        self.btn_guardar.setObjectName("primaryButton")
        self.btn_guardar.clicked.connect(self.guardar_personal)
        
        btn_cancelar = QPushButton("Cancelar")
        btn_cancelar.clicked.connect(self.reject)
        
        layout_botones.addStretch()
        layout_botones.addWidget(btn_cancelar)
        layout_botones.addWidget(self.btn_guardar)
        self.layout_principal.addLayout(layout_botones)

        if self.personal_id:
            self.setWindowTitle("Editar Personal")
            self.cargar_datos_personal()
        else:
            self.setWindowTitle("Registrar Nuevo Personal")

    def tomar_foto(self):
        # (Reutiliza la l√≥gica de VentanaPrincipal.tomar_foto_webcam)
        # (Necesitar√°s pasar self.lbl_foto_registro a esa funci√≥n o copiarla aqu√≠)
        # (Por simplicidad, asumiremos que se copia la l√≥gica de la VentanaPrincipal)
        try:
            cap = cv2.VideoCapture(0)
            if not cap.isOpened():
                mostrar_error("No se pudo acceder a la c√°mara web.")
                return
            while True:
                ret, frame = cap.read()
                if not ret: break
                cv2.imshow('Presione ESPACIO para capturar, ESC para salir', frame)
                key = cv2.waitKey(1)
                if key % 256 == 32:
                    temp_filename = os.path.join(FOTOS_PERSONAL_DIR, "temp_capture.jpg")
                    cv2.imwrite(temp_filename, frame)
                    self.ruta_foto_temporal = temp_filename
                    self.mostrar_foto(temp_filename)
                    break
                elif key % 256 == 27:
                    break
            cap.release()
            cv2.destroyAllWindows()
        except Exception as e:
             mostrar_error(f"Error con la c√°mara: {e}")

    def cargar_foto(self):
        file_path, _ = QFileDialog.getOpenFileName(self, "Seleccionar Foto", "", "Im√°genes (*.png *.jpg *.jpeg)")
        if file_path:
            self.ruta_foto_temporal = file_path
            self.mostrar_foto(file_path)

    def mostrar_foto(self, ruta_imagen):
        if ruta_imagen and os.path.exists(ruta_imagen):
            pixmap = QPixmap(ruta_imagen)
            self.lbl_foto_registro.setPixmap(pixmap.scaled(self.lbl_foto_registro.size(), Qt.AspectRatioMode.KeepAspectRatio, Qt.TransformationMode.SmoothTransformation))
        else:
            self.lbl_foto_registro.setText("Sin Foto")

    def cargar_datos_personal(self):
        """Carga los datos si estamos en modo EDICI√ìN."""
        try:
            with get_db_connection() as conn:
                datos = conn.cursor().execute("SELECT * FROM personal WHERE id = ?", (self.personal_id,)).fetchone()
            if datos:
                self.entry_nombre.setText(datos['nombre'])
                self.entry_ap_paterno.setText(datos['apellido_paterno'])
                self.entry_ap_materno.setText(datos['apellido_materno'])
                self.entry_fecha_nac.setText(datos['fecha_nacimiento'])
                self.entry_curp.setText(datos['curp'])
                self.entry_rfc.setText(datos['rfc'])
                self.entry_nss.setText(datos['nss'])
                self.entry_direccion.setText(datos['direccion'])
                self.combo_estado_civil.setCurrentText(datos['estado_civil'])
                self.entry_email.setText(datos['email'])
                self.entry_telefono.setText(datos['telefono'])
                self.combo_escolaridad.setCurrentText(datos['escolaridad'])
                self.combo_puesto.setCurrentText(datos['puesto'])
                self.entry_emerg_1_nombre.setText(datos['emerg_1_nombre'])
                self.entry_emerg_1_telefono.setText(datos['emerg_1_telefono'])
                self.entry_emerg_2_nombre.setText(datos['emerg_2_nombre'])
                self.entry_emerg_2_telefono.setText(datos['emerg_2_telefono'])
                
                self.ruta_foto_temporal = datos['foto_ruta'] # Guardamos la ruta existente
                self.mostrar_foto(datos['foto_ruta'])
        except Exception as e:
            mostrar_error(f"Error al cargar datos del personal: {e}")

    def guardar_personal(self):
        """Guarda (INSERT o UPDATE) los datos del personal."""
        # Recolectar datos
        datos_personales = (
            self.entry_nombre.text(), self.entry_ap_paterno.text(), self.entry_ap_materno.text(),
            self.entry_fecha_nac.text(), self.entry_curp.text(), self.entry_rfc.text(), self.entry_nss.text(),
            self.entry_direccion.text(), self.combo_estado_civil.currentText(), self.entry_email.text(),
            self.entry_telefono.text(), self.combo_escolaridad.currentText(), self.combo_puesto.currentText(),
            self.entry_emerg_1_nombre.text(), self.entry_emerg_1_telefono.text(),
            self.entry_emerg_2_nombre.text(), self.entry_emerg_2_telefono.text()
        )
        
        if not self.entry_nombre.text() or not self.entry_ap_paterno.text() or not self.combo_puesto.currentText():
            mostrar_error("Nombre, Apellido Paterno y Puesto son obligatorios.")
            return

        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                ruta_final_foto = ""

                if self.personal_id is None:
                    # --- MODO INSERTAR (NUEVO) ---
                    
                    # Generar No. Empleado (Ej: P-2023-1, P-2023-2)
                    a√±o = datetime.date.today().year
                    cursor.execute("SELECT COUNT(id) FROM personal WHERE num_empleado LIKE ?", (f"P-{a√±o}-%",))
                    count = cursor.fetchone()[0]
                    num_empleado = f"P-{a√±o}-{count + 1:03d}"

                    cursor.execute("""
                        INSERT INTO personal (num_empleado, nombre, apellido_paterno, apellido_materno, fecha_nacimiento, curp, rfc, nss,
                                            direccion, estado_civil, email, telefono, escolaridad, puesto,
                                            emerg_1_nombre, emerg_1_telefono, emerg_2_nombre, emerg_2_telefono)
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    """, (num_empleado,) + datos_personales)
                    self.personal_id = cursor.lastrowid
                    mostrar_info(f"Personal registrado con √©xito.\nN√∫mero de Empleado: {num_empleado}")
                
                else:
                    # --- MODO ACTUALIZAR (EDITAR) ---
                    cursor.execute("""
                        UPDATE personal SET
                            nombre=?, apellido_paterno=?, apellido_materno=?, fecha_nacimiento=?, curp=?, rfc=?, nss=?,
                            direccion=?, estado_civil=?, email=?, telefono=?, escolaridad=?, puesto=?,
                            emerg_1_nombre=?, emerg_1_telefono=?, emerg_2_nombre=?, emerg_2_telefono=?
                        WHERE id = ?
                    """, datos_personales + (self.personal_id,))
                    mostrar_info("Personal actualizado con √©xito.")

                # --- L√≥gica de Foto (Com√∫n para ambos modos) ---
                if self.ruta_foto_temporal and os.path.exists(self.ruta_foto_temporal):
                    # (Copiado de registrar_alumno_e_inscribir)
                    try:
                        img = PILImage.open(self.ruta_foto_temporal)
                        img.thumbnail((400, 400), PILImage.Resampling.LANCZOS)
                        nombre_foto = f"foto_personal_{self.personal_id}.png"
                        ruta_final_foto = os.path.abspath(os.path.join(FOTOS_PERSONAL_DIR, nombre_foto))
                        img.save(ruta_final_foto, "PNG")
                        
                        # Actualizar la ruta en la BD
                        cursor.execute("UPDATE personal SET foto_ruta = ? WHERE id = ?", (ruta_final_foto, self.personal_id))
                    except Exception as e:
                        print(f"Error al guardar foto de personal: {e}")
                
                conn.commit()
            self.accept() # Cerrar el di√°logo si todo sali√≥ bien
        except sqlite3.IntegrityError as e:
            mostrar_error(f"Error: El CURP, RFC o NSS ya podr√≠an existir en la base de datos. {e}")
        except Exception as e:
            mostrar_error(f"Error al guardar en base de datos: {e}")

# --- (Fin de la clase DialogGestionPersonal) ---

# --- (PEGAR ESTA NUEVA CLASE COMPLETA) ---

class DialogoInscribirCurso(QDialog):
    """
    Un nuevo di√°logo para inscribir a un ALUMNO EXISTENTE en un NUEVO CURSO.
    """
    def __init__(self, alumno_id, nombre_alumno, parent=None):
        super().__init__(parent)
        self.alumno_id = alumno_id
        self.parent_window = parent # Guardamos la VentanaPrincipal
        self.setWindowTitle("Inscribir a Nuevo Curso")
        self.setMinimumWidth(500)

        self.layout = QFormLayout(self)
        
        self.lbl_nombre = QLabel(f"{nombre_alumno} (ID: {self.alumno_id})")
        self.lbl_nombre.setStyleSheet("font-weight: bold;")
        
        self.combo_curso = QComboBox()
        self.combo_plan_pago = QComboBox()
        self.lbl_costo_total = QLabel("$ 0.00")
        self.lbl_costo_total.setStyleSheet("font-weight: bold; color: #4CAF50; font-size: 11pt;")
        
        self.layout.addRow("Alumno:", self.lbl_nombre)
        self.layout.addRow("Seleccionar Curso:", self.combo_curso)
        self.layout.addRow("Seleccionar Plan de Pago:", self.combo_plan_pago)
        self.layout.addRow("Costo de Inscripci√≥n:", self.lbl_costo_total)

        # Botones
        layout_botones = QHBoxLayout()
        self.btn_guardar = QPushButton("Inscribir")
        self.btn_guardar.setObjectName("primaryButton")
        btn_cancelar = QPushButton("Cancelar")
        
        layout_botones.addStretch()
        layout_botones.addWidget(btn_cancelar)
        layout_botones.addWidget(self.btn_guardar)
        self.layout.addRow(layout_botones)

        # Conexiones
        btn_cancelar.clicked.connect(self.reject)
        self.btn_guardar.clicked.connect(self.guardar_inscripcion)
        self.combo_curso.currentIndexChanged.connect(self.actualizar_planes_pago)
        self.combo_plan_pago.currentIndexChanged.connect(self.actualizar_costo_label)

        self.cargar_cursos_disponibles()

    def cargar_cursos_disponibles(self):
        """Carga solo los cursos en los que el alumno NO est√° inscrito."""
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                # 1. Obtener cursos en los que el alumno YA est√°
                cursor.execute("SELECT curso_id FROM inscripciones WHERE alumno_id = ?", (self.alumno_id,))
                cursos_actuales = [row['curso_id'] for row in cursor.fetchall()]
                
                # 2. Obtener TODOS los cursos
                cursor.execute("SELECT * FROM cursos ORDER BY nombre_curso")
                todos_cursos = cursor.fetchall()

            self.combo_curso.addItem("--- Seleccione un curso ---", userData=None)
            count = 0
            for curso in todos_cursos:
                if curso['id'] not in cursos_actuales:
                    # Guardamos el objeto Fila completo (sqlite3.Row)
                    self.combo_curso.addItem(curso['nombre_curso'], userData=curso)
                    count += 1
            
            if count == 0:
                self.combo_curso.clear()
                self.combo_curso.addItem("Este alumno ya est√° en todos los cursos")
                self.btn_guardar.setEnabled(False)
                
        except Exception as e:
            mostrar_error(f"Error al cargar cursos disponibles: {e}")

    def actualizar_planes_pago(self):
        """
        Copia la l√≥gica de 'actualizar_opciones_pago' de la VentanaPrincipal,
        pero usa los controles de este di√°logo.
        """
        try:
            self.combo_plan_pago.clear()
            self.lbl_costo_total.setText("$ 0.00")
            
            curso = self.combo_curso.currentData() # Obtenemos la Fila completa
            if not curso:
                self.combo_plan_pago.addItem("---", userData=None)
                return
            
            self.combo_plan_pago.addItem("--- Seleccione un plan ---", userData=None)
            quantizer = Decimal('0.01')
            
            # (Revisamos todos los planes igual que en la funci√≥n original)
            if curso['costo_exhibicion'] > 0:
                costo = Decimal(curso['costo_exhibicion']).quantize(quantizer)
                texto = f"Una Sola Exhibici√≥n (${costo})"
                self.combo_plan_pago.addItem(texto, userData=("Exhibici√≥n √önica", float(costo), 1))

            if curso['costo_sem_15'] > 0:
                costo = Decimal(curso['costo_sem_15']).quantize(quantizer)
                pago = (costo / 15).quantize(quantizer, rounding=ROUND_HALF_UP)
                texto = f"Semanal (15 pagos de ${pago})"
                self.combo_plan_pago.addItem(texto, userData=("Semanal (15)", float(costo), 15))
              
            if curso['costo_sem_12'] > 0: 
                costo = Decimal(curso['costo_sem_12']).quantize(quantizer)
                pago = (costo / 12).quantize(quantizer, rounding=ROUND_HALF_UP) 
                texto = f"Semanal (12 pagos de ${pago})" 
                self.combo_plan_pago.addItem(texto, userData=("Semanal (12)", float(costo), 12))
            
            if curso['costo_mensual_3'] > 0: 
                costo = Decimal(curso['costo_mensual_3']).quantize(quantizer)
                pago = (costo / 3).quantize(quantizer, rounding=ROUND_HALF_UP) 
                texto = f"Mensual (3 pagos de ${pago})" 
                self.combo_plan_pago.addItem(texto, userData=("Mensual (3)", float(costo), 3))

            if curso['costo_bi_semanal'] > 0:
                costo = Decimal(curso['costo_bi_semanal']).quantize(quantizer)
                pago = (costo / 2).quantize(quantizer, rounding=ROUND_HALF_UP)
                texto = f"Bisemanal (2 pagos de ${pago})"
                self.combo_plan_pago.addItem(texto, userData=("Bisemanal (2)", float(costo), 2)) 

            if curso['costo_mensual_4'] > 0:
                costo = Decimal(curso['costo_mensual_4']).quantize(quantizer)
                pago = (costo / 4).quantize(quantizer, rounding=ROUND_HALF_UP)
                texto = f"Mensual (4 pagos de ${pago})"
                self.combo_plan_pago.addItem(texto, userData=("Mensual (4)", float(costo), 4))
            
            # (Incluimos la l√≥gica de mensualidad que ya existe en el archivo base)
            if 'costo_mensualidad' in curso.keys() and curso['costo_mensualidad'] > 0:
                costo = Decimal(curso['costo_mensualidad']).quantize(quantizer)
                texto = f"Colegiatura Mensual (${costo})"
                self.combo_plan_pago.addItem(texto, userData=("Mensualidad", float(costo), 1))
        
        except Exception as e:
            mostrar_error(f"Error al actualizar planes de pago: {e}")

    def actualizar_costo_label(self):
        """Actualiza el label de costo total."""
        try:
            data = self.combo_plan_pago.currentData()
            if data:
                plan, costo_total, num_pagos = data
                self.lbl_costo_total.setText(f"$ {costo_total:.2f}")
            else:
                self.lbl_costo_total.setText("$ 0.00")
        except:
            pass # Ignorar error si est√° vac√≠o

    def guardar_inscripcion(self):
        """Guarda la nueva inscripci√≥n en la BD."""
        curso_data = self.combo_curso.currentData()
        plan_data = self.combo_plan_pago.currentData()
        
        if not curso_data or not plan_data:
            mostrar_error("Debe seleccionar un curso y un plan de pago v√°lidos.")
            return

        try:
            curso_id = curso_data['id']
            plan_nombre, monto_total, num_pagos = plan_data
            fecha_insc = datetime.date.today().isoformat()
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                INSERT INTO inscripciones (alumno_id, curso_id, fecha_inscripcion, monto_total, estado, tipo_pago_seleccionado)
                VALUES (?, ?, ?, ?, 'Pendiente', ?)
                """, (self.alumno_id, curso_id, fecha_insc, monto_total, plan_nombre))
                
                inscripcion_id = cursor.lastrowid
                conn.commit()
            
            # Preguntar para generar PDF (opcional, pero recomendado)
            reply = QMessageBox.question(self, "Generar PDF",
                                         "Inscripci√≥n exitosa.\n¬øDesea generar la ficha de inscripci√≥n y el calendario de pagos para este nuevo curso?",
                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
            
            if reply == QMessageBox.StandardButton.Yes:
                # Usamos la funci√≥n de la VentanaPrincipal
                self.parent_window.generar_ficha_completa_pdf(inscripcion_id, imprimir_poliza=False)

            self.accept() # Cierra el di√°logo

        except Exception as e:
            mostrar_error(f"Error al guardar la inscripci√≥n: {e}\n{traceback.format_exc()}")

# --- (PEGAR ESTA NUEVA CLASE COMPLETA) ---

class DialogoEditarAlumno(QDialog):
    """
    Un di√°logo para editar los datos de un ALUMNO EXISTENTE.
    (Basado en el formulario de crear_pagina_nueva_inscripcion)
    """
    def __init__(self, alumno_id, parent=None):
        super().__init__(parent)
        self.alumno_id = alumno_id
        self.parent_window = parent # Guardamos la VentanaPrincipal
        self.setWindowTitle(f"Editar Expediente - Alumno ID: {self.alumno_id}")
        self.setMinimumSize(800, 600)
        self.ruta_foto_temporal = None # Para manejar cambios de foto

        # --- Layout Principal (con Scroll) ---
        self.layout_principal = QVBoxLayout(self)
        self.scroll_area = QScrollArea()
        self.scroll_area.setWidgetResizable(True)
        
        self.scroll_content = QWidget()
        self.layout_scroll = QVBoxLayout(self.scroll_content)

        # --- 1. Layout Superior (Foto y Datos Alumno) ---
        layout_superior = QHBoxLayout()
        
        # Panel de Foto
        panel_foto = QVBoxLayout()
        self.lbl_foto_registro = QLabel("Sin Foto")
        self.lbl_foto_registro.setFixedSize(150, 200)
        self.lbl_foto_registro.setStyleSheet("background-color: #E0E0E0; border: 1px solid #A0A0A0;")
        self.lbl_foto_registro.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        btn_tomar_foto = QPushButton("üì∏ Tomar Foto")
        btn_tomar_foto.clicked.connect(self.tomar_foto_webcam)
        btn_cargar_foto = QPushButton("üìÇ Cargar Foto")
        btn_cargar_foto.clicked.connect(self.cargar_foto_desde_archivo)
        
        panel_foto.addWidget(self.lbl_foto_registro)
        panel_foto.addWidget(btn_tomar_foto)
        panel_foto.addWidget(btn_cargar_foto)
        panel_foto.addStretch()
        layout_superior.addLayout(panel_foto)

        # Panel de Datos Alumno
        group_alumno = QGroupBox("Datos del Alumno")
        form_alumno = QFormLayout(group_alumno)
        self.entry_al_ap_paterno = QLineEdit()
        self.entry_al_ap_materno = QLineEdit()
        self.entry_al_nombres = QLineEdit()
        self.entry_al_escuela_procedencia = QLineEdit()
        self.entry_al_escuela_ingresar = QLineEdit()
        self.entry_al_edad = QLineEdit() 
        self.entry_al_telefono = QLineEdit()
        self.entry_al_email = QLineEdit()
        self.combo_al_turno = QComboBox()
        self.combo_al_turno.addItems(["Matutino", "Vespertino"])
        self.check_autoriza_salida = QCheckBox("Autoriza que el alumno se retire solo del plantel")

        form_alumno.addRow("Apellido Paterno:", self.entry_al_ap_paterno)
        form_alumno.addRow("Apellido Materno:", self.entry_al_ap_materno)
        form_alumno.addRow("Nombre(s):", self.entry_al_nombres)
        form_alumno.addRow("Escuela de Procedencia:", self.entry_al_escuela_procedencia)
        form_alumno.addRow("Escuela a Ingresar:", self.entry_al_escuela_ingresar)
        form_alumno.addRow("Edad:", self.entry_al_edad)
        form_alumno.addRow("Tel√©fono (Alumno):", self.entry_al_telefono)
        form_alumno.addRow("Correo Electr√≥nico:", self.entry_al_email)
        form_alumno.addRow("Turno:", self.combo_al_turno)
        form_alumno.addRow("", self.check_autoriza_salida) 
        
        layout_superior.addWidget(group_alumno)
        self.layout_scroll.addLayout(layout_superior)

        # --- 2. Grupo Datos del Tutor ---
        group_tutor = QGroupBox("Datos del Padre o Tutor")
        form_tutor = QFormLayout(group_tutor)
        self.entry_tutor_ap_paterno = QLineEdit()
        self.entry_tutor_ap_materno = QLineEdit()
        self.entry_tutor_nombres = QLineEdit()
        self.entry_tutor_telefono = QLineEdit()
        form_tutor.addRow("Apellido Paterno:", self.entry_tutor_ap_paterno)
        form_tutor.addRow("Apellido Materno:", self.entry_tutor_ap_materno)
        form_tutor.addRow("Nombre(s):", self.entry_tutor_nombres)
        form_tutor.addRow("Tel√©fono (Tutor):", self.entry_tutor_telefono)
        self.layout_scroll.addWidget(group_tutor)

        # --- 3. Grupo Domicilio del Tutor ---
        group_domicilio = QGroupBox("Domicilio del Tutor")
        form_domicilio = QFormLayout(group_domicilio)
        self.entry_dom_calle = QLineEdit()
        self.entry_dom_num_ext = QLineEdit()
        self.entry_dom_num_int = QLineEdit()
        self.entry_dom_colonia = QLineEdit()
        self.entry_dom_municipio = QLineEdit()
        self.entry_dom_estado = QLineEdit()
        self.entry_dom_cp = QLineEdit()
        form_domicilio.addRow("Calle:", self.entry_dom_calle)
        form_domicilio.addRow("N√∫mero Exterior:", self.entry_dom_num_ext)
        form_domicilio.addRow("N√∫mero Interior:", self.entry_dom_num_int)
        form_domicilio.addRow("Colonia:", self.entry_dom_colonia)
        form_domicilio.addRow("Municipio:", self.entry_dom_municipio)
        form_domicilio.addRow("Estado:", self.entry_dom_estado)
        form_domicilio.addRow("C√≥digo Postal:", self.entry_dom_cp)
        self.layout_scroll.addWidget(group_domicilio)

        # --- 4. Grupo Contactos de Emergencia ---
        group_emergencia = QGroupBox("Contactos de Emergencia")
        layout_emergencia = QFormLayout(group_emergencia)
        self.entry_emerg_1_nombre = QLineEdit()
        self.entry_emerg_1_telefono = QLineEdit()
        self.entry_emerg_1_parentesco = QLineEdit()
        self.entry_emerg_2_nombre = QLineEdit()
        self.entry_emerg_2_telefono = QLineEdit()
        self.entry_emerg_2_parentesco = QLineEdit()
        layout_emergencia.addRow("Nombre Completo 1:", self.entry_emerg_1_nombre)
        layout_emergencia.addRow("Tel√©fono 1:", self.entry_emerg_1_telefono)
        layout_emergencia.addRow("Parentesco 1:", self.entry_emerg_1_parentesco)
        layout_emergencia.addRow("Nombre Completo 2:", self.entry_emerg_2_nombre)
        layout_emergencia.addRow("Tel√©fono 2:", self.entry_emerg_2_telefono)
        layout_emergencia.addRow("Parentesco 2:", self.entry_emerg_2_parentesco)
        self.layout_scroll.addWidget(group_emergencia)

        # --- 5. Configuraci√≥n del Scroll y Botones ---
        self.layout_scroll.addStretch()
        self.scroll_area.setWidget(self.scroll_content)
        self.layout_principal.addWidget(self.scroll_area)

        layout_botones = QHBoxLayout()
        self.btn_guardar = QPushButton("Guardar Cambios")
        self.btn_guardar.setObjectName("primaryButton")
        self.btn_guardar.clicked.connect(self.guardar_cambios_alumno)
        btn_cancelar = QPushButton("Cancelar")
        btn_cancelar.clicked.connect(self.reject)
        layout_botones.addStretch()
        layout_botones.addWidget(btn_cancelar)
        layout_botones.addWidget(self.btn_guardar)
        self.layout_principal.addLayout(layout_botones)

        # Cargar los datos existentes
        self.cargar_datos_alumno()

    def cargar_datos_alumno(self):
        """Carga los datos del alumno_id en los campos del formulario."""
        try:
            with get_db_connection() as conn:
                datos = conn.cursor().execute("SELECT * FROM alumnos WHERE id = ?", (self.alumno_id,)).fetchone()
            
            if datos:
                self.entry_al_ap_paterno.setText(datos['apellido_paterno'])
                self.entry_al_ap_materno.setText(datos['apellido_materno'])
                self.entry_al_nombres.setText(datos['nombres'])
                self.entry_al_escuela_procedencia.setText(datos['escuela_procedencia'])
                self.entry_al_escuela_ingresar.setText(datos['escuela_ingresar'])
                self.entry_al_edad.setText(str(datos['edad']))
                self.entry_al_telefono.setText(datos['telefono'])
                self.entry_al_email.setText(datos['email'])
                self.combo_al_turno.setCurrentText(datos['turno'])
                self.check_autoriza_salida.setChecked(bool(datos['autoriza_salida_solo']))
                
                self.entry_tutor_ap_paterno.setText(datos['tutor_ap_paterno'])
                self.entry_tutor_ap_materno.setText(datos['tutor_ap_materno'])
                self.entry_tutor_nombres.setText(datos['tutor_nombres'])
                self.entry_tutor_telefono.setText(datos['tutor_telefono'])
                
                self.entry_dom_calle.setText(datos['dom_calle'])
                self.entry_dom_num_ext.setText(datos['dom_num_ext'])
                self.entry_dom_num_int.setText(datos['dom_num_int'])
                self.entry_dom_colonia.setText(datos['dom_colonia'])
                self.entry_dom_municipio.setText(datos['dom_municipio'])
                self.entry_dom_estado.setText(datos['dom_estado'])
                self.entry_dom_cp.setText(datos['dom_cp'])
                
                self.entry_emerg_1_nombre.setText(datos['emerg_1_nombre'])
                self.entry_emerg_1_telefono.setText(datos['emerg_1_telefono'])
                self.entry_emerg_1_parentesco.setText(datos['emerg_1_parentesco'])
                self.entry_emerg_2_nombre.setText(datos['emerg_2_nombre'])
                self.entry_emerg_2_telefono.setText(datos['emerg_2_telefono'])
                self.entry_emerg_2_parentesco.setText(datos['emerg_2_parentesco'])
                
                self.ruta_foto_temporal = datos['foto_ruta'] # Guardamos la ruta existente
                self.mostrar_foto(datos['foto_ruta'])
        except Exception as e:
            mostrar_error(f"Error al cargar datos del alumno: {e}")

    def guardar_cambios_alumno(self):
        """Guarda los datos modificados en la BD usando UPDATE."""
        try:
            # Recolectar todos los datos (similar a registrar_alumno_e_inscribir)
            edad = int(self.entry_al_edad.text().strip()) if self.entry_al_edad.text().strip().isdigit() else 0
            autoriza_salida = 1 if self.check_autoriza_salida.isChecked() else 0

            with get_db_connection() as conn:
                cursor = conn.cursor()
                
                # 1. Actualizar datos de texto
                cursor.execute("""
                    UPDATE alumnos SET
                        apellido_paterno = ?, apellido_materno = ?, nombres = ?, escuela_procedencia = ?,
                        escuela_ingresar = ?, edad = ?, telefono = ?, email = ?, turno = ?,
                        tutor_ap_paterno = ?, tutor_ap_materno = ?, tutor_nombres = ?, tutor_telefono = ?,
                        dom_calle = ?, dom_num_int = ?, dom_num_ext = ?, dom_colonia = ?, dom_municipio = ?,
                        dom_estado = ?, dom_cp = ?,
                        emerg_1_nombre = ?, emerg_1_telefono = ?, emerg_1_parentesco = ?,
                        emerg_2_nombre = ?, emerg_2_telefono = ?, emerg_2_parentesco = ?,
                        autoriza_salida_solo = ?
                    WHERE id = ?
                """, (
                    self.entry_al_ap_paterno.text().strip(), self.entry_al_ap_materno.text().strip(), self.entry_al_nombres.text().strip(), self.entry_al_escuela_procedencia.text().strip(),
                    self.entry_al_escuela_ingresar.text().strip(), edad, self.entry_al_telefono.text().strip(), self.entry_al_email.text().strip(), self.combo_al_turno.currentText(),
                    self.entry_tutor_ap_paterno.text().strip(), self.entry_tutor_ap_materno.text().strip(), self.entry_tutor_nombres.text().strip(), self.entry_tutor_telefono.text().strip(),
                    self.entry_dom_calle.text().strip(), self.entry_dom_num_int.text().strip(), self.entry_dom_num_ext.text().strip(), self.entry_dom_colonia.text().strip(), self.entry_dom_municipio.text().strip(),
                    self.entry_dom_estado.text().strip(), self.entry_dom_cp.text().strip(),
                    self.entry_emerg_1_nombre.text().strip(), self.entry_emerg_1_telefono.text().strip(), self.entry_emerg_1_parentesco.text().strip(),
                    self.entry_emerg_2_nombre.text().strip(), self.entry_emerg_2_telefono.text().strip(), self.entry_emerg_2_parentesco.text().strip(),
                    autoriza_salida,
                    self.alumno_id
                ))
                
                # 2. Actualizar la foto (solo si se cambi√≥)
                # La ruta guardada en self.ruta_foto_temporal puede ser la original o una nueva
                if self.ruta_foto_temporal and os.path.exists(self.ruta_foto_temporal):
                    # Verificamos si la ruta es la misma que ya est√° en la BD
                    datos_actuales = conn.cursor().execute("SELECT foto_ruta FROM alumnos WHERE id = ?", (self.alumno_id,)).fetchone()
                    
                    # Si la ruta es DIFERENTE a la guardada, la procesamos
                    if self.ruta_foto_temporal != datos_actuales['foto_ruta']:
                        img = PILImage.open(self.ruta_foto_temporal)
                        img.thumbnail((400, 400), PILImage.Resampling.LANCZOS)
                        nombre_foto = f"foto_{self.alumno_id}.png"
                        ruta_final_foto = os.path.abspath(os.path.join(FOTOS_DIR, nombre_foto))
                        img.save(ruta_final_foto, "PNG")
                        cursor.execute("UPDATE alumnos SET foto_ruta = ? WHERE id = ?", (ruta_final_foto, self.alumno_id))

                conn.commit()
            
            mostrar_info("Expediente del alumno actualizado correctamente.")
            self.accept() # Cerrar el di√°logo

        except sqlite3.IntegrityError:
            mostrar_error("Error: El correo electr√≥nico ya existe para otro alumno.")
        except Exception as e:
            mostrar_error(f"Error al guardar cambios: {e}\n{traceback.format_exc()}")
    
    # --- M√©todos de Foto (Copiados de VentanaPrincipal) ---
    def tomar_foto_webcam(self):
        try:
            cap = cv2.VideoCapture(0) 
            if not cap.isOpened():
                mostrar_error("No se pudo acceder a la c√°mara web.")
                return
            while True:
                ret, frame = cap.read()
                if not ret: break
                cv2.imshow('Presione ESPACIO para capturar, ESC para salir', frame)
                key = cv2.waitKey(1)
                if key % 256 == 32: 
                    temp_filename = os.path.join(FOTOS_DIR, "temp_capture.jpg")
                    cv2.imwrite(temp_filename, frame)
                    self.ruta_foto_temporal = temp_filename # Guardamos la nueva ruta
                    self.mostrar_foto(temp_filename)
                    break
                elif key % 256 == 27: 
                    break
            cap.release()
            cv2.destroyAllWindows()
        except Exception as e:
             mostrar_error(f"Error con la c√°mara: {e}")

    def cargar_foto_desde_archivo(self):
        file_path, _ = QFileDialog.getOpenFileName(self, "Seleccionar Foto", "", "Im√°genes (*.png *.jpg *.jpeg)")
        if file_path:
            self.ruta_foto_temporal = file_path # Guardamos la nueva ruta
            self.mostrar_foto(file_path)

    def mostrar_foto(self, ruta_imagen):
        if ruta_imagen and os.path.exists(ruta_imagen):
            pixmap = QPixmap(ruta_imagen)
            if not pixmap.isNull():
                self.lbl_foto_registro.setPixmap(pixmap.scaled(self.lbl_foto_registro.size(), Qt.AspectRatioMode.KeepAspectRatio, Qt.TransformationMode.SmoothTransformation))
                self.lbl_foto_registro.setText("")
        else:
            self.lbl_foto_registro.clear()
            self.lbl_foto_registro.setText("Sin Foto")

# --- (Fin de la clase DialogoEditarAlumno) ---

# ---- Ventana de Login ----
class LoginScreen(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Sistema de Gesti√≥n Escolar - Login")
        self.resize(800, 500)
        self.username = "" 
        self.full_username = "" 
        self.user_role = "" 
        self.accept_login = False 

        self.setup_ui()
        self.apply_styles()
        self.start_time_update()

    def setup_ui(self):
        main_layout = QHBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0) 
        main_layout.setSpacing(0)

        # Panel Izquierdo: Login Form
        login_panel = QWidget()
        login_panel.setObjectName("loginPanel")
        login_layout = QVBoxLayout(login_panel)
        login_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
        login_layout.setSpacing(20)
        login_layout.setContentsMargins(50, 50, 50, 50)

        # Logo Placeholder
        self.logo_label = QLabel()
        try:
            pixmap = QPixmap(LOGO_PATH) 
            if pixmap.isNull():
                raise FileNotFoundError 

            self.logo_label.setPixmap(pixmap.scaledToHeight(150, Qt.TransformationMode.SmoothTransformation))
            self.logo_label.setAlignment(Qt.AlignmentFlag.AlignCenter)

        except FileNotFoundError:
            self.logo_label.setText("LOGO ESCUELA")
            self.logo_label.setFont(QFont("Arial", 24, QFont.Weight.Bold))
            self.logo_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            self.logo_label.setStyleSheet("color: #FFFFFF;")

        login_layout.addWidget(self.logo_label)

        # Campos de Usuario
        user_label = QLabel("Correo Electr√≥nico:") 
        user_label.setObjectName("inputLabel")
        self.username_input = QLineEdit()
        self.username_input.setPlaceholderText("admin@sistema.com") 
        self.username_input.setObjectName("textInput")
        login_layout.addWidget(user_label)
        login_layout.addWidget(self.username_input)

        # Campos de Contrase√±a
        password_label = QLabel("Contrase√±a:")
        password_label.setObjectName("inputLabel")
        self.password_input = QLineEdit()
        self.password_input.setPlaceholderText("Contrase√±a")
        self.password_input.setEchoMode(QLineEdit.EchoMode.Password)
        self.password_input.setObjectName("textInput")
        login_layout.addWidget(password_label)
        login_layout.addWidget(self.password_input)

        # Botones
        self.login_button = QPushButton("INICIAR SESI√ìN")
        self.login_button.setObjectName("primaryButton")
        self.login_button.clicked.connect(self.handle_login)
        login_layout.addWidget(self.login_button)

        self.forgot_password_button = QPushButton("RECUPERAR CONTRASE√ëA")
        self.forgot_password_button.setObjectName("secondaryButton")
        self.forgot_password_button.clicked.connect(self.show_forgot_password_message) 
        login_layout.addWidget(self.forgot_password_button)

        login_layout.addStretch() 

        main_layout.addWidget(login_panel, 2)
        self.username_input.returnPressed.connect(self.password_input.setFocus)
        self.password_input.returnPressed.connect(self.handle_login)

        # Panel Derecho: Mensaje de Bienvenida y Fondo
        self.welcome_panel = QWidget()
        self.welcome_panel.setObjectName("welcomePanel")
        welcome_layout = QVBoxLayout(self.welcome_panel)
        welcome_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        self.time_of_day_label = QLabel()
        self.time_of_day_label.setFont(QFont("Arial", 28, QFont.Weight.Bold))
        self.time_of_day_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.time_of_day_label.setStyleSheet("color: white; background-color: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px;")

        # Efecto de sombra para el label de bienvenida
        shadow = QGraphicsDropShadowEffect()
        shadow.setBlurRadius(20)
        shadow.setColor(QColor(0, 0, 0, 150))
        shadow.setXOffset(0)
        shadow.setYOffset(0)
        self.time_of_day_label.setGraphicsEffect(shadow)

        welcome_layout.addWidget(self.time_of_day_label)
        welcome_layout.addStretch() 

        # Texto inferior
        bottom_text_label = QLabel("Unidad Profesional de Asesor√≠a y Regularizaci√≥n")
        bottom_text_label.setObjectName("bottomText")
        bottom_text_label.setAlignment(Qt.AlignmentFlag.AlignBottom | Qt.AlignmentFlag.AlignCenter)
        bottom_text_label.setStyleSheet("color: white; background-color: rgba(0,0,0,0.5); padding: 5px;")
        welcome_layout.addWidget(bottom_text_label)

        main_layout.addWidget(self.welcome_panel, 3) 

    def apply_styles(self):
        # Estilos inspirados en tu imagen de ejemplo
        self.setStyleSheet("""
            QWidget {
                font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Roboto", "Segoe UI", sans-serif;
                font-size: 10pt;
            }
            #loginPanel {
                background-color: #3C3C3C; 
                color: #E0E0E0;
            }
            #welcomePanel {
                background-image: url(background.jpg);
                background-repeat: no-repeat;
                background-position: center;
                background-size: cover; 
                background-color: #F0F0F0;
            }
            #inputLabel {
                color: #E0E0E0;
                font-weight: bold;
                margin-top: 10px;
                background: transparent;
            }
            #textInput {
                background-color: #4A4A4A;
                color: #E0E0E0;
                border: 1px solid #5C5C5C;
                border-radius: 4px;
                padding: 8px;
            }
            #textInput:focus {
                border: 1px solid #007ACC;
            }
            #primaryButton {
                background-color: #4CAF50; 
                color: #FFFFFF;
                border: none;
                border-radius: 6px;
                padding: 10px 20px;
                font-weight: bold;
                font-size: 11pt;
                margin-top: 20px;
            }
            #primaryButton:hover {
                background-color: #45A049;
            }
            #primaryButton:pressed {
                background-color: #397D3D;
            }
            #secondaryButton {
                background-color: #607D8B; 
                color: #FFFFFF;
                border: none;
                border-radius: 6px;
                padding: 10px 20px;
                font-weight: bold;
                font-size: 11pt;
            }
            #secondaryButton:hover {
                background-color: #546E7A;
            }
            #secondaryButton:pressed {
                background-color: #455A64;
            }
            #bottomText {
                font-size: 9pt;
            }
        """)

    def start_time_update(self):
        self.update_time_of_day_message()
        self.timer = QTimer(self)
        self.timer.timeout.connect(self.update_time_of_day_message)
        self.timer.start(60000) 

    def update_time_of_day_message(self):
        current_hour = QDateTime.currentDateTime().time().hour()
        if 5 <= current_hour < 12:
            message = "¬°Buenos d√≠as!\nBienvenido(a)"
        elif 12 <= current_hour < 19:
            message = "¬°Buenas tardes!\nBienvenido(a)"
        else:
            message = "¬°Buenas noches!\nBienvenido(a)"
        self.time_of_day_label.setText(message)

    def handle_login(self):
        """Maneja el inicio de sesi√≥n consultando la base de datos."""
        email = self.username_input.text().strip()
        password = self.password_input.text()

        if not email or not password:
            QMessageBox.warning(self, "Error de Login", "Email y contrase√±a no pueden estar vac√≠os.")
            return

        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                # --- INICIO DE MODIFICACI√ìN: Seleccionar 'permisos' en lugar de 'rol' ---
                cursor.execute("SELECT * FROM usuarios WHERE email = ? AND password = ?", (email, password))
                usuario = cursor.fetchone()
                
            if usuario:
                self.accept_login = True
                self.username = usuario['email'] 
                self.full_username = usuario['nombre_completo']
                
                # Cargar el string JSON de la DB y convertirlo a un diccionario Python
                try:
                    self.permisos_dict = json.loads(usuario['permisos'])
                except json.JSONDecodeError:
                    # Fallback por si el JSON est√° corrupto
                    self.permisos_dict = {"is_admin": False} 
                
                # Guardar el rol anterior por compatibilidad (aunque usaremos el dict)
                self.user_role = "Administrador" if self.permisos_dict.get("is_admin") else "Asesor"
                # --- FIN DE MODIFICACI√ìN ---
                
                self.close() 
            else:
                QMessageBox.warning(self, "Error de Login", "Email o contrase√±a incorrectos.")
                self.password_input.clear()
                self.username_input.setFocus() 

        except sqlite3.Error as e:
            mostrar_error(f"Error en la base de datos al iniciar sesi√≥n: {e}")

    def show_forgot_password_message(self):
        """Muestra un di√°logo para resetear la contrase√±a de un usuario."""
        email, ok = QInputDialog.getText(self, "Recuperar Contrase√±a",
                                           "Ingrese su correo electr√≥nico para resetear la contrase√±a:")
        
        if ok and email:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("SELECT id, rol FROM usuarios WHERE email = ?", (email,))
                    usuario = cursor.fetchone()
                    
                if usuario:
                    # Protecci√≥n para el admin ID 1
                    if usuario['id'] == 1:
                        mostrar_error("No se puede resetear la contrase√±a del Administrador principal. Contacte al soporte.")
                        return

                    # Generar nueva contrase√±a
                    nueva_password = secrets.token_hex(4) 
                    
                    with get_db_connection() as conn:
                        cursor = conn.cursor()
                        cursor.execute("UPDATE usuarios SET password = ? WHERE email = ?", (nueva_password, email))
                        conn.commit()
                    
                    mostrar_info(f"La contrase√±a para {email} ha sido reseteada.\n\n"
                                 f"Su nueva contrase√±a es: {nueva_password}\n\n"
                                 "Por favor, √∫sela para iniciar sesi√≥n y c√°mbiela si es necesario.")
                else:
                    mostrar_error("No se encontr√≥ ning√∫n usuario con ese correo electr√≥nico.")
                    
            except sqlite3.Error as e:
                mostrar_error(f"Error en la base de datos al iniciar sesi√≥n: {e}")
            except Exception as e:
                 mostrar_error(f"Error inesperado: {e}")

    def closeEvent(self, event):
        if not self.accept_login:
            sys.exit(0)
        event.permisos_dict = self.permisos_dict 
        event.accept()

# ---- Ventana Principal de la Aplicaci√≥n (REDISE√ëADA AL ESTILO DASHBOARD) ----
class VentanaPrincipal(QMainWindow):
    def __init__(self, username, full_username, user_role, permisos_dict):
        super().__init__()
        self.username = username
        self.full_username = full_username 
        self.user_role = user_role
        self.permisos = permisos_dict
        self.logout_solicitado = False 
        self._temp_pdf_files = [] 
        self.usuario_seleccionado_id = None 
        self.curso_seleccionado_id = None 
        
        # Almacenamiento local de inscripciones para el filtro de pagos
        self._inscripciones_cache = [] 
        self.descuento_actual_pct = 0.0
        self.costo_original_actual = 0.0

        self.spin_costo_sem_2 = None 
        self.spin_costo_mensual_3 = None
        self.spin_costo_mensual_4 = None

        self.setWindowTitle("Sistema de Gesti√≥n Escolar - UPASER")
        self.setGeometry(100, 100, 1200, 700)
        self.setMinimumSize(1024, 700) 
        
        # --- IDIOMA A ESPA√ëOL ---
        self.locale = QLocale(QLocale.Language.Spanish, QLocale.Country.Mexico)
        QLocale.setDefault(self.locale)

        # --- Cargar configuraci√≥n de tema ---
        self.theme, self.accent = self.cargar_configuracion_tema()
        self.aplicar_estilo_actual()

        # Configurar UI
        self.init_ui()

        # Cargar datos iniciales
        self.cargar_datos_maestros()

        # REMOVIDO: self.iniciar_timer_reloj()
        
        # Conectar se√±al de cierre para limpiar archivos temporales
        app.aboutToQuit.connect(self.limpiar_archivos_temporales)

    # --- NUEVA FUNCI√ìN DE PDF: draw_text_pdf ---
    def draw_text_pdf(self, c, current_y, texto, x, style):
        """Dibuja un Paragraph de ReportLab y maneja saltos de p√°gina."""
        width, height = letter
        
        p = Paragraph(texto.replace('\n', '<br/>'), style)
        p_width, p_height = p.wrapOn(c, width - (x + inch), height)

        # Si no cabe
        if current_y - p_height < inch:
            self.draw_watermark(c, width, height)
            c.showPage()
            self.draw_watermark(c, width, height)
            current_y = height - inch
            self.draw_logo(c, width, height)

        p.drawOn(c, x, current_y - p_height)
        current_y -= (p_height + 4) 
        return current_y 

    # --- NUEVA FUNCI√ìN DE PDF: draw_logo ---
    def draw_logo(self, canvas_obj, page_width, page_height):
         if os.path.exists(LOGO_PATH):
             try:
                logo_img = Image(LOGO_PATH, width=1*inch, height=1*inch)
                logo_img.drawOn(canvas_obj, 0.5 * inch, page_height - 1.25 * inch)
             except Exception as img_err:
                 print(f"Error al dibujar logo: {img_err}")


    # --- NUEVA FUNCI√ìN DE PDF: draw_watermark ---
    def draw_watermark(self, canvas_obj, page_width, page_height):
         if os.path.exists(LOGO_PATH):
           try:
                 canvas_obj.saveState()
                 canvas_obj.setFillAlpha(0.15)
                 img = Image(LOGO_PATH)
                 img_width, img_height = img.wrap(page_width, page_height)
                
                 aspect = img_height / float(img_width) if img_width else 1
                 
                 display_width = page_width * 0.6
                 display_height = display_width * aspect
                 x_centered = (page_width - display_width) / 2.0
                 y_centered = (page_height - display_height) / 2.0
                 canvas_obj.drawImage(LOGO_PATH, x_centered, y_centered,
                                      width=display_width, height=display_height,
                                      mask='auto')
                 canvas_obj.restoreState()
           except Exception as wm_err:
                 print(f"Error al dibujar marca de agua: {wm_err}")
    
    # --- NUEVA FUNCI√ìN DE PDF: draw_double_signature ---
    def draw_double_signature(self, c, y_position):
        width, height = letter
        c.line(inch, y_position, inch * 4, y_position)
        c.setFont(FONT_NAME, 10)
        c.drawCentredString(inch * 2.5, y_position - 0.2 * inch, "Firma del Padre o Tutor")
        
        c.line(width - inch * 4, y_position, width - inch, y_position)
        c.setFont(FONT_NAME, 10)
        c.drawCentredString(width - inch * 2.5, y_position - 0.2 * inch, "Firma del Alumno")


    def init_ui(self):
        """Inicializa la interfaz de usuario principal con estilo dashboard."""

        # Widget central y layout principal vertical
        widget_central = QWidget()
        self.setCentralWidget(widget_central)
        layout_principal = QVBoxLayout(widget_central)
        layout_principal.setContentsMargins(0, 0, 0, 0)
        layout_principal.setSpacing(0)

        # 1. Barra Superior de Informaci√≥n
        barra_superior = self.crear_barra_superior()
        layout_principal.addWidget(barra_superior)

        # 2. Layout de Contenido Principal (Horizontal)
        layout_contenido = QHBoxLayout()
        layout_contenido.setSpacing(0)

        # 2.1. Panel de Navegaci√≥n (Izquierda)
        panel_navegacion = self.crear_panel_navegacion()
        layout_contenido.addWidget(panel_navegacion)

        # 2.2. Panel de Contenido (Derecha)
        self.stacked_widget = QStackedWidget()
        self.stacked_widget.setObjectName("mainContentArea")

        # Crear las p√°ginas
        self.pagina_inicio = self.crear_pagina_inicio()
        self.pagina_inscripcion = self.crear_pagina_nueva_inscripcion() 
        self.pagina_pagos = self.crear_pagina_pagos()
        self.pagina_lista_alumnos = self.crear_pagina_lista_alumnos() 
        self.pagina_gestion_cursos = self.crear_pagina_gestion_cursos() 
        self.pagina_gestion_usuarios = self.crear_pagina_gestion_usuarios()
        self.pagina_gestion_materias = self.crear_pagina_gestion_materias()
        self.pagina_gestion_calificaciones = self.crear_pagina_gestion_calificaciones()
        self.pagina_configuracion = self.crear_pagina_configuracion()
        self.pagina_gestion_personal = self.crear_pagina_gestion_personal() # NUEVA P√ÅGINA

        # A√±adir p√°ginas al StackedWidget 
        self.stacked_widget.addWidget(self.pagina_inicio) 
        self.stacked_widget.addWidget(self.pagina_inscripcion) 
        self.stacked_widget.addWidget(self.pagina_pagos) 
        self.stacked_widget.addWidget(self.pagina_lista_alumnos) 
        self.stacked_widget.addWidget(self.pagina_gestion_cursos) 
        self.stacked_widget.addWidget(self.pagina_gestion_usuarios)
        self.stacked_widget.addWidget(self.pagina_gestion_materias)
        self.stacked_widget.addWidget(self.pagina_gestion_calificaciones) 
        self.stacked_widget.addWidget(self.pagina_configuracion)
        self.stacked_widget.addWidget(self.pagina_gestion_personal) # √çNDICE 9

        layout_contenido.addWidget(self.stacked_widget, 1) 

        # A√±adir el layout de contenido al layout principal
        layout_principal.addLayout(layout_contenido)

        # Conectar botones de navegaci√≥n a las p√°ginas 
        self.btn_nav_inicio.clicked.connect(lambda: self.cambiar_pagina(0))
        self.btn_nav_inscripcion.clicked.connect(lambda: self.cambiar_pagina(1)) 
        self.btn_nav_pagos.clicked.connect(lambda: self.cambiar_pagina(2))
        self.btn_nav_lista_alumnos.clicked.connect(lambda: self.cambiar_pagina(3)) 
        
        # Conectar botones de admin si existen
        if hasattr(self, 'btn_nav_gestion_cursos'):
            self.btn_nav_gestion_cursos.clicked.connect(lambda: self.cambiar_pagina(4))
        if hasattr(self, 'btn_nav_gestion_usuarios'):
            self.btn_nav_gestion_usuarios.clicked.connect(lambda: self.cambiar_pagina(5))
        if hasattr(self, 'btn_nav_config'):
            self.btn_nav_config.clicked.connect(lambda: self.cambiar_pagina(8))
           
        
        self.btn_logout.clicked.connect(self.cerrar_sesion)

        # Establecer p√°gina inicial
        self.cambiar_pagina(0)

    def crear_barra_superior(self):
        """Crea la barra de informaci√≥n superior."""
        widget = QWidget()
        widget.setObjectName("topBar")
        widget.setFixedHeight(50)
        layout = QHBoxLayout(widget)
        layout.setContentsMargins(15, 5, 15, 5)

        icon_usuario = QLabel("üë§")
        icon_usuario.setFont(QFont("Helvetica Neue", 16))
        icon_usuario.setObjectName("topBarIcon") 

        info_layout = QVBoxLayout()
        info_layout.setSpacing(0)
        self.lbl_usuario_top = QLabel(f"Usuario: {self.full_username} ({self.user_role})") 
        self.lbl_usuario_top.setObjectName("topBarUser")

        # ELIMINADAS LAS ETIQUETAS DE FECHA Y HORA
        
        info_layout.addWidget(self.lbl_usuario_top)

        layout.addWidget(icon_usuario)
        layout.addLayout(info_layout)

        layout.addStretch()

        # Icono de logout 
        self.btn_logout = QPushButton("üö™")
        self.btn_logout.setObjectName("topBarButton")
        self.btn_logout.setToolTip("Cerrar Sesi√≥n")

        layout.addWidget(self.btn_logout)

        return widget


    def crear_panel_navegacion(self):
        """Crea el panel de navegaci√≥n izquierdo."""
        panel = QWidget()
        panel.setObjectName("navBar")
        panel.setFixedWidth(200)
        layout = QVBoxLayout(panel)
        layout.setContentsMargins(0, 10, 0, 10)
        layout.setSpacing(5)

        # Contenedor para el bot√≥n de Men√∫
        menu_frame = QFrame()
        menu_layout = QVBoxLayout(menu_frame)
        menu_layout.setContentsMargins(0, 0, 0, 0)
        
        # Bot√≥n de Inicio (siempre visible)
        self.btn_nav_inicio = QPushButton("üè†  Inicio")
        self.btn_nav_inicio.setObjectName("navButton")
        menu_layout.addWidget(self.btn_nav_inicio)
        
        # Bot√≥n Men√∫ que abrir√° el QMenu
        self.btn_menu = QPushButton("‚ò∞ Men√∫")
        self.btn_menu.setObjectName("navButton")
        self.btn_menu.clicked.connect(self.show_navigation_menu)
        menu_layout.addWidget(self.btn_menu)
        
        layout.addWidget(menu_frame)
        
        # Spacer para empujar el men√∫ hacia arriba y el de Configuraci√≥n hacia abajo
        spacer = QSpacerItem(20, 40, QSizePolicy.Policy.Minimum, QSizePolicy.Policy.Expanding)
        layout.addItem(spacer)

        # Lista completa de botones (solo se usan para el QMenu y el QStackedWidget)
        self.btn_nav_inscripcion = QPushButton("üìù  Nueva Inscripci√≥n")
        self.btn_nav_pagos = QPushButton("üíµ  Registro de Pagos")
        self.btn_nav_lista_alumnos = QPushButton("üë•  Lista de Alumnos") 
        self.btn_nav_gestion_cursos = QPushButton("üìö  Gestionar Cursos")
        self.btn_nav_gestion_usuarios = QPushButton("üë§  Gestionar Usuarios")
        self.btn_nav_config = QPushButton("‚öôÔ∏è  Configuraci√≥n")
        
        self.nav_buttons = [
            self.btn_nav_inicio, 
            self.btn_nav_inscripcion, 
            self.btn_nav_pagos,
            self.btn_nav_lista_alumnos,
            self.btn_nav_gestion_cursos,
            self.btn_nav_gestion_usuarios,
            self.btn_nav_config
        ]
        
        # Asegurarse de que solo se muestren Inicio y Men√∫
        self.btn_nav_inscripcion.setVisible(False)
        self.btn_nav_pagos.setVisible(False)
        self.btn_nav_lista_alumnos.setVisible(False)
        self.btn_nav_gestion_cursos.setVisible(False)
        self.btn_nav_gestion_usuarios.setVisible(False)
        self.btn_nav_config.setVisible(False)
        
        # Aplicar el mismo ObjectName a todos los botones para el estilo
        for btn in self.nav_buttons:
            if btn: 
                btn.setObjectName("navButton")

        return panel

    def show_navigation_menu(self):
        """Muestra el men√∫ contextual con las opciones de navegaci√≥n."""
        menu = QMenu(self)
        
        # Acciones principales
        menu.addAction("üìù Nueva Inscripci√≥n", lambda: self.cambiar_pagina(1))
        menu.addAction("üíµ Registro de Pagos", lambda: self.cambiar_pagina(2))
        menu.addAction("üë• Lista de Alumnos", lambda: self.cambiar_pagina(3))
        
        # Secci√≥n de Administraci√≥n (solo si es Admin)
        if self.permisos.get('is_admin'): # O usar permisos espec√≠ficos
            menu.addSeparator()
            menu.addAction("üìö Gestionar Cursos", lambda: self.cambiar_pagina(4))
            menu.addAction("üë§ Gestionar Usuarios", lambda: self.cambiar_pagina(5))
            menu.addAction("üë®‚Äçüíº Gestionar Personal", lambda: self.cambiar_pagina(9))
            menu.addAction("üìñ Gestionar Materias", lambda: self.cambiar_pagina(6))
            menu.addAction("üìä Asignar Calificaciones", lambda: self.cambiar_pagina(7))
            menu.addSeparator()
            menu.addAction("‚öôÔ∏è Configuraci√≥n", lambda: self.cambiar_pagina(8))
            
        # Mostrar el men√∫ justo debajo del bot√≥n "Men√∫"
        # Usamos mapToGlobal para obtener la posici√≥n global del bot√≥n
        # Nota: Necesitas importar QPoint
        try:
            point = self.btn_menu.mapToGlobal(QPoint(0, self.btn_menu.height()))
            menu.exec(point)
        except AttributeError:
             # Fallback si QPoint no est√° definido o hay error de widget
             menu.exec(self.mapToGlobal(QPoint(0, self.height() / 2)))


    def crear_pagina_inicio(self):
        """Crea la p√°gina de bienvenida con accesos directos."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout = QVBoxLayout(widget)
        layout.setContentsMargins(25, 25, 25, 25)
        layout.setSpacing(20)

        lbl_bienvenida = QLabel(f"¬°¬°BIENVENIDO(A), {self.full_username}!!")
        lbl_bienvenida.setObjectName("welcomeTitle")
        lbl_bienvenida.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(lbl_bienvenida)

        lbl_accesos = QLabel("Accesos directos")
        lbl_accesos.setObjectName("shortcutsTitle")
        layout.addWidget(lbl_accesos)

        # Contenedor de accesos directos
        layout_accesos = QHBoxLayout()
        layout_accesos.setSpacing(30)

        # "Nueva Inscripci√≥n" va a p√°gina 1 (formulario)
        btn_sc_inscribir = self.crear_boton_acceso("üìù", "Nueva Inscripci√≥n", lambda: self.cambiar_pagina(1))
        # "Registrar Pago" va a p√°gina 2
        btn_sc_pagar = self.crear_boton_acceso("üíµ", "Registrar Pago", lambda: self.cambiar_pagina(2))
        # "Consultar Alumnos" va a p√°gina 3 (lista alumnos)
        btn_sc_gestionar = self.crear_boton_acceso("üë•", "Consultar Alumnos", lambda: self.cambiar_pagina(3))
        
        layout_accesos.addWidget(btn_sc_inscribir)
        layout_accesos.addWidget(btn_sc_pagar)
        layout_accesos.addWidget(btn_sc_gestionar)
        
        # --- A√ëADIR ACCESOS DE ADMIN ---
        if self.permisos.get('can_manage_courses') or self.permisos.get('is_admin'):
            btn_sc_cursos = self.crear_boton_acceso("üìö", "Gestionar Cursos", lambda: self.cambiar_pagina(4))
            layout_accesos.addWidget(btn_sc_cursos)
            btn_sc_personal = self.crear_boton_acceso("üë®‚Äçüíº", "Gestionar Personal", lambda: self.cambiar_pagina(9))
            layout_accesos.addWidget(btn_sc_personal)
        if self.permisos.get('can_manage_users') or self.permisos.get('is_admin'):
            btn_sc_usuarios = self.crear_boton_acceso("üë§", "Gestionar Usuarios", lambda: self.cambiar_pagina(5))
            layout_accesos.addWidget(btn_sc_usuarios)
            
        layout_accesos.addStretch()

        layout.addLayout(layout_accesos)
        layout.addStretch()
        return widget
    
    def crear_boton_acceso(self, icono, texto, on_click):
        """Crea un bot√≥n de acceso directo (icono + texto)."""
        widget = QWidget()
        widget.setObjectName("shortcutButton")
        layout = QVBoxLayout(widget)

        btn = QPushButton(icono)
        btn.setObjectName("shortcutIcon")
        btn.setFixedSize(100, 100)
        btn.clicked.connect(on_click)

        lbl = QLabel(texto)
        lbl.setAlignment(Qt.AlignmentFlag.AlignCenter)
        lbl.setObjectName("shortcutLabel")

        layout.addWidget(btn)
        layout.addWidget(lbl)

        return widget


    def _acceso(self, icono, texto, on_click):
        """Crea un bot√≥n de acceso directo (icono + texto)."""
        widget = QWidget()
        widget.setObjectName("shortcutButton")
        layout = QVBoxLayout(widget)

        btn = QPushButton(icono)
        btn.setObjectName("shortcutIcon")
        btn.setFixedSize(100, 100)
        btn.clicked.connect(on_click)

        lbl = QLabel(texto)
        lbl.setAlignment(Qt.AlignmentFlag.AlignCenter)
        lbl.setObjectName("shortcutLabel")

        layout.addWidget(btn)
        layout.addWidget(lbl)

        return widget

    def cambiar_pagina(self, index):
        """Cambia la p√°gina visible en el QStackedWidget con una animaci√≥n de deslizamiento."""
        
        # 1. Evitar recargar la misma p√°gina si ya est√° activa
        if self.stacked_widget.currentIndex() == index:
            return

        # 2. Resetear estilos de todos los botones principales
        for btn in self.nav_buttons:
            if btn: 
                btn.setProperty("selected", False)
                self.style().polish(btn)

        boton_activo = None

        # 3. L√≥gica de preparaci√≥n de datos (IGUAL QUE ANTES, PERO SIN setCurrentIndex)
        if index == 0: 
            boton_activo = self.btn_nav_inicio
        elif index == 1: 
            boton_activo = self.btn_nav_inscripcion
            self.cargar_combo_curso_registro() 
        elif index == 2: 
            boton_activo = self.btn_nav_pagos
            self.cargar_tabla_inscripciones_pagos() 
        elif index == 3: 
            boton_activo = self.btn_nav_lista_alumnos
            self.cargar_tabla_alumnos() 
            self.cargar_cursos_para_filtro() 
        elif index == 4: 
             if self.permisos.get('can_manage_courses') or self.permisos.get('is_admin'):
                boton_activo = self.btn_nav_gestion_cursos
                self.cargar_tabla_cursos() # Es bueno cargar antes de mostrar
        elif index == 5: 
            if self.permisos.get('can_manage_users') or self.permisos.get('is_admin'):
                boton_activo = self.btn_nav_gestion_usuarios
                self.cargar_tabla_usuarios()
        elif index == 6: 
            if self.permisos.get('can_manage_subjects') or self.permisos.get('is_admin'):
                # boton_activo = ... (Si tuvieras bot√≥n para esto)
                self.cargar_combo_cursos_materias()
        elif index == 7: 
            if self.permisos.get('can_assign_grades') or self.permisos.get('is_admin'):
                # boton_activo = ...
                self.cargar_combo_cursos_calif()
        elif index == 8:
            if self.permisos.get('can_access_settings') or self.permisos.get('is_admin'):
                boton_activo = self.btn_nav_config
        elif index == 9: # P√°gina de Gesti√≥n de Personal
             if self.permisos.get('is_admin'): # O el permiso que decidas
                # boton_activo = ... (No hay bot√≥n principal, se maneja por men√∫)
                self.cargar_tabla_personal()

        # 4. --- INICIO DE ANIMACI√ìN ESTILO MACOS ---
        # Obtenemos el widget que va a entrar y el ancho actual del contenedor
        widget_entrante = self.stacked_widget.widget(index)
        ancho = self.stacked_widget.frameRect().width()
        alto = self.stacked_widget.frameRect().height()

        # Colocamos la p√°gina entrante fuera de la pantalla (a la derecha)
        widget_entrante.setGeometry(ancho, 0, ancho, alto)
        
        # La hacemos visible inmediatamente (aunque est√© fuera del √°rea visible)
        self.stacked_widget.setCurrentIndex(index)
        
        # Creamos la animaci√≥n de deslizamiento
        self.animacion = QPropertyAnimation(widget_entrante, b"pos")
        self.animacion.setDuration(300)  # Duraci√≥n en milisegundos (ajustable)
        self.animacion.setStartValue(QPoint(ancho, 0))
        self.animacion.setEndValue(QPoint(0, 0))
        self.animacion.setEasingCurve(QEasingCurve.Type.InOutCubic) # Curva de aceleraci√≥n suave
        self.animacion.start()
        # 5. --- FIN DE ANIMACI√ìN ---

        # 6. Poner estilo seleccionado al bot√≥n activo (si aplica)
        if boton_activo:
            boton_activo.setProperty("selected", True)
            self.style().polish(boton_activo)


    def cerrar_sesion(self):
        """Cierra la sesi√≥n y vuelve al login."""
        self.logout_solicitado = True
        self.close()

    # ---- P√ÅGINA 1: NUEVA INSCRIPCI√ìN (Formulario Detallado) ----
    def crear_pagina_nueva_inscripcion(self):
        """Crea la interfaz para la p√°gina de NUEVA INSCRIPCI√ìN (Formulario detallado)."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_principal = QVBoxLayout(widget) 
        layout_principal.setContentsMargins(15, 15, 15, 15)

        scroll_area = QScrollArea() 
        scroll_area.setWidgetResizable(True)

        # Widget contenedor para el layout dentro del scroll
        scroll_content_widget = QWidget()
        layout_nuevo_alumno = QVBoxLayout(scroll_content_widget) 

        # --- 1. Crear los layouts contenedores ---
        layout_superior = QHBoxLayout()
        panel_foto = QVBoxLayout() # <--- ¬°IMPORTANTE! Se debe crear AQU√ç, al principio.

        # --- 2. Configurar el √°rea de la foto ---
        self.lbl_foto_registro = QLabel()
        self.lbl_foto_registro.setFixedSize(150, 200)
        self.lbl_foto_registro.setStyleSheet("background-color: #E0E0E0; border: 1px solid #A0A0A0;")
        self.lbl_foto_registro.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.lbl_foto_registro.setText("Sin Foto")
        self.ruta_foto_temporal = None 

        btn_tomar_foto = QPushButton("üì∏ Tomar Foto")
        btn_tomar_foto.clicked.connect(self.tomar_foto_webcam)
        btn_cargar_foto = QPushButton("üìÇ Cargar Foto")
        btn_cargar_foto.clicked.connect(self.cargar_foto_desde_archivo)

        panel_foto.addWidget(self.lbl_foto_registro)
        panel_foto.addWidget(btn_tomar_foto)
        panel_foto.addWidget(btn_cargar_foto)
        panel_foto.addStretch()

        # --- 3. Crear el grupo de datos del alumno ---
        group_alumno = QGroupBox("Datos del Alumno")
        form_alumno = QFormLayout(group_alumno)
        self.entry_al_ap_paterno = QLineEdit()
        self.entry_al_ap_materno = QLineEdit()
        self.entry_al_nombres = QLineEdit()
        self.entry_al_escuela_procedencia = QLineEdit()
        self.entry_al_escuela_ingresar = QLineEdit()
        self.entry_al_edad = QLineEdit() 
        self.entry_al_telefono = QLineEdit()
        self.entry_al_email = QLineEdit()
        self.combo_al_turno = QComboBox()
        self.combo_al_turno.addItems(["Matutino", "Vespertino"])

        self.combo_curso_registro = QComboBox() 
        self.combo_tipo_pago_registro = QComboBox() 
        self.lbl_costo_total_registro = QLabel("$ 0.00") 
        self.lbl_costo_total_registro.setStyleSheet("font-weight: bold; color: #4CAF50; font-size: 11pt;")

        self.check_autoriza_salida = QCheckBox("Autoriza que el alumno se retire solo del plantel")
        self.check_imprimir_poliza = QCheckBox("Imprimir P√≥liza de Garant√≠a y T√©rminos y Condiciones")
        self.check_aplicar_descuento = QCheckBox("Aplicar Descuento Personalizado")
        self.lbl_descuento_info = QLabel("")
        self.lbl_descuento_info.setStyleSheet("color: gray; font-style: italic;")

        form_alumno.addRow("Apellido Paterno:", self.entry_al_ap_paterno)
        form_alumno.addRow("Apellido Materno:", self.entry_al_ap_materno)
        form_alumno.addRow("Nombre(s):", self.entry_al_nombres)
        form_alumno.addRow("Escuela de Procedencia:", self.entry_al_escuela_procedencia)
        form_alumno.addRow("Escuela a Ingresar:", self.entry_al_escuela_ingresar)
        form_alumno.addRow("Edad:", self.entry_al_edad)
        form_alumno.addRow("Tel√©fono (Alumno):", self.entry_al_telefono)
        form_alumno.addRow("Correo Electr√≥nico:", self.entry_al_email)
        form_alumno.addRow("Turno:", self.combo_al_turno)
        form_alumno.addRow("Curso a Inscribir:", self.combo_curso_registro)
        form_alumno.addRow("Plan de Pago:", self.combo_tipo_pago_registro)
        form_alumno.addRow("Costo Total:", self.lbl_costo_total_registro)
        form_alumno.addRow("", self.check_autoriza_salida) 
        form_alumno.addRow("", self.check_imprimir_poliza)
        form_alumno.addRow("", self.check_aplicar_descuento)
        form_alumno.addRow("", self.lbl_descuento_info)

        # Conectar se√±ales
        self.combo_curso_registro.currentIndexChanged.connect(self.actualizar_opciones_pago)
        self.combo_tipo_pago_registro.currentIndexChanged.connect(self.actualizar_costo_total_label)
        self.check_aplicar_descuento.toggled.connect(self.solicitar_y_aplicar_descuento)

        # --- 4. A√±adir los paneles al layout superior ---
        # AHORA S√ç funcionar√° porque 'panel_foto' ya fue creado en el paso 1
        layout_superior.addLayout(panel_foto)
        layout_superior.addWidget(group_alumno)

        # --- 5. A√±adir el layout superior al principal ---
        layout_nuevo_alumno.addLayout(layout_superior)

        # ... (El resto de tu funci√≥n sigue aqu√≠: group_tutor, group_domicilio, etc.) ...
    
        # Conectar se√±ales
        self.combo_curso_registro.currentIndexChanged.connect(self.actualizar_opciones_pago)
        self.combo_tipo_pago_registro.currentIndexChanged.connect(self.actualizar_costo_total_label)

        layout_nuevo_alumno.addLayout(layout_superior)


        # -- Grupo Datos del Tutor --
        group_tutor = QGroupBox("Datos del Padre o Tutor")
        form_tutor = QFormLayout(group_tutor)
        self.entry_tutor_ap_paterno = QLineEdit()
        self.entry_tutor_ap_materno = QLineEdit()
        self.entry_tutor_nombres = QLineEdit()
        self.entry_tutor_telefono = QLineEdit()

        form_tutor.addRow("Apellido Paterno:", self.entry_tutor_ap_paterno)
        form_tutor.addRow("Apellido Materno:", self.entry_tutor_ap_materno)
        form_tutor.addRow("Nombre(s):", self.entry_tutor_nombres)
        form_tutor.addRow("Tel√©fono (Tutor):", self.entry_tutor_telefono)
        layout_nuevo_alumno.addWidget(group_tutor)

        # -- Grupo Domicilio del Tutor --
        group_domicilio = QGroupBox("Domicilio del Tutor")
        form_domicilio = QFormLayout(group_domicilio)
        self.entry_dom_calle = QLineEdit()
        self.entry_dom_num_ext = QLineEdit()
        self.entry_dom_num_int = QLineEdit()
        self.entry_dom_colonia = QLineEdit()
        self.entry_dom_municipio = QLineEdit()
        self.entry_dom_estado = QLineEdit()
        self.entry_dom_cp = QLineEdit()

        form_domicilio.addRow("Calle:", self.entry_dom_calle)
        form_domicilio.addRow("N√∫mero Exterior:", self.entry_dom_num_ext)
        form_domicilio.addRow("N√∫mero Interior:", self.entry_dom_num_int)
        form_domicilio.addRow("Colonia:", self.entry_dom_colonia)
        form_domicilio.addRow("Municipio:", self.entry_dom_municipio)
        form_domicilio.addRow("Estado:", self.entry_dom_estado)
        form_domicilio.addRow("C√≥digo Postal:", self.entry_dom_cp)
        layout_nuevo_alumno.addWidget(group_domicilio)

        # -- Grupo Contactos de Emergencia --
        group_emergencia = QGroupBox("Contactos de Emergencia")
        layout_emergencia = QVBoxLayout(group_emergencia)

        # Contacto 1
        layout_emerg_1 = QFormLayout()
        self.entry_emerg_1_nombre = QLineEdit()
        self.entry_emerg_1_telefono = QLineEdit()
        self.entry_emerg_1_parentesco = QLineEdit()
        layout_emerg_1.addRow("Nombre Completo 1:", self.entry_emerg_1_nombre)
        layout_emerg_1.addRow("Tel√©fono 1:", self.entry_emerg_1_telefono)
        layout_emerg_1.addRow("Parentesco 1:", self.entry_emerg_1_parentesco)
        layout_emergencia.addLayout(layout_emerg_1)

        # Contacto 2
        layout_emerg_2 = QFormLayout()
        self.entry_emerg_2_nombre = QLineEdit()
        self.entry_emerg_2_telefono = QLineEdit()
        self.entry_emerg_2_parentesco = QLineEdit()
        layout_emerg_2.addRow("Nombre Completo 2:", self.entry_emerg_2_nombre)
        layout_emerg_2.addRow("Tel√©fono 2:", self.entry_emerg_2_telefono)
        layout_emerg_2.addRow("Parentesco 2:", self.entry_emerg_2_parentesco)
        layout_emergencia.addLayout(layout_emerg_2)

        layout_nuevo_alumno.addWidget(group_emergencia)

        # Bot√≥n de Guardar e Imprimir
        self.btn_guardar_alumno = QPushButton("Imprimir Ficha de Inscripci√≥n")
        self.btn_guardar_alumno.setObjectName("primaryButton")
        self.btn_guardar_alumno.clicked.connect(self.registrar_alumno_e_inscribir)
        layout_nuevo_alumno.addWidget(self.btn_guardar_alumno)

        layout_nuevo_alumno.addStretch() 

        # Establecer el widget con el layout en el scroll area
        scroll_area.setWidget(scroll_content_widget)

        # A√±adir el scroll area al layout principal de la p√°gina
        layout_principal.addWidget(scroll_area)

        self.entry_emerg_2_parentesco.returnPressed.connect(self.registrar_alumno_e_inscribir)

        self.ruta_foto_temporal = None  # Asegurar que empieza limpia
        self.lbl_foto_registro.setText("Sin Foto") # Mostrar el placeholder

        return widget
    
    # --- M√âTODOS PARA MANEJO DE FOTOS ---
    def tomar_foto_webcam(self):
        """Abre la c√°mara web para capturar una foto."""
        try:
            cap = cv2.VideoCapture(0) # 0 suele ser la webcam integrada
            if not cap.isOpened():
                mostrar_error("No se pudo acceder a la c√°mara web.")
                return

            while True:
                ret, frame = cap.read()
                if not ret:
                    mostrar_error("Error al leer de la c√°mara.")
                    break

                cv2.imshow('Presione ESPACIO para capturar, ESC para salir', frame)

                key = cv2.waitKey(1)
                if key % 256 == 32: # ESPACIO presionado
                    # Guardar foto temporalmente
                    temp_filename = os.path.join(FOTOS_DIR, "temp_capture.jpg")
                    cv2.imwrite(temp_filename, frame)
                    self.ruta_foto_temporal = temp_filename
                    self.mostrar_foto_en_label(self.lbl_foto_registro, temp_filename)
                    break
                elif key % 256 == 27: # ESC presionado
                    break

            cap.release()
            cv2.destroyAllWindows()

        except Exception as e:
             mostrar_error(f"Error con la c√°mara: {e}\nAseg√∫rese de tener opencv-python instalado.")

    def cargar_foto_desde_archivo(self):
        """Permite seleccionar una imagen existente."""
        file_path, _ = QFileDialog.getOpenFileName(self, "Seleccionar Foto", "", "Im√°genes (*.png *.jpg *.jpeg *.bmp)")
        if file_path:
            self.ruta_foto_temporal = file_path
            self.mostrar_foto_en_label(self.lbl_foto_registro, file_path)

    def mostrar_foto_en_label(self, label_widget, ruta_imagen):
        """Funci√≥n auxiliar para escalar y mostrar im√°genes en QLabels."""
        if ruta_imagen and os.path.exists(ruta_imagen):
            pixmap = QPixmap(ruta_imagen)
            if not pixmap.isNull():
                # Escalar manteniendo relaci√≥n de aspecto
                label_widget.setPixmap(pixmap.scaled(label_widget.size(), Qt.AspectRatioMode.KeepAspectRatio, Qt.TransformationMode.SmoothTransformation))
                label_widget.setText("")
            else:
                label_widget.setText("Error Imagen")
        else:
            label_widget.clear()
            label_widget.setText("Sin Foto")

    # ---- P√ÅGINA 2: REGISTRO DE PAGOS ----
    def crear_pagina_pagos(self):
        """Crea la interfaz para la p√°gina de registro de pagos."""
        main_layout = QHBoxLayout()
        widget = QWidget()
        widget.setObjectName("contentPage")
        widget.setContentsMargins(15, 15, 15, 15) 

        # Lado izquierdo: Registrar Pago
        left_panel = QGroupBox("Registrar Nuevo Pago")
        left_layout = QFormLayout()
        
        # --- ELIMINADO EL CAMPO DE B√öSQUEDA ---
        
        # El combo box ahora es la lista filtrada por la entrada de b√∫squeda
        self.combo_inscripcion_pago = QComboBox()
        self.combo_inscripcion_pago.setPlaceholderText("--- Seleccione una inscripci√≥n ---")
        
        self.lbl_pago_total = QLabel("$ 0.00")
        self.lbl_pago_pagado = QLabel("$ 0.00")
        self.lbl_pago_pendiente = QLabel("$ 0.00")

        self.lbl_pago_pendiente.setStyleSheet("font-weight: bold; color: #D32F2F;")
        self.lbl_pago_pagado.setStyleSheet("color: #4CAF50;")

        self.spin_monto_pago = QDoubleSpinBox()
        self.spin_monto_pago.setRange(0.01, 100000.0)
        self.spin_monto_pago.setPrefix("$ ")

        self.combo_metodo_pago = QComboBox()
        self.combo_metodo_pago.addItems(["Efectivo", "Transferencia", "Tarjeta de D√©bito", "Tarjeta de Cr√©dito"])

        self.btn_registrar_pago = QPushButton("Registrar Pago")
        self.btn_registrar_pago.setObjectName("primaryButton") 

        # Se usa el QComboBox est√°ndar como √∫nica forma de selecci√≥n
        left_layout.addRow(QLabel("Inscripci√≥n (Alumno - Curso):"), self.combo_inscripcion_pago)
        left_layout.addRow(QLabel("Monto Total:"), self.lbl_pago_total)
        left_layout.addRow(QLabel("Monto Pagado:"), self.lbl_pago_pagado)
        left_layout.addRow(QLabel("Saldo Pendiente:"), self.lbl_pago_pendiente)
        left_layout.addRow(QLabel("Monto a Pagar:"), self.spin_monto_pago)
        left_layout.addRow(QLabel("M√©todo de Pago:"), self.combo_metodo_pago)
        left_layout.addRow(self.btn_registrar_pago)
        left_panel.setLayout(left_layout)

        # Lado derecho: Historial de Pagos de la Inscripci√≥n
        right_panel = QGroupBox("Historial de Pagos")
        right_layout = QVBoxLayout()
        self.tabla_historial_pagos = QTableWidget(0, 3)
        self.tabla_historial_pagos.setHorizontalHeaderLabels(["Fecha", "Monto", "M√©todo"])
        self.tabla_historial_pagos.horizontalHeader().setStretchLastSection(True)
        self.tabla_historial_pagos.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        right_layout.addWidget(self.tabla_historial_pagos)
        right_panel.setLayout(right_layout)

        main_layout.addWidget(left_panel, 1)
        main_layout.addWidget(right_panel, 2)
        widget.setLayout(main_layout)

        # Conexiones
        self.combo_inscripcion_pago.currentIndexChanged.connect(self.actualizar_detalles_pago)
        self.btn_registrar_pago.clicked.connect(self.registrar_pago)
        
        self.cargar_cache_inscripciones() 

        return widget

    # ---- P√ÅGINA 3: LISTA DE ALUMNOS ----
    def crear_pagina_lista_alumnos(self):
        """Crea la interfaz para la p√°gina que muestra la lista de alumnos."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        # Layout principal horizontal: Tabla | Expediente
        layout_principal = QHBoxLayout(widget)
        layout_principal.setContentsMargins(15, 15, 15, 15)
        layout_principal.setSpacing(15)

        # Panel Izquierdo: Tabla de Alumnos
        group_tabla = QGroupBox("Lista de Alumnos Registrados")
        layout_tabla = QVBoxLayout(group_tabla)

        # --- NUEVO: FILTRO DE CURSO ---
        filter_layout = QHBoxLayout()
        filter_label = QLabel("Filtrar por Curso:")
        self.combo_filtro_curso = QComboBox()
        self.combo_filtro_curso.setMinimumWidth(250)
        
        filter_layout.addWidget(filter_label)
        filter_layout.addWidget(self.combo_filtro_curso)
        filter_layout.addStretch()
        layout_tabla.addLayout(filter_layout)
        # --- FIN NUEVO: FILTRO DE CURSO ---
        
        self.tabla_alumnos = QTableWidget(0, 6) # Modificado a 6 columnas: ID, Nombre, ApellidoP, ApellidoM, Email, Curso
        self.tabla_alumnos.setHorizontalHeaderLabels(["ID", "Nombre(s)", "Ap. Paterno", "Ap. Materno", "Email", "Curso Inscrito"])
        self.tabla_alumnos.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.tabla_alumnos.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        self.tabla_alumnos.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.tabla_alumnos.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.tabla_alumnos.itemSelectionChanged.connect(self.mostrar_expediente_alumno)

        layout_tabla.addWidget(self.tabla_alumnos)
        layout_principal.addWidget(group_tabla, 2) 

        # Panel Derecho: Expediente y Bot√≥n
        panel_derecho = QWidget()
        layout_derecho = QVBoxLayout(panel_derecho)
        layout_derecho.setContentsMargins(0,0,0,0) 
        
        self.btn_inscribir_a_curso = QPushButton("‚ûï Inscribir a Nuevo Curso")
        self.btn_inscribir_a_curso.setObjectName("primaryButton")
        self.btn_inscribir_a_curso.setToolTip("Inscribe al alumno seleccionado en un curso adicional")
        self.btn_inscribir_a_curso.clicked.connect(self.abrir_dialogo_nueva_inscripcion)
        layout_derecho.addWidget(self.btn_inscribir_a_curso)
        
        self.btn_editar_alumno = QPushButton("‚úèÔ∏è Editar Alumno Seleccionado")
        self.btn_editar_alumno.setObjectName("secondaryButton") # Bot√≥n de color gris/secundario
        self.btn_editar_alumno.setToolTip("Modifica los datos personales del alumno seleccionado")
        self.btn_editar_alumno.clicked.connect(self.abrir_dialogo_editar_alumno)
        layout_derecho.addWidget(self.btn_editar_alumno)

        group_expediente = QGroupBox("Expediente del Alumno")
        layout_expediente = QVBoxLayout(group_expediente)
        self.expediente_texto = QTextEdit()
        self.expediente_texto.setReadOnly(True)
        self.expediente_texto.setObjectName("expedienteDisplay") 
        layout_expediente.addWidget(self.expediente_texto)

        self.btn_dar_baja = QPushButton("Dar de Baja Alumno Seleccionado")
        self.btn_dar_baja.setObjectName("deleteButton") 
        self.btn_dar_baja.clicked.connect(self.dar_baja_alumno)
        self.btn_generar_boleta = QPushButton("Generar Boleta de Calificaciones")
        self.btn_generar_boleta.setObjectName("primaryButton")
        self.btn_generar_boleta.clicked.connect(self.generar_boleta_pdf)
        self.btn_generar_credencial = QPushButton("üÜî Generar Credencial de Alumno")
        self.btn_generar_credencial.setObjectName("primaryButton")
        # Usamos un color distinto para diferenciarlo (opcional, puedes usar primaryButton si prefieres azul)
        self.btn_generar_credencial.setStyleSheet("background-color: #6f42c1; color: white; font-weight: bold; padding: 10px; border-radius: 4px;")
        self.btn_generar_credencial.clicked.connect(self.generar_credencial_pdf)
        self.btn_abrir_expediente = QPushButton("üìÇ Gestionar Expediente Digital")
        self.btn_abrir_expediente.setObjectName("secondaryButton")
        self.btn_abrir_expediente.clicked.connect(self.abrir_expediente_seleccionado)

        layout_derecho.addWidget(self.btn_abrir_expediente)
        layout_derecho.addWidget(group_expediente)
        layout_derecho.addWidget(self.btn_generar_boleta)
        layout_derecho.addWidget(self.btn_generar_credencial)
        layout_derecho.addWidget(self.btn_dar_baja)

        layout_principal.addWidget(panel_derecho, 1) 

        # Conectar el filtro
        self.combo_filtro_curso.currentIndexChanged.connect(self.filtrar_alumnos_por_curso)

        return widget

    # ---- P√ÅGINA 4: GESTIONAR CURSOS ----
    def crear_pagina_gestion_usuarios(self):
        """Crea la interfaz para la p√°gina de gesti√≥n de usuarios."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_main = QHBoxLayout(widget)
        layout_main.setContentsMargins(15, 15, 15, 15)

        # Panel Izquierdo: Formulario de Usuario
        panel_usuario_form = QGroupBox("Registrar / Editar Usuario")
        layout_form = QVBoxLayout(panel_usuario_form)
        
        form_usuario = QFormLayout()
        self.entry_usr_nombre = QLineEdit()
        self.entry_usr_telefono = QLineEdit()
        self.entry_usr_email = QLineEdit()
        
        form_usuario.addRow(QLabel("Nombre Completo:"), self.entry_usr_nombre)
        form_usuario.addRow(QLabel("Tel√©fono:"), self.entry_usr_telefono)
        form_usuario.addRow(QLabel("Correo Electr√≥nico:"), self.entry_usr_email)
        
        layout_form.addLayout(form_usuario)

        # --- INICIO DE MODIFICACI√ìN: A√±adir CheckBoxes de Permisos ---
        
        # Definir los permisos (texto_amigable, clave_json)
        self.permisos_map = [
            ("Registrar Alumnos", "can_register_students"),
            ("Registrar Pagos", "can_register_payments"),
            ("Ver Lista Alumnos", "can_view_all_students"),
            ("Gestionar Cursos", "can_manage_courses"),
            ("Gestionar Materias", "can_manage_subjects"),
            ("Asignar Calificaciones", "can_assign_grades"),
            ("Gestionar Usuarios", "can_manage_users"),
            ("Ver Configuraci√≥n", "can_access_settings"),
            ("ES ADMINISTRADOR (Acceso Total)", "is_admin"),
        ]
        
        self.permisos_checkboxes = {} # Diccionario para guardar los checkboxes

        group_permisos = QGroupBox("Permisos del Usuario")
        layout_permisos = QGridLayout(group_permisos)

        for i, (texto, clave) in enumerate(self.permisos_map):
            chk = QCheckBox(texto)
            self.permisos_checkboxes[clave] = chk
            layout_permisos.addWidget(chk, i, 0)

        layout_form.addWidget(group_permisos)
        # --- FIN DE MODIFICACI√ìN ---

        # Botones de acci√≥n del formulario
        self.btn_guardar_usuario = QPushButton("Guardar Usuario")
        self.btn_guardar_usuario.setObjectName("primaryButton")
        self.btn_guardar_usuario.clicked.connect(self.guardar_usuario) 

        self.btn_limpiar_form_usuario = QPushButton("Limpiar Formulario")
        self.btn_limpiar_form_usuario.setObjectName("secondaryButton") 
        self.btn_limpiar_form_usuario.clicked.connect(self.limpiar_campos_usuario)

        self.btn_cambiar_password = QPushButton("Cambiar Contrase√±a")
        self.btn_cambiar_password.setObjectName("secondaryButton") 
        self.btn_cambiar_password.clicked.connect(self.cambiar_password_usuario)
        self.btn_cambiar_password.setVisible(False) 

        layout_botones_form = QHBoxLayout()
        layout_botones_form.addWidget(self.btn_guardar_usuario)
        layout_botones_form.addWidget(self.btn_limpiar_form_usuario)
        
        layout_form.addLayout(layout_botones_form)
        layout_form.addWidget(self.btn_cambiar_password)
        layout_form.addStretch() 
        
        # Panel Derecho: Tabla de Usuarios
        panel_usuario_tabla = QGroupBox("Lista de Usuarios")
        layout_usuario_tabla = QVBoxLayout(panel_usuario_tabla)
        # --- MODIFICADO: Quitar columna 'Rol' ---
        self.tabla_usuarios = QTableWidget(0, 3)
        self.tabla_usuarios.setHorizontalHeaderLabels(["ID (No. Empleado)", "Nombre", "Email"])
        self.tabla_usuarios.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.tabla_usuarios.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        self.tabla_usuarios.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.tabla_usuarios.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.tabla_usuarios.itemSelectionChanged.connect(self.seleccionar_usuario_para_edicion)
        
        self.btn_eliminar_usuario = QPushButton("Eliminar Usuario Seleccionado")
        self.btn_eliminar_usuario.setObjectName("deleteButton") 
        self.btn_eliminar_usuario.clicked.connect(self.dar_baja_usuario)

        layout_usuario_tabla.addWidget(self.tabla_usuarios)
        layout_usuario_tabla.addWidget(self.btn_eliminar_usuario)

        layout_main.addWidget(panel_usuario_form)
        layout_main.addWidget(panel_usuario_tabla, 1)

        self.entry_usr_email.returnPressed.connect(self.guardar_usuario)
        
        return widget
    
    # ---- P√ÅGINA 4: GESTIONAR CURSOS ----
    def crear_pagina_gestion_cursos(self):
        """Crea la interfaz para la p√°gina de gesti√≥n de cursos."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_main = QHBoxLayout(widget)
        layout_main.setContentsMargins(15, 15, 15, 15)

        # Panel Izquierdo: Formulario de Cursos
        panel_cursos_form = QGroupBox("Gesti√≥n de Cursos")
        layout_form = QVBoxLayout(panel_cursos_form)
        
        form_cursos = QFormLayout()
        self.entry_cur_nombre = QLineEdit()
        self.spin_costo_exhibicion = QDoubleSpinBox()
        self.spin_costo_exhibicion.setRange(0.0, 100000.0)
        self.spin_costo_exhibicion.setPrefix("$ ")
        
        # Costo Total (15 Semanas)
        self.spin_costo_sem_15 = QDoubleSpinBox()
        self.spin_costo_sem_15.setRange(0.0, 100000.0)
        self.spin_costo_sem_15.setPrefix("$ ")
        
        # Costo Total (12 Semanas)
        self.spin_costo_sem_12 = QDoubleSpinBox()
        self.spin_costo_sem_12.setRange(0.0, 100000.0)
        self.spin_costo_sem_12.setPrefix("$ ")
        
        # Costo Total (3 Meses)
        self.spin_costo_mensual_3 = QDoubleSpinBox()
        self.spin_costo_mensual_3.setRange(0.0, 100000.0)
        self.spin_costo_mensual_3.setPrefix("$ ")
        
        # --- PLAZOS NUEVOS (Bisemanal y Mensual 4) ---
        # Bisemanal (El nuevo plazo bisemanal que se corresponde con el "sem_2" o "mensual_1" err√≥neos en tu imagen)
        self.spin_costo_bi_semanal = QDoubleSpinBox()
        self.spin_costo_bi_semanal.setRange(0.0, 100000.0)
        self.spin_costo_bi_semanal.setPrefix("$ ")
        
        # Mensual (4 Meses)
        self.spin_costo_mensual_4 = QDoubleSpinBox()
        self.spin_costo_mensual_4.setRange(0.0, 100000.0)
        self.spin_costo_mensual_4.setPrefix("$ ")
        
        # Mensualidad
        self.spin_costo_mensualidad = QDoubleSpinBox()
        self.spin_costo_mensualidad.setRange(0.0, 100000.0)
        self.spin_costo_mensualidad.setPrefix("$ ")
        
        form_cursos.addRow(QLabel("Nombre del Curso:"), self.entry_cur_nombre)
        form_cursos.addRow(QLabel("Costo (Exhibici√≥n √önica):"), self.spin_costo_exhibicion)
        form_cursos.addRow(QLabel("Costo Total (15 Semanas):"), self.spin_costo_sem_15)
        form_cursos.addRow(QLabel("Costo Total (12 Semanas):"), self.spin_costo_sem_12) 
        form_cursos.addRow(QLabel("Costo Total (3 meses):"), self.spin_costo_mensual_3)
        form_cursos.addRow(QLabel("Costo Total (Bi Semanal):"), self.spin_costo_bi_semanal)
        form_cursos.addRow(QLabel("Costo Total (4 Meses):"), self.spin_costo_mensual_4)
        label_mensualidad = QLabel("Mensualidad (Colegiatura):")
        label_mensualidad.setToolTip("Costo mensual recurrente (para escuelas). Deje en 0 si no aplica.")
        form_cursos.addRow(label_mensualidad, self.spin_costo_mensualidad)
        
        self.btn_guardar_curso = QPushButton("Guardar Curso")
        self.btn_guardar_curso.setObjectName("primaryButton")
        self.btn_guardar_curso.clicked.connect(self.guardar_curso)

        self.btn_limpiar_form_curso = QPushButton("Limpiar Formulario")
        self.btn_limpiar_form_curso.setObjectName("secondaryButton")
        self.btn_limpiar_form_curso.clicked.connect(self.limpiar_campos_curso)

        layout_botones_form = QHBoxLayout()
        layout_botones_form.addWidget(self.btn_guardar_curso)
        layout_botones_form.addWidget(self.btn_limpiar_form_curso)

        layout_form.addLayout(form_cursos)
        layout_form.addLayout(layout_botones_form)
        layout_form.addStretch()

        
        # Panel Derecho: Tabla de Cursos
        panel_cursos_tabla = QGroupBox("Lista de Cursos")
        layout_cursos_tabla = QVBoxLayout(panel_cursos_tabla)
        self.tabla_cursos = QTableWidget(0, 6) 
        self.tabla_cursos.setHorizontalHeaderLabels(["ID", "Curso", "Exhibici√≥n", "Sem 15", "Sem 12", "Mensual 3"]) 
        self.tabla_cursos.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.tabla_cursos.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        self.tabla_cursos.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.tabla_cursos.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.tabla_cursos.itemSelectionChanged.connect(self.seleccionar_curso_para_edicion)
        
        self.btn_eliminar_curso = QPushButton("Eliminar Curso Seleccionado")
        self.btn_eliminar_curso.setObjectName("deleteButton") 
        self.btn_eliminar_curso.clicked.connect(self.dar_baja_curso)

        layout_cursos_tabla.addWidget(self.tabla_cursos)
        layout_cursos_tabla.addWidget(self.btn_eliminar_curso)

        layout_main.addWidget(panel_cursos_form)
        layout_main.addWidget(panel_cursos_tabla, 1)

        self.entry_cur_nombre.returnPressed.connect(self.guardar_curso)
        
        return widget
    
        
    # ---- P√ÅGINA 5: GESTIONAR USUARIOS (NUEVA CON EDICI√ìN) ----
    # ---- P√ÅGINA 5: GESTIONAR USUARIOS (NUEVA CON PERMISOS) ----
    def crear_pagina_gestion_usuarios(self):
        """Crea la interfaz para la p√°gina de gesti√≥n de usuarios."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_main = QHBoxLayout(widget)
        layout_main.setContentsMargins(15, 15, 15, 15)

        # Panel Izquierdo: Formulario de Usuario
        panel_usuario_form = QGroupBox("Registrar / Editar Usuario")
        layout_form = QVBoxLayout(panel_usuario_form)
        
        form_usuario = QFormLayout()
        self.entry_usr_nombre = QLineEdit()
        self.entry_usr_telefono = QLineEdit()
        self.entry_usr_email = QLineEdit()
        
        form_usuario.addRow(QLabel("Nombre Completo:"), self.entry_usr_nombre)
        form_usuario.addRow(QLabel("Tel√©fono:"), self.entry_usr_telefono)
        form_usuario.addRow(QLabel("Correo Electr√≥nico:"), self.entry_usr_email)
        
        layout_form.addLayout(form_usuario)

        # --- INICIO DE MODIFICACI√ìN: A√±adir CheckBoxes de Permisos ---
        
        # Definir los permisos (texto_amigable, clave_json)
        self.permisos_map = [
            ("Registrar Alumnos", "can_register_students"),
            ("Registrar Pagos", "can_register_payments"),
            ("Ver Lista Alumnos", "can_view_all_students"),
            ("Gestionar Cursos", "can_manage_courses"),
            ("Gestionar Materias", "can_manage_subjects"),
            ("Asignar Calificaciones", "can_assign_grades"),
            ("Gestionar Usuarios", "can_manage_users"),
            ("Ver Configuraci√≥n", "can_access_settings"),
            ("ES ADMINISTRADOR (Acceso Total)", "is_admin"),
        ]
        
        self.permisos_checkboxes = {} # Diccionario para guardar los checkboxes

        group_permisos = QGroupBox("Permisos del Usuario")
        layout_permisos = QGridLayout(group_permisos)

        for i, (texto, clave) in enumerate(self.permisos_map):
            chk = QCheckBox(texto)
            self.permisos_checkboxes[clave] = chk
            layout_permisos.addWidget(chk, i, 0)

            if clave == 'is_admin':
                chk.toggled.connect(self.toggle_all_permissions)

        layout_form.addWidget(group_permisos)
        # --- FIN DE MODIFICACI√ìN ---

        # Botones de acci√≥n del formulario
        self.btn_guardar_usuario = QPushButton("Guardar Usuario")
        self.btn_guardar_usuario.setObjectName("primaryButton")
        self.btn_guardar_usuario.clicked.connect(self.guardar_usuario) 

        self.btn_limpiar_form_usuario = QPushButton("Limpiar Formulario")
        self.btn_limpiar_form_usuario.setObjectName("secondaryButton") 
        self.btn_limpiar_form_usuario.clicked.connect(self.limpiar_campos_usuario)

        self.btn_cambiar_password = QPushButton("Cambiar Contrase√±a")
        self.btn_cambiar_password.setObjectName("secondaryButton") 
        self.btn_cambiar_password.clicked.connect(self.cambiar_password_usuario)
        self.btn_cambiar_password.setVisible(False) 

        layout_botones_form = QHBoxLayout()
        layout_botones_form.addWidget(self.btn_guardar_usuario)
        layout_botones_form.addWidget(self.btn_limpiar_form_usuario)
        
        layout_form.addLayout(layout_botones_form)
        layout_form.addWidget(self.btn_cambiar_password)
        layout_form.addStretch() 
        
        # Panel Derecho: Tabla de Usuarios
        panel_usuario_tabla = QGroupBox("Lista de Usuarios")
        layout_usuario_tabla = QVBoxLayout(panel_usuario_tabla)
        # --- MODIFICADO: Quitar columna 'Rol' ---
        self.tabla_usuarios = QTableWidget(0, 3)
        self.tabla_usuarios.setHorizontalHeaderLabels(["ID (No. Empleado)", "Nombre", "Email"])
        self.tabla_usuarios.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.tabla_usuarios.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        self.tabla_usuarios.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.tabla_usuarios.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.tabla_usuarios.itemSelectionChanged.connect(self.seleccionar_usuario_para_edicion)
        
        self.btn_eliminar_usuario = QPushButton("Eliminar Usuario Seleccionado")
        self.btn_eliminar_usuario.setObjectName("deleteButton") 
        self.btn_eliminar_usuario.clicked.connect(self.dar_baja_usuario)

        layout_usuario_tabla.addWidget(self.tabla_usuarios)
        layout_usuario_tabla.addWidget(self.btn_eliminar_usuario)

        layout_main.addWidget(panel_usuario_form)
        layout_main.addWidget(panel_usuario_tabla, 1) 
        
        return widget
    
    # ---- (P√ÅGINA 6: GESTIONAR MATERIAS - Esta debe estar aqu√≠) ----
    def crear_pagina_gestion_materias(self):
        """Crea la interfaz para a√±adir o quitar materias a un curso."""
        # ... (Aseg√∫rate de que esta funci√≥n est√© presente) ...
        # (El c√≥digo de esta funci√≥n no se muestra para abreviar,
        #  pero debe estar en tu archivo entre crear_pagina_gestion_usuarios
        #  y crear_pagina_gestion_calificaciones)
        pass # Reemplaza 'pass' con el c√≥digo de la funci√≥n si la borraste
    
    # ---- (P√ÅGINA 7: ASIGNAR CALIFICACIONES - Esta debe estar aqu√≠) ----
    def crear_pagina_gestion_calificaciones(self):
        """Crea la interfaz para asignar calificaciones a los alumnos."""
        # ... (El c√≥digo de esta funci√≥n debe estar aqu√≠) ...
        pass # Reemplaza 'pass' con el c√≥digo de la funci√≥n si la borraste
        
    # ---- (P√ÅGINA 8: CONFIGURACI√ìN - Esta debe estar aqu√≠) ----
    def crear_pagina_configuracion(self):
        """Crea la interfaz para la p√°gina de configuraci√≥n."""
        # ... (El c√≥digo de esta funci√≥n debe estar aqu√≠) ...
        pass # Reemplaza 'pass' con el c√≥digo de la funci√≥n si la borraste
    
    # ---- P√ÅGINA 9: GESTI√ìN DE PERSONAL ----
    def crear_pagina_gestion_personal(self):
        """Crea la interfaz para la p√°gina de gesti√≥n de personal."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_principal = QHBoxLayout(widget)
        layout_principal.setContentsMargins(15, 15, 15, 15)
        layout_principal.setSpacing(15)

        # Panel Izquierdo: Tabla de Personal
        group_tabla = QGroupBox("Lista de Personal Registrado")
        layout_tabla = QVBoxLayout(group_tabla)

        # (Opcional: A√±adir filtro por puesto si se desea)

        self.tabla_personal = QTableWidget(0, 5) 
        self.tabla_personal.setHorizontalHeaderLabels(["ID", "No. Empleado", "Nombre Completo", "Puesto", "Email"])
        self.tabla_personal.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.tabla_personal.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        self.tabla_personal.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.tabla_personal.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.tabla_personal.itemSelectionChanged.connect(self.mostrar_expediente_personal)
        self.tabla_personal.hideColumn(0) # Ocultar ID interno

        layout_tabla.addWidget(self.tabla_personal)
        
        btn_registrar_nuevo = QPushButton("Registrar Nuevo Personal")
        btn_registrar_nuevo.setObjectName("primaryButton")
        btn_registrar_nuevo.clicked.connect(self.abrir_dialogo_personal)
        layout_tabla.addWidget(btn_registrar_nuevo)

        layout_principal.addWidget(group_tabla, 2) 

        # Panel Derecho: Expediente y Acciones
        panel_derecho = QWidget()
        layout_derecho = QVBoxLayout(panel_derecho)
        layout_derecho.setContentsMargins(0,0,0,0) 

        group_expediente = QGroupBox("Expediente de Personal")
        layout_expediente = QVBoxLayout(group_expediente)
        self.expediente_personal_texto = QTextEdit()
        self.expediente_personal_texto.setReadOnly(True)
        self.expediente_personal_texto.setObjectName("expedienteDisplay") 
        layout_expediente.addWidget(self.expediente_personal_texto)

        self.btn_editar_personal = QPushButton("Editar Personal Seleccionado")
        self.btn_editar_personal.setObjectName("secondaryButton")
        self.btn_editar_personal.clicked.connect(lambda: self.abrir_dialogo_personal(editar=True))

        self.btn_abrir_expediente_personal = QPushButton("üìÇ Gestionar Expediente Digital (Personal)")
        self.btn_abrir_expediente_personal.setObjectName("secondaryButton")
        self.btn_abrir_expediente_personal.clicked.connect(self.abrir_expediente_personal_seleccionado)

        self.btn_generar_credencial_personal = QPushButton("üÜî Generar Credencial de Personal")
        self.btn_generar_credencial_personal.setObjectName("primaryButton")
        self.btn_generar_credencial_personal.setStyleSheet("background-color: #6f42c1; color: white;")
        self.btn_generar_credencial_personal.clicked.connect(self.generar_credencial_personal_pdf)

        self.btn_eliminar_personal = QPushButton("Eliminar Personal Seleccionado")
        self.btn_eliminar_personal.setObjectName("deleteButton") 
        self.btn_eliminar_personal.clicked.connect(self.eliminar_personal)

        layout_derecho.addWidget(self.btn_editar_personal)
        layout_derecho.addWidget(self.btn_abrir_expediente_personal)
        layout_derecho.addWidget(group_expediente)
        layout_derecho.addWidget(self.btn_generar_credencial_personal)
        layout_derecho.addWidget(self.btn_eliminar_personal)

        layout_principal.addWidget(panel_derecho, 1) 
        return widget


    # --- L√ìGICA DE GESTI√ìN DE USUARIOS (ACTUALIZADA) ---

    def guardar_usuario(self):
        """Guarda un usuario nuevo o actualiza uno existente."""
        if not all(hasattr(self, w) for w in ['entry_usr_nombre', 'entry_usr_email', 'permisos_checkboxes']):
            return 

        nombre = self.entry_usr_nombre.text().strip()
        telefono = self.entry_usr_telefono.text().strip()
        email = self.entry_usr_email.text().strip()
        
        if not nombre or not email:
            mostrar_error("Nombre Completo y Correo Electr√≥nico son obligatorios.")
            return
            
        # --- INICIO DE MODIFICACI√ìN: Construir diccionario de permisos ---
        permisos_dict = {}
        for clave, checkbox in self.permisos_checkboxes.items():
            permisos_dict[clave] = checkbox.isChecked()
        
        # Convertir a JSON
        permisos_json = json.dumps(permisos_dict)
        # --- FIN DE MODIFICACI√ìN ---
            
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                
                if self.usuario_seleccionado_id is None:
                    # --- CREAR NUEVO USUARIO ---
                    password = secrets.token_hex(4) 
                    cursor.execute("""
                    INSERT INTO usuarios (nombre_completo, telefono, email, permisos, password)
                    VALUES (?, ?, ?, ?, ?)
                    """, (nombre, telefono, email, permisos_json, password))
                    user_id = cursor.lastrowid 
                    conn.commit()
                    
                    mostrar_info(f"Usuario creado exitosamente:\n\n"
                                 f"No. de Empleado (ID): {user_id}\n"
                                 f"Usuario (Email): {email}\n"
                                 f"Contrase√±a: {password}\n\n"
                                 "Por favor, guarde esta contrase√±a. No se puede recuperar.")
                
                else:
                    # --- ACTUALIZAR USUARIO EXISTENTE ---
                    cursor.execute("""
                    UPDATE usuarios SET nombre_completo = ?, telefono = ?, email = ?, permisos = ?
                    WHERE id = ?
                    """, (nombre, telefono, email, permisos_json, self.usuario_seleccionado_id))
                    conn.commit()
                    mostrar_info(f"Usuario (ID: {self.usuario_seleccionado_id}) actualizado exitosamente.")
                         
            self.limpiar_campos_usuario()
            self.cargar_tabla_usuarios()
            
        except sqlite3.IntegrityError:
            mostrar_error("Error: Ese correo electr√≥nico ya est√° registrado.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al registrar usuario: {e}")

    def cambiar_password_usuario(self):
        """Cambia la contrase√±a del usuario seleccionado."""
        if self.usuario_seleccionado_id is None:
            mostrar_error("No hay ning√∫n usuario seleccionado.")
            return
        
        # --- A√ëADIDO: Proteger al Admin ID 1 ---
        if self.usuario_seleccionado_id == 1:
            mostrar_error("No se puede cambiar la contrase√±a del Administrador principal desde aqu√≠.")
            return

        nueva_pass, ok = QInputDialog.getText(self, "Cambiar Contrase√±a",
                                              "Ingrese la nueva contrase√±a:", QLineEdit.EchoMode.Password)
        
        if ok and nueva_pass:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("UPDATE usuarios SET password = ? WHERE id = ?", (nueva_pass, self.usuario_seleccionado_id))
                    conn.commit()
                mostrar_info("Contrase√±a actualizada exitosamente.")
            except sqlite3.Error as e:
                mostrar_error(f"Error al cambiar la contrase√±a: {e}")
        elif ok and not nueva_pass:
            mostrar_error("La contrase√±a no puede estar vac√≠a.")

    def seleccionar_usuario_para_edicion(self):
        """Carga los datos del usuario seleccionado en el formulario de edici√≥n."""
        selected_items = self.tabla_usuarios.selectedItems()
        if not selected_items:
            self.limpiar_campos_usuario() 
            return

        selected_row = self.tabla_usuarios.currentRow()
        
        if selected_row < 0:
             self.limpiar_campos_usuario()
             return
             
        user_id_item = self.tabla_usuarios.item(selected_row, 0)
        if not user_id_item: return

        try:
            user_id = int(user_id_item.text())
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM usuarios WHERE id = ?", (user_id,))
                datos = cursor.fetchone()

            if datos:
                self.usuario_seleccionado_id = user_id
                self.entry_usr_nombre.setText(datos['nombre_completo'])
                self.entry_usr_telefono.setText(datos['telefono'])
                self.entry_usr_email.setText(datos['email'])
                
                # --- INICIO DE MODIFICACI√ìN: Cargar permisos ---
                try:
                    permisos_dict = json.loads(datos['permisos'])
                except json.JSONDecodeError:
                    permisos_dict = {} # Fallback

                # Asignar el estado de los checkboxes
                for clave, checkbox in self.permisos_checkboxes.items():
                    checkbox.setChecked(permisos_dict.get(clave, False))
                # --- FIN DE MODIFICACI√ìN ---
                
                self.btn_guardar_usuario.setText("Actualizar Usuario")

                is_admin = permisos_dict.get('is_admin', False)
                
                # Proteger al Admin ID 1
                if user_id == 1:
                    self.btn_cambiar_password.setVisible(False)
                    self.toggle_all_permissions(True) # Deshabilita todo
                else:
                    self.btn_cambiar_password.setVisible(True)
                    self.toggle_all_permissions(is_admin)

        except Exception as e:
            mostrar_error(f"Error al cargar datos de usuario: {e}")
            self.limpiar_campos_usuario()
    
    def abrir_expediente_seleccionado(self):
        """Abre la ventana de documentos para el alumno seleccionado."""
        selected_items = self.tabla_alumnos.selectedItems()
        if not selected_items or self.tabla_alumnos.currentRow() < 0:
            mostrar_error("Por favor, seleccione un alumno de la lista.")
            return

        try:
            row = self.tabla_alumnos.currentRow()
            alumno_id = int(self.tabla_alumnos.item(row, 0).text())
            # Obtener nombre de las columnas 1, 2 y 3 de la tabla
            nombre = self.tabla_alumnos.item(row, 1).text()
            ap_paterno = self.tabla_alumnos.item(row, 2).text()
            ap_materno = self.tabla_alumnos.item(row, 3).text()
            nombre_completo = f"{nombre} {ap_paterno} {ap_materno}"

            ventana_docs = VentanaDocumentos(alumno_id, nombre_completo, self)
            ventana_docs.exec()

        except Exception as e:
            mostrar_error(f"Error al abrir expediente: {e}")

    def dar_baja_usuario(self):
        """Elimina un usuario seleccionado de la BD."""
        
        # --- L√≥gica de selecci√≥n mejorada ---
        user_id_a_eliminar = None
        nombre_seleccionado = ""
        
        selected_items = self.tabla_usuarios.selectedItems()
        if selected_items and self.tabla_usuarios.currentRow() >= 0:
            selected_row = self.tabla_usuarios.currentRow()
            user_id_item = self.tabla_usuarios.item(selected_row, 0)
            nombre_item = self.tabla_usuarios.item(selected_row, 1)
            if user_id_item:
                user_id_a_eliminar = int(user_id_item.text())
                nombre_seleccionado = nombre_item.text()
        else:
             mostrar_error("Por favor, seleccione un usuario de la lista para eliminar.")
             return
        # --- Fin l√≥gica de selecci√≥n ---

        # Protecci√≥n para el admin ID 1 y para no borrarse a s√≠ mismo
        if user_id_a_eliminar == 1:
            mostrar_error("No se puede eliminar al administrador principal (ID 1).")
            return
            
        if self.username == self.tabla_usuarios.item(self.tabla_usuarios.currentRow(), 2).text():
            mostrar_error("No puede eliminarse a s√≠ mismo.")
            return

        reply = QMessageBox.question(self, "Confirmar Eliminaci√≥n",
                                     f"¬øEst√° seguro que desea eliminar al usuario:\n\n{nombre_seleccionado} (ID: {user_id_a_eliminar})?\n\nEsta acci√≥n no se puede deshacer.",
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.Cancel)

        if reply == QMessageBox.StandardButton.Yes:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("DELETE FROM usuarios WHERE id = ?", (user_id_a_eliminar,))
                    conn.commit()
                
                mostrar_info(f"Usuario {nombre_seleccionado} eliminado exitosamente.")
                self.limpiar_campos_usuario()
                self.cargar_tabla_usuarios()

            except sqlite3.Error as e:
                mostrar_error(f"Error al eliminar usuario: {e}")

            
    def limpiar_campos_usuario(self):
        """Limpia el formulario de gesti√≥n de usuarios y resetea el modo a 'Guardar'."""
        try:
            if hasattr(self, 'entry_usr_nombre'):
                self.entry_usr_nombre.clear()
                self.entry_usr_telefono.clear()
                self.entry_usr_email.clear()
                
                # --- INICIO DE MODIFICACI√ìN: Limpiar y HABILITAR checkboxes ---
                if hasattr(self, 'permisos_checkboxes'):
                    for checkbox in self.permisos_checkboxes.values():
                        checkbox.setChecked(False)
                        checkbox.setEnabled(True) # Asegurarse de que est√©n habilitados
                # --- FIN DE MODIFICACI√ìN ---
                
                self.usuario_seleccionado_id = None
                self.btn_guardar_usuario.setText("Guardar Usuario")
                self.btn_cambiar_password.setVisible(False)
                self.tabla_usuarios.clearSelection()
        except AttributeError:
            pass 

    def cargar_tabla_usuarios(self):
        """Carga la lista de usuarios (empleados) en la QTableWidget."""
        try: 
            if hasattr(self, 'tabla_usuarios'):
                self.tabla_usuarios.setRowCount(0)
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    # --- MODIFICADO: Quitar 'rol' ---
                    cursor.execute("SELECT id, nombre_completo, email FROM usuarios ORDER BY nombre_completo")
                    usuarios = cursor.fetchall()

                    self.tabla_usuarios.setRowCount(len(usuarios))
                    for row, usuario in enumerate(usuarios):
                        self.tabla_usuarios.setItem(row, 0, QTableWidgetItem(str(usuario['id'])))
                        self.tabla_usuarios.setItem(row, 1, QTableWidgetItem(usuario['nombre_completo']))
                        self.tabla_usuarios.setItem(row, 2, QTableWidgetItem(usuario['email']))
        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar tabla de usuarios: {e}")
        except AttributeError:
            pass
    
    # ---- P√ÅGINA 6: GESTIONAR MATERIAS ----
    def crear_pagina_gestion_materias(self):
        """Crea la interfaz para a√±adir o quitar materias a un curso."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_main = QHBoxLayout(widget)
        layout_main.setContentsMargins(15, 15, 15, 15)

        # Panel Izquierdo: Selecci√≥n de Curso
        panel_izq = QGroupBox("Seleccionar Curso")
        layout_izq = QVBoxLayout(panel_izq)
        
        self.combo_curso_materias = QComboBox()
        self.tabla_materias = QTableWidget(0, 2)
        self.tabla_materias.setHorizontalHeaderLabels(["ID", "Nombre de la Materia"])
        self.tabla_materias.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.Stretch)
        self.tabla_materias.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.tabla_materias.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)

        layout_izq.addWidget(QLabel("Curso:"))
        layout_izq.addWidget(self.combo_curso_materias)
        layout_izq.addWidget(self.tabla_materias)
        
        layout_main.addWidget(panel_izq, 1)

        # Panel Derecho: A√±adir/Eliminar Materias
        panel_der = QGroupBox("A√±adir/Eliminar Materia")
        layout_der = QFormLayout(panel_der)
        layout_der.setSpacing(10)

        self.entry_nombre_materia = QLineEdit()
        self.btn_anadir_materia = QPushButton("A√±adir Materia al Curso")
        self.btn_anadir_materia.setObjectName("primaryButton")
        
        self.btn_eliminar_materia = QPushButton("Eliminar Materia Seleccionada")
        self.btn_eliminar_materia.setObjectName("deleteButton")
        
        layout_der.addRow(QLabel("Nombre Nueva Materia:"), self.entry_nombre_materia)
        layout_der.addRow(self.btn_anadir_materia)
        layout_der.addRow(self.btn_eliminar_materia)
        
        layout_main.addWidget(panel_der)
        
        # Conexiones
        self.combo_curso_materias.currentIndexChanged.connect(self.cargar_tabla_materias)
        self.btn_anadir_materia.clicked.connect(self.anadir_materia)
        self.btn_eliminar_materia.clicked.connect(self.eliminar_materia)

        self.entry_nombre_materia.returnPressed.connect(self.anadir_materia)

        return widget

    def cargar_combo_cursos_materias(self):
        """Carga los cursos en el combo de la p√°g. de gesti√≥n de materias."""
        try:
            if not hasattr(self, 'combo_curso_materias'): return
            self.combo_curso_materias.clear()
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT id, nombre_curso FROM cursos ORDER BY nombre_curso")
                cursos = cursor.fetchall()
            
            self.combo_curso_materias.addItem("--- Seleccione un Curso ---", userData=None)
            for curso in cursos:
                self.combo_curso_materias.addItem(curso['nombre_curso'], userData=curso['id'])
        except Exception as e:
            mostrar_error(f"Error al cargar cursos para materias: {e}")

    def cargar_tabla_materias(self):
        """Carga las materias del curso seleccionado en la tabla."""
        try:
            if not hasattr(self, 'tabla_materias'): return
            self.tabla_materias.setRowCount(0)
            curso_id = self.combo_curso_materias.currentData()
            if not curso_id: return

            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT id, nombre_materia FROM materias WHERE curso_id = ? ORDER BY nombre_materia", (curso_id,))
                materias = cursor.fetchall()
            
            self.tabla_materias.setRowCount(len(materias))
            for row, materia in enumerate(materias):
                self.tabla_materias.setItem(row, 0, QTableWidgetItem(str(materia['id'])))
                self.tabla_materias.setItem(row, 1, QTableWidgetItem(materia['nombre_materia']))
        
        except Exception as e:
            mostrar_error(f"Error al cargar tabla de materias: {e}")

    def anadir_materia(self):
        curso_id = self.combo_curso_materias.currentData()
        nombre_materia = self.entry_nombre_materia.text().strip()
        
        if not curso_id or not nombre_materia:
            mostrar_error("Debe seleccionar un curso y escribir un nombre para la materia.")
            return
            
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("INSERT INTO materias (curso_id, nombre_materia) VALUES (?, ?)", (curso_id, nombre_materia))
                conn.commit()
            
            self.entry_nombre_materia.clear()
            self.cargar_tabla_materias() # Recargar la lista
        except Exception as e:
            mostrar_error(f"Error al a√±adir materia: {e}")

    def eliminar_materia(self):
        selected_items = self.tabla_materias.selectedItems()
        if not selected_items:
            mostrar_error("Seleccione una materia de la tabla para eliminar.")
            return
        
        materia_id = int(self.tabla_materias.item(self.tabla_materias.currentRow(), 0).text())
        
        reply = QMessageBox.question(self, "Confirmar Eliminaci√≥n",
                                     "¬øSeguro que desea eliminar esta materia?\nEsto eliminar√° tambi√©n todas las calificaciones asociadas a ella.",
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
        
        if reply == QMessageBox.StandardButton.Yes:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    # Gracias a "ON DELETE CASCADE" en la tabla calificaciones,
                    # SQLite borrar√° autom√°ticamente las calificaciones asociadas.
                    cursor.execute("DELETE FROM materias WHERE id = ?", (materia_id,))
                    conn.commit()
                self.cargar_tabla_materias()
            except Exception as e:
                mostrar_error(f"Error al eliminar materia: {e}")

    # ---- P√ÅGINA 7: ASIGNAR CALIFICACIONES ----
    def crear_pagina_gestion_calificaciones(self):
        """Crea la interfaz para asignar calificaciones a los alumnos."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_main = QHBoxLayout(widget)
        layout_main.setContentsMargins(15, 15, 15, 15)

        # Panel Izquierdo: Selecci√≥n de Curso y Alumno
        panel_izq = QGroupBox("Selecci√≥n")
        layout_izq = QVBoxLayout(panel_izq)
        
        self.combo_curso_calif = QComboBox()
        self.lista_alumnos_calif = QListWidget()
        
        layout_izq.addWidget(QLabel("1. Seleccione el Curso:"))
        layout_izq.addWidget(self.combo_curso_calif)
        layout_izq.addWidget(QLabel("2. Seleccione el Alumno:"))
        layout_izq.addWidget(self.lista_alumnos_calif)
        layout_main.addWidget(panel_izq, 1)

        # Panel Derecho: Tabla de Calificaciones
        panel_der = QGroupBox("Calificaciones del Alumno")
        layout_der = QVBoxLayout(panel_der)
        
        # --- INICIO DE MODIFICACI√ìN: A√±adir selector de parcial ---
        selector_layout = QHBoxLayout()
        selector_layout.addWidget(QLabel("Seleccionar Parcial:"))
        self.combo_parcial_select = QComboBox()
        self.combo_parcial_select.addItems(["Primer Parcial", "Segundo Parcial"])
        selector_layout.addWidget(self.combo_parcial_select)
        selector_layout.addStretch()
        layout_der.addLayout(selector_layout)
        # --- FIN DE MODIFICACI√ìN ---

        self.tabla_calificaciones = QTableWidget(0, 4) # ID_Materia (oculto), Materia, Calificaci√≥n, Observaciones
        self.tabla_calificaciones.setHorizontalHeaderLabels(["ID_Materia", "Materia", "Calificaci√≥n (0-10)", "Observaciones"])
        self.tabla_calificaciones.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.Stretch)
        self.tabla_calificaciones.horizontalHeader().setSectionResizeMode(3, QHeaderView.ResizeMode.Stretch)
        self.tabla_calificaciones.hideColumn(0) # Ocultamos la columna ID
        self.tabla_calificaciones.setEditTriggers(QTableWidget.EditTrigger.DoubleClicked) # Permitir edici√≥n
        
        self.btn_guardar_calificaciones = QPushButton("Guardar Calificaciones")
        self.btn_guardar_calificaciones.setObjectName("primaryButton")
        
        layout_der.addWidget(self.tabla_calificaciones)
        layout_der.addWidget(self.btn_guardar_calificaciones)
        layout_main.addWidget(panel_der, 2)
        
        # Conexiones
        self.combo_curso_calif.currentIndexChanged.connect(self.cargar_alumnos_para_calificar)
        self.lista_alumnos_calif.currentItemChanged.connect(self.cargar_tabla_calificaciones)
        self.btn_guardar_calificaciones.clicked.connect(self.guardar_calificaciones)
        
        # --- INICIO DE MODIFICACI√ìN: Conectar el nuevo ComboBox ---
        # (A√±adimos un lambda para que llame a la funci√≥n de recarga)
        self.combo_parcial_select.currentIndexChanged.connect(lambda: self.cargar_tabla_calificaciones(self.lista_alumnos_calif.currentItem(), None))
        # --- FIN DE MODIFICACI√ìN ---
        
        return widget
        
    def cargar_combo_cursos_calif(self):
        """Carga los cursos en el combo de la p√°g. de calificaciones."""
        try:
            if not hasattr(self, 'combo_curso_calif'): return
            self.combo_curso_calif.clear()
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT id, nombre_curso FROM cursos ORDER BY nombre_curso")
                cursos = cursor.fetchall()
            
            self.combo_curso_calif.addItem("--- Seleccione un Curso ---", userData=None)
            for curso in cursos:
                self.combo_curso_calif.addItem(curso['nombre_curso'], userData=curso['id'])
        except Exception as e:
            mostrar_error(f"Error al cargar cursos para calificar: {e}")

    def cargar_alumnos_para_calificar(self):
        """Carga la lista de alumnos inscritos en el curso seleccionado."""
        try:
            if not hasattr(self, 'lista_alumnos_calif'): return
            self.lista_alumnos_calif.clear()
            self.tabla_calificaciones.setRowCount(0)
            curso_id = self.combo_curso_calif.currentData()
            if not curso_id: return

            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT i.id, a.nombres, a.apellido_paterno, a.apellido_materno
                    FROM inscripciones i
                    JOIN alumnos a ON i.alumno_id = a.id
                    WHERE i.curso_id = ?
                    ORDER BY a.apellido_paterno
                """, (curso_id,))
                alumnos = cursor.fetchall()
            
            for alumno in alumnos:
                nombre_completo = f"{alumno['apellido_paterno']} {alumno['apellido_materno']}, {alumno['nombres']}"
                item = QListWidgetItem(nombre_completo)
                item.setData(Qt.ItemDataRole.UserRole, alumno['id']) # Guardamos el ID de INSCRIPCI√ìN
                self.lista_alumnos_calif.addItem(item)
        except Exception as e:
            mostrar_error(f"Error al cargar alumnos para calificar: {e}")

    def cargar_tabla_calificaciones(self, current_item, previous_item):
        """Carga las materias y las calificaciones existentes del alumno."""
        try:
            if not hasattr(self, 'tabla_calificaciones') or not current_item:
                self.tabla_calificaciones.setRowCount(0)
                return

            inscripcion_id = current_item.data(Qt.ItemDataRole.UserRole)
            curso_id = self.combo_curso_calif.currentData()
            
            # --- INICIO DE MODIFICACI√ìN: Determinar qu√© parcial cargar ---
            idx_parcial = self.combo_parcial_select.currentIndex()
            col_calif_db = f"parcial_{idx_parcial + 1}"
            col_obs_db = f"obs_{idx_parcial + 1}"
            # --- FIN DE MODIFICACI√ìN ---
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                # 1. Obtener todas las materias de ese curso
                cursor.execute("SELECT id, nombre_materia FROM materias WHERE curso_id = ?", (curso_id,))
                materias = cursor.fetchall()
                
                # 2. Obtener las calificaciones YA GUARDADAS
                # --- MODIFICADO: Seleccionar solo las columnas del parcial elegido ---
                cursor.execute(f"SELECT materia_id, {col_calif_db}, {col_obs_db} FROM calificaciones WHERE inscripcion_id = ?", (inscripcion_id,))
                
                # Mapear materia_id -> (calificacion, observacion)
                calif_guardadas = {
                    c['materia_id']: (c[col_calif_db], c[col_obs_db]) 
                    for c in cursor.fetchall()
                }

            self.tabla_calificaciones.setRowCount(len(materias))
            for row, materia in enumerate(materias):
                materia_id = materia['id']
                calif, obs = calif_guardadas.get(materia_id, (0.0, "")) # Default
                
                self.tabla_calificaciones.setItem(row, 0, QTableWidgetItem(str(materia_id)))
                self.tabla_calificaciones.setItem(row, 1, QTableWidgetItem(materia['nombre_materia']))
                self.tabla_calificaciones.setItem(row, 2, QTableWidgetItem(str(calif)))
                self.tabla_calificaciones.setItem(row, 3, QTableWidgetItem(obs))
                
                # La columna 1 (Materia) no debe ser editable
                item_materia = self.tabla_calificaciones.item(row, 1)
                item_materia.setFlags(item_materia.flags() & ~Qt.ItemFlag.ItemIsEditable)

        except Exception as e:
            mostrar_error(f"Error al cargar tabla de calificaciones: {e}")

    def guardar_calificaciones(self):
        """Guarda o actualiza las calificaciones de la tabla en la BD."""
        try:
            current_item = self.lista_alumnos_calif.currentItem()
            if not current_item:
                mostrar_error("Debe seleccionar un alumno.")
                return
            
            inscripcion_id = current_item.data(Qt.ItemDataRole.UserRole)
            
            # --- INICIO DE MODIFICACI√ìN: Determinar d√≥nde guardar ---
            idx_parcial = self.combo_parcial_select.currentIndex()
            col_calif_db = f"parcial_{idx_parcial + 1}"
            col_obs_db = f"obs_{idx_parcial + 1}"
            # --- FIN DE MODIFICACI√ìN ---
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                
                for row in range(self.tabla_calificaciones.rowCount()):
                    materia_id = int(self.tabla_calificaciones.item(row, 0).text())
                    
                    calificacion_str = self.tabla_calificaciones.item(row, 2).text()
                    try:
                        calificacion = float(calificacion_str)
                    except ValueError:
                        calificacion = 0.0
                        
                    observaciones = self.tabla_calificaciones.item(row, 3).text()
                    
                    # Usar "INSERT OR REPLACE" (UPSERT)
                    cursor.execute("SELECT id FROM calificaciones WHERE inscripcion_id = ? AND materia_id = ?", (inscripcion_id, materia_id))
                    existe = cursor.fetchone()
                    
                    if existe:
                        # Actualizar (MODIFICADO para guardar en la columna correcta)
                        query = f"""
                            UPDATE calificaciones SET {col_calif_db} = ?, {col_obs_db} = ?
                            WHERE id = ?
                        """
                        cursor.execute(query, (calificacion, observaciones, existe['id']))
                    else:
                        # Insertar (MODIFICADO para guardar en la columna correcta)
                        query = f"""
                            INSERT INTO calificaciones (inscripcion_id, materia_id, {col_calif_db}, {col_obs_db})
                            VALUES (?, ?, ?, ?)
                        """
                        cursor.execute(query, (inscripcion_id, materia_id, calificacion, observaciones))

                conn.commit()
            mostrar_info("Calificaciones guardadas exitosamente.")

        except Exception as e:
            mostrar_error(f"Error al guardar calificaciones: {e}")

    # ---- P√ÅGINA 6: CONFIGURACI√ìN (NUEVA) ----
    def crear_pagina_configuracion(self):
        """Crea la interfaz para la p√°gina de configuraci√≥n con desplazamiento."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_principal = QVBoxLayout(widget)
        layout_principal.setContentsMargins(0, 0, 0, 0) # M√°rgenes cero para el scroll

        # 1. Crear el √°rea de desplazamiento
        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setFrameShape(QFrame.Shape.NoFrame) # Quitar borde al scroll

        # 2. Widget contenedor para el contenido
        scroll_content = QWidget()
        layout_content = QVBoxLayout(scroll_content)
        layout_content.setContentsMargins(15, 15, 15, 30) # Margen inferior extra
        layout_content.setSpacing(20)
        layout_content.setAlignment(Qt.AlignmentFlag.AlignTop)

        # --- Grupo Apariencia ---
        group_apariencia = QGroupBox("Apariencia de la Aplicaci√≥n")
        group_apariencia.setMaximumWidth(450) 
        form_apariencia = QFormLayout(group_apariencia)

        self.combo_tema = QComboBox()
        self.combo_tema.addItems(["Claro", "Oscuro"])
        self.combo_tema.setCurrentText(self.theme)
        self.combo_tema.currentTextChanged.connect(self.actualizar_tema)
        form_apariencia.addRow(QLabel("Tema General:"), self.combo_tema)

        self.combo_acento = QComboBox()
        self.combo_acento.addItems(["Naranja", "Azul", "Verde"])
        self.combo_acento.setCurrentText(self.accent)
        self.combo_acento.currentTextChanged.connect(self.actualizar_tema)
        form_apariencia.addRow(QLabel("Color de Acento:"), self.combo_acento)
        
        lbl_colores_logo = QLabel("Pr√≥ximamente: Extraer colores del logo.")
        lbl_colores_logo.setObjectName("placeholderText")
        form_apariencia.addRow(QLabel("Colores del Logo:"), lbl_colores_logo)
        
        layout_content.addWidget(group_apariencia)

        # --- Grupo Reloj ---
        group_reloj = QGroupBox("Configuraci√≥n de Hora")
        group_reloj.setMaximumWidth(450) 
        form_reloj = QFormLayout(group_reloj)
        
        lbl_zona_horaria = QLabel("Pr√≥ximamente: Ajuste de Zona Horaria / Formato 12h/24h.")
        lbl_zona_horaria.setObjectName("placeholderText")
        form_reloj.addRow(QLabel("Ajustes de Hora:"), lbl_zona_horaria)
        
        layout_content.addWidget(group_reloj)

        # --- Grupo Base de Datos ---
        group_db = QGroupBox("Respaldo y Restauraci√≥n de Base de Datos")
        group_db.setMaximumWidth(450)
        layout_db = QVBoxLayout(group_db)

        lbl_info_db = QLabel("Genera copias de seguridad de tu informaci√≥n o restaura un respaldo anterior.\nPuedes guardar el respaldo en tu carpeta de OneDrive/Google Drive para tenerlo en la nube.")
        lbl_info_db.setWordWrap(True)
        # Ajuste de color para que se vea bien en temas claros y oscuros
        lbl_info_db.setStyleSheet("opacity: 0.7; font-size: 9pt; margin-bottom: 10px;") 

        btn_backup = QPushButton("üíæ Generar Respaldo (Backup)")
        btn_backup.setObjectName("primaryButton")
        btn_backup.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_backup.clicked.connect(self.respaldar_base_datos)

        btn_restore = QPushButton("‚ôªÔ∏è Restaurar desde Respaldo")
        btn_restore.setObjectName("secondaryButton")
        btn_restore.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_restore.setStyleSheet("background-color: #d9534f; color: white; font-weight: bold;")
        btn_restore.clicked.connect(self.restaurar_base_datos)

        layout_db.addWidget(lbl_info_db)
        layout_db.addWidget(btn_backup)
        layout_db.addWidget(btn_restore)

        layout_content.addWidget(group_db)
        
        group_updates = QGroupBox("Actualizaciones del Sistema")
        group_updates.setMaximumWidth(450)
        layout_updates = QVBoxLayout(group_updates)

        # (Aseg√∫rate de tener la variable APP_CURRENT_VERSION definida al inicio de tu script)
        try:
            version_actual = APP_CURRENT_VERSION
        except NameError:
            version_actual = "No definida"

        lbl_info_updates = QLabel(f"Versi√≥n actual: {version_actual}\nBusque nuevas versiones en el repositorio.")
        lbl_info_updates.setWordWrap(True)
        lbl_info_updates.setStyleSheet("opacity: 0.7; font-size: 9pt; margin-bottom: 10px;")

        self.btn_check_updates = QPushButton("üõ∞Ô∏è Buscar Actualizaciones")
        self.btn_check_updates.setObjectName("primaryButton") # Estilo azul
        self.btn_check_updates.setCursor(Qt.CursorShape.PointingHandCursor)
        self.btn_check_updates.clicked.connect(self.on_check_for_updates_button_click)

        layout_updates.addWidget(lbl_info_updates)
        layout_updates.addWidget(self.btn_check_updates)
        
        layout_content.addWidget(group_updates)

        # Empujar todo hacia arriba
        layout_content.addStretch()

        # 3. Configurar el scroll area
        scroll_area.setWidget(scroll_content)
        layout_principal.addWidget(scroll_area)

        return widget


    # --- NUEVAS FUNCIONES ---
    def cargar_cursos_para_filtro(self):
        """Carga los cursos en el combo de filtro de la p√°gina de alumnos."""
        if not hasattr(self, 'combo_filtro_curso'): return
        
        self.combo_filtro_curso.clear()
        
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT id, nombre_curso FROM cursos ORDER BY nombre_curso")
                cursos = cursor.fetchall()
                
            self.combo_filtro_curso.addItem("--- Todos los Alumnos ---", userData=None)
            
            for curso in cursos:
                # Almacenar el ID del curso como UserData
                self.combo_filtro_curso.addItem(curso['nombre_curso'], userData=curso['id'])

        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar cursos para filtro: {e}")
        except AttributeError:
            pass # Ignorar si el widget a√∫n no est√° listo

    def filtrar_alumnos_por_curso(self, index):
        """Maneja el cambio en el combo de filtro y recarga la tabla de alumnos."""
        # El UserData es el ID del curso o None para "Todos"
        curso_id = self.combo_filtro_curso.itemData(index)
        self.cargar_tabla_alumnos(curso_id=curso_id)

    def mostrar_expediente_alumno(self):
        """Muestra los detalles completos del alumno seleccionado en la tabla."""
        if not hasattr(self, 'expediente_texto'):
            return

        selected_items = self.tabla_alumnos.selectedItems()
        if not selected_items or self.tabla_alumnos.currentRow() < 0:
            self.expediente_texto.clear()
            return

        alumno_id_item = self.tabla_alumnos.item(self.tabla_alumnos.currentRow(), 0)
        if not alumno_id_item:
            self.expediente_texto.clear()
            return

        try:
            alumno_id = int(alumno_id_item.text())
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM alumnos WHERE id = ?", (alumno_id,))
                datos_row = cursor.fetchone()

            if datos_row:
                datos = dict(datos_row)
                
                # --- PREPARACI√ìN DE LA FOTO ---
                foto_html = ""
                ruta_foto_bd = datos.get('foto_ruta')
                if ruta_foto_bd and os.path.exists(ruta_foto_bd):
                    ruta_normalizada = ruta_foto_bd.replace('\\', '/')
                    foto_html = f'<img src="{ruta_normalizada}" width="150" height="200">'
                else:
                    # Placeholder usando una tabla simple para evitar problemas de fondo
                    foto_html = '<table width="150" height="200" bgcolor="#cccccc"><tr><td align="center" valign="middle" style="color:#555555; font-size:14px;">Sin Foto</td></tr></table>'

                # --- CONSTRUCCI√ìN DEL EXPEDIENTE (USANDO TABLA PARA DISE√ëO) ---
                expediente_str = f"""
                <table width="100%" border="0" cellspacing="0" cellpadding="5">
                    <tr>
                        <td valign="top">
                            <b><u>DATOS DEL ALUMNO</u></b><br>
                            <b>ID:</b> {datos['id']}<br>
                            <b>Nombre:</b> {datos['nombres']} {datos['apellido_paterno']} {datos['apellido_materno']}<br>
                            <b>Edad:</b> {datos['edad']} a√±os<br>
                            <b>Turno:</b> {datos['turno']}<br>
                            <b>Tel√©fono:</b> {datos['telefono']}<br>
                            <b>Email:</b> {datos['email']}<br>
                            <b>Escuela Procedencia:</b> {datos['escuela_procedencia']}<br>
                            <b>Escuela a Ingresar:</b> {datos['escuela_ingresar']}<br>
                            <b>Autoriza Salida Solo:</b> {'S√≠' if datos.get('autoriza_salida_solo') == 1 else 'No'}
                        </td>
                        <td valign="top" align="right" width="160">
                            {foto_html}
                        </td>
                    </tr>
                </table>
                <hr>
                <b><u>DATOS DEL TUTOR</u></b><br>
                <b>Nombre:</b> {datos['tutor_nombres']} {datos['tutor_ap_paterno']} {datos['tutor_ap_materno']}<br>
                <b>Tel√©fono:</b> {datos['tutor_telefono']}<br>
                <br>
                <b><u>DOMICILIO</u></b><br>
                <b>Calle:</b> {datos['dom_calle']} <b>N¬∞ Ext:</b> {datos['dom_num_ext']} <b>N¬∞ Int:</b> {datos['dom_num_int']}<br>
                <b>Colonia:</b> {datos['dom_colonia']} <b>C.P.:</b> {datos['dom_cp']}<br>
                <b>Municipio:</b> {datos['dom_municipio']} <b>Estado:</b> {datos['dom_estado']}<br>
                <br>
                <b><u>CONTACTOS DE EMERGENCIA</u></b><br>
                <b>1:</b> {datos['emerg_1_nombre']} ({datos['emerg_1_parentesco']}) - Tel: {datos['emerg_1_telefono']}<br>
                <b>2:</b> {datos['emerg_2_nombre']} ({datos['emerg_2_parentesco']}) - Tel: {datos['emerg_2_telefono']}<br>
                """
                self.expediente_texto.setHtml(expediente_str)
            else:
                self.expediente_texto.setText("No se encontraron datos para el alumno seleccionado.")

        except ValueError:
            self.expediente_texto.setText("Error: ID de alumno inv√°lido.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al buscar expediente: {e}")
            self.expediente_texto.clear()
        except Exception as e:
             mostrar_error(f"Error inesperado al mostrar expediente: {e}")

    def dar_baja_alumno(self):
        """Elimina al alumno seleccionado de la base de datos."""
        if not hasattr(self, 'tabla_alumnos') or not hasattr(self, 'expediente_texto'):
            return

        selected_items = self.tabla_alumnos.selectedItems()
        if not selected_items:
            mostrar_error("Por favor, seleccione un alumno de la lista para dar de baja.")
            return

        selected_row = self.tabla_alumnos.currentRow()
        if selected_row < 0:
            mostrar_error("Por favor, seleccione un alumno de la lista para dar de baja.")
            return

        alumno_id_item = self.tabla_alumnos.item(selected_row, 0)
        nombre_item = self.tabla_alumnos.item(selected_row, 1) 
        ap_paterno_item = self.tabla_alumnos.item(selected_row, 2) 

        if not alumno_id_item or not nombre_item or not ap_paterno_item:
            mostrar_error("No se pudo obtener la informaci√≥n completa del alumno seleccionado.")
            return

        try:
            alumno_id = int(alumno_id_item.text())
            nombre_completo = f"{nombre_item.text()} {ap_paterno_item.text()}"

            reply = QMessageBox.question(self, "Confirmar Baja",
                                         f"¬øEst√° seguro que desea dar de baja al alumno:\n\n{nombre_completo} (ID: {alumno_id})?\n\nEsta acci√≥n eliminar√° tambi√©n todas sus inscripciones y pagos asociados. Esta acci√≥n no se puede deshacer.",
                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.Cancel)

            if reply == QMessageBox.StandardButton.Yes:
                with get_db_connection() as conn:
                    cursor = conn.cursor()

                    # 1. Obtener IDs de inscripciones del alumno
                    cursor.execute("SELECT id FROM inscripciones WHERE alumno_id = ?", (alumno_id,))
                    inscripciones_ids_tuples = cursor.fetchall() 
                    # Convertir lista de Rows a lista de IDs
                    inscripciones_ids = [row['id'] for row in inscripciones_ids_tuples]


                    # 2. Borrar pagos asociados a esas inscripciones (si hay alguna)
                    if inscripciones_ids:
                        # Crear placeholders (?) para la consulta IN
                        placeholders = ','.join('?' for _ in inscripciones_ids)
                        cursor.execute(f"DELETE FROM pagos WHERE inscripcion_id IN ({placeholders})", inscripciones_ids)

                    # 3. Borrar inscripciones del alumno
                    cursor.execute("DELETE FROM inscripciones WHERE alumno_id = ?", (alumno_id,))

                    # 4. Borrar al alumno
                    cursor.execute("DELETE FROM alumnos WHERE id = ?", (alumno_id,))

                    conn.commit()

                mostrar_info(f"Alumno {nombre_completo} (ID: {alumno_id}) dado de baja exitosamente.")
                self.cargar_tabla_alumnos() 
                self.expediente_texto.clear() 
                self.cargar_tabla_inscripciones_pagos()

        except ValueError:
            mostrar_error("Error: ID de alumno inv√°lido.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al dar de baja al alumno: {e}")
            print(f"--- SQLITE ERROR DETAILED: {e} ---") 
            traceback.print_exc()
        except Exception as e:
             mostrar_error(f"Error inesperado al dar de baja: {e}")
             print(f"--- UNEXPECTED ERROR DETAILED: {e} ---") 
             traceback.print_exc()


    # --- M√©todos de carga y registro (MODIFICADOS) ---

    def cargar_cache_inscripciones(self):
        """Carga TODAS las inscripciones (Pagadas, Parciales, Pendientes) en una cach√© local."""
        self._inscripciones_cache = []
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                # Consulta SQL modificada para INCLUIR TODAS las inscripciones, incluyendo el estado 'Pagado'.
                query = """
                SELECT
                    i.id, i.monto_total, i.monto_pagado, i.estado,
                    a.nombres, a.apellido_paterno, a.apellido_materno,
                    c.nombre_curso
                FROM inscripciones i
                JOIN alumnos a ON i.alumno_id = a.id
                LEFT JOIN cursos c ON i.curso_id = c.id
                ORDER BY a.apellido_paterno, c.nombre_curso
                """
                cursor.execute(query)
                inscripciones = cursor.fetchall()
                
            for inscripcion in inscripciones:
                # Calcular el saldo pendiente y crear el texto de visualizaci√≥n
                total = inscripcion['monto_total']
                pagado = inscripcion['monto_pagado']
                pendiente = total - pagado
                estado = inscripcion['estado']
                
                # Formato del texto: APELLIDO, NOMBRE - CURSO (Estado o Pendiente)
                if estado == 'Pagado':
                    status_text = "(Pagado)"
                elif estado == 'Pendiente':
                    status_text = f"(Pendiente: ${pendiente:.2f})"
                else: # Parcial
                    status_text = f"(Parcial: ${pendiente:.2f})"
                
                texto_completo = f"{inscripcion['apellido_paterno']} {inscripcion['apellido_materno']}, {inscripcion['nombres']} - {inscripcion['nombre_curso']} {status_text}"
                
                self._inscripciones_cache.append({
                    'id': inscripcion['id'],
                    'data': (inscripcion['id'], total, pagado),
                    'display_text': texto_completo,
                    'search_keys': texto_completo.lower() # Texto para b√∫squeda r√°pida
                })
        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar la cach√© de inscripciones: {e}")
            
        self.actualizar_combo_desde_cache()
    
    # ELIMINADO: La funci√≥n de b√∫squeda se elimina si el campo de b√∫squeda ya no est√°
    # def buscar_inscripcion(self, search_term):
    #     """Filtra el QComboBox de inscripciones usando la cach√© local."""
    #     search_term = search_term.lower().strip()
        
    #     if not search_term:
    #         self.actualizar_combo_desde_cache(self._inscripciones_cache)
    #         return

    #     filtered_results = [
    #         item for item in self._inscripciones_cache
    #         if search_term in item['search_keys']
    #     ]
        
    #     self.actualizar_combo_desde_cache(filtered_results)
    
    def actualizar_combo_desde_cache(self, items_to_display=None):
        """
        Rellena el QComboBox con los resultados filtrados o toda la cach√©.
        """
        if items_to_display is None:
            items_to_display = self._inscripciones_cache
            
        self.combo_inscripcion_pago.blockSignals(True) # Evitar que dispare currentIndexChanged
        self.combo_inscripcion_pago.clear()
        self.combo_inscripcion_pago.addItem("--- Seleccione una inscripci√≥n ---", userData=None)
        
        for item in items_to_display:
            self.combo_inscripcion_pago.addItem(item['display_text'], userData=item['data'])
            
        self.combo_inscripcion_pago.blockSignals(False)
        self.actualizar_detalles_pago() # Para limpiar los detalles si no hay selecci√≥n


    def cargar_tabla_inscripciones_pagos(self):
        """Recarga la cach√© de inscripciones y actualiza el combo."""
        # Esta funci√≥n ahora solo llama a cargar_cache_inscripciones
        self.cargar_cache_inscripciones()


    def actualizar_detalles_pago(self):
        """Actualiza los labels y la tabla de historial cuando se selecciona una inscripci√≥n."""
        try: 
            if hasattr(self, 'combo_inscripcion_pago'):
                data = self.combo_inscripcion_pago.currentData()

                if not data:
                    if hasattr(self, 'lbl_pago_total'): self.lbl_pago_total.setText("$ 0.00")
                    if hasattr(self, 'lbl_pago_pagado'): self.lbl_pago_pagado.setText("$ 0.00")
                    if hasattr(self, 'lbl_pago_pendiente'): self.lbl_pago_pendiente.setText("$ 0.00")
                    if hasattr(self, 'spin_monto_pago'): self.spin_monto_pago.setValue(0.0)
                    if hasattr(self, 'tabla_historial_pagos'): self.tabla_historial_pagos.setRowCount(0)
                    
                    if hasattr(self, 'spin_monto_pago'): self.spin_monto_pago.setEnabled(False)
                    if hasattr(self, 'btn_registrar_pago'): self.btn_registrar_pago.setEnabled(False)
                    
                    return

                insc_id, total, pagado = data
                pendiente = total - pagado
                
                # Deshabilitar el monto a pagar si ya est√° saldado
                if pendiente <= 0.001:
                    self.spin_monto_pago.setValue(0.00)
                    self.spin_monto_pago.setEnabled(False)
                    self.btn_registrar_pago.setEnabled(False)
                else:
                    self.spin_monto_pago.setValue(max(0.01, pendiente))
                    self.spin_monto_pago.setEnabled(True)
                    self.btn_registrar_pago.setEnabled(True)


                if hasattr(self, 'lbl_pago_total'): self.lbl_pago_total.setText(f"$ {total:.2f}")
                if hasattr(self, 'lbl_pago_pagado'): self.lbl_pago_pagado.setText(f"$ {pagado:.2f}")
                if hasattr(self, 'lbl_pago_pendiente'): self.lbl_pago_pendiente.setText(f"$ {pendiente:.2f}")

                # Cargar historial de pagos
                self.cargar_historial_pagos(insc_id)
        except AttributeError:
             pass
    
    def cargar_historial_pagos(self, inscripcion_id):
        """Rellena la tabla con el historial de pagos de una inscripci√≥n."""
        try: 
            # 1. Limpiar la tabla si existe
            if hasattr(self, 'tabla_historial_pagos'):
                self.tabla_historial_pagos.setRowCount(0)
            
            # 2. Conectar a la BD y cargar datos
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                SELECT fecha_pago, monto, metodo_pago
                FROM pagos
                WHERE inscripcion_id = ?
                ORDER BY fecha_pago DESC
                """, (inscripcion_id,))

                pagos = cursor.fetchall()

                # 3. Rellenar la tabla (solo si existe)
                if hasattr(self, 'tabla_historial_pagos'):
                    self.tabla_historial_pagos.setRowCount(len(pagos))
                    for row, pago in enumerate(pagos): 
                        self.tabla_historial_pagos.setItem(row, 0, QTableWidgetItem(pago['fecha_pago']))
                        item_monto = QTableWidgetItem(f"$ {pago['monto']:.2f}")
                        item_monto.setTextAlignment(Qt.AlignmentFlag.AlignRight | Qt.AlignmentFlag.AlignVCenter)
                        self.tabla_historial_pagos.setItem(row, 1, item_monto)
                        self.tabla_historial_pagos.setItem(row, 2, QTableWidgetItem(pago['metodo_pago']))

        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar historial de pagos: {e}")
        except AttributeError:
            pass # Ignorar si el widget no existe

    def registrar_pago(self):
        """Registra un nuevo pago en la BD y genera la siguiente mensualidad si aplica."""
        
        data = self.combo_inscripcion_pago.currentData()
        if not data:
            mostrar_error("Debe seleccionar una inscripci√≥n.")
            return

        insc_id, monto_total_actual, monto_pagado_actual = data
        monto_a_pagar = self.spin_monto_pago.value()

        if monto_a_pagar <= 0:
            mostrar_error("El monto a pagar debe ser mayor a cero.")
            return

        saldo_pendiente = monto_total_actual - monto_pagado_actual
        if monto_a_pagar > saldo_pendiente + 0.001: 
             reply = QMessageBox.question(self, "Confirmar Sobrepago",
                                         f"El monto a pagar (${monto_a_pagar:.2f}) es mayor al saldo pendiente (${saldo_pendiente:.2f}).\n¬øDesea continuar?",
                                             QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
             if reply == QMessageBox.StandardButton.No:
                 return

        fecha_pago = datetime.date.today().isoformat()
        metodo_pago = self.combo_metodo_pago.currentText()
        nuevo_monto_pagado = monto_pagado_actual + monto_a_pagar
        
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()

                # --- NUEVO: Obtener el tipo de plan y curso_id de la inscripci√≥n ---
                cursor.execute("SELECT tipo_pago_seleccionado, curso_id FROM inscripciones WHERE id = ?", (insc_id,))
                insc_data = cursor.fetchone()
                plan_tipo = insc_data['tipo_pago_seleccionado']
                curso_id = insc_data['curso_id']
                # --- FIN NUEVO ---

                # 1. Insertar en la tabla de pagos (Esto no cambia)
                cursor.execute("""
                INSERT INTO pagos (inscripcion_id, monto, fecha_pago, metodo_pago)
                VALUES (?, ?, ?, ?)
                """, (insc_id, monto_a_pagar, fecha_pago, metodo_pago))

                # --- INICIO DE L√ìGICA DE ACTUALIZACI√ìN MODIFICADA ---
                
                nuevo_monto_total = monto_total_actual
                
                if plan_tipo == "Mensualidad":
                    # --- ES UNA COLEGIATURA MENSUAL ---
                    
                    # Comprobamos si el pago actual cubre la deuda actual
                    if nuevo_monto_pagado >= (monto_total_actual - 0.001):
                        # 1. S√≠ cubre, as√≠ que generamos la deuda del siguiente mes.
                        #    Obtenemos el costo base de la mensualidad
                        cursor.execute("SELECT costo_mensualidad FROM cursos WHERE id = ?", (curso_id,))
                        curso_data = cursor.fetchone()
                        costo_base_mensual = curso_data['costo_mensualidad']
                        
                        # 2. El nuevo total adeudado es el total anterior + un mes m√°s
                        nuevo_monto_total = monto_total_actual + costo_base_mensual
                    
                    # 3. Determinamos el nuevo estado (nunca ser√° 'Pagado' a menos que pague por adelantado)
                    if nuevo_monto_pagado >= (nuevo_monto_total - 0.001):
                        nuevo_estado = 'Pagado' # Pag√≥ este mes Y el siguiente
                    elif nuevo_monto_pagado > 0:
                        nuevo_estado = 'Parcial' # (Estado normal: debe el siguiente mes)
                    else:
                        nuevo_estado = 'Pendiente'
                        
                else:
                    # --- L√ìGICA ORIGINAL (Para cursos fijos) ---
                    nuevo_monto_total = monto_total_actual # El total no cambia
                    if nuevo_monto_pagado >= (monto_total_actual - 0.001):
                        nuevo_estado = 'Pagado'
                    elif nuevo_monto_pagado > 0:
                        nuevo_estado = 'Parcial'
                    else:
                        nuevo_estado = 'Pendiente'

                # 2. Actualizar la tabla de inscripciones (Unificado)
                cursor.execute("""
                UPDATE inscripciones
                SET monto_pagado = ?, monto_total = ?, estado = ?
                WHERE id = ?
                """, (nuevo_monto_pagado, nuevo_monto_total, nuevo_estado, insc_id))
                # --- FIN DE L√ìGICA DE ACTUALIZACI√ìN ---

                conn.commit()

            mostrar_info("Pago registrado exitosamente.")

            # (Preguntar por el recibo)
            opciones_recibo = ["No generar recibo", "Ticket (Impresora T√©rmica)", "Recibo PDF (Completo)"]
            opcion_elegida, ok = QInputDialog.getItem(self, "Generar Recibo",
                                                      "¬øQu√© tipo de recibo desea generar?",
                                                      opciones_recibo, 0, False)
            
            if ok and opcion_elegida != "No generar recibo":
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("""
                        SELECT a.nombres, a.apellido_paterno, a.apellido_materno, c.nombre_curso
                        FROM inscripciones i
                        JOIN alumnos a ON i.alumno_id = a.id
                        JOIN cursos c ON i.curso_id = c.id
                        WHERE i.id = ?
                    """, (insc_id,))
                    datos_extra = cursor.fetchone()

                pago_info = {
                    "inscripcion_id": insc_id,
                    "fecha_pago": fecha_pago,
                    "monto_pagado_recibo": monto_a_pagar,
                    "metodo_pago": metodo_pago,
                    "nombre_alumno": f"{datos_extra['nombres']} {datos_extra['apellido_paterno']} {datos_extra['apellido_materno']}",
                    "nombre_curso": datos_extra['nombre_curso'],
                    "monto_total_curso": nuevo_monto_total, # Usamos el total actualizado
                    "monto_pagado_total": nuevo_monto_pagado, 
                    "saldo_pendiente": nuevo_monto_total - nuevo_monto_pagado
                }
                
                if opcion_elegida == "Recibo PDF (Completo)":
                    self.generar_ticket_pago_pdf(pago_info)
                elif opcion_elegida == "Ticket (Impresora T√©rmica)":
                    self.generar_ticket_termico_pdf(pago_info)

            # Recargar todo
            self.cargar_tabla_inscripciones_pagos() 

        except sqlite3.Error as e:
            mostrar_error(f"Error al registrar el pago: {e}")
        except Exception as e:
            mostrar_error(f"Error inesperado al generar recibo: {e}\n{traceback.format_exc()}")

    # --- FUNCI√ìN NUEVA ---
    def actualizar_opciones_pago(self):
        """Actualiza el combo de planes de pago basado en el curso seleccionado."""
        try:
            if not hasattr(self, 'combo_tipo_pago_registro'): return 
            
            self.combo_tipo_pago_registro.clear()
            self.lbl_costo_total_registro.setText("$ 0.00")
            
            curso_id = self.combo_curso_registro.currentData()
            if not curso_id:
                self.combo_tipo_pago_registro.addItem("--- Seleccione un curso ---", userData=None)
                return
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM cursos WHERE id = ?", (curso_id,))
                curso = cursor.fetchone()
                
            if not curso:
                return
            
            # --- L√ìGICA DE DESCUENTO ---
            quantizer = Decimal('0.01')
            # Usar .keys() para asegurar que la columna existe
            descuento_pct = curso['descuento_porcentaje'] if 'descuento_porcentaje' in curso.keys() else 0.0
            descuento_factor = Decimal(str(1.0 - (descuento_pct / 100.0)))
            
            def crear_texto_plan(nombre, costo_original, costo_final, num_pagos, pago_individual):
                texto = f"{nombre} (${costo_final})"
                if num_pagos > 1:
                    texto = f"{nombre} ({num_pagos} pagos de ${pago_individual})"
                if descuento_pct > 0:
                    texto += f" (Orig: ${costo_original}) - {descuento_pct}% Dto."
                return texto

            self.combo_tipo_pago_registro.addItem("--- Seleccione un plan de pago ---", userData=None)
            
            if curso['costo_exhibicion'] > 0:
                costo_orig = Decimal(curso['costo_exhibicion']).quantize(quantizer)
                costo_final = (costo_orig * descuento_factor).quantize(quantizer)
                texto = crear_texto_plan("Una Sola Exhibici√≥n", costo_orig, costo_final, 1, costo_final)
                self.combo_tipo_pago_registro.addItem(texto, userData=("Exhibici√≥n √önica", float(costo_final), 1))

            if curso['costo_sem_15'] > 0:
                costo_orig = Decimal(curso['costo_sem_15']).quantize(quantizer)
                costo_final = (costo_orig * descuento_factor).quantize(quantizer)
                pago = (costo_final / 15).quantize(quantizer, rounding=ROUND_HALF_UP)
                texto = crear_texto_plan("Semanal (15)", costo_orig, costo_final, 15, pago)
                self.combo_tipo_pago_registro.addItem(texto, userData=("Semanal (15)", float(costo_final), 15))
              
            if curso['costo_sem_12'] > 0: 
                costo_orig = Decimal(curso['costo_sem_12']).quantize(quantizer)
                costo_final = (costo_orig * descuento_factor).quantize(quantizer)
                pago = (costo_final / 12).quantize(quantizer, rounding=ROUND_HALF_UP) 
                texto = crear_texto_plan("Semanal (12)", costo_orig, costo_final, 12, pago)
                self.combo_tipo_pago_registro.addItem(texto, userData=("Semanal (12)", float(costo_final), 12))
            
            if curso['costo_mensual_3'] > 0: 
                costo_orig = Decimal(curso['costo_mensual_3']).quantize(quantizer)
                costo_final = (costo_orig * descuento_factor).quantize(quantizer)
                pago = (costo_final / 3).quantize(quantizer, rounding=ROUND_HALF_UP) 
                texto = crear_texto_plan("Mensual (3)", costo_orig, costo_final, 3, pago)
                self.combo_tipo_pago_registro.addItem(texto, userData=("Mensual (3)", float(costo_final), 3))

            if curso['costo_bi_semanal'] > 0:
                costo_orig = Decimal(curso['costo_bi_semanal']).quantize(quantizer)
                costo_final = (costo_orig * descuento_factor).quantize(quantizer)
                pago = (costo_final / 2).quantize(quantizer, rounding=ROUND_HALF_UP)
                texto = crear_texto_plan("Bisemanal (2)", costo_orig, costo_final, 2, pago)
                self.combo_tipo_pago_registro.addItem(texto, userData=("Bisemanal (2)", float(costo_final), 2)) 

            if curso['costo_mensual_4'] > 0:
                costo_orig = Decimal(curso['costo_mensual_4']).quantize(quantizer)
                costo_final = (costo_orig * descuento_factor).quantize(quantizer)
                pago = (costo_final / 4).quantize(quantizer, rounding=ROUND_HALF_UP)
                texto = crear_texto_plan("Mensual (4)", costo_orig, costo_final, 4, pago)
                self.combo_tipo_pago_registro.addItem(texto, userData=("Mensual (4)", float(costo_final), 4))
            
            # --- ESTA ES LA PARTE QUE FALTABA ---
            # Verificar si existe la columna y si tiene precio mayor a 0
            val_mensualidad = curso['costo_mensualidad'] if 'costo_mensualidad' in curso.keys() else 0.0
            
            if val_mensualidad > 0:
                costo_orig = Decimal(str(val_mensualidad)).quantize(quantizer)
                costo_final = (costo_orig * descuento_factor).quantize(quantizer)
                
                texto = f"Colegiatura Mensual (${costo_final})"
                if descuento_pct > 0:
                    texto += f" (Orig: ${costo_orig}) - {descuento_pct}% Dto."
                
                # userData = ("Mensualidad", Costo de 1 Mes, 1 pago inicial)
                self.combo_tipo_pago_registro.addItem(texto, userData=("Mensualidad", float(costo_final), 1))
            # -------------------------------------

        except sqlite3.Error as e:
             mostrar_error(f"Error al cargar planes de pago: {e}")
        except Exception as e:
             mostrar_error(f"Error inesperado al calcular descuentos: {e}\n{traceback.format_exc()}")
    
    def solicitar_y_aplicar_descuento(self, checked):
        """
        Se activa con el checkbox de descuento. Pide un porcentaje
        y actualiza el costo total.
        """
        if checked:
            porcentaje, ok = QInputDialog.getDouble(self, "Aplicar Descuento",
                                                    "Ingrese el porcentaje de descuento a aplicar (ej. 10, 15.5):",
                                                    0.0, 0.0, 100.0, 1)
            if ok:
                self.descuento_actual_pct = porcentaje
                self.lbl_descuento_info.setText(f"Descuento aplicado: {self.descuento_actual_pct}%")
            else:
                # Si el usuario cancela, desmarca el checkbox
                self.check_aplicar_descuento.setChecked(False)
        else:
            self.descuento_actual_pct = 0.0
            self.lbl_descuento_info.setText("")
        
        # Recalcular el costo total
        self.actualizar_costo_total_label()

    def actualizar_costo_total_label(self):
        """
        Actualiza el label de costo total, APLICANDO el descuento si existe.
        """
        try:
            if not hasattr(self, 'combo_tipo_pago_registro'): return
            
            data = self.combo_tipo_pago_registro.currentData()
            if data:
                plan, costo_original, num_pagos = data
                
                # Guardar el costo original
                self.costo_original_actual = costo_original
                
                # Calcular el costo final con descuento
                descuento_factor = Decimal(str(1.0 - (self.descuento_actual_pct / 100.0)))
                costo_final = (Decimal(str(costo_original)) * descuento_factor).quantize(Decimal('0.01'))
                
                # Mostrar el costo final
                self.lbl_costo_total_registro.setText(f"$ {float(costo_final):.2f}")
                
                if self.descuento_actual_pct > 0:
                    self.lbl_costo_total_registro.setText(f"$ {float(costo_final):.2f} (Orig: ${costo_original:.2f})")
                
            else:
                self.costo_original_actual = 0.0
                self.lbl_costo_total_registro.setText("$ 0.00")
        except AttributeError:
             pass
            
    # --- FUNCI√ìN NUEVA ---
    def actualizar_costo_total_label(self):
        """Actualiza el label de costo total al seleccionar un plan de pago."""
        try:
            if not hasattr(self, 'combo_tipo_pago_registro'): return
            
            data = self.combo_tipo_pago_registro.currentData()
            if data:
                plan, costo_total, num_pagos = data
                self.lbl_costo_total_registro.setText(f"$ {costo_total:.2f}")
            else:
                self.lbl_costo_total_registro.setText("$ 0.00")
        except AttributeError:
            pass 

    def cargar_combo_curso_registro(self):
        """Carga los cursos en el combo del formulario de registro."""
        try:
             if hasattr(self, 'combo_curso_registro'):
          
                current_id = self.combo_curso_registro.currentData()

                self.combo_curso_registro.clear()
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("SELECT id, nombre_curso FROM cursos ORDER BY nombre_curso")
                    cursos = cursor.fetchall()
                    self.combo_curso_registro.addItem("--- Seleccione un Curso ---", userData=None)
                 
                    found_index = -1
                    for index, curso in enumerate(cursos): 
                        user_data = curso['id']
                        self.combo_curso_registro.addItem(curso['nombre_curso'], userData=user_data)
                
                        if current_id is not None and curso['id'] == current_id:
                            found_index = index + 1

                if found_index != -1:
                    self.combo_curso_registro.setCurrentIndex(found_index)
                else:
                    self.actualizar_opciones_pago() 

        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar combo de cursos en registro: {e}")
        except AttributeError:
            pass 

    def registrar_alumno_e_inscribir(self):
        """Guarda un nuevo alumno y lo inscribe al curso seleccionado."""
        try:
            # Datos Alumno
            ap_paterno = self.entry_al_ap_paterno.text().strip()
            ap_materno = self.entry_al_ap_materno.text().strip()
            nombres = self.entry_al_nombres.text().strip()
            email = self.entry_al_email.text().strip()
            
            # --- VALIDACI√ìN ---
            if not ap_paterno or not nombres:
                mostrar_error("Apellido Paterno y Nombre(s) del alumno son obligatorios.")
                return
                
            # --- VALIDACI√ìN DE PLAN DE PAGO ---
            plan_data = self.combo_tipo_pago_registro.currentData()
            if not plan_data:
                mostrar_error("Debe seleccionar un plan de pago para inscribir al alumno.")
                return

            plan_nombre, monto_total, num_pagos = plan_data
            curso_id = self.combo_curso_registro.currentData()
            if not curso_id: 
                mostrar_error("Debe seleccionar un curso para inscribir al alumno.")
                return
                
            fecha_insc = datetime.date.today().isoformat()

        
            # Recolectar el resto de los datos
            esc_procedencia = self.entry_al_escuela_procedencia.text().strip()
            esc_ingresar = self.entry_al_escuela_ingresar.text().strip()
            edad_str = self.entry_al_edad.text().strip()
            telefono = self.entry_al_telefono.text().strip()
            turno = self.combo_al_turno.currentText()
            autoriza_salida = 1 if self.check_autoriza_salida.isChecked() else 0
            imprimir_poliza = self.check_imprimir_poliza.isChecked() 
            
            tutor_ap_paterno = self.entry_tutor_ap_paterno.text().strip()
            tutor_ap_materno = self.entry_tutor_ap_materno.text().strip()
            tutor_nombres = self.entry_tutor_nombres.text().strip()
            tutor_telefono = self.entry_tutor_telefono.text().strip()
            dom_calle = self.entry_dom_calle.text().strip()
            dom_num_int = self.entry_dom_num_int.text().strip()
            dom_num_ext = self.entry_dom_num_ext.text().strip()
            dom_colonia = self.entry_dom_colonia.text().strip()
            dom_municipio = self.entry_dom_municipio.text().strip()
            dom_estado = self.entry_dom_estado.text().strip()
            dom_cp = self.entry_dom_cp.text().strip()
            emerg_1_nombre = self.entry_emerg_1_nombre.text().strip()
            emerg_1_telefono = self.entry_emerg_1_telefono.text().strip()
            emerg_1_parentesco = self.entry_emerg_1_parentesco.text().strip()
            emerg_2_nombre = self.entry_emerg_2_nombre.text().strip()
            emerg_2_telefono = self.entry_emerg_2_telefono.text().strip()
            emerg_2_parentesco = self.entry_emerg_2_parentesco.text().strip()
            edad = int(edad_str) if edad_str.isdigit() else 0

            # --- Inserci√≥n en BD (Transacci√≥n) ---
            with get_db_connection() as conn:
                cursor = conn.cursor()

                # 1. Insertar Alumno
                cursor.execute("""
                INSERT INTO alumnos (
                    apellido_paterno, apellido_materno, nombres, escuela_procedencia,
                    escuela_ingresar, edad, telefono, email, turno,
                    tutor_ap_paterno, tutor_ap_materno, tutor_nombres, tutor_telefono,
                    dom_calle, dom_num_int, dom_num_ext, dom_colonia, dom_municipio,
                    dom_estado, dom_cp,
                    emerg_1_nombre, emerg_1_telefono, emerg_1_parentesco,
                    emerg_2_nombre, emerg_2_telefono, emerg_2_parentesco,
                    autoriza_salida_solo
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                """, (
                    ap_paterno, ap_materno, nombres, esc_procedencia,
                    esc_ingresar, edad, telefono, email, turno,
                    tutor_ap_paterno, tutor_ap_materno, tutor_nombres, tutor_telefono,
                    dom_calle, dom_num_int, dom_num_ext, dom_colonia, dom_municipio,
                    dom_estado, dom_cp,
                    emerg_1_nombre, emerg_1_telefono, emerg_1_parentesco,
                    emerg_2_nombre, emerg_2_telefono, emerg_2_parentesco,
                    autoriza_salida
                ))
                alumno_id = cursor.lastrowid
                
                plan_data = self.combo_tipo_pago_registro.currentData()
                plan_nombre, monto_original, num_pagos = plan_data
                descuento_factor = Decimal(str(1.0 - (self.descuento_actual_pct / 100.0)))
                monto_final_decimal = (Decimal(str(monto_original)) * descuento_factor).quantize(Decimal('0.01'))
                monto_final = float(monto_final_decimal)
                descuento_guardar = self.descuento_actual_pct

                ruta_final_foto = ""
                if self.ruta_foto_temporal and os.path.exists(self.ruta_foto_temporal):
                    try:
                        from PIL import Image # Aseg√∫rate de tener Pillow instalado
                        
                        # 1. Abrir la imagen original
                        img = Image.open(self.ruta_foto_temporal)

                        # 2. Redimensionar si es muy grande (opcional pero recomendado)
                        max_size = (400, 400)
                        img.thumbnail(max_size, Image.Resampling.LANCZOS)

                        # 3. Definir ruta final absoluta con extensi√≥n .png
                        nombre_foto = f"foto_{alumno_id}.png"
                        ruta_final_foto = os.path.abspath(os.path.join(FOTOS_DIR, nombre_foto))
                        
                        # 4. Guardar como PNG (m√°s compatible con reportlab)
                        img.save(ruta_final_foto, "PNG")
                        
                        # 5. Actualizar BD con la ruta absoluta
                        cursor.execute("UPDATE alumnos SET foto_ruta = ? WHERE id = ?", (ruta_final_foto, alumno_id))
                        
                    except Exception as e:
                        print(f"Error al procesar foto: {e}")
                        QMessageBox.warning(self, "Advertencia", f"No se pudo guardar la foto: {e}")

                conn.commit()

                mostrar_info("Alumno registrado e inscrito exitosamente.")

                self.ruta_foto_temporal = None
                self.lbl_foto_registro.setText("Sin Foto")
                self.lbl_foto_registro.setPixmap(QPixmap())

                self.limpiar_campos_alumno()  # Limpia el resto de campos de texto
                self.cargar_datos_maestros()  # Recarga las tablas (alumnos, etc.)

                # 2. Insertar Inscripci√≥n
                cursor.execute("""
                INSERT INTO inscripciones (
                    alumno_id, curso_id, fecha_inscripcion, 
                    monto_original, descuento_aplicado_pct, monto_total, 
                    estado, tipo_pago_seleccionado
                )
                VALUES (?, ?, ?, ?, ?, ?, 'Pendiente', ?)
                """, (alumno_id, curso_id, fecha_insc, 
                      monto_original, descuento_guardar, monto_final, 
                      plan_nombre))
                
                inscripcion_id = cursor.lastrowid
                conn.commit()

                mostrar_info("Alumno registrado e inscrito al curso exitosamente.")

                        # --- Preguntar para generar PDF ---
                reply = QMessageBox.question(self, "Generar PDF",
                                            "¬øDesea generar la ficha completa de inscripci√≥n en PDF ahora?",
                                            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)

                # --- Bloque 1: Generaci√≥n de PDF (Condicional) ---
            if reply == QMessageBox.StandardButton.Yes:
                self.generar_ficha_completa_pdf(inscripcion_id, imprimir_poliza)

                # --- Bloque 2: Expediente Digital (SIEMPRE se ejecuta, desanidado) ---
                print(f"DEBUG - Checkbox Expediente Digital marcado? {hasattr(self, 'check_generar_expediente') and self.check_generar_expediente.isChecked()}")

                # --- Bloque 3: Limpieza Final (SIEMPRE se ejecuta, desanidado) ---
                self.limpiar_campos_alumno()
                self.cargar_datos_maestros()

        except sqlite3.IntegrityError:
            mostrar_error("Error: El correo electr√≥nico ya existe o hubo un problema de integridad.")
        except ValueError:
            mostrar_error("Error: La edad debe ser un n√∫mero v√°lido.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al guardar e inscribir alumno: {e}")
        except Exception as e:
             mostrar_error(f"Error inesperado: {e}")


    def generar_ficha_completa_pdf(self, inscripcion_id, imprimir_poliza=False): 
        """Genera un PDF con todos los datos del alumno, curso y CALENDARIO DE PAGOS."""
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                SELECT
                    a.*,
                    i.id as inscripcion_id, i.fecha_inscripcion, 
                    i.monto_total, i.tipo_pago_seleccionado,
                    i.monto_original, i.descuento_aplicado_pct,
                    c.nombre_curso
                FROM alumnos a
                JOIN inscripciones i ON a.id = i.alumno_id
                JOIN cursos c ON i.curso_id = c.id
                WHERE i.id = ?
            """, (inscripcion_id,))
            datos = cursor.fetchone()

            if not datos:
                mostrar_error("No se encontraron datos completos para la ficha.")
                return

            temp_pdf = tempfile.NamedTemporaryFile(suffix=".pdf", delete=False)
            filename = temp_pdf.name
            temp_pdf.close() 

            c = canvas.Canvas(filename, pagesize=letter)
            width, height = letter
            
            # --- Estilos (Arial 12) ---
            styles = getSampleStyleSheet()
            styleN = ParagraphStyle(name='Normal_Arial', parent=styles['Normal'], fontName=FONT_NAME, fontSize=12, leading=14)
            styleH_centered = ParagraphStyle(name='Heading_Arial_Centered', parent=styles['Heading3'], fontName=FONT_BOLD_NAME, fontSize=12, alignment=TA_CENTER, spaceAfter=8)
            styleCosto = ParagraphStyle(name='Costo_Arial', parent=styles['Normal'], fontName=FONT_BOLD_NAME, fontSize=12, leading=14)
            styleSmall = ParagraphStyle(name='Small_Arial', parent=styles['Normal'], fontName=FONT_NAME, fontSize=8, leading=10)
            styleTitle = ParagraphStyle(name='Title_Arial', parent=styles['h1'], fontName=FONT_BOLD_NAME, fontSize=14, alignment=TA_CENTER, spaceAfter=16)
            
            # --- Estilos para P√≥liza (Optimizados) ---
            styleN_poliza = ParagraphStyle(name='Normal_Poliza', parent=styleN, fontName=FONT_NAME, fontSize=10, leading=12, alignment=TA_LEFT) 
            styleH_poliza = ParagraphStyle(name='Heading_Poliza', parent=styleN, fontName=FONT_BOLD_NAME, fontSize=11, leading=14, spaceBefore=10, alignment=TA_LEFT)
            styleN_terminos = ParagraphStyle(name='Normal_Terminos', parent=styleN, fontSize=11, leading=13, alignment=TA_LEFT)


            # ==================================================
            # --- P√ÅGINA 1: FICHA DE INSCRIPCI√ìN ---
            # ==================================================
            
            self.draw_watermark(c, width, height)
            self.draw_logo(c, width, height)

            # --- T√≠tulo ---
            titulo_texto = f"<b>Unidad Profesional de Asesor√≠as y Regularizaci√≥n (UPASER)<br/>Formato de Inscripci√≥n para el curso: {datos['nombre_curso']}</b>"
            title_p = Paragraph(titulo_texto, styleTitle)
            title_w, title_h = title_p.wrapOn(c, width - 2*inch, height)
            title_p.drawOn(c, inch, height - 0.75 * inch - title_h)
            current_y = height - 0.75 * inch - title_h - 16

            # --- Datos del Alumno ---
            current_y = self.draw_text_pdf(c, current_y, "Datos del Alumno", inch, styleH_centered)
            current_y = self.draw_text_pdf(c, current_y, f"Folio Alumno: {datos['id']}", inch, styleN)
            nombre_alumno_completo = f"{datos['nombres']} {datos['apellido_paterno']} {datos['apellido_materno']}"
            current_y = self.draw_text_pdf(c, current_y, f"Nombre: {nombre_alumno_completo}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Edad: {datos['edad']} a√±os | Turno: {datos['turno']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Tel√©fono: {datos['telefono']} | Email: {datos['email']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Escuela de Procedencia: {datos['escuela_procedencia']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Escuela a Ingresar: {datos['escuela_ingresar']}", inch, styleN)

            # --- Datos del Tutor ---
            current_y -= 0.15 * inch
            current_y = self.draw_text_pdf(c, current_y, "Datos del Padre o Tutor", inch, styleH_centered)
            nombre_tutor_completo = f"{datos['tutor_nombres']} {datos['tutor_ap_paterno']} {datos['tutor_ap_materno']}"
            current_y = self.draw_text_pdf(c, current_y, f"Nombre: {nombre_tutor_completo}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Tel√©fono: {datos['tutor_telefono']}", inch, styleN)

            # --- Domicilio ---
            current_y -= 0.15 * inch
            current_y = self.draw_text_pdf(c, current_y, "Domicilio", inch, styleH_centered)
            current_y = self.draw_text_pdf(c, current_y, f"Calle: {datos['dom_calle']} N¬∞ Ext: {datos['dom_num_ext']} N¬∞ Int: {datos['dom_num_int']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Colonia: {datos['dom_colonia']}, C.P. {datos['dom_cp']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Municipio: {datos['dom_municipio']}, Estado: {datos['dom_estado']}", inch, styleN)

            # --- Contactos de Emergencia ---
            current_y -= 0.15 * inch
            current_y = self.draw_text_pdf(c, current_y, "Contactos de Emergencia", inch, styleH_centered)
            current_y = self.draw_text_pdf(c, current_y, f"1. {datos['emerg_1_nombre']} ({datos['emerg_1_parentesco']}) - Tel: {datos['emerg_1_telefono']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"2. {datos['emerg_2_nombre']} ({datos['emerg_2_parentesco']}) - Tel: {datos['emerg_2_telefono']}", inch, styleN)

            # --- Datos del Curso Inscrito ---
            current_y -= 0.2 * inch
            current_y = self.draw_text_pdf(c, current_y, "Curso Inscrito", inch, styleH_centered)
            current_y = self.draw_text_pdf(c, current_y, f"Folio Inscripci√≥n a Curso: {datos['inscripcion_id']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Nombre del Curso: {datos['nombre_curso']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Plan de Pago: {datos['tipo_pago_seleccionado']}", inch, styleN)
            
            if datos['descuento_aplicado_pct'] > 0:
                # A√±adimos 'inch' como cuarto argumento
                current_y = self.draw_text_pdf(c, current_y, f"Costo Original: $ {datos['monto_original']:.2f}", inch, styleN)
                current_y = self.draw_text_pdf(c, current_y, f"Descuento Aplicado: {datos['descuento_aplicado_pct']}%", inch, styleN)
                current_y = self.draw_text_pdf(c, current_y, f"Costo Final (con Dto.): $ {datos['monto_total']:.2f}", inch, styleCosto)
            else:
                # A√±adimos 'inch' como cuarto argumento
                current_y = self.draw_text_pdf(c, current_y, f"Costo Total: $ {datos['monto_total']:.2f}", inch, styleCosto)
            
            # --- CORRECCI√ìN: Separar Leyenda y Firma ---
            current_y = 2.5 * inch 

            # --- Autorizaci√≥n de Salida (si aplica) ---
            if datos['autoriza_salida_solo'] == 1:
                leyenda = f"Yo, {nombre_tutor_completo}, autorizo que mi hijo(a): {nombre_alumno_completo}, pueda retirarse de la instituci√≥n sin que acuda alguna persona mayor de edad a recogerlo al plantel, deslindando de toda responsabilidad a UPASER despu√©s de la hora de salida."
                current_y = self.draw_text_pdf(c, current_y + 0.2*inch, leyenda, inch, style=styleSmall) 
                
            
            # --- Firma ---
            firma_y_base = current_y - 0.5*inch 
            if datos['autoriza_salida_solo'] == 0: 
                firma_y_base = 1.5 * inch

            c.line(inch * 1.5, firma_y_base, width - (inch * 1.5), firma_y_base)
            c.setFont(FONT_NAME, 10)
            c.drawCentredString(width / 2, firma_y_base - 0.2 * inch, "Firma del Padre o Tutor")

            # ==================================================
            # --- P√ÅGINA 2: CALENDARIO DE PAGOS ---
            # ==================================================
            c.showPage() 
            self.draw_watermark(c, width, height)
            self.draw_logo(c, width, height)
            
            current_y = height - 1.5 * inch 

            current_y = self.draw_text_pdf(c, current_y, "Calendario de Pagos", inch, styleH_centered)
            
            plan_nombre = datos['tipo_pago_seleccionado']
            monto_total = Decimal(str(datos['monto_total']))
            fecha_inicio = datetime.date.fromisoformat(datos['fecha_inscripcion'])
            
            calendario_data = [["No. de Pago", "Fecha L√≠mite de Pago", "Monto"]]
            
            num_pagos = 1
            monto_pago = monto_total
            
            if plan_nombre == "Semanal (15)":
                num_pagos = 15
                monto_pago = (monto_total / 15).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)
            elif plan_nombre == "Semanal (12)": 
                num_pagos = 12
                monto_pago = (monto_total / 12).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)
            elif plan_nombre == "Mensual (3)":
                num_pagos = 3
                monto_pago = (monto_total / 3).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)
            elif plan_nombre == "Bisemanal (2)": # (A√±adido para completar)
                num_pagos = 2
                monto_pago = (monto_total / 2).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)
            elif plan_nombre == "Mensual (4)": # (A√±adido para completar)
                num_pagos = 4
                monto_pago = (monto_total / 4).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)
            elif plan_nombre == "Mensualidad":
                # ¬°AQU√ç EST√Å TU L√ìGICA NUEVA!
                num_pagos = 12 # 12 meses del a√±o escolar
                # monto_total ya es el costo mensual, as√≠ que monto_pago es correcto
                monto_pago = monto_total
            
            monto_acumulado = Decimal('0.00')
            for i in range(num_pagos):
                fecha_pago = fecha_inicio
                if plan_nombre.startswith("Semanal"):
                    fecha_pago = fecha_inicio + datetime.timedelta(weeks=i)
                elif plan_nombre.startswith("Mensual") or plan_nombre == "Mensualidad":
                    mes = fecha_inicio.month + i
                    a√±o = fecha_inicio.year + (mes - 1) // 12
                    mes = (mes - 1) % 12 + 1
                    dia = min(fecha_inicio.day, [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][mes])
                    if mes == 2 and dia == 28 and ((a√±o % 4 == 0 and a√±o % 100 != 0) or (a√±o % 400 == 0)):
                        dia = 29
                    fecha_pago = datetime.date(a√±o, mes, dia)

                
                monto_actual = monto_pago
                if plan_nombre != "Mensualidad" and i == num_pagos - 1:
                    monto_actual = monto_total - monto_acumulado
                    
                calendario_data.append([
                    str(i+1), 
                    fecha_pago.strftime("%Y-%m-%d"), 
                    f"$ {monto_actual:.2f}"
                ])
                if plan_nombre != "Mensualidad":
                   monto_acumulado += monto_actual
            
            # Dibujar la tabla del calendario
            tabla_calendario = Table(calendario_data, colWidths=[1*inch, 2.5*inch, 2*inch])
            tabla_calendario.setStyle(TableStyle([
                ('BACKGROUND', (0,0), (-1,0), colors.grey),
                ('TEXTCOLOR', (0,0), (-1,0), colors.whitesmoke),
                ('ALIGN', (0,0), (-1,-1), 'CENTER'),
                ('FONTNAME', (0,0), (-1,0), FONT_BOLD_NAME),
                ('FONTNAME', (0,1), (-1,-1), FONT_NAME),
                ('FONTSIZE', (0,0), (-1,-1), 10),
                ('BOTTOMPADDING', (0,0), (-1,0), 6),
                
                ('BACKGROUND', (0,1), (-1,-1), colors.whitesmoke),
                ('GRID', (0,0), (-1,-1), 1, colors.black),
                ('ALIGN', (2,1), (2,-1), 'RIGHT'), 
            ]))

            w_tabla, h_tabla = tabla_calendario.wrapOn(c, width - 2*inch, height)
            if current_y - h_tabla < inch:
                self.draw_watermark(c, width, height)
                c.showPage()
                self.draw_watermark(c, width, height)
                self.draw_logo(c, width, height)
                current_y = height - inch
            
            tabla_calendario.drawOn(c, inch, current_y - h_tabla)
            current_y -= (h_tabla + 10)
            
            # --- FIN P√ÅGINA 2 ---
            
            # ==================================================
            # --- P√ÅGINAS 3 y 4: P√ìLIZA Y T√âRMINOS (Opcional) ---
            # ==================================================
            if imprimir_poliza:
                
                # --- P√ÅGINA 3: P√ìLIZA DE GARANT√çA ---
                c.showPage()
                self.draw_watermark(c, width, height)
                self.draw_logo(c, width, height)
                
                # Definir un Frame que ocupe la p√°gina, dejando m√°rgenes y espacio para firmas
                frame_poliza = Frame(inch, 2.5*inch, width - 2*inch, height - 4*inch, id='polizaFrame', leftPadding=0, topPadding=0, rightPadding=0, bottomPadding=0)
                
                story_poliza = []
                story_poliza.append(Paragraph("P√ìLIZA DE GARANT√çA", styleH_centered))
                story_poliza.append(Spacer(1, 0.2*inch))
                
                
                story_poliza.append(Paragraph("<b>DERECHOS</b>", styleH_poliza))
                story_poliza.append(Paragraph("a) Recibir sus clases conforme lo se√±ale su horario y fecha de evaluaci√≥n.", styleN_poliza))
                story_poliza.append(Paragraph("b) Conocer anticipadamente temarios, formas de trabajo y criterios de evaluaci√≥n de cada una de las asignaturas.", styleN_poliza))
                story_poliza.append(Paragraph("c) Ser tratado por sus docentes y autoridades educativas con cortes√≠a, respeto y amabilidad.", styleN_poliza))
                story_poliza.append(Spacer(1, 0.15*inch))
                
                story_poliza.append(Paragraph("<b>OBLIGACIONES</b>", styleH_poliza))
                story_poliza.append(Paragraph("a) Asistir a sus clases conforme al horario establecido, teniendo como margen de tiempo 10 min. Despu√©s de haber iniciado la clase, dos retardos equivalen a una falta.", styleN_poliza))
                story_poliza.append(Paragraph("b) Respetar el tiempo de receso otorgado (30 min.).", styleN_poliza))
                story_poliza.append(Paragraph("c) Ser respetuoso con sus compa√±eros, docentes y personal en general.", styleN_poliza))
                story_poliza.append(Paragraph("d) Mantener orden y disciplina.", styleN_poliza))
                story_poliza.append(Paragraph("e) Cumplir con tareas e investigaciones encomendados.", styleN_poliza))
                story_poliza.append(Paragraph("f) Conservar y cuidar la instituci√≥n.", styleN_poliza))
                story_poliza.append(Paragraph("g) Cumplir en tiempo y forma con los pagos estipulados.", styleN_poliza))
                story_poliza.append(Paragraph("<i>El incumplimiento de cualquiera de las obligaciones es motivo de la perdida de garant√≠a.</i>", styleN_poliza))
                story_poliza.append(Spacer(1, 0.15*inch))

                story_poliza.append(Paragraph("<b>ANULACI√ìN DE LA GARANT√çA</b>", styleH_poliza))
                story_poliza.append(Paragraph("‚Ä¢ Tener menos del 90% de asistencias, tomando en cuenta que por d√≠a se pueden ver una o m√°s clases; lo que equivale a una falta por materia.", styleN_poliza))
                story_poliza.append(Paragraph("‚Ä¢ Tener menos del 90% en entregas de tareas y actividades asignadas por el docente.", styleN_poliza))
                story_poliza.append(Paragraph("‚Ä¢ No a ver liquidado el total del curso antes de que finalice el mismo.", styleN_poliza))
                story_poliza.append(Paragraph("‚Ä¢ Tener menos de 80% en las evaluaciones que se har√°n por parte de UPASER.", styleN_poliza))
                story_poliza.append(Spacer(1, 0.15*inch))
                
                story_poliza.append(Paragraph("<b>NOTA.</b> El alumno podr√° solicitar su garant√≠a siempre y cuando cumpla con los requisitos antes mencionados.", styleN_poliza))
                story_poliza.append(Spacer(1, 0.15*inch))

                story_poliza.append(Paragraph("<b>CLAUSULA PARA USO DE MARTKETING</b>", styleH_poliza))
                story_poliza.append(Paragraph("El alumno autoriza expresamente a UPASER a captar, reproducir y utilizar su imagen, nombre y/o voz a trav√©s de fotograf√≠as, grabaciones de video o cualquier otro medio audiovisual, con fines exclusivamente publicitarios, institucionales, informativos y/o acad√©micos relacionados con las actividades de la instituci√≥n.", styleN_poliza))
                story_poliza.append(Paragraph("Dicha autorizaci√≥n se concede de manera gratuita, sin limitaci√≥n territorial ni temporal, y comprende su difusi√≥n en medios digitales, electr√≥nicos y redes sociales oficiales de UPASER, as√≠ como en cualquier otra plataforma en l√≠nea utilizada por la instituci√≥n.", styleN_poliza))

                # Construir la historia en el Frame
                frame_poliza.addFromList(story_poliza, c)
                
                # Dibujar firmas al final
                self.draw_double_signature(c, 2 * inch) 
                
                # --- P√ÅGINA 4: T√âRMINOS Y CONDICIONES ---
                c.showPage()
                self.draw_watermark(c, width, height)
                self.draw_logo(c, width, height)
                current_y = height - 1.5 * inch 
                
                # Definir un Frame que ocupe la p√°gina, dejando m√°rgenes y espacio para firmas
                frame_terminos = Frame(inch, 2.5*inch, width - 2*inch, height - 4*inch, id='terminosFrame', leftPadding=0, topPadding=0, rightPadding=0, bottomPadding=0)
                
                story_terminos = []
                story_terminos.append(Paragraph("T√âRMINOS Y CONDICIONES", styleH_centered))
                story_terminos.append(Spacer(1, 0.2*inch))
                
                story_terminos.append(Paragraph("Es de suma importancia leer cuidadosamente este apartado antes de iniciar tu curso, para que conozcas tus derechos y obligaciones como alumno UPASER.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("La Unidad Profesional de Asesor√≠a y Regularizaci√≥n (UPASER) tiene como garant√≠a que el alumno se quede en sus primeras 5 opciones que seleccione en el concurso ECOEMS/103 Municipios/EXAMEN DE INGRESO A UNIVERSIDAD (UNAM, IPN, UAM, UAEMex, ETC), asegurando que nuestro curso es competente bajo nuestro m√©todo de ense√±anza.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("Antes de efectuar el pago, el usuario deber√° aceptar la Pol√≠tica de Privacidad, una vez confirmado el pago del curso seleccionado por el aspirante este no podr√° solicitar reembolso.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("<b>I. Clases:</b> Est√°n sujetas a modificaciones, UPASER se reserva el derecho de cancelar o cambiar cualquier clase, se les notificara a los alumnos o participantes cualquier cambio a trav√©s de los grupos de WhatsApp oficiales. UPASER esta obligado a reponer la clase cancelada, si este fuera el caso.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("<b>II. Comportamiento:</b> UPASER se reserva el derecho de retirar a cualquier persona registrada en el curso, cuyo comportamiento sea considerado inapropiado, por parte de UPASER o sus docentes. En estas circunstancias UPASER no reembolsara ninguna tarifa.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("<b>III. Plazo para registrarse:</b> Estamos contentos de apoyar a nuestros alumnos con el proceso de registro en las plataformas oficiales COMIPEMS/103 MUNICIPIOS, sin embargo, es responsabilidad total del aspirante. En caso de que el aspirante no se registre en las fechas que la convocatoria este abierta no habr√° ning√∫n tipo de reembolso por el pago efectuado al curso de capacitaci√≥n.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("<b>IV. Talleres opcionales:</b> UPASER programara talleres a lo largo del curso de capacitaci√≥n, estos talleres son considerados un plus CON COSTO para cualquier alumno UPASER.", styleN_terminos))

                # Construir la historia en el Frame
                frame_terminos.addFromList(story_terminos, c)
                
            
                # Dibujar firmas al final
                self.draw_double_signature(c, 2 * inch) 
            
            # --- FIN DEL BLOQUE 'if imprimir_poliza' ---

            c.save()

            # --- ABRIR EL PDF ---
            self._temp_pdf_files.append(filename)
            url = QUrl.fromLocalFile(filename)
            QDesktopServices.openUrl(url)

            mostrar_info(f"Ficha PDF generada y abierta.")

        except Exception as e:
            mostrar_error(f"Error al generar o abrir PDF completo: {e}\n{traceback.format_exc()}")
    
    def generar_ticket_pago_pdf(self, pago_info):
        """Genera un PDF simple para un recibo de pago."""
        try:
            temp_pdf = tempfile.NamedTemporaryFile(suffix=".pdf", delete=False)
            filename = temp_pdf.name
            temp_pdf.close() 

            c = canvas.Canvas(filename, pagesize=letter)
            width, height = letter
            
            # --- Estilos ---
            styles = getSampleStyleSheet()
            styleN = ParagraphStyle(name='Normal_Arial', parent=styles['Normal'], fontName=FONT_NAME, fontSize=12, leading=14)
            styleH_centered = ParagraphStyle(name='Heading_Arial_Centered', parent=styles['Heading3'], fontName=FONT_BOLD_NAME, fontSize=12, alignment=TA_CENTER, spaceAfter=8)
            styleTitle = ParagraphStyle(name='Title_Arial', parent=styles['h1'], fontName=FONT_BOLD_NAME, fontSize=14, alignment=TA_CENTER, spaceAfter=16)
            
            # Estilos espec√≠ficos para el recibo
            styleRecibo = ParagraphStyle(name='Recibo_Arial', parent=styleN, fontName=FONT_BOLD_NAME, fontSize=14, textColor=colors.HexColor("#4CAF50"))
            stylePendiente = ParagraphStyle(name='Pendiente_Arial', parent=styleN, fontName=FONT_BOLD_NAME, fontSize=12, textColor=colors.HexColor("#D32F2F"))
            
            # Dibujar logo y marca de agua
            self.draw_watermark(c, width, height)
            self.draw_logo(c, width, height)

            # --- T√≠tulo ---
            titulo_texto = "<b>Unidad Profesional de Asesor√≠as y Regularizaci√≥n (UPASER)<br/>Recibo de Pago</b>"
            title_p = Paragraph(titulo_texto, styleTitle)
            title_w, title_h = title_p.wrapOn(c, width - 2*inch, height)
            title_p.drawOn(c, inch, height - 0.75 * inch - title_h)
            current_y = height - 0.75 * inch - title_h - 24

            # --- Contenido ---
            current_y = self.draw_text_pdf(c, current_y, "Detalles del Pago", inch, styleH_centered)
            current_y = self.draw_text_pdf(c, current_y, f"<b>Fecha de Pago:</b> {pago_info['fecha_pago']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"<b>Alumno:</b> {pago_info['nombre_alumno']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"<b>Curso:</b> {pago_info['nombre_curso']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"<b>Inscripci√≥n ID:</b> {pago_info['inscripcion_id']}", inch, styleN)

            current_y -= 0.25 * inch # Espacio
            
            current_y = self.draw_text_pdf(c, current_y, f"<b>Monto Recibido:</b> ${pago_info['monto_pagado_recibo']:.2f}", inch, styleRecibo)
            current_y = self.draw_text_pdf(c, current_y, f"<b>M√©todo de Pago:</b> {pago_info['metodo_pago']}", inch, styleN)
            
            current_y -= 0.25 * inch # Espacio
            
            current_y = self.draw_text_pdf(c, current_y, "Estado de Cuenta de la Inscripci√≥n", inch, styleH_centered)
            current_y = self.draw_text_pdf(c, current_y, f"<b>Costo Total del Curso:</b> ${pago_info['monto_total_curso']:.2f}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"<b>Total Pagado (a la fecha):</b> ${pago_info['monto_pagado_total']:.2f}", inch, styleN)
            
            # Mostrar el saldo pendiente solo si es mayor que cero
            if pago_info['saldo_pendiente'] > 0.01:
                current_y = self.draw_text_pdf(c, current_y, f"<b>Saldo Pendiente:</b> ${pago_info['saldo_pendiente']:.2f}", inch, stylePendiente)
            else:
                current_y = self.draw_text_pdf(c, current_y, "<b>¬°CURSO LIQUIDADO!</b>", inch, styleRecibo)


            # --- Firma (simple) ---
            firma_y_base = 2 * inch
            c.line(inch * 2.5, firma_y_base, width - (inch * 2.5), firma_y_base)
            c.setFont(FONT_NAME, 10)
            c.drawCentredString(width / 2, firma_y_base - 0.2 * inch, "Control Escolar UPASER")
            
            c.save()

            # --- Abrir el PDF ---
            self._temp_pdf_files.append(filename)
            url = QUrl.fromLocalFile(filename)
            QDesktopServices.openUrl(url)
            
            mostrar_info("Recibo PDF generado y abierto.")

        except Exception as e:
            mostrar_error(f"Error al generar o abrir el recibo PDF: {e}\n{traceback.format_exc()}")
    
    def generar_ticket_termico_pdf(self, pago_info):
        """Genera un PDF del tama√±o de un ticket t√©rmico (80mm)."""
        
        # Ancho est√°ndar de impresora t√©rmica
        TICKET_WIDTH = 80 * mm
        # Altura inicial (crecer√° si es necesario)
        TICKET_HEIGHT = 120 * mm 
        
        try:
            temp_pdf = tempfile.NamedTemporaryFile(suffix=".pdf", delete=False)
            filename = temp_pdf.name
            temp_pdf.close() 

            # Usamos un tama√±o de p√°gina personalizado
            c = canvas.Canvas(filename, pagesize=(TICKET_WIDTH, TICKET_HEIGHT))
            
            # --- Estilos para el Ticket (Fuente monoespaciada) ---
            FONT_TICKET = "Courier"
            FONT_TICKET_BOLD = "Courier-Bold"
            
            styles = getSampleStyleSheet()
            styleHeader = ParagraphStyle(name='Header', parent=styles['Normal'], fontName=FONT_TICKET_BOLD, fontSize=10, alignment=TA_CENTER, spaceAfter=6)
            styleNormal = ParagraphStyle(name='Normal', parent=styles['Normal'], fontName=FONT_TICKET, fontSize=8, leading=10, alignment=TA_LEFT)
            styleNormalCenter = ParagraphStyle(name='NormalCenter', parent=styleNormal, alignment=TA_CENTER)
            styleTotal = ParagraphStyle(name='Total', parent=styles['Normal'], fontName=FONT_TICKET_BOLD, fontSize=11, alignment=TA_CENTER, spaceAfter=8)

            # --- Contenido del Ticket (Usando Platypus para que fluya) ---
            story = []
            
            # Margen
            margin = 3 * mm
            
            # 1. Logo (peque√±o)
            if os.path.exists(LOGO_PATH):
                try:
                    story.append(Image(LOGO_PATH, width=25*mm, height=25*mm))
                except Exception as e:
                    print(f"Error al a√±adir logo al ticket: {e}")
            
            # 2. Encabezado
            story.append(Paragraph("Unidad Profesional de Asesor√≠as y Regularizaci√≥n (UPASER)", styleHeader))
            story.append(Paragraph("--- RECIBO DE PAGO ---", styleNormalCenter))
            story.append(Spacer(1, 4 * mm))
            
            # 3. Detalles del Pago
            story.append(Paragraph(f"Fecha: {pago_info['fecha_pago']}", styleNormal))
            story.append(Paragraph(f"Alumno: {pago_info['nombre_alumno']}", styleNormal))
            story.append(Paragraph(f"Curso: {pago_info['nombre_curso']}", styleNormal))
            story.append(Paragraph(f"ID Inscripci√≥n: {pago_info['inscripcion_id']}", styleNormal))
            story.append(Paragraph("-" * 46, styleNormalCenter))
            
            # 4. Montos
            story.append(Paragraph(f"Monto Recibido: ${pago_info['monto_pagado_recibo']:.2f}", styleTotal))
            story.append(Paragraph(f"M√©todo de Pago: {pago_info['metodo_pago']}", styleNormalCenter))
            story.append(Paragraph("-" * 46, styleNormalCenter))
            
            # 5. Estado de Cuenta
            story.append(Paragraph(f"Total del Curso: ${pago_info['monto_total_curso']:.2f}", styleNormal))
            story.append(Paragraph(f"Total Pagado: ${pago_info['monto_pagado_total']:.2f}", styleNormal))
            
            if pago_info['saldo_pendiente'] > 0.01:
                story.append(Paragraph(f"Saldo Pendiente: ${pago_info['saldo_pendiente']:.2f}", styleNormal))
            else:
                story.append(Spacer(1, 4 * mm))
                story.append(Paragraph("¬°CURSO LIQUIDADO!", styleHeader))

            story.append(Spacer(1, 5 * mm))
            story.append(Paragraph("Gracias por su pago", styleNormalCenter))

            # --- Construir el PDF ---
            # Definir el Frame (el √°rea donde fluye el texto)
            frame = Frame(margin, margin, TICKET_WIDTH - (2*margin), TICKET_HEIGHT - (2*margin), id='ticket_frame')
            
            # Construir la historia en el canvas
            frame.addFromList(story, c)
            c.save()

            # --- Abrir el PDF ---
            self._temp_pdf_files.append(filename)
            url = QUrl.fromLocalFile(filename)
            QDesktopServices.openUrl(url)
            
            mostrar_info("Ticket (80mm) generado y abierto.")

        except Exception as e:
            mostrar_error(f"Error al generar el ticket t√©rmico PDF: {e}\n{traceback.format_exc()}")
    
    def generar_boleta_pdf(self):
        """Genera la boleta de calificaciones en PDF para el alumno seleccionado."""
        
        # 1. Obtener el Alumno ID seleccionado de la tabla
        selected_items = self.tabla_alumnos.selectedItems()
        if not selected_items or self.tabla_alumnos.currentRow() < 0:
            mostrar_error("Por favor, seleccione un alumno de la lista.")
            return

        try:
            alumno_id = int(self.tabla_alumnos.item(self.tabla_alumnos.currentRow(), 0).text())
        except Exception:
            mostrar_error("No se pudo obtener el ID del alumno seleccionado.")
            return
            
        inscripcion_id_seleccionada = None
        curso_nombre_seleccionado = ""
        
        # --- INICIO DE MODIFICACI√ìN: Cambiar a 2 parciales + Promedio Final ---
        parciales = ["Primer Parcial", "Segundo Parcial", "Promedio Final"]
        parcial_elegido, ok = QInputDialog.getItem(self, "Seleccionar Boleta",
                                                     "¬øQu√© boleta desea generar?",
                                                     parciales, 0, False)
        
        if not ok or not parcial_elegido:
            return # El usuario cancel√≥
        
        # Determinar columnas de la DB
        col_calif_db = ""
        col_obs_db = ""
        
        if parcial_elegido == "Primer Parcial":
            idx_parcial = 0
            col_calif_db = "parcial_1"
            col_obs_db = "obs_1"
        elif parcial_elegido == "Segundo Parcial":
            idx_parcial = 1
            col_calif_db = "parcial_2"
            col_obs_db = "obs_2"
        # Si es "Promedio Final", dejamos las variables vac√≠as por ahora
        # --- FIN DE MODIFICACI√ìN ---

        try:
            # 2. Verificar inscripciones del alumno
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT i.id, c.nombre_curso 
                    FROM inscripciones i
                    JOIN cursos c ON i.curso_id = c.id
                    WHERE i.alumno_id = ?
                """, (alumno_id,))
                inscripciones = cursor.fetchall()

            if not inscripciones:
                mostrar_error("Este alumno no est√° inscrito en ning√∫n curso.")
                return
            
            if len(inscripciones) == 1:
                inscripcion_id_seleccionada = inscripciones[0]['id']
                curso_nombre_seleccionado = inscripciones[0]['nombre_curso']
            else:
                nombres_cursos = [i['nombre_curso'] for i in inscripciones]
                curso_elegido, ok = QInputDialog.getItem(self, "Seleccionar Curso",
                                                         "Este alumno est√° en varios cursos. ¬øDe cu√°l desea generar la boleta?",
                                                         nombres_cursos, 0, False)
                if ok and curso_elegido:
                    for insc in inscripciones:
                        if insc['nombre_curso'] == curso_elegido:
                            inscripcion_id_seleccionada = insc['id']
                            curso_nombre_seleccionado = insc['nombre_curso']
                            break
                else:
                    return

            if not inscripcion_id_seleccionada:
                mostrar_error("No se pudo seleccionar una inscripci√≥n v√°lida.")
                return

            # 3. Obtener todos los datos para el PDF
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM alumnos WHERE id = ?", (alumno_id,))
                datos_alumno = cursor.fetchone()
                
                # --- INICIO DE MODIFICACI√ìN: L√≥gica para Promedio Final ---
                if parcial_elegido == "Promedio Final":
                    query = """
                        SELECT m.nombre_materia, c.parcial_1, c.parcial_2, c.obs_1, c.obs_2 
                        FROM calificaciones c
                        JOIN materias m ON c.materia_id = m.id
                        WHERE c.inscripcion_id = ?
                        ORDER BY m.nombre_materia
                    """
                    cursor.execute(query, (inscripcion_id_seleccionada,))
                else:
                    # L√≥gica original para parcial individual
                    query = f"""
                        SELECT m.nombre_materia, c.{col_calif_db} AS calificacion, c.{col_obs_db} AS observaciones 
                        FROM calificaciones c
                        JOIN materias m ON c.materia_id = m.id
                        WHERE c.inscripcion_id = ?
                        ORDER BY m.nombre_materia
                    """
                    cursor.execute(query, (inscripcion_id_seleccionada,))
                
                calificaciones = cursor.fetchall()
                # --- FIN DE MODIFICACI√ìN ---

            if not datos_alumno:
                mostrar_error("Error fatal: No se encontraron los datos del alumno.")
                return

            # 4. Generar el PDF
            temp_pdf = tempfile.NamedTemporaryFile(suffix=".pdf", delete=False)
            filename = temp_pdf.name
            temp_pdf.close() 

            c = canvas.Canvas(filename, pagesize=letter)
            width, height = letter
            
            styles = getSampleStyleSheet()
            styleN = ParagraphStyle(name='Normal_Arial', parent=styles['Normal'], fontName=FONT_NAME, fontSize=12, leading=14)
            styleH_centered = ParagraphStyle(name='Heading_Arial_Centered', parent=styles['Heading3'], fontName=FONT_BOLD_NAME, fontSize=12, alignment=TA_CENTER, spaceAfter=8)
            styleTitle = ParagraphStyle(name='Title_Arial', parent=styles['h1'], fontName=FONT_BOLD_NAME, fontSize=14, alignment=TA_CENTER, spaceAfter=16)
            
            styleLegenda = ParagraphStyle(
                name='Legenda_Boleta', 
                parent=styles['Normal'], 
                fontName=FONT_BOLD_NAME, 
                fontSize=9, 
                leading=11, 
                alignment=TA_CENTER, 
                textColor=colors.black
            )

            self.draw_watermark(c, width, height)
            self.draw_logo(c, width, height)

            # T√≠tulo (MODIFICADO)
            titulo_texto = f"<b>Unidad Profesional de Asesor√≠as y Regularizaci√≥n (UPASER)<br/>Boleta de Calificaciones: {parcial_elegido.upper()}</b>"
            title_p = Paragraph(titulo_texto, styleTitle)
            title_w, title_h = title_p.wrapOn(c, width - 2*inch, height)
            title_p.drawOn(c, inch, height - 0.75 * inch - title_h)
            current_y = height - 0.75 * inch - title_h - 16

            # Datos
            nombre_alumno_completo = f"{datos_alumno['nombres']} {datos_alumno['apellido_paterno']} {datos_alumno['apellido_materno']}"
            current_y = self.draw_text_pdf(c, current_y, f"<b>Alumno:</b> {nombre_alumno_completo}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"<b>Curso:</b> {curso_nombre_seleccionado}", inch, styleN)
            current_y -= 0.25 * inch

            # --- INICIO DE MODIFICACI√ìN: Columnas din√°micas para Promedio ---
            if parcial_elegido == "Promedio Final":
                data_tabla = [["Materia", "Parcial 1", "Parcial 2", "Promedio"]]
                colWidths = [3*inch, 1.5*inch, 1.5*inch, 1.5*inch]
            else:
                data_tabla = [["Materia", "Calificaci√≥n", "Observaciones"]]
                colWidths = [2.5*inch, 1.5*inch, 2.5*inch]
            # --- FIN DE MODIFICACI√ìN ---
            
            total_promedio_final = 0.0
            num_materias = 0

            if calificaciones:
                for calif in calificaciones:
                    # --- INICIO DE MODIFICACI√ìN: L√≥gica de llenado de tabla ---
                    if parcial_elegido == "Promedio Final":
                        p1 = calif['parcial_1']
                        p2 = calif['parcial_2']
                        promedio_materia = (p1 + p2) / 2.0
                        data_tabla.append([
                            Paragraph(calif['nombre_materia'], styleN),
                            f"{p1:.1f}",
                            f"{p2:.1f}",
                            f"{promedio_materia:.1f}"
                        ])
                        total_promedio_final += promedio_materia
                        num_materias += 1
                    else:
                        # L√≥gica original
                        data_tabla.append([
                            Paragraph(calif['nombre_materia'], styleN),
                            f"{calif['calificacion']:.1f}",
                            Paragraph(calif['observaciones'], styleN)
                        ])
                        total_promedio_final += calif['calificacion']
                        num_materias += 1
                    # --- FIN DE MODIFICACI√ìN ---
            else:
                # L√≥gica original adaptada
                if parcial_elegido == "Promedio Final":
                     data_tabla.append(["(Sin materias asignadas)", "", "", ""])
                else:
                     data_tabla.append(["(Sin materias asignadas)", "", ""])

            tabla_calif = Table(data_tabla, colWidths=colWidths)
            
            # --- INICIO DE MODIFICACI√ìN: Estilo din√°mico ---
            if parcial_elegido == "Promedio Final":
                table_style = TableStyle([
                    ('BACKGROUND', (0,0), (-1,0), colors.grey),
                    ('TEXTCOLOR', (0,0), (-1,0), colors.whitesmoke),
                    ('ALIGN', (0,0), (-1,-1), 'CENTER'),
                    ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
                    ('FONTNAME', (0,0), (-1,0), FONT_BOLD_NAME),
                    ('FONTNAME', (0,1), (-1,-1), FONT_NAME),
                    ('FONTSIZE', (0,0), (-1,-1), 10),
                    ('BOTTOMPADDING', (0,0), (-1,0), 6),
                    ('BACKGROUND', (0,1), (-1,-1), colors.whitesmoke),
                    ('GRID', (0,0), (-1,-1), 1, colors.black),
                    ('ALIGN', (0,1), (0,-1), 'LEFT'), # Materias a la izquierda
                ])
            else:
                 table_style = TableStyle([
                    ('BACKGROUND', (0,0), (-1,0), colors.grey),
                    ('TEXTCOLOR', (0,0), (-1,0), colors.whitesmoke),
                    ('ALIGN', (0,0), (-1,-1), 'CENTER'),
                    ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
                    ('FONTNAME', (0,0), (-1,0), FONT_BOLD_NAME),
                    ('FONTNAME', (0,1), (-1,-1), FONT_NAME),
                    ('FONTSIZE', (0,0), (-1,-1), 10),
                    ('BOTTOMPADDING', (0,0), (-1,0), 6),
                    ('BACKGROUND', (0,1), (-1,-1), colors.whitesmoke),
                    ('GRID', (0,0), (-1,-1), 1, colors.black),
                    ('ALIGN', (0,1), (0,-1), 'LEFT'), # Materias a la izquierda
                    ('ALIGN', (2,1), (2,-1), 'LEFT'), # Observaciones a la izquierda
                ])
            tabla_calif.setStyle(table_style)
            # --- FIN DE MODIFICACI√ìN ---
            
            w_tabla, h_tabla = tabla_calif.wrapOn(c, width - 2*inch, height)
            x_centered = (width - w_tabla) / 2.0
            tabla_calif.drawOn(c, x_centered, current_y - h_tabla)
            current_y -= (h_tabla + 0.25 * inch)

            # Promedio (MODIFICADO)
            promedio_final = (total_promedio_final / num_materias) if num_materias > 0 else 0.0
            
            # --- INICIO DE MODIFICACI√ìN: T√≠tulo del promedio ---
            promedio_titulo = f"PROMEDIO {parcial_elegido.upper()}"
            if parcial_elegido == "Promedio Final":
                promedio_titulo = "PROMEDIO GENERAL"
                
            current_y = self.draw_text_pdf(c, current_y, f"<b>{promedio_titulo}: {promedio_final:.2f}</b>", inch, styleN)
            # --- FIN DE MODIFICACI√ìN --
            
            # Firma
            firma_y_base = 2 * inch
            c.line(inch * 2.5, firma_y_base, width - (inch * 2.5), firma_y_base)
            texto_firma_y = firma_y_base - 0.2 * inch
            c.setFont(FONT_NAME, 10)
            c.drawCentredString(width / 2, firma_y_base - 0.2 * inch, "Control Escolar UPASER")
            
            leyenda_texto = "RECUERDA: Para que puedas hacer valida tu P√ìLIZA DE GARANT√çA, es necesario contar con un PROMEDIO GENERAL m√≠nimo de 8.0."
            p = Paragraph(leyenda_texto, styleLegenda)
            p_width, p_height = p.wrapOn(c, width - 2*inch, height)
            x_centered = (width - p_width) / 2.0
            y_pos = texto_firma_y - p_height - (0.1 * inch)
            p.drawOn(c, x_centered, y_pos)

            # Guardar y abrir
            c.save()
            self._temp_pdf_files.append(filename)
            url = QUrl.fromLocalFile(filename)
            QDesktopServices.openUrl(url)

        except Exception as e:
            mostrar_error(f"Error al generar boleta PDF: {e}\n{traceback.format_exc()}")

    def generar_credencial_pdf(self):
        """Genera dos caras de la credencial (Anverso y Reverso) en una sola p√°gina de tama√±o carta (letter)."""
        
        # --- DEFINICIONES CR√çTICAS DE TAMA√ëO ---
        PAGE_WIDTH, PAGE_HEIGHT = letter 
        GAFETE_W, GAFETE_H = 85.6 * mm, 53.98 * mm # Medida est√°ndar CR80 (la que ya usabas)
        
        # Margen para centrar los gafetes en la hoja carta (215.9mm x 279.4mm)
        MARGIN_X = (PAGE_WIDTH - (GAFETE_W * 2 + 10 * mm)) / 2 
        MARGIN_Y = PAGE_HEIGHT - GAFETE_H - 15 * mm # Dejamos 1.5cm arriba
        # ---------------------------------------
        
        selected_items = self.tabla_alumnos.selectedItems()
        if not selected_items or self.tabla_alumnos.currentRow() < 0:
            mostrar_error("Por favor, seleccione un alumno de la lista.")
            return
        try:
            alumno_id = int(self.tabla_alumnos.item(self.tabla_alumnos.currentRow(), 0).text())
        except Exception:
            return

        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT a.*, c.nombre_curso 
                    FROM alumnos a
                    LEFT JOIN inscripciones i ON a.id = i.alumno_id
                    LEFT JOIN cursos c ON i.curso_id = c.id
                    WHERE a.id = ?
                    ORDER BY i.fecha_inscripcion DESC LIMIT 1
                """, (alumno_id,))
                datos_row = cursor.fetchone()

            if not datos_row:
                mostrar_error("No se encontraron datos para el alumno.")
                return

            datos = dict(datos_row)
            
            temp_pdf = tempfile.NamedTemporaryFile(suffix=".pdf", delete=False)
            filename = temp_pdf.name
            temp_pdf.close()

            # Usamos el tama√±o de p√°gina 'letter' para la impresi√≥n
            c = canvas.Canvas(filename, pagesize=letter)
            
            # --- FUNCI√ìN AUXILIAR DE DIBUJO DE MARCA DE AGUA Y PLACEHOLDER ---
            def dibujar_marca_agua(canvas_obj, width, height):
                if os.path.exists(LOGO_PATH):
                    canvas_obj.saveState()
                    canvas_obj.setFillAlpha(0.1) 
                    logo_w, logo_h = 35 * mm, 35 * mm
                    canvas_obj.drawImage(LOGO_PATH, (width - logo_w)/2, (height - logo_h)/2, 
                                         width=logo_w, height=logo_h, mask='auto')
                    canvas_obj.restoreState()

            def dibujar_placeholder(canvas_obj):
                canvas_obj.setFillColorRGB(0.85, 0.85, 0.85)
                canvas_obj.setStrokeColorRGB(0.6, 0.6, 0.6)
                canvas_obj.rect(4*mm, 12*mm, 22*mm, 26*mm, fill=1, stroke=1)
                canvas_obj.setFillColorRGB(0.5, 0.5, 0.5)
                canvas_obj.setFont("Helvetica", 8)
                canvas_obj.drawCentredString(15*mm, 25*mm, "FOTO")
            
            # --- FUNCI√ìN CENTRAL PARA DIBUJAR UNA CARA ---
            def dibujar_cara_credencial(canvas_obj, x_offset, y_offset, es_reverso=False):
                
                # Definir el √°rea de la credencial (usamos la medida fija)
                width, height = GAFETE_W, GAFETE_H 
                
                # Mover el origen de coordenadas al inicio del gafete
                canvas_obj.saveState()
                canvas_obj.translate(x_offset, y_offset) 

                # Fondo general
                canvas_obj.setFillColorRGB(0.97, 0.97, 0.97)
                canvas_obj.rect(0, 0, width, height, fill=1, stroke=0)

                # Marca de agua
                dibujar_marca_agua(canvas_obj, width, height)

                # Franja superior verde
                canvas_obj.setFillColorRGB(0, 0.2, 0.4)
                canvas_obj.rect(0, height - 14*mm, width, 14*mm, fill=1, stroke=0)

                # Logo y textos institucionales
                if os.path.exists(LOGO_PATH):
                     canvas_obj.drawImage(LOGO_PATH, 2*mm, height - 12*mm, width=10*mm, height=10*mm, mask='auto')
                canvas_obj.setFillColorRGB(1, 1, 1)
                canvas_obj.setFont("Helvetica-Bold", 11)
                canvas_obj.drawString(14*mm, height - 6*mm, "UPASER")
                canvas_obj.setFont("Helvetica", 6)
                canvas_obj.drawString(14*mm, height - 10*mm, "Unidad Profesional de Asesor√≠a y Regularizaci√≥n")

                if not es_reverso: # --- ANVERSO ---
                    # Foto del Alumno
                    foto_ruta = datos.get('foto_ruta')
                    if foto_ruta and os.path.exists(foto_ruta):
                        try:
                            canvas_obj.drawImage(foto_ruta, 4*mm, 12*mm, width=22*mm, height=26*mm, preserveAspectRatio=True, anchor='c')
                            canvas_obj.setStrokeColorRGB(0, 0, 0)
                            canvas_obj.rect(4*mm, 12*mm, 22*mm, 26*mm, fill=0, stroke=1)
                        except Exception: dibujar_placeholder(canvas_obj)
                    else: dibujar_placeholder(canvas_obj)
                    
                    # Datos del Alumno
                    canvas_obj.setFillColorRGB(0.2, 0.2, 0.2)
                    canvas_obj.setFont("Helvetica-Bold", 7)
                    canvas_obj.drawString(30*mm, 34*mm, "ALUMNO(A):")
                    canvas_obj.setFont("Helvetica", 9)
                    nombre_completo = f"{datos['nombres']} {datos['apellido_paterno']} {datos['apellido_materno']}"
                    if len(nombre_completo) > 25: canvas_obj.setFont("Helvetica", 8)
                    canvas_obj.drawString(30*mm, 30*mm, nombre_completo)

                    canvas_obj.setFont("Helvetica-Bold", 7)
                    canvas_obj.drawString(30*mm, 24*mm, "MATR√çCULA:")
                    canvas_obj.setFont("Helvetica", 10)
                    canvas_obj.setFillColorRGB(0.7, 0, 0)
                    canvas_obj.drawString(30*mm, 19.5*mm, f"{datos['id']:06d}")

                    canvas_obj.setFillColorRGB(0.2, 0.2, 0.2)
                    canvas_obj.setFont("Helvetica-Bold", 7)
                    canvas_obj.drawString(55*mm, 24*mm, "CURSO:")
                    
                    # Curso ajustado (Anverso)
                    textobject = canvas_obj.beginText()
                    textobject.setFont("Helvetica", 7)
                    textobject.setTextOrigin(55*mm, 20*mm)
                    max_curso_width = 38*mm
                    curso_texto = datos['nombre_curso'] if datos['nombre_curso'] else "N/A"
                    wrapped_curso = []
                    current_line = ""
                    for word in curso_texto.split():
                        if canvas_obj.stringWidth(current_line + word + " ", "Helvetica", 7) < max_curso_width:
                            current_line += word + " "
                        else:
                            wrapped_curso.append(current_line.strip())
                            current_line = word + " "
                    wrapped_curso.append(current_line.strip())
                    for line in wrapped_curso:
                        textobject.textLine(line)
                    canvas_obj.drawText(textobject)

                    # Pie de p√°gina (Vigencia)
                    canvas_obj.setStrokeColorRGB(0, 0.2, 0.4)
                    canvas_obj.line(4*mm, 8*mm, width-4*mm, 8*mm)
                    canvas_obj.setFont("Helvetica", 6)
                    canvas_obj.setFillColorRGB(0.4, 0.4, 0.4)
                    anio_actual = datetime.date.today().year
                    canvas_obj.drawCentredString(width/2, 5*mm, f"VIGENCIA: CICLO ESCOLAR {anio_actual} - {anio_actual+1}")
                    
                else: # --- REVERSO ---
                    director_nombre = "MTRO. JOVANY IVAN CERVANTES CARRERAS"
                    
                    # T√≠tulo de reverso
                    canvas_obj.setFillColorRGB(0.2, 0.2, 0.2)
                    canvas_obj.setFont("Helvetica-Bold", 10)
                    
                    # L√≠nea de firma
                    firma_y = height / 2.0
                    canvas_obj.setStrokeColorRGB(0.5, 0.5, 0.5)
                    canvas_obj.line(width/4, firma_y, width*3/4, firma_y) # L√≠nea centrada

                    # Firma del Director
                    canvas_obj.setFont("Helvetica", 7)
                    canvas_obj.setFillColorRGB(0.2, 0.2, 0.2)
                    canvas_obj.drawCentredString(width/2, firma_y - 4*mm, director_nombre)
                    canvas_obj.setFont("Helvetica-Bold", 6)
                    canvas_obj.drawCentredString(width/2, firma_y - 7*mm, "DIRECTOR DEL PLANTEL")

                    # Leyenda legal
                    canvas_obj.setStrokeColorRGB(0, 0.2, 0.4)
                    canvas_obj.line(4*mm, 8*mm, width-4*mm, 8*mm)
                    canvas_obj.setFont("Helvetica", 6)
                    canvas_obj.setFillColorRGB(0.4, 0.4, 0.4)
                    canvas_obj.drawCentredString(width/2, 5*mm, "Esta credencial es personal e intransferible y debe ser portada obligatoriamente.")


                canvas_obj.restoreState()
            
            # --- 1. DIBUJAR CARA FRONTAL (ANVERSO) ---
            # Posici√≥n izquierda
            dibujar_cara_credencial(c, MARGIN_X, MARGIN_Y, es_reverso=False)

            # --- 2. DIBUJAR CARA TRASERA (REVERSO) ---
            # Colocamos el reverso a la derecha del anverso, con 1cm de separaci√≥n
            dibujar_cara_credencial(c, MARGIN_X + GAFETE_W + 10 * mm, MARGIN_Y, es_reverso=True)
            
            c.save()

            self._temp_pdf_files.append(filename)
            url = QUrl.fromLocalFile(filename)
            QDesktopServices.openUrl(url)

        except Exception as e:
            mostrar_error(f"Error al generar credencial: {e}\n{traceback.format_exc()}")

    def limpiar_archivos_temporales(self):
        """Elimina los archivos PDF temporales creados."""
        print("Limpiando archivos PDF temporales...")
        for filepath in self._temp_pdf_files:
            try:
                if os.path.exists(filepath):
                    os.remove(filepath)
                    print(f"Eliminado: {filepath}")
            except Exception as e:
                print(f"Error al eliminar archivo temporal {filepath}: {e}")


    def limpiar_campos_alumno(self):
        """Limpia todos los campos del formulario de registro de alumno."""
        # --- NUEVO: Limpiar foto ---
        if hasattr(self, 'lbl_foto_registro'):
            self.ruta_foto_temporal = None
            self.lbl_foto_registro.clear()
            self.lbl_foto_registro.setText("Sin Foto")
        # ---------------------------

        # Alumno
        self.entry_al_ap_paterno.clear()
        self.entry_al_ap_materno.clear()
        self.entry_al_nombres.clear()
        self.entry_al_escuela_procedencia.clear()
        self.entry_al_escuela_ingresar.clear()
        self.entry_al_edad.clear()
        self.entry_al_telefono.clear()
        self.entry_al_email.clear()
        self.combo_al_turno.setCurrentIndex(0)
        self.combo_curso_registro.setCurrentIndex(0) 
        self.check_autoriza_salida.setChecked(False)
        self.check_imprimir_poliza.setChecked(False)
        # Tutor
        self.entry_tutor_ap_paterno.clear()
        self.entry_tutor_ap_materno.clear()
        self.entry_tutor_nombres.clear()
        self.entry_tutor_telefono.clear()
        # Domicilio
        self.entry_dom_calle.clear()
        self.entry_dom_num_int.clear()
        self.entry_dom_num_ext.clear()
        self.entry_dom_colonia.clear()
        self.entry_dom_municipio.clear()
        self.entry_dom_estado.clear()
        self.entry_dom_cp.clear()
        # Emergencia
        self.entry_emerg_1_nombre.clear()
        self.entry_emerg_1_telefono.clear()
        self.entry_emerg_1_parentesco.clear()
        self.entry_emerg_2_nombre.clear()
        self.entry_emerg_2_telefono.clear()
        self.entry_emerg_2_parentesco.clear()

    def cargar_tabla_alumnos(self, curso_id=None):
        """
        Carga la lista de alumnos en la QTableWidget. 
        Si se proporciona un curso_id, filtra por ese curso.
        """
        try: 
            if not hasattr(self, 'tabla_alumnos'): return

            self.tabla_alumnos.setRowCount(0)
            self.expediente_texto.clear()
            
            # --- Consulta SQL modificada para obtener el nombre del curso ---
            query = """
            SELECT 
                a.id, a.nombres, a.apellido_paterno, a.apellido_materno, a.email, c.nombre_curso 
            FROM 
                alumnos a
            LEFT JOIN inscripciones i ON a.id = i.alumno_id
            LEFT JOIN cursos c ON i.curso_id = c.id
            """
            params = []
            
            if curso_id is not None:
                query += " WHERE i.curso_id = ?"
                params.append(curso_id)

            query += " ORDER BY a.apellido_paterno"
            # --- Fin Consulta SQL ---
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute(query, tuple(params))
                alumnos = cursor.fetchall()

            self.tabla_alumnos.setRowCount(len(alumnos))
            for row, alumno in enumerate(alumnos):
                curso_nombre = alumno['nombre_curso'] if alumno['nombre_curso'] else "No Inscrito"
                
                self.tabla_alumnos.setItem(row, 0, QTableWidgetItem(str(alumno['id'])))
                self.tabla_alumnos.setItem(row, 1, QTableWidgetItem(alumno['nombres']))
                self.tabla_alumnos.setItem(row, 2, QTableWidgetItem(alumno['apellido_paterno']))
                self.tabla_alumnos.setItem(row, 3, QTableWidgetItem(alumno['apellido_materno']))
                self.tabla_alumnos.setItem(row, 4, QTableWidgetItem(alumno['email']))
                self.tabla_alumnos.setItem(row, 5, QTableWidgetItem(curso_nombre)) # Nueva Columna

        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar tabla de alumnos: {e}")
        except AttributeError:
            pass 
    
    def abrir_dialogo_nueva_inscripcion(self):
        """
        Abre el di√°logo para inscribir a un alumno existente en un nuevo curso.
        """
        selected_items = self.tabla_alumnos.selectedItems()
        if not selected_items or self.tabla_alumnos.currentRow() < 0:
            mostrar_error("Por favor, seleccione un alumno de la lista.")
            return
        
        try:
            row = self.tabla_alumnos.currentRow()
            alumno_id = int(self.tabla_alumnos.item(row, 0).text())
            # Construir nombre completo desde la tabla
            nombre = self.tabla_alumnos.item(row, 1).text()
            ap_paterno = self.tabla_alumnos.item(row, 2).text()
            ap_materno = self.tabla_alumnos.item(row, 3).text()
            nombre_completo = f"{nombre} {ap_paterno} {ap_materno}"
            
            # Llamar al nuevo QDialog
            dialogo = DialogoInscribirCurso(alumno_id, nombre_completo, self)
            
            if dialogo.exec(): # Si el di√°logo se acepta (si se guard√≥)
                mostrar_info("Alumno inscrito a nuevo curso exitosamente.")
                # Recargamos la lista de alumnos (para actualizar el filtro)
                # y el combo de pagos (para que aparezca la nueva inscripci√≥n)
                self.cargar_tabla_alumnos()
                self.cargar_cache_inscripciones() # Recarga el combo de la p√°g de pagos
                
        except Exception as e:
            mostrar_error(f"Error al abrir di√°logo de inscripci√≥n: {e}")
    
    def abrir_dialogo_editar_alumno(self):
        """
        Abre el di√°logo para editar un alumno existente.
        """
        selected_items = self.tabla_alumnos.selectedItems()
        if not selected_items or self.tabla_alumnos.currentRow() < 0:
            mostrar_error("Por favor, seleccione un alumno de la lista para editar.")
            return
        
        try:
            row = self.tabla_alumnos.currentRow()
            alumno_id = int(self.tabla_alumnos.item(row, 0).text())
            
            # Llamar al nuevo QDialog
            dialogo = DialogoEditarAlumno(alumno_id, self)
            
            if dialogo.exec(): # Si el di√°logo se acepta (si se guard√≥)
                # Recargamos la tabla y el expediente para ver los cambios
                self.cargar_tabla_alumnos()
                # Volvemos a seleccionar la fila que estaba editada (opcional)
                self.tabla_alumnos.selectRow(row) 
                self.mostrar_expediente_alumno()
                
        except Exception as e:
            mostrar_error(f"Error al abrir di√°logo de edici√≥n: {e}")

    def registrar_curso(self):
        """DEPRECADO: Usar guardar_curso."""
        self.guardar_curso()

    def guardar_curso(self):
        """Guarda un nuevo curso o actualiza uno existente."""
        if not all(hasattr(self, w) for w in ['entry_cur_nombre', 'spin_costo_exhibicion', 'spin_costo_sem_15', 'spin_costo_sem_12', 'spin_costo_mensual_3', 'spin_costo_bi_semanal', 'spin_costo_mensual_4']):
            return 

        nombre = self.entry_cur_nombre.text().strip()
        costo_exhibicion = self.spin_costo_exhibicion.value()
        costo_sem_15 = self.spin_costo_sem_15.value()
        costo_sem_12 = self.spin_costo_sem_12.value() 
        costo_mensual_3 = self.spin_costo_mensual_3.value()
        costo_bi_semanal = self.spin_costo_bi_semanal.value()
        costo_mensual_4 = self.spin_costo_mensual_4.value()
        costo_mensualidad = self.spin_costo_mensualidad.value()
        if not nombre:
            mostrar_error("El nombre del curso es obligatorio.")
            return
        if costo_exhibicion == 0 and costo_sem_15 == 0 and costo_sem_12 == 0 and costo_mensual_3 == 0 and costo_bi_semanal == 0 and costo_mensual_4 == 0 and costo_mensualidad == 0:
            mostrar_error("Debe definir al menos un plan de costo para el curso.")
            return

        if costo_exhibicion == 0 and costo_sem_15 == 0 and costo_sem_12 == 0 and costo_mensual_3 == 0 and costo_bi_semanal == 0 and costo_mensual_4 == 0 and costo_mensualidad == 0:
            mostrar_error("Debe definir al menos un plan de costo o un descuento para el curso.")
            return

        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                if self.curso_seleccionado_id is None:
                    # --- MODIFICA EL INSERT ---
                    cursor.execute("""
                    INSERT INTO cursos (nombre_curso, costo_exhibicion, costo_sem_15, costo_sem_12, costo_mensual_3, costo_bi_semanal, costo_mensual_4, costo_mensualidad)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                    """, (nombre, costo_exhibicion, costo_sem_15, costo_sem_12, costo_mensual_3, costo_bi_semanal, costo_mensual_4, costo_mensualidad)) 
                else:
                    # --- MODIFICA EL UPDATE ---
                    cursor.execute("""
                    UPDATE cursos SET nombre_curso = ?, costo_exhibicion = ?, costo_sem_15 = ?, costo_sem_12 = ?, costo_mensual_3 = ?, costo_bi_semanal = ?, costo_mensual_4 = ?, costo_mensualidad = ?
                    WHERE id = ?
                    """, (nombre, costo_exhibicion, costo_sem_15, costo_sem_12, costo_mensual_3, costo_bi_semanal, costo_mensual_4, costo_mensualidad, self.curso_seleccionado_id))
                
                conn.commit()
                
            self.limpiar_campos_curso()
            self.cargar_datos_maestros() 

        except sqlite3.IntegrityError:
            mostrar_error("Error: El nombre del curso ya existe.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al guardar curso: {e}")

    def limpiar_campos_curso(self):
        """Limpia el formulario de cursos y resetea el modo a 'Guardar'."""
        try: 
            if hasattr(self, 'entry_cur_nombre'):
                self.entry_cur_nombre.clear()
                self.spin_costo_exhibicion.setValue(0.0)
                self.spin_costo_sem_15.setValue(0.0)
                self.spin_costo_sem_12.setValue(0.0) 
                self.spin_costo_mensual_3.setValue(0.0)
                self.spin_costo_bi_semanal.setValue(0.0)
                self.spin_costo_mensual_4.setValue(0.0)
                self.spin_costo_mensualidad.setValue(0.0)
                
                self.curso_seleccionado_id = None
                self.btn_guardar_curso.setText("Guardar Curso")
                self.tabla_cursos.clearSelection()
        except AttributeError:
            pass 

    def seleccionar_curso_para_edicion(self):
        """Carga los datos del curso seleccionado en el formulario de edici√≥n."""
        selected_items = self.tabla_cursos.selectedItems()
        if not selected_items:
            self.limpiar_campos_curso()
            return

        selected_row = self.tabla_cursos.currentRow()
        if selected_row < 0:
             self.limpiar_campos_curso()
             return
            
        curso_id_item = self.tabla_cursos.item(selected_row, 0)
        if not curso_id_item: return

        try:
            curso_id = int(curso_id_item.text())
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM cursos WHERE id = ?", (curso_id,))
                datos = cursor.fetchone()

            if datos:
                self.curso_seleccionado_id = curso_id
                self.entry_cur_nombre.setText(datos['nombre_curso'])
                self.spin_costo_exhibicion.setValue(datos['costo_exhibicion'])
                self.spin_costo_sem_15.setValue(datos['costo_sem_15'])
                self.spin_costo_sem_12.setValue(datos['costo_sem_12'])
                self.spin_costo_mensual_3.setValue(datos['costo_mensual_3'])
                self.spin_costo_bi_semanal.setValue(datos['costo_bi_semanal'])
                self.spin_costo_mensual_4.setValue(datos['costo_mensual_4'])
                self.spin_costo_mensualidad.setValue(datos['costo_mensualidad'] if 'costo_mensualidad' in datos.keys() else 0.0)
                # --- FIN ---
                
                self.btn_guardar_curso.setText("Actualizar Curso")

        except Exception as e:
            mostrar_error(f"Error al cargar datos de curso: {e}")
            self.limpiar_campos_curso()
            
    def dar_baja_curso(self):
        """Elimina un curso seleccionado de la BD."""
        selected_items = self.tabla_cursos.selectedItems()
        if not selected_items:
            mostrar_error("Por favor, seleccione un curso de la lista para eliminar.")
            return
        
        selected_row = self.tabla_cursos.currentRow()
        if selected_row < 0: return
        
        curso_id_item = self.tabla_cursos.item(selected_row, 0)
        nombre_curso_item = self.tabla_cursos.item(selected_row, 1)
        if not curso_id_item: return
        
        curso_id = int(curso_id_item.text())
        nombre_curso = nombre_curso_item.text()
        
        # --- VERIFICACI√ìN DE ALUMNOS INSCRITOS ---
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT COUNT(id) as count FROM inscripciones WHERE curso_id = ?", (curso_id,))
                conteo = cursor.fetchone()
        
            if conteo['count'] > 0:
                mostrar_error(f"No se puede eliminar el curso '{nombre_curso}' porque tiene {conteo['count']} alumno(s) inscrito(s).")
                return

            # Si no hay alumnos, proceder a eliminar
            reply = QMessageBox.question(self, "Confirmar Eliminaci√≥n",
                                         f"¬øEst√° seguro que desea eliminar al curso:\n\n{nombre_curso} (ID: {curso_id})?\n\nEsta acci√≥n no se puede deshacer.",
                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.Cancel)

            if reply == QMessageBox.StandardButton.Yes:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("DELETE FROM cursos WHERE id = ?", (curso_id,))
                    conn.commit()
                
                mostrar_info(f"Curso '{nombre_curso}' eliminado exitosamente.")
                self.limpiar_campos_curso()
                self.cargar_datos_maestros()

        except sqlite3.Error as e:
            mostrar_error(f"Error al eliminar curso: {e}")
        except Exception as e:
             mostrar_error(f"Error inesperado: {e}")


    def cargar_tabla_cursos(self):
        """Carga la lista de cursos en la QTableWidget."""
        try: 
            if hasattr(self, 'tabla_cursos'):
                self.tabla_cursos.setRowCount(0)
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("SELECT * FROM cursos ORDER BY nombre_curso")
                    cursos = cursor.fetchall()

                    self.tabla_cursos.setRowCount(len(cursos))
            for row, curso in enumerate(cursos):
                        self.tabla_cursos.setItem(row, 0, QTableWidgetItem(str(curso['id'])))
                        self.tabla_cursos.setItem(row, 1, QTableWidgetItem(curso['nombre_curso']))
                        self.tabla_cursos.setItem(row, 2, QTableWidgetItem(f"$ {curso['costo_exhibicion']:.2f}"))
                        self.tabla_cursos.setItem(row, 3, QTableWidgetItem(f"$ {curso['costo_sem_15']:.2f}"))
                        self.tabla_cursos.setItem(row, 4, QTableWidgetItem(f"$ {curso['costo_sem_12']:.2f}")) 
                        self.tabla_cursos.setItem(row, 5, QTableWidgetItem(f"$ {curso['costo_mensual_3']:.2f}"))
                        self.tabla_cursos.setItem(row, 5, QTableWidgetItem(f"$ {curso['costo_bi_semanal']:.2f}"))
                        self.tabla_cursos.setItem(row, 5, QTableWidgetItem(f"$ {curso['costo_mensual_4']:.2f}"))
                   
                        # Alinear costos a la derecha
                        for col in range(2, 6):
                            item = self.tabla_cursos.item(row, col)
                            if item:
                                item.setTextAlignment(Qt.AlignmentFlag.AlignRight | Qt.AlignmentFlag.AlignVCenter)
                                
        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar tabla de cursos: {e}")
        except AttributeError:
            pass 

    def registrar_nuevo_usuario(self):
        """DEPRECADO: Usar guardar_usuario."""
        self.guardar_usuario() 

    def guardar_usuario(self):
        """Guarda un usuario nuevo o actualiza uno existente."""
        if not all(hasattr(self, w) for w in ['entry_usr_nombre', 'entry_usr_email', 'permisos_checkboxes']):
            return 

        nombre = self.entry_usr_nombre.text().strip()
        telefono = self.entry_usr_telefono.text().strip()
        email = self.entry_usr_email.text().strip()
        
        if not nombre or not email:
            mostrar_error("Nombre Completo y Correo Electr√≥nico son obligatorios.")
            return
            
        # --- INICIO DE MODIFICACI√ìN: Construir diccionario de permisos ---
        permisos_dict = {}
        for clave, checkbox in self.permisos_checkboxes.items():
            permisos_dict[clave] = checkbox.isChecked()
        
        # Convertir a JSON
        permisos_json = json.dumps(permisos_dict)
        # --- FIN DE MODIFICACI√ìN ---
            
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                
                if self.usuario_seleccionado_id is None:
                    # --- CREAR NUEVO USUARIO ---
                    password = secrets.token_hex(4) 
                    cursor.execute("""
                    INSERT INTO usuarios (nombre_completo, telefono, email, permisos, password)
                    VALUES (?, ?, ?, ?, ?)
                    """, (nombre, telefono, email, permisos_json, password))
                    user_id = cursor.lastrowid 
                    conn.commit()
                    
                    mostrar_info(f"Usuario creado exitosamente:\n\n"
                                 f"No. de Empleado (ID): {user_id}\n"
                                 f"Usuario (Email): {email}\n"
                                 f"Contrase√±a: {password}\n\n"
                                 "Por favor, guarde esta contrase√±a. No se puede recuperar.")
                
                else:
                    # --- ACTUALIZAR USUARIO EXISTENTE ---
                    cursor.execute("""
                    UPDATE usuarios SET nombre_completo = ?, telefono = ?, email = ?, permisos = ?
                    WHERE id = ?
                    """, (nombre, telefono, email, permisos_json, self.usuario_seleccionado_id))
                    conn.commit()
                    mostrar_info(f"Usuario (ID: {self.usuario_seleccionado_id}) actualizado exitosamente.")
                         
            self.limpiar_campos_usuario()
            self.cargar_tabla_usuarios()
            
        except sqlite3.IntegrityError:
            mostrar_error("Error: Ese correo electr√≥nico ya est√° registrado.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al registrar usuario: {e}")

    def cambiar_password_usuario(self):
        """Cambia la contrase√±a del usuario seleccionado."""
        if self.usuario_seleccionado_id is None:
            mostrar_error("No hay ning√∫n usuario seleccionado.")
            return

        nueva_pass, ok = QInputDialog.getText(self, "Cambiar Contrase√±a",
                                              "Ingrese la nueva contrase√±a:", QLineEdit.EchoMode.Password)
        
        if ok and nueva_pass:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("UPDATE usuarios SET password = ? WHERE id = ?", (nueva_pass, self.usuario_seleccionado_id))
                    conn.commit()
                mostrar_info("Contrase√±a actualizada exitosamente.")
            except sqlite3.Error as e:
                mostrar_error(f"Error al cambiar la contrase√±a: {e}")
        elif ok and not nueva_pass:
            mostrar_error("La contrase√±a no puede estar vac√≠a.")

    def seleccionar_usuario_para_edicion(self):
        """Carga los datos del usuario seleccionado en el formulario de edici√≥n."""
        selected_items = self.tabla_usuarios.selectedItems()
        if not selected_items:
            self.limpiar_campos_usuario() 
            return

        selected_row = self.tabla_usuarios.currentRow()
        
        if selected_row < 0:
             self.limpiar_campos_usuario()
             return
             
        user_id_item = self.tabla_usuarios.item(selected_row, 0)
        if not user_id_item: return

        try:
            user_id = int(user_id_item.text())
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM usuarios WHERE id = ?", (user_id,))
                datos = cursor.fetchone()

            if datos:
                self.usuario_seleccionado_id = user_id
                self.entry_usr_nombre.setText(datos['nombre_completo'])
                self.entry_usr_telefono.setText(datos['telefono'])
                self.entry_usr_email.setText(datos['email'])
                
                # --- INICIO DE MODIFICACI√ìN: Cargar permisos ---
                try:
                    permisos_dict = json.loads(datos['permisos'])
                except json.JSONDecodeError:
                    permisos_dict = {} # Fallback

                # Asignar el estado de los checkboxes
                for clave, checkbox in self.permisos_checkboxes.items():
                    checkbox.setChecked(permisos_dict.get(clave, False))
                # --- FIN DE MODIFICACI√ìN ---
                
                self.btn_guardar_usuario.setText("Actualizar Usuario")
                
                # Proteger al Admin ID 1
                if user_id == 1:
                    self.btn_cambiar_password.setVisible(False)
                else:
                    self.btn_cambiar_password.setVisible(True)

        except Exception as e:
            mostrar_error(f"Error al cargar datos de usuario: {e}")
            self.limpiar_campos_usuario()

    def dar_baja_usuario(self):
        """Elimina un usuario seleccionado de la BD."""
        if self.usuario_seleccionado_id is None:
            selected_items = self.tabla_usuarios.selectedItems()
            if not selected_items:
                mostrar_error("Por favor, seleccione un usuario de la lista para eliminar.")
                return
            selected_row = self.tabla_usuarios.currentRow()
            if selected_row < 0: return
            user_id_item = self.tabla_usuarios.item(selected_row, 0)
            nombre_item = self.tabla_usuarios.item(selected_row, 1)
            email_item = self.tabla_usuarios.item(selected_row, 2)
            if not user_id_item: return
            
            self.usuario_seleccionado_id = int(user_id_item.text())
            nombre_seleccionado = nombre_item.text()
            email_seleccionado = email_item.text()
        else:
            nombre_seleccionado = self.entry_usr_nombre.text()
            email_seleccionado = self.entry_usr_email.text()

            
        # Protecci√≥n para el admin ID 1 y para no borrarse a s√≠ mismo
        if self.usuario_seleccionado_id == 1:
            mostrar_error("No se puede eliminar al administrador principal (ID 1).")
            return
            
        if email_seleccionado == self.username:
            mostrar_error("No puede eliminarse a s√≠ mismo.")
            return

        reply = QMessageBox.question(self, "Confirmar Eliminaci√≥n",
                                     f"¬øEst√° seguro que desea eliminar al usuario:\n\n{nombre_seleccionado} (ID: {self.usuario_seleccionado_id})?\n\nEsta acci√≥n no se puede deshacer.",
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.Cancel)

        if reply == QMessageBox.StandardButton.Yes:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("DELETE FROM usuarios WHERE id = ?", (self.usuario_seleccionado_id,))
                    conn.commit()
                
                mostrar_info(f"Usuario {nombre_seleccionado} eliminado exitosamente.")
                self.limpiar_campos_usuario()
                self.cargar_tabla_usuarios()

            except sqlite3.Error as e:
                mostrar_error(f"Error al eliminar usuario: {e}")

            
    def limpiar_campos_usuario(self):
        """Limpia el formulario de gesti√≥n de usuarios y resetea el modo a 'Guardar'."""
        try:
            if hasattr(self, 'entry_usr_nombre'):
                self.entry_usr_nombre.clear()
                self.entry_usr_telefono.clear()
                self.entry_usr_email.clear()
                
                # --- INICIO DE MODIFICACI√ìN: Limpiar checkboxes ---
                if hasattr(self, 'permisos_checkboxes'):
                    for checkbox in self.permisos_checkboxes.values():
                        checkbox.setChecked(False)
                        checkbox.setEnabled(True)
                # --- FIN DE MODIFICACI√ìN ---
                
                self.usuario_seleccionado_id = None
                self.btn_guardar_usuario.setText("Guardar Usuario")
                self.btn_cambiar_password.setVisible(False)
                self.tabla_usuarios.clearSelection()
        except AttributeError:
            pass
    
    def toggle_all_permissions(self, is_admin_checked):
        """
        Se llama cuando el checkbox 'ES ADMINISTRADOR' cambia.
        Habilita/deshabilita y marca/desmarca todos los dem√°s permisos.
        """
        if not hasattr(self, 'permisos_checkboxes'):
            return # Salir si los checkboxes no est√°n listos

        for clave, checkbox in self.permisos_checkboxes.items():
            if clave == 'is_admin':
                continue # No te deshabilites a ti mismo

            # Si 'is_admin' est√° marcado, deshabilita y marca los otros
            checkbox.setEnabled(not is_admin_checked)
            checkbox.setChecked(is_admin_checked)

    def cargar_tabla_usuarios(self):
        """Carga la lista de usuarios (empleados) en la QTableWidget."""
        try: 
            if hasattr(self, 'tabla_usuarios'):
                self.tabla_usuarios.setRowCount(0)
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    # --- MODIFICADO: Quitar 'rol' ---
                    cursor.execute("SELECT id, nombre_completo, email FROM usuarios ORDER BY nombre_completo")
                    usuarios = cursor.fetchall()

                    self.tabla_usuarios.setRowCount(len(usuarios))
                    for row, usuario in enumerate(usuarios):
                        self.tabla_usuarios.setItem(row, 0, QTableWidgetItem(str(usuario['id'])))
                        self.tabla_usuarios.setItem(row, 1, QTableWidgetItem(usuario['nombre_completo']))
                        self.tabla_usuarios.setItem(row, 2, QTableWidgetItem(usuario['email']))
        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar tabla de usuarios: {e}")
        except AttributeError:
            pass

    def cargar_datos_maestros(self):
        """Funci√≥n central para recargar todos los datos."""
        if hasattr(self, 'cargar_tabla_alumnos'):
            self.cargar_tabla_alumnos()
        if hasattr(self, 'cargar_tabla_cursos'):
            self.cargar_tabla_cursos()
        if hasattr(self, 'cargar_combo_curso_registro'):
            self.cargar_combo_curso_registro()
        if hasattr(self, 'cargar_tabla_inscripciones_pagos'):
            self.cargar_tabla_inscripciones_pagos()
        if hasattr(self, 'cargar_tabla_usuarios') and self.user_role == "Administrador":
            self.cargar_tabla_usuarios()
        
        if hasattr(self, 'cargar_cursos_para_filtro'): 
            self.cargar_cursos_para_filtro()
        if self.user_role == "Administrador":
            if hasattr(self, 'cargar_combo_cursos_materias'): self.cargar_combo_cursos_materias()
            if hasattr(self, 'cargar_combo_cursos_calif'): self.cargar_combo_cursos_calif()


    # --- NUEVAS FUNCIONES DE TEMA ---
    def cargar_configuracion_tema(self):
        """Carga la configuraci√≥n de tema desde CONFIG_FILE."""
        try:
            if os.path.exists(CONFIG_FILE):
                with open(CONFIG_FILE, 'r') as f:
                    config = json.load(f)
                    theme = config.get("theme", "Claro")
                    accent = config.get("accent", "Naranja")
                    return theme, accent
        except Exception as e:
            print(f"Error al cargar configuraci√≥n: {e}")
        return "Claro", "Naranja" 

    def guardar_configuracion_tema(self):
        """Guarda la configuraci√≥n actual en CONFIG_FILE."""
        try:
            config = {
                "theme": self.theme,
                "accent": self.accent
            }
            with open(CONFIG_FILE, 'w') as f:
                json.dump(config, f, indent=4)
        except Exception as e:
            print(f"Error al guardar configuraci√≥n: {e}")

    def actualizar_tema(self):
        """Se llama cuando un combo de configuraci√≥n cambia."""
        self.theme = self.combo_tema.currentText()
        self.accent = self.combo_acento.currentText()
        self.aplicar_estilo_actual()
        self.guardar_configuracion_tema()

    def aplicar_estilo_actual(self):
        """Aplica el stylesheet combinado a la aplicaci√≥n y fuerza la actualizaci√≥n de widgets."""
        
        theme_name = "claro" if self.theme == "Claro" else "dark"
        self.setProperty("style", theme_name)
        
        stylesheet = get_full_stylesheet(self.theme, self.accent)
        app.setStyleSheet(stylesheet)

        # "Pulir" la ventana principal
        self.style().unpolish(self)
        self.style().polish(self)

        # --- CORRECCI√ìN: Forzar actualizaci√≥n de los botones de navegaci√≥n ---
        if hasattr(self, 'nav_buttons'):
            for btn in self.nav_buttons:
                if btn:
                    self.style().unpolish(btn)
                    self.style().polish(btn)
        
        # Forzar actualizaci√≥n de la barra superior si existe
        if hasattr(self, 'lbl_usuario_top'):
             # A veces es necesario repulir el contenedor padre de la barra superior
             top_bar = self.findChild(QWidget, "topBar")
             if top_bar:
                 self.style().unpolish(top_bar)
                 self.style().polish(top_bar)
        # --- FIN DE CORRECCI√ìN ---

# --- M√âTODOS DE RESPALDO Y RESTAURACI√ìN ---

    def respaldar_base_datos(self):
        """Crea una copia del archivo de base de datos actual."""
        try:
            # Nombre de archivo sugerido con fecha y hora
            fecha_hoy = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
            default_name = f"respaldo_escolar_{fecha_hoy}.db"
            
            # Di√°logo para guardar
            file_path, _ = QFileDialog.getSaveFileName(self, "Guardar Respaldo", default_name, "Archivos de Base de Datos (*.db);;Todos los archivos (*.*)")

            if file_path:
                if os.path.exists(DB_NAME):
                    # Copiar el archivo de base de datos activo al destino seleccionado
                    shutil.copy2(DB_NAME, file_path)
                    mostrar_info(f"‚úÖ Respaldo creado exitosamente en:\n{file_path}\n\nGuarda este archivo en un lugar seguro (como tu OneDrive).")
                else:
                     mostrar_error("CR√çTICO: No se encuentra el archivo de base de datos activo para respaldar.")

        except Exception as e:
            mostrar_error(f"Error al crear respaldo: {e}")

    def restaurar_base_datos(self):
        """Restaura la base de datos desde una copia de seguridad."""
        # Advertencia fuerte antes de proceder
        reply = QMessageBox.warning(self, "‚ö†Ô∏è Confirmar Restauraci√≥n",
                                    "ADVERTENCIA: Al restaurar una base de datos, SE BORRAR√Å TODA LA INFORMACI√ìN ACTUAL y ser√° reemplazada por la del respaldo.\n\n"
                                    "Se recomienda generar un respaldo actual antes de continuar.\n\n"
                                    "¬øEst√° completamente seguro de que desea continuar?",
                                    QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
                                    QMessageBox.StandardButton.No)

        if reply == QMessageBox.StandardButton.Yes:
            # Di√°logo para abrir archivo
            file_path, _ = QFileDialog.getOpenFileName(self, "Seleccionar Archivo de Respaldo", "", "Archivos de Base de Datos (*.db);;Todos los archivos (*.*)")

            if file_path:
                 try:
                    # Verificar que sea un archivo SQLite v√°lido (b√°sico)
                    if not os.path.isfile(file_path):
                        raise FileNotFoundError("El archivo seleccionado no existe.")

                    # Reemplazar la base de datos actual con el respaldo
                    shutil.copy2(file_path, DB_NAME)
                    
                    QMessageBox.information(self, "Restauraci√≥n Exitosa", 
                                            "La base de datos ha sido restaurada correctamente.\n\n"
                                            "La aplicaci√≥n se cerrar√° ahora para asegurar la integridad de los datos.\n"
                                            "Por favor, inicie el sistema nuevamente.")
                    # Cerrar la aplicaci√≥n para forzar recarga limpia de datos
                    sys.exit(0) 

                 except Exception as e:
                     mostrar_error(f"Error al restaurar la base de datos:\n{e}\n\nAseg√∫rese de que el archivo seleccionado sea un respaldo v√°lido y que el sistema tenga permisos de escritura.")
    
    def on_check_for_updates_button_click(self):
        """
        Se ejecuta al presionar el bot√≥n "Buscar Actualizaciones" en Configuraci√≥n.
        Realiza una comprobaci√≥n s√≠ncrona.
        """
        try:
            # Deshabilitar el bot√≥n para evitar clics dobles
            self.btn_check_updates.setEnabled(False)
            self.btn_check_updates.setText("Buscando...")
            QApplication.processEvents() # Actualizar UI

            # (Aseg√∫rate de tener requests y APP_VERSION_URL definidos al inicio de tu script)
            response = requests.get(APP_VERSION_URL, timeout=5)
            response.raise_for_status()
            
            data = response.json()
            latest_version = data.get("version")
            download_url = data.get("url")

            if latest_version and download_url:
                # (Aseg√∫rate de tener APP_CURRENT_VERSION definida)
                if latest_version != APP_CURRENT_VERSION:
                    print(f"¬°Nueva versi√≥n encontrada! {latest_version}")
                    # Llamar a la funci√≥n que pregunta al usuario (ya existe)
                    prompt_update(self, latest_version, download_url)
                else:
                    print("El sistema ya est√° actualizado.")
                    mostrar_info("El sistema ya est√° actualizado a la √∫ltima versi√≥n.")
            else:
                mostrar_error("El archivo de versi√≥n en el servidor tiene un formato incorrecto.")

        except requests.exceptions.RequestException as e:
            mostrar_error(f"Error al buscar actualizaciones:\nNo se pudo conectar al servidor.\n\n{e}")
        except NameError as e:
            mostrar_error(f"Error de configuraci√≥n: Faltan variables de actualizaci√≥n (APP_VERSION_URL o APP_CURRENT_VERSION) en el script.\n\n{e}")
        except Exception as e:
            mostrar_error(f"Error desconocido al procesar actualizaciones: {e}")
        finally:
            # Reactivar el bot√≥n
            self.btn_check_updates.setEnabled(True)
            self.btn_check_updates.setText("üõ∞Ô∏è Buscar Actualizaciones")


# ---- HOJAS DE ESTILO (QSS) ----

# --- INICIO DE M√âTODOS DE GESTI√ìN DE PERSONAL ---
    
    def cargar_tabla_personal(self):
        """Carga la lista del personal en la QTableWidget."""
        try: 
            if not hasattr(self, 'tabla_personal'): return
            self.tabla_personal.setRowCount(0)
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT id, num_empleado, nombre, apellido_paterno, apellido_materno, puesto, email FROM personal ORDER BY apellido_paterno")
                personal = cursor.fetchall()

                self.tabla_personal.setRowCount(len(personal))
                for row, p in enumerate(personal):
                    nombre_completo = f"{p['nombre']} {p['apellido_paterno']} {p['apellido_materno']}"
                    self.tabla_personal.setItem(row, 0, QTableWidgetItem(str(p['id'])))
                    self.tabla_personal.setItem(row, 1, QTableWidgetItem(p['num_empleado']))
                    self.tabla_personal.setItem(row, 2, QTableWidgetItem(nombre_completo))
                    self.tabla_personal.setItem(row, 3, QTableWidgetItem(p['puesto']))
                    self.tabla_personal.setItem(row, 4, QTableWidgetItem(p['email']))
        except Exception as e:
            mostrar_error(f"Error al cargar tabla de personal: {e}")

    def mostrar_expediente_personal(self):
        """Muestra los detalles del empleado seleccionado en el QTextEdit."""
        if not hasattr(self, 'expediente_personal_texto'): return
        
        selected_items = self.tabla_personal.selectedItems()
        if not selected_items or self.tabla_personal.currentRow() < 0:
            self.expediente_personal_texto.clear()
            return
        
        personal_id = int(self.tabla_personal.item(self.tabla_personal.currentRow(), 0).text())
        
        try:
            with get_db_connection() as conn:
                datos = conn.cursor().execute("SELECT * FROM personal WHERE id = ?", (personal_id,)).fetchone()
            
            if datos:
                # (L√≥gica de foto copiada de mostrar_expediente_alumno)
                foto_html = ""
                ruta_foto_bd = datos['foto_ruta']
                if ruta_foto_bd and os.path.exists(ruta_foto_bd):
                    ruta_normalizada = ruta_foto_bd.replace('\\', '/')
                    foto_html = f'<img src="{ruta_normalizada}" width="150" height="200">'
                else:
                    foto_html = '<table width="150" height="200" bgcolor="#cccccc"><tr><td align="center" valign="middle">Sin Foto</td></tr></table>'

                expediente_str = f"""
                <table width="100%" border="0" cellspacing="0" cellpadding="5">
                    <tr>
                        <td valign="top">
                            <b><u>DATOS DEL PERSONAL</u></b><br>
                            <b>No. Empleado:</b> {datos['num_empleado']}<br>
                            <b>Nombre:</b> {datos['nombre']} {datos['apellido_paterno']} {datos['apellido_materno']}<br>
                            <b>Puesto:</b> {datos['puesto']}<br>
                            <b>CURP:</b> {datos['curp']} | <b>RFC:</b> {datos['rfc']}<br>
                            <b>NSS:</b> {datos['nss']}<br>
                            <b>Fecha Nac:</b> {datos['fecha_nacimiento']} | <b>Edo. Civil:</b> {datos['estado_civil']}<br>
                            <b>Escolaridad:</b> {datos['escolaridad']}
                        </td>
                        <td valign="top" align="right" width="160">{foto_html}</td>
                    </tr>
                </table>
                <hr>
                <b><u>CONTACTO Y DOMICILIO</u></b><br>
                <b>Tel√©fono:</b> {datos['telefono']} | <b>Email:</b> {datos['email']}<br>
                <b>Direcci√≥n:</b> {datos['direccion']}<br>
                <br>
                <b><u>CONTACTOS DE EMERGENCIA</u></b><br>
                <b>1:</b> {datos['emerg_1_nombre']} - Tel: {datos['emerg_1_telefono']}<br>
                <b>2:</b> {datos['emerg_2_nombre']} - Tel: {datos['emerg_2_telefono']}<br>
                """
                self.expediente_personal_texto.setHtml(expediente_str)
            else:
                self.expediente_personal_texto.clear()
        except Exception as e:
            mostrar_error(f"Error al mostrar expediente de personal: {e}")

    def abrir_dialogo_personal(self, editar=False):
        """Abre el QDialog para registrar o editar personal."""
        personal_id = None
        if editar:
            selected_items = self.tabla_personal.selectedItems()
            if not selected_items or self.tabla_personal.currentRow() < 0:
                mostrar_error("Por favor, seleccione un empleado de la lista para editar.")
                return
            personal_id = int(self.tabla_personal.item(self.tabla_personal.currentRow(), 0).text())
        
        dialogo = DialogGestionPersonal(personal_id=personal_id, parent=self)
        # Aplicamos el estilo actual al di√°logo
        self.style().polish(dialogo) 
        
        if dialogo.exec():
            # Si el di√°logo se guard√≥ (accept()), recargamos
            self.cargar_tabla_personal()
            self.mostrar_expediente_personal()

    def abrir_expediente_personal_seleccionado(self):
        """Abre la ventana de documentos para el personal seleccionado."""
        selected_items = self.tabla_personal.selectedItems()
        if not selected_items or self.tabla_personal.currentRow() < 0:
            mostrar_error("Por favor, seleccione un empleado de la lista.")
            return
        
        try:
            row = self.tabla_personal.currentRow()
            personal_id = int(self.tabla_personal.item(row, 0).text())
            nombre_completo = self.tabla_personal.item(row, 2).text()

            ventana_docs = VentanaDocumentosPersonal(personal_id, nombre_completo, self)
            ventana_docs.exec()
        except Exception as e:
            mostrar_error(f"Error al abrir expediente de personal: {e}")

    def eliminar_personal(self):
        """Elimina al empleado seleccionado (con confirmaci√≥n)."""
        selected_items = self.tabla_personal.selectedItems()
        if not selected_items or self.tabla_personal.currentRow() < 0:
            mostrar_error("Por favor, seleccione un empleado de la lista para eliminar.")
            return
        
        row = self.tabla_personal.currentRow()
        personal_id = int(self.tabla_personal.item(row, 0).text())
        nombre_completo = self.tabla_personal.item(row, 2).text()
        
        # (Opcional: Verificar si est√° ligado a un usuario)
        
        reply = QMessageBox.question(self, "Confirmar Eliminaci√≥n",
                                     f"¬øEst√° seguro que desea eliminar a:\n\n{nombre_completo} (ID: {personal_id})?\n\nEsta acci√≥n eliminar√° sus documentos asociados.",
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
        
        if reply == QMessageBox.StandardButton.Yes:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    # ON DELETE CASCADE se encargar√° de borrar 'documentos_personal'
                    cursor.execute("DELETE FROM personal WHERE id = ?", (personal_id,))
                    conn.commit()
                
                mostrar_info(f"Personal '{nombre_completo}' eliminado exitosamente.")
                self.cargar_tabla_personal()
                self.expediente_personal_texto.clear()
            except Exception as e:
                mostrar_error(f"Error al eliminar personal: {e}")

    def generar_credencial_personal_pdf(self):
        """
        Genera la credencial de personal REUTILIZANDO el dise√±o de la credencial de alumno.
        """
        
        # --- 1. DEFINICIONES DE TAMA√ëO ---
        PAGE_WIDTH, PAGE_HEIGHT = letter 
        GAFETE_W, GAFETE_H = 85.6 * mm, 53.98 * mm 
        MARGIN_X = (PAGE_WIDTH - (GAFETE_W * 2 + 10 * mm)) / 2 
        MARGIN_Y = PAGE_HEIGHT - GAFETE_H - 15 * mm 
        
        # --- 2. OBTENER DATOS DEL PERSONAL ---
        selected_items = self.tabla_personal.selectedItems()
        if not selected_items or self.tabla_personal.currentRow() < 0:
            mostrar_error("Por favor, seleccione un empleado de la lista.")
            return
        try:
             personal_id = int(self.tabla_personal.item(self.tabla_personal.currentRow(), 0).text())
        except Exception:
            mostrar_error("No se pudo obtener el ID del personal.")
            return

        try:
            with get_db_connection() as conn:
                datos = conn.cursor().execute("SELECT * FROM personal WHERE id = ?", (personal_id,)).fetchone()

            if not datos:
                mostrar_error("No se encontraron datos para el empleado.")
                return

            # --- 3. FUNCIONES DE AYUDA (Reutilizadas de la credencial de alumno) ---

            def dibujar_marca_agua(canvas_obj, width, height):
                if os.path.exists(LOGO_PATH):
                    try:
                        canvas_obj.saveState()
                        canvas_obj.setFillAlpha(0.1) 
                        logo_w, logo_h = 35 * mm, 35 * mm
                        canvas_obj.drawImage(LOGO_PATH, (width - logo_w)/2, (height - logo_h)/2, 
                                             width=logo_w, height=logo_h, mask='auto')
                        canvas_obj.restoreState()
                    except Exception as e:
                        print(f"Error dibujando marca de agua (personal): {e}")

            def dibujar_placeholder(canvas_obj):
                canvas_obj.setFillColorRGB(0.85, 0.85, 0.85)
                canvas_obj.setStrokeColorRGB(0.6, 0.6, 0.6)
                canvas_obj.rect(4*mm, 12*mm, 22*mm, 26*mm, fill=1, stroke=1)
                canvas_obj.setFillColorRGB(0.5, 0.5, 0.5)
                canvas_obj.setFont("Helvetica", 8)
                canvas_obj.drawCentredString(15*mm, 25*mm, "FOTO")
            
            def dibujar_cara_credencial(canvas_obj, x_offset, y_offset, es_reverso=False):
                width, height = GAFETE_W, GAFETE_H 
                canvas_obj.saveState()
                canvas_obj.translate(x_offset, y_offset) 

                # Fondo
                canvas_obj.setFillColorRGB(0.97, 0.97, 0.97)
                canvas_obj.rect(0, 0, width, height, fill=1, stroke=0)
                dibujar_marca_agua(canvas_obj, width, height)

                # Franja superior verde
                canvas_obj.setFillColorRGB(0.2, 0.6, 0.2)
                canvas_obj.rect(0, height - 14*mm, width, 14*mm, fill=1, stroke=0)

                # Logo y textos institucionales
                if os.path.exists(LOGO_PATH):
                     canvas_obj.drawImage(LOGO_PATH, 2*mm, height - 12*mm, width=10*mm, height=10*mm, mask='auto')
                canvas_obj.setFillColorRGB(1, 1, 1)
                canvas_obj.setFont("Helvetica-Bold", 11)
                canvas_obj.drawString(14*mm, height - 6*mm, "UPASER")
                canvas_obj.setFont("Helvetica", 6)
                canvas_obj.drawString(14*mm, height - 10*mm, "Unidad Profesional de Asesor√≠a y Regularizaci√≥n")

                if not es_reverso: 
                    # --- ANVERSO (DATOS DE PERSONAL) ---
                    foto_ruta = datos['foto_ruta']
                    if foto_ruta and os.path.exists(foto_ruta):
                        try:
                            canvas_obj.drawImage(foto_ruta, 4*mm, 12*mm, width=22*mm, height=26*mm, preserveAspectRatio=True, anchor='c')
                            canvas_obj.setStrokeColorRGB(0, 0, 0)
                            canvas_obj.rect(4*mm, 12*mm, 22*mm, 26*mm, fill=0, stroke=1)
                        except Exception: dibujar_placeholder(canvas_obj)
                    else: dibujar_placeholder(canvas_obj)
                    
                    # --- DATOS ADAPTADOS A PERSONAL ---
                    canvas_obj.setFillColorRGB(0.2, 0.2, 0.2)
                    canvas_obj.setFont("Helvetica-Bold", 7)
                    canvas_obj.drawString(30*mm, 34*mm, "NOMBRE:")
                    canvas_obj.setFont("Helvetica", 9)
                    nombre_completo = f"{datos['nombre']} {datos['apellido_paterno']} {datos['apellido_materno']}".upper()
                    if len(nombre_completo) > 25: canvas_obj.setFont("Helvetica", 8)
                    canvas_obj.drawString(30*mm, 30*mm, nombre_completo)

                    canvas_obj.setFont("Helvetica-Bold", 7)
                    canvas_obj.drawString(30*mm, 24*mm, "NO. DE EMPLEADO:")
                    canvas_obj.setFont("Helvetica", 10)
                    canvas_obj.setFillColorRGB(0.7, 0, 0)
                    canvas_obj.drawString(30*mm, 19.5*mm, f"{datos['num_empleado']}")

                    canvas_obj.setFillColorRGB(0.2, 0.2, 0.2)
                    canvas_obj.setFont("Helvetica-Bold", 7)
                    canvas_obj.drawString(30*mm, 14*mm, "PUESTO:")
                    canvas_obj.setFont("Helvetica", 8)
                    canvas_obj.drawString(30*mm, 10*mm, datos['puesto'])
                    
                    # --- Pie de p√°gina (Vigencia) ---
                    # (Este bloque debe estar al mismo nivel que "C√ìDIGO DE BARRAS")
                    canvas_obj.setStrokeColorRGB(0.2, 0.6, 0.2)
                    canvas_obj.line(4*mm, 8*mm, width-4*mm, 8*mm)
                    canvas_obj.setFont("Helvetica", 6)
                    canvas_obj.setFillColorRGB(0.4, 0.4, 0.4)
                    anio_actual = datetime.date.today().year
                    canvas_obj.drawCentredString(width/2, 5*mm, f"VIGENCIA: {anio_actual} - {anio_actual+1}")
                    
                else: 
                    # --- REVERSO (ID√âNTICO AL DE ALUMNO) ---
                    # (Todo este bloque 'else' debe estar alineado con el 'if not es_reverso:')
                    director_nombre_completo = "JOVANY IVAN CERVANTES CARRERAS"
                    
                    canvas_obj.setFillColorRGB(0.2, 0.2, 0.2)
                    canvas_obj.setFont("Helvetica-Bold", 10)
           
                    firma_y = height / 2.0
                    canvas_obj.setStrokeColorRGB(0.5, 0.5, 0.5)
                    canvas_obj.line(width/4, firma_y, width*3/4, firma_y)

                    canvas_obj.setFont("Helvetica", 7)
                    canvas_obj.setFillColorRGB(0.2, 0.2, 0.2)
                    canvas_obj.drawCentredString(width/2, firma_y - 4*mm, director_nombre_completo.upper())
                    canvas_obj.setFont("Helvetica-Bold", 6)
                    canvas_obj.drawCentredString(width/2, firma_y - 7*mm, "DIRECTOR DEL PLANTEL")

                    canvas_obj.setStrokeColorRGB(0.2, 0.6, 0.2)
                    canvas_obj.line(4*mm, 8*mm, width-4*mm, 8*mm)
                    canvas_obj.setFont("Helvetica", 6)
                    canvas_obj.setFillColorRGB(0.4, 0.4, 0.4)
                    canvas_obj.drawCentredString(width/2, 5*mm, "Esta credencial es personal e intransferible y debe ser portada obligatoriamente.")

                canvas_obj.restoreState()
            
            # --- 4. GENERAR EL PDF ---
            temp_pdf = tempfile.NamedTemporaryFile(suffix=".pdf", delete=False)
            filename = temp_pdf.name
            temp_pdf.close()
            
            c = canvas.Canvas(filename, pagesize=letter)
            
            dibujar_cara_credencial(c, MARGIN_X, MARGIN_Y, es_reverso=False)
            dibujar_cara_credencial(c, MARGIN_X + GAFETE_W + 10*mm, MARGIN_Y, es_reverso=True)
            
            c.save()

            # --- 5. ABRIR EL PDF ---
            self._temp_pdf_files.append(filename)
            QDesktopServices.openUrl(QUrl.fromLocalFile(filename))

        except Exception as e:
            mostrar_error(f"Error al generar credencial de personal: {e}\n{traceback.format_exc()}")
    
    # --- FIN DE M√âTODOS DE GESTI√ìN DE PERSONAL ---

def get_accent_stylesheet(accent_name):
    """Retorna el QSS para un color de acento espec√≠fico."""
    if accent_name == "Azul":
        return f"""
            /* Se establece el color de acento para hover/select */
            :root {{
                --accent-color: #0d6efd;
            }}
            #navBar {{ 
                /* Se usa un fondo neutro para el men√∫ */
                background-color: transparent;
            }}
            #navButton {{
                color: #555555; /* Texto gris neutro en claro */
                margin: 5px 10px;
                border-radius: 8px; /* Mac: Esquinas suaves */
                background-color: transparent;
                padding-left: 20px; /* Alineaci√≥n del texto */
                
            }}
            #navButton:hover {{ 
                background-color: rgba(13, 110, 253, 0.1); 
                color: #0d6efd; 
            }}
            #navButton[selected="true"] {{ 
                background-color: rgba(13, 110, 253, 0.2); 
                color: #0d6efd;
                font-weight: 600; /* Mac: Font semi-bold */
                border-left: none; /* Mac: Eliminar borde lateral, usar solo el fondo */
            }}
            QGroupBox::title {{ color: #0a58ca; }}
            QHeaderView::section {{ background-color: #0d6efd; border: 1px solid #0a58ca; }}
            #topBar {{ background-color: #0a58ca; }}
            
            /* Ajustes en Modo Oscuro */
            QWidget[style="dark"] #navButton {{ color: #E0E0E0; }}
            QWidget[style="dark"] #navButton:hover {{ 
                background-color: rgba(13, 110, 253, 0.2); 
                color: #0d6efd; 
            }}
            QWidget[style="dark"] #navButton[selected="true"] {{ 
                background-color: rgba(13, 110, 253, 0.3); 
                color: #0d6efd;
                border-left: none;
            }}
        """
    elif accent_name == "Verde":
        return f"""
            :root {{
                --accent-color: #198754;
            }}
            #navBar {{ 
                background-color: transparent;
            }}
            #navButton {{
                color: #555555; 
                margin: 5px 10px;
                border-radius: 8px;
                background-color: transparent;
                padding-left: 20px;
            }}
            #navButton:hover {{ 
                background-color: rgba(25, 135, 84, 0.1); 
                color: #198754; 
            }}
            #navButton[selected="true"] {{ 
                background-color: rgba(25, 135, 84, 0.2); 
                color: #198754;
                font-weight: 600;
                border-left: none;
            }}
            QGroupBox::title {{ color: #146c43; }}
            QHeaderView::section {{ background-color: #198754; border: 1px solid #146c43; }}
            #topBar {{ background-color: #146c43; }}
            
            /* Ajustes en Modo Oscuro */
            QWidget[style="dark"] #navButton {{ color: #E0E0E0; }}
            QWidget[style="dark"] #navButton:hover {{ 
                background-color: rgba(25, 135, 84, 0.2); 
                color: #198754; 
            }}
            QWidget[style="dark"] #navButton[selected="true"] {{ 
                background-color: rgba(25, 135, 84, 0.3); 
                color: #198754;
                border-left: none;
            }}
        """
    # Default (Naranja)
    return f"""
        :root {{
            --accent-color: #FFA726;
        }}
        #navBar {{ 
            background-color: transparent;
        }}
        #navButton {{
            color: #555555; 
            margin: 5px 10px;
            border-radius: 8px;
            background-color: transparent;
            padding-left: 20px;
        }}
        #navButton:hover {{ 
            background-color: rgba(255, 167, 38, 0.1); 
            color: #E65100;
        }}
        #navButton[selected="true"] {{ 
            background-color: rgba(255, 167, 38, 0.2); 
            color: #E65100;
            font-weight: 600;
            border-left: none;
        }}
        QGroupBox::title {{ color: #E65100; }}
        QHeaderView::section {{ background-color: #FFA726; border: 1px solid #E65100; }}
        #topBar {{ background-color: #E65100; }} /* Se usa un color m√°s profundo */

        /* Ajustes en Modo Oscuro */
        QWidget[style="dark"] #navButton {{ color: #E0E0E0; }}
        QWidget[style="dark"] #navButton:hover {{ 
            background-color: rgba(255, 167, 38, 0.2); 
            color: #FFA726; 
        }}
        QWidget[style="dark"] #navButton[selected="true"] {{ 
            background-color: rgba(255, 167, 38, 0.3); 
            color: #FFA726;
            border-left: none;
        }}
    """

style_sheet_light = """
    /* --- Tema Claro (Base) --- */
    QWidget {
        background-color: #FFFFFF;
        color: #333333;
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Roboto", "Segoe UI", sans-serif;
        font-size: 10pt;
    }
    
    /* CORRECCI√ìN CR√çTICA: Fuerza el color del texto a blanco para asegurar legibilidad sobre el fondo de acento saturado */
    #topBar QLabel, #topBarUser, #topBarLabel, #topBarIcon { 
        color: #333333; 
        font-size: 9pt; 
    }
    #topBarUser { font-weight: bold; font-size: 10pt; }
    #topBarButton { background-color: transparent;
        color: #555555; border: none; font-size: 16pt; padding: 5px; }
    #topBarButton:hover { background-color: rgba(0, 0, 0, 0.1); }
    
    #navBar { background-color: #F8F8F8; } /* Fondo m√°s claro para el men√∫ */
    
    /* Reglas base del bot√≥n de navegaci√≥n (para ambos modos, los colores se aplican con el accent) */
    #navButton { 
        border: none; 
        padding: 15px 10px; 
        font-size: 11pt; 
        text-align: left; 
        padding-left: 20px;
        font-weight: normal; 
    }
    
    #mainContentArea, #contentPage { background-color: #FFFFFF; }
    QScrollArea { border: none; background-color: #FFFFFF; }
    #welcomeTitle { font-size: 24pt; font-weight: bold; color: #333333; }
    #shortcutsTitle { font-size: 16pt;
        font-weight: bold; color: #555555; padding-bottom: 5px; }
    #shortcutButton { 
        border: 1px solid #E0E0E0;
        background-color: #FFFFFF; 
        border-radius: 12px;
        padding: 15px;
        /* Sombra Sutil y Profesional */
        box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.05), 0px 1px 2px rgba(0, 0, 0, 0.1);
    }
    #shortcutIcon { 
        background-color: #F0F0F0; /* Fondo m√°s limpio para el √≠cono */
        border: none; 
        border-radius: 8px; /* Menos redondeado */
        font-size: 36pt; /* √çcono un poco m√°s peque√±o, m√°s elegante */
        padding: 10px;
    }
    #shortcutIcon:hover { background-color: #E0E0E0; }
    #shortcutLabel { font-size: 11pt; font-weight: bold; color: #333333; }
    QGroupBox { background-color: #F9F9F9; border: 1px solid #E0E0E0; border-radius: 6px; margin-top: 10px; padding: 10px; }
    QGroupBox::title { subcontrol-origin: margin; subcontrol-position: top left; padding: 0 10px 0 10px; font-size: 12pt; font-weight: bold; }
    QLabel { color: #333333; }
    QLineEdit, QComboBox, QDoubleSpinBox { background-color: #FFFFFF; color: #333333;
        border: 1px solid #C0C0C0; border-radius: 4px; padding: 5px; min-height: 20px; }
    QComboBox QAbstractItemView { background-color: #FFFFFF; color: #333333; }
    QCheckBox { color: #333333; font-size: 9pt; }
    QCheckBox::indicator { width: 16px; height: 16px; }
    QCheckBox::indicator:unchecked { border: 1px solid #C0C0C0; background-color: #FFFFFF; border-radius: 3px; }
    QCheckBox::indicator:checked { 
            background-color: #007ACC;
            border: 1px solid #007ACC;
            image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="none" stroke="%23FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 8l3 3l7-7"/></svg>');
        }
    #expedienteDisplay { background-color: #FDFDFD; border: 1px solid #E0E0E0; font-family: Consolas, monospace; font-size: 9pt; }
    #deleteButton { background-color: #D32F2F; color: #FFFFFF; border: none; border-radius: 4px; padding: 10px 20px; font-weight: bold;
        font-size: 10pt; margin-top: 10px; }
    #deleteButton:hover { background-color: #E53935; }
    #deleteButton:pressed { background-color: #B71C1C; }
    #secondaryButton { background-color: #607D8B; color: #FFFFFF; border: none; border-radius: 4px; padding: 10px 20px; font-weight: bold;
        font-size: 10pt; }
    #secondaryButton:hover { background-color: #546E7A; }
    QPushButton#primaryButton { background-color: #007ACC; color: #FFFFFF; border: none; border-radius: 4px; padding: 10px 20px; font-weight: bold; font-size: 11pt; min-height: 25px; }
    QPushButton#primaryButton:hover { background-color: #0099E6; }
    QPushButton#primaryButton:pressed { background-color: #005F99; }
    QTableWidget { background-color: #FFFFFF; color: #333333; gridline-color: #E0E0E0; border: 1px solid #C0C0C0; selection-color: #333333; }
    QHeaderView::section { color: #FFFFFF; padding: 6px; font-weight: bold; }
    QMessageBox { background-color: #FFFFFF; }
    #placeholderText { font-style: italic; color: #888888; }
"""

style_sheet_dark = """
    /* --- Tema Oscuro (Base) --- */
    QWidget {
        background-color: #2D2D2D; /* Gris oscuro para mayor contraste */
        color: #E0E0E0;
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Roboto", "Segoe UI", sans-serif;
        font-size: 10pt;
    }

    #topBar QLabel, #topBarUser, #topBarLabel, #topBarIcon { 
        color: #FFFFFF;
        font-size: 9pt; 
    }
    #topBarUser { font-weight: 600; font-size: 11pt; } 
    #topBarButton { background-color: transparent;
        color: #FFFFFF; border: none; font-size: 16pt; padding: 5px; }
    #topBarButton:hover { background-color: #3A3A3A; }
    
    #navBar { background-color: #3A3A3A; } /* Fondo del men√∫ ligeramente m√°s claro para contraste */
    
    /* Reglas base del bot√≥n de navegaci√≥n */
    #navButton { 
        border: none; 
        padding: 15px 10px; 
        font-size: 11pt; 
        text-align: left; 
        padding-left: 20px;
        font-weight: normal;
        border-radius: 8px; /* Esquinas redondeadas */
        margin: 5px 8px; /* Margen para flotar */
    }

    #mainContentArea, #contentPage { background-color: #2D2D2D; }
    QScrollArea { border: none; background-color: #2D2D2D; }
    #welcomeTitle { font-size: 24pt; font-weight: 600; color: #E0E0E0; }
    #shortcutsTitle { font-size: 16pt;
        font-weight: 500; color: #C0C0C0; padding-bottom: 5px; }
    #shortcutButton { 
        border: 1px solid #4D4D4D;
        background-color: #3A3A3A; /* Fondo de botones de acceso */
        border-radius: 12px;
        padding: 15px;
    }
    #shortcutIcon { 
        background-color: #4A4A4A; /* Fondo m√°s limpio para el √≠cono */
        border: none;
        border-radius: 8px;
        font-size: 36pt; 
        padding: 10px;
    }
    #shortcutIcon:hover { background-color: #5A5A5A; }
    QGroupBox { background-color: #3A3A3A; border: 1px solid #4D4D4D; border-radius: 8px; margin-top: 10px; padding: 10px; }
    QGroupBox::title { subcontrol-origin: margin; subcontrol-position: top left; padding: 0 10px 0 10px; font-size: 12pt; font-weight: 600; }
    QLabel { color: #E0E0E0; }
    QLineEdit, QComboBox, QDoubleSpinBox { background-color: #4A4A4A; color: #E0E0E0;
        border: 1px solid #4D4D4D; border-radius: 6px; padding: 5px; min-height: 20px; }
    QLineEdit:focus, QComboBox:focus, QDoubleSpinBox:focus { border: 1px solid #707070; }
    QComboBox QAbstractItemView { background-color: #4A4A4A; color: #E0E0E0; selection-background-color: #5A5A5A; }
    QCheckBox { color: #E0E0E0; font-size: 9pt; }
    QCheckBox::indicator { width: 16px; height: 16px; }
    QCheckBox::indicator:unchecked { border: 1px solid #4D4D4D; background-color: #3A3A3A; border-radius: 3px; }
    QCheckBox::indicator:checked { 
            background-color: #007ACC;
            border: 1px solid #007ACC;
            image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="none" stroke="%23FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 8l3 3l7-7"/></svg>');
        }
    #expedienteDisplay { background-color: #3A3A3A; border: 1px solid #4D4D4D; font-family: Consolas, monospace; font-size: 9pt; }
    #deleteButton { background-color: #D32F2F; color: #FFFFFF; border: none; border-radius: 6px; padding: 10px 20px; font-weight: 600; font-size: 10pt; margin-top: 10px; }
    #deleteButton:hover { background-color: #E53935; }
    #deleteButton:pressed { background-color: #B71C1C; }
    #secondaryButton { background-color: #607D8B; color: #FFFFFF; border: none; border-radius: 6px; padding: 10px 20px; font-weight: 600; font-size: 10pt; }
    QPushButton#primaryButton { background-color: #007ACC; color: #FFFFFF; border: none; border-radius: 6px; padding: 10px 20px; font-weight: 600; font-size: 11pt; min-height: 25px; }
    QPushButton#primaryButton:hover { background-color: #0099E6; }
    QPushButton#primaryButton:pressed { background-color: #005F99; }
    QTableWidget { background-color: #3A3A3A; color: #E0E0E0; gridline-color: #4D4D4D; border: 1px solid #4D4D4D; selection-background-color: #5A5A5A; selection-color: #E0E0E0; }
    QHeaderView::section { color: #FFFFFF; padding: 6px; font-weight: 600; border: 1px solid #4D4D4D; }
    QMessageBox { background-color: #3A3A3A; color: #E0E0E0; }
    #placeholderText { font-style: italic; color: #888888; }
"""

def get_full_stylesheet(theme, accent):
    """Combina el tema base (claro/oscuro) con el color de acento."""
    base_style = style_sheet_light if theme == "Claro" else style_sheet_dark
    accent_style = get_accent_stylesheet(accent)
    return base_style + accent_style


# ---- Punto de Entrada de la Aplicaci√≥n (CON BUCLE DE SESI√ìN) ----
if __name__ == '__main__':

    try:
        # 1. Asegurar que la DB est√© inicializada
        inicializar_db()
        
        app = QApplication(sys.argv)
        
        login_exitoso = True
        window = None # Definir window fuera del bucle

        while login_exitoso:
            # 1. Iniciar la pantalla de Login
            app.setStyleSheet("")
            login_window = LoginScreen()
            login_window.show()
            app.exec() 

            # Si el usuario cerr√≥ el login sin autenticarse, salimos del bucle
            if not login_window.accept_login:
                login_exitoso = False
                continue 

            # 2. Si el login fue exitoso, obtener usuario y mostrar ventana principal
            username = login_window.username
            full_username = login_window.full_username
            user_role = login_window.user_role # Obtener el ROL
            permisos_dict = login_window.permisos_dict
            
            window = VentanaPrincipal(username, full_username, user_role, permisos_dict)
            window.showMaximized() 

            app.exec() 

            # 3. Cuando la app principal se cierra, revisamos si fue por "Cerrar Sesi√≥n"
            if not window.logout_solicitado:
                login_exitoso = False 

        # --- Limpiar archivos temporales al salir del bucle principal ---
        if window and hasattr(window, '_temp_pdf_files'): 
            window.limpiar_archivos_temporales()

        sys.exit(0) 

    except Exception as e:
        # Captura de error final por si algo falla en la inicializaci√≥n
        print(f"--- ERROR FATAL: {e} ---")
        error_info = traceback.format_exc()

        with open("error_log.txt", "w", encoding="utf-8") as f:
            f.write("Ha ocurrido un error fatal al iniciar la aplicaci√≥n:\n\n")
            f.write(error_info)

        # Mostrar el error en una ventana emergente simple si es posible
        try:
            error_dialog = QMessageBox()
            error_dialog.setIcon(QMessageBox.Icon.Critical)
            error_dialog.setWindowTitle("Error Fatal")
            error_dialog.setText(f"Error fatal al iniciar:\n{e}\n\nConsulte 'error_log.txt' para detalles.")
            error_dialog.exec()
        except:
            pass

        sys.exit(1)
