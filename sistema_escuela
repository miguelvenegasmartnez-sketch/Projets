import sys
import sqlite3
import datetime
import traceback
import os 
import tempfile 
from decimal import Decimal, ROUND_HALF_UP 
import secrets 
import json 

# --- Importar bibliotecas de PyQt6 (Fusionadas) ---
try:
    from PyQt6.QtWidgets import (
        QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
        QGridLayout, QLabel, QLineEdit, QPushButton, QComboBox, QTabWidget,
        QTableWidget, QTableWidgetItem, QMessageBox, QGroupBox, QFormLayout,
        QDoubleSpinBox, QHeaderView, QFileDialog, QGraphicsDropShadowEffect,
        QStackedWidget, QFrame, QScrollArea, QCheckBox, QTextEdit, QInputDialog,
        QMenu, QSizePolicy, QSpacerItem, QListWidget, QListWidgetItem # Necesario para el nuevo men√∫
    )
    # --- A√ëADIDO QLocale ---
    from PyQt6.QtCore import Qt, QDate, QTimer, QDateTime, QSize, QUrl, QLocale, QPoint # Necesario para QPoint
    from PyQt6.QtGui import QFont, QIcon, QPixmap, QColor, QDesktopServices
except ImportError as e:
    print(f"Error: Faltan bibliotecas de PyQt6. Ejecuta: pip install PyQt6\nDetalle: {e}")
    sys.exit(1)

# --- Importar ReportLab para PDF ---
try:
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import letter
    from reportlab.lib.units import inch
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.platypus import Paragraph, Image, Spacer, Table, TableStyle, Frame 
    from reportlab.lib.enums import TA_CENTER, TA_LEFT 
    from reportlab.lib import colors
    FONT_NAME = 'Helvetica'
    FONT_BOLD_NAME = 'Helvetica-Bold'

except ImportError as e:
    print(f"Error: Falta la biblioteca ReportLab. Ejecuta: pip install reportlab\nDetalle: {e}")
    sys.exit(1)


# ---- Configuraci√≥n de la Base de Datos y Archivos ----
DB_NAME = "gestion_escolar.db"
LOGO_PATH = "logo.png" 
CONFIG_FILE = "config.json" 

# --- FUNCI√ìN DE CONEXI√ìN GLOBAL ---
def get_db_connection():
    """Establece conexi√≥n a la BD y activa las claves for√°neas."""
    conn = sqlite3.connect(DB_NAME)
    # --- ASEGURARSE QUE SIEMPRE EST√â ACTIVO ---
    conn.execute("PRAGMA foreign_keys = ON")
    conn.row_factory = sqlite3.Row 
    return conn

def inicializar_db():
    """Crea las tablas de la base de datos si no existen."""
    conn = None
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute("PRAGMA foreign_keys = ON")

        # --- Tabla de Alumnos ---
        cursor.execute("PRAGMA table_info(alumnos)")
        columns = [info[1] for info in cursor.fetchall()]

        if 'apellido_paterno' not in columns:
             cursor.execute("DROP TABLE IF EXISTS alumnos")
             cursor.execute("""
             CREATE TABLE alumnos (
                 id INTEGER PRIMARY KEY AUTOINCREMENT,
                 apellido_paterno TEXT NOT NULL,
                 apellido_materno TEXT,
                 nombres TEXT NOT NULL,
                 escuela_procedencia TEXT,
                 escuela_ingresar TEXT,
                 edad INTEGER,
                 telefono TEXT,
                 email TEXT UNIQUE,
                 turno TEXT,
                 tutor_ap_paterno TEXT,
                 tutor_ap_materno TEXT,
                 tutor_nombres TEXT,
                 dom_calle TEXT,
                 dom_num_int TEXT,
                 dom_num_ext TEXT,
                 dom_colonia TEXT,
                 dom_municipio TEXT,
                 dom_estado TEXT,
                 dom_cp TEXT,
                 tutor_telefono TEXT,
                 emerg_1_nombre TEXT,
                 emerg_1_telefono TEXT,
                 emerg_1_parentesco TEXT,
                 emerg_2_nombre TEXT,
                 emerg_2_telefono TEXT,
                 emerg_2_parentesco TEXT,
                 autoriza_salida_solo INTEGER DEFAULT 0
             )
             """)
        elif 'autoriza_salida_solo' not in columns:
             cursor.execute("ALTER TABLE alumnos ADD COLUMN autoriza_salida_solo INTEGER DEFAULT 0")

        # --- Tabla de Cursos ---
        cursor.execute("PRAGMA table_info(cursos)")
        columns_cursos = [info[1] for info in cursor.fetchall()]
        
        if 'profesor' in columns_cursos or 'costo' in columns_cursos or 'costo_sem_16' in columns_cursos or 'costo_sem_12' not in columns_cursos:
            print("Detectando estructura de tabla 'cursos' antigua o faltante. Recreando tabla...")
            cursor.execute("DROP TABLE IF EXISTS cursos")
            cursor.execute("""
            CREATE TABLE IF NOT EXISTS cursos (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                nombre_curso TEXT NOT NULL UNIQUE,
                costo_exhibicion REAL DEFAULT 0.0,
                costo_sem_15 REAL DEFAULT 0.0,
                costo_sem_12 REAL DEFAULT 0.0,
                costo_mensual_3 REAL DEFAULT 0.0
            )
            """)

        # --- Tabla de Inscripciones ---
        cursor.execute("PRAGMA table_info(inscripciones)")
        columns_insc = [info[1] for info in cursor.fetchall()]
        
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS inscripciones (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            alumno_id INTEGER NOT NULL,
            curso_id INTEGER NOT NULL,
            fecha_inscripcion TEXT NOT NULL,
            monto_total REAL NOT NULL,
            monto_pagado REAL DEFAULT 0.0,
            estado TEXT DEFAULT 'Pendiente',
            tipo_pago_seleccionado TEXT,
            FOREIGN KEY (alumno_id) REFERENCES alumnos(id) ON DELETE CASCADE,
            FOREIGN KEY (curso_id) REFERENCES cursos(id) ON DELETE RESTRICT
        )
        """)
        
        if 'tipo_pago_seleccionado' not in columns_insc:
            try:
                cursor.execute("ALTER TABLE inscripciones ADD COLUMN tipo_pago_seleccionado TEXT")
            except sqlite3.OperationalError:
                pass 

        # --- Tabla de Pagos ---
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS pagos (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            inscripcion_id INTEGER NOT NULL,
            monto REAL NOT NULL,
            fecha_pago TEXT NOT NULL,
            metodo_pago TEXT,
            FOREIGN KEY (inscripcion_id) REFERENCES inscripciones(id) ON DELETE CASCADE
        )
        """)
        
        # --- NUEVA TABLA: Usuarios ---
        #cursor.execute("DROP TABLE IF EXISTS usuarios") #
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS usuarios (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            nombre_completo TEXT NOT NULL,
            telefono TEXT,
            email TEXT NOT NULL UNIQUE,
            permisos TEXT NOT NULL,  -- Reemplaza a 'rol'
            password TEXT NOT NULL
        )
        """)
        
        # --- Insertar usuario admin por defecto con todos los permisos ---
        try:
            # Definir todos los permisos para el admin
            admin_permissions = {
                "is_admin": True,
                "can_register_students": True,
                "can_register_payments": True,
                "can_view_all_students": True,
                "can_manage_courses": True,
                "can_manage_users": True,
                "can_manage_subjects": True,
                "can_assign_grades": True,
                "can_access_settings": True
            }
            # Convertir el diccionario a un string JSON para guardarlo
            admin_permisos_json = json.dumps(admin_permissions)
            
            cursor.execute("""
            INSERT INTO usuarios (id, nombre_completo, email, permisos, password)
            VALUES (1, 'Administrador', 'admin@sistema.com', ?, 'admin123')
            """, (admin_permisos_json,))
        except sqlite3.IntegrityError:
            pass

        # --- NUEVA TABLA: Materias (Asignaturas por Curso) ---
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS materias (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            curso_id INTEGER NOT NULL,
            nombre_materia TEXT NOT NULL,
            FOREIGN KEY (curso_id) REFERENCES cursos(id) ON DELETE CASCADE
        )
        """)

        # --- NUEVA TABLA: Calificaciones (Notas por Alumno/Materia) ---
        cursor.execute("DROP TABLE IF EXISTS calificaciones")
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS calificaciones (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            inscripcion_id INTEGER NOT NULL,
            materia_id INTEGER NOT NULL,
            
            parcial_1 REAL DEFAULT 0.0,
            obs_1 TEXT DEFAULT '',
            
            parcial_2 REAL DEFAULT 0.0,
            obs_2 TEXT DEFAULT '',

            FOREIGN KEY (inscripcion_id) REFERENCES inscripciones(id) ON DELETE CASCADE,
            FOREIGN KEY (materia_id) REFERENCES materias(id) ON DELETE CASCADE
        )
        """)
        
        conn.commit()
    except sqlite3.Error as e:
        print(f"CRITICAL: Error al inicializar la base de datos: {e}")
    finally:
        if conn:
            conn.close() 

# Funciones globales de mensajes (deben estar definidas antes de usarse)
def mostrar_error(mensaje):
    """Muestra un di√°logo de error cr√≠tico."""
    msg_box = QMessageBox()
    msg_box.setIcon(QMessageBox.Icon.Critical)
    msg_box.setWindowTitle("Error")
    msg_box.setText(str(mensaje))
    msg_box.exec()

def mostrar_info(mensaje):
    """Muestra un di√°logo de informaci√≥n."""
    msg_box = QMessageBox()
    msg_box.setIcon(QMessageBox.Icon.Information)
    msg_box.setWindowTitle("Informaci√≥n")
    msg_box.setText(str(mensaje))
    msg_box.exec()

# ---- Ventana de Login ----
class LoginScreen(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Sistema de Gesti√≥n Escolar - Login")
        self.resize(800, 500)
        self.username = "" 
        self.full_username = "" 
        self.user_role = "" 
        self.accept_login = False 

        self.setup_ui()
        self.apply_styles()
        self.start_time_update()

    def setup_ui(self):
        main_layout = QHBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0) 
        main_layout.setSpacing(0)

        # Panel Izquierdo: Login Form
        login_panel = QWidget()
        login_panel.setObjectName("loginPanel")
        login_layout = QVBoxLayout(login_panel)
        login_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
        login_layout.setSpacing(20)
        login_layout.setContentsMargins(50, 50, 50, 50)

        # Logo Placeholder
        self.logo_label = QLabel()
        try:
            pixmap = QPixmap(LOGO_PATH) 
            if pixmap.isNull():
                raise FileNotFoundError 

            self.logo_label.setPixmap(pixmap.scaledToHeight(150, Qt.TransformationMode.SmoothTransformation))
            self.logo_label.setAlignment(Qt.AlignmentFlag.AlignCenter)

        except FileNotFoundError:
            self.logo_label.setText("LOGO ESCUELA")
            self.logo_label.setFont(QFont("Arial", 24, QFont.Weight.Bold))
            self.logo_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            self.logo_label.setStyleSheet("color: #FFFFFF;")

        login_layout.addWidget(self.logo_label)

        # Campos de Usuario
        user_label = QLabel("Correo Electr√≥nico:") 
        user_label.setObjectName("inputLabel")
        self.username_input = QLineEdit()
        self.username_input.setPlaceholderText("admin@sistema.com") 
        self.username_input.setObjectName("textInput")
        login_layout.addWidget(user_label)
        login_layout.addWidget(self.username_input)

        # Campos de Contrase√±a
        password_label = QLabel("Contrase√±a:")
        password_label.setObjectName("inputLabel")
        self.password_input = QLineEdit()
        self.password_input.setPlaceholderText("Contrase√±a")
        self.password_input.setEchoMode(QLineEdit.EchoMode.Password)
        self.password_input.setObjectName("textInput")
        login_layout.addWidget(password_label)
        login_layout.addWidget(self.password_input)

        # Botones
        self.login_button = QPushButton("INICIAR SESI√ìN")
        self.login_button.setObjectName("primaryButton")
        self.login_button.clicked.connect(self.handle_login)
        login_layout.addWidget(self.login_button)

        self.forgot_password_button = QPushButton("RECUPERAR CONTRASE√ëA")
        self.forgot_password_button.setObjectName("secondaryButton")
        self.forgot_password_button.clicked.connect(self.show_forgot_password_message) 
        login_layout.addWidget(self.forgot_password_button)

        login_layout.addStretch() 

        main_layout.addWidget(login_panel, 2) 

        # Panel Derecho: Mensaje de Bienvenida y Fondo
        self.welcome_panel = QWidget()
        self.welcome_panel.setObjectName("welcomePanel")
        welcome_layout = QVBoxLayout(self.welcome_panel)
        welcome_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        self.time_of_day_label = QLabel()
        self.time_of_day_label.setFont(QFont("Arial", 28, QFont.Weight.Bold))
        self.time_of_day_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.time_of_day_label.setStyleSheet("color: white; background-color: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px;")

        # Efecto de sombra para el label de bienvenida
        shadow = QGraphicsDropShadowEffect()
        shadow.setBlurRadius(20)
        shadow.setColor(QColor(0, 0, 0, 150))
        shadow.setXOffset(0)
        shadow.setYOffset(0)
        self.time_of_day_label.setGraphicsEffect(shadow)

        welcome_layout.addWidget(self.time_of_day_label)
        welcome_layout.addStretch() 

        # Texto inferior
        bottom_text_label = QLabel("Unidad Profesional de Asesor√≠a y Regularizaci√≥n")
        bottom_text_label.setObjectName("bottomText")
        bottom_text_label.setAlignment(Qt.AlignmentFlag.AlignBottom | Qt.AlignmentFlag.AlignCenter)
        bottom_text_label.setStyleSheet("color: white; background-color: rgba(0,0,0,0.5); padding: 5px;")
        welcome_layout.addWidget(bottom_text_label)

        main_layout.addWidget(self.welcome_panel, 3) 

    def apply_styles(self):
        # Estilos inspirados en tu imagen de ejemplo
        self.setStyleSheet("""
            QWidget {
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 10pt;
            }
            #loginPanel {
                background-color: #3C3C3C; 
                color: #E0E0E0;
            }
            #welcomePanel {
                background-image: url(background.jpg);
                background-repeat: no-repeat;
                background-position: center;
                background-size: cover; 
                background-color: #F0F0F0;
            }
            #inputLabel {
                color: #E0E0E0;
                font-weight: bold;
                margin-top: 10px;
            }
            #textInput {
                background-color: #4A4A4A;
                color: #E0E0E0;
                border: 1px solid #5C5C5C;
                border-radius: 4px;
                padding: 8px;
            }
            #textInput:focus {
                border: 1px solid #007ACC;
            }
            #primaryButton {
                background-color: #4CAF50; 
                color: #FFFFFF;
                border: none;
                border-radius: 6px;
                padding: 10px 20px;
                font-weight: bold;
                font-size: 11pt;
                margin-top: 20px;
            }
            #primaryButton:hover {
                background-color: #45A049;
            }
            #primaryButton:pressed {
                background-color: #397D3D;
            }
            #secondaryButton {
                background-color: #607D8B; 
                color: #FFFFFF;
                border: none;
                border-radius: 6px;
                padding: 10px 20px;
                font-weight: bold;
                font-size: 11pt;
            }
            #secondaryButton:hover {
                background-color: #546E7A;
            }
            #secondaryButton:pressed {
                background-color: #455A64;
            }
            #bottomText {
                font-size: 9pt;
            }
        """)

    def start_time_update(self):
        self.update_time_of_day_message()
        self.timer = QTimer(self)
        self.timer.timeout.connect(self.update_time_of_day_message)
        self.timer.start(60000) 

    def update_time_of_day_message(self):
        current_hour = QDateTime.currentDateTime().time().hour()
        if 5 <= current_hour < 12:
            message = "¬°Buenos d√≠as!\nBienvenido(a)"
        elif 12 <= current_hour < 19:
            message = "¬°Buenas tardes!\nBienvenido(a)"
        else:
            message = "¬°Buenas noches!\nBienvenido(a)"
        self.time_of_day_label.setText(message)

    def handle_login(self):
        """Maneja el inicio de sesi√≥n consultando la base de datos."""
        email = self.username_input.text().strip()
        password = self.password_input.text()

        if not email or not password:
            QMessageBox.warning(self, "Error de Login", "Email y contrase√±a no pueden estar vac√≠os.")
            return

        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                # --- INICIO DE MODIFICACI√ìN: Seleccionar 'permisos' en lugar de 'rol' ---
                cursor.execute("SELECT * FROM usuarios WHERE email = ? AND password = ?", (email, password))
                usuario = cursor.fetchone()
                
            if usuario:
                self.accept_login = True
                self.username = usuario['email'] 
                self.full_username = usuario['nombre_completo']
                
                # Cargar el string JSON de la DB y convertirlo a un diccionario Python
                try:
                    self.permisos_dict = json.loads(usuario['permisos'])
                except json.JSONDecodeError:
                    # Fallback por si el JSON est√° corrupto
                    self.permisos_dict = {"is_admin": False} 
                
                # Guardar el rol anterior por compatibilidad (aunque usaremos el dict)
                self.user_role = "Administrador" if self.permisos_dict.get("is_admin") else "Asesor"
                # --- FIN DE MODIFICACI√ìN ---
                
                self.close() 
            else:
                QMessageBox.warning(self, "Error de Login", "Email o contrase√±a incorrectos.")
                self.password_input.clear()
                self.username_input.setFocus() 

        except sqlite3.Error as e:
            mostrar_error(f"Error en la base de datos al iniciar sesi√≥n: {e}")

    def show_forgot_password_message(self):
        """Muestra un di√°logo para resetear la contrase√±a de un usuario."""
        email, ok = QInputDialog.getText(self, "Recuperar Contrase√±a",
                                           "Ingrese su correo electr√≥nico para resetear la contrase√±a:")
        
        if ok and email:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("SELECT id, rol FROM usuarios WHERE email = ?", (email,))
                    usuario = cursor.fetchone()
                    
                if usuario:
                    # Protecci√≥n para el admin ID 1
                    if usuario['id'] == 1:
                        mostrar_error("No se puede resetear la contrase√±a del Administrador principal. Contacte al soporte.")
                        return

                    # Generar nueva contrase√±a
                    nueva_password = secrets.token_hex(4) 
                    
                    with get_db_connection() as conn:
                        cursor = conn.cursor()
                        cursor.execute("UPDATE usuarios SET password = ? WHERE email = ?", (nueva_password, email))
                        conn.commit()
                    
                    mostrar_info(f"La contrase√±a para {email} ha sido reseteada.\n\n"
                                 f"Su nueva contrase√±a es: {nueva_password}\n\n"
                                 "Por favor, √∫sela para iniciar sesi√≥n y c√°mbiela si es necesario.")
                else:
                    mostrar_error("No se encontr√≥ ning√∫n usuario con ese correo electr√≥nico.")
                    
            except sqlite3.Error as e:
                mostrar_error(f"Error en la base de datos al iniciar sesi√≥n: {e}")
            except Exception as e:
                 mostrar_error(f"Error inesperado: {e}")

    def closeEvent(self, event):
        if not self.accept_login:
            sys.exit(0)
        event.permisos_dict = self.permisos_dict 
        event.accept()

# ---- Ventana Principal de la Aplicaci√≥n (REDISE√ëADA AL ESTILO DASHBOARD) ----
class VentanaPrincipal(QMainWindow):
    def __init__(self, username, full_username, user_role, permisos_dict):
        super().__init__()
        self.username = username
        self.full_username = full_username 
        self.user_role = user_role
        self.permisos = permisos_dict
        self.logout_solicitado = False 
        self._temp_pdf_files = [] 
        self.usuario_seleccionado_id = None 
        self.curso_seleccionado_id = None 
        
        # Almacenamiento local de inscripciones para el filtro de pagos
        self._inscripciones_cache = [] 

        self.setWindowTitle("Sistema de Gesti√≥n Escolar - UPASER")
        self.setGeometry(100, 100, 1200, 700)
        self.setMinimumSize(1024, 700) 
        
        # --- IDIOMA A ESPA√ëOL ---
        self.locale = QLocale(QLocale.Language.Spanish, QLocale.Country.Mexico)
        QLocale.setDefault(self.locale)

        # --- Cargar configuraci√≥n de tema ---
        self.theme, self.accent = self.cargar_configuracion_tema()
        self.aplicar_estilo_actual()

        # Configurar UI
        self.init_ui()

        # Cargar datos iniciales
        self.cargar_datos_maestros()

        # REMOVIDO: self.iniciar_timer_reloj()
        
        # Conectar se√±al de cierre para limpiar archivos temporales
        app.aboutToQuit.connect(self.limpiar_archivos_temporales)

    # --- NUEVA FUNCI√ìN DE PDF: draw_text_pdf ---
    def draw_text_pdf(self, c, current_y, texto, x, style):
        """Dibuja un Paragraph de ReportLab y maneja saltos de p√°gina."""
        width, height = letter
        
        p = Paragraph(texto.replace('\n', '<br/>'), style)
        p_width, p_height = p.wrapOn(c, width - (x + inch), height)

        # Si no cabe
        if current_y - p_height < inch:
            self.draw_watermark(c, width, height)
            c.showPage()
            self.draw_watermark(c, width, height)
            current_y = height - inch
            self.draw_logo(c, width, height)

        p.drawOn(c, x, current_y - p_height)
        current_y -= (p_height + 4) 
        return current_y 

    # --- NUEVA FUNCI√ìN DE PDF: draw_logo ---
    def draw_logo(self, canvas_obj, page_width, page_height):
         if os.path.exists(LOGO_PATH):
             try:
                logo_img = Image(LOGO_PATH, width=1*inch, height=1*inch)
                logo_img.drawOn(canvas_obj, 0.5 * inch, page_height - 1.25 * inch)
             except Exception as img_err:
                 print(f"Error al dibujar logo: {img_err}")


    # --- NUEVA FUNCI√ìN DE PDF: draw_watermark ---
    def draw_watermark(self, canvas_obj, page_width, page_height):
         if os.path.exists(LOGO_PATH):
           try:
                 canvas_obj.saveState()
                 canvas_obj.setFillAlpha(0.15)
                 img = Image(LOGO_PATH)
                 img_width, img_height = img.wrap(page_width, page_height)
                
                 aspect = img_height / float(img_width) if img_width else 1
                 
                 display_width = page_width * 0.6
                 display_height = display_width * aspect
                 x_centered = (page_width - display_width) / 2.0
                 y_centered = (page_height - display_height) / 2.0
                 canvas_obj.drawImage(LOGO_PATH, x_centered, y_centered,
                                      width=display_width, height=display_height,
                                      mask='auto')
                 canvas_obj.restoreState()
           except Exception as wm_err:
                 print(f"Error al dibujar marca de agua: {wm_err}")
    
    # --- NUEVA FUNCI√ìN DE PDF: draw_double_signature ---
    def draw_double_signature(self, c, y_position):
        width, height = letter
        c.line(inch, y_position, inch * 4, y_position)
        c.setFont(FONT_NAME, 10)
        c.drawCentredString(inch * 2.5, y_position - 0.2 * inch, "Firma del Padre o Tutor")
        
        c.line(width - inch * 4, y_position, width - inch, y_position)
        c.setFont(FONT_NAME, 10)
        c.drawCentredString(width - inch * 2.5, y_position - 0.2 * inch, "Firma del Alumno")


    def init_ui(self):
        """Inicializa la interfaz de usuario principal con estilo dashboard."""

        # Widget central y layout principal vertical
        widget_central = QWidget()
        self.setCentralWidget(widget_central)
        layout_principal = QVBoxLayout(widget_central)
        layout_principal.setContentsMargins(0, 0, 0, 0)
        layout_principal.setSpacing(0)

        # 1. Barra Superior de Informaci√≥n
        barra_superior = self.crear_barra_superior()
        layout_principal.addWidget(barra_superior)

        # 2. Layout de Contenido Principal (Horizontal)
        layout_contenido = QHBoxLayout()
        layout_contenido.setSpacing(0)

        # 2.1. Panel de Navegaci√≥n (Izquierda)
        panel_navegacion = self.crear_panel_navegacion()
        layout_contenido.addWidget(panel_navegacion)

        # 2.2. Panel de Contenido (Derecha)
        self.stacked_widget = QStackedWidget()
        self.stacked_widget.setObjectName("mainContentArea")

        # Crear las p√°ginas
        self.pagina_inicio = self.crear_pagina_inicio()
        self.pagina_inscripcion = self.crear_pagina_nueva_inscripcion() 
        self.pagina_pagos = self.crear_pagina_pagos()
        self.pagina_lista_alumnos = self.crear_pagina_lista_alumnos() 
        self.pagina_gestion_cursos = self.crear_pagina_gestion_cursos() 
        self.pagina_gestion_usuarios = self.crear_pagina_gestion_usuarios()
        self.pagina_gestion_materias = self.crear_pagina_gestion_materias()
        self.pagina_gestion_calificaciones = self.crear_pagina_gestion_calificaciones()
        self.pagina_configuracion = self.crear_pagina_configuracion() 

        # A√±adir p√°ginas al StackedWidget 
        self.stacked_widget.addWidget(self.pagina_inicio) 
        self.stacked_widget.addWidget(self.pagina_inscripcion) 
        self.stacked_widget.addWidget(self.pagina_pagos) 
        self.stacked_widget.addWidget(self.pagina_lista_alumnos) 
        self.stacked_widget.addWidget(self.pagina_gestion_cursos) 
        self.stacked_widget.addWidget(self.pagina_gestion_usuarios)
        self.stacked_widget.addWidget(self.pagina_gestion_materias)
        self.stacked_widget.addWidget(self.pagina_gestion_calificaciones) 
        self.stacked_widget.addWidget(self.pagina_configuracion)

        layout_contenido.addWidget(self.stacked_widget, 1) 

        # A√±adir el layout de contenido al layout principal
        layout_principal.addLayout(layout_contenido)

        # Conectar botones de navegaci√≥n a las p√°ginas 
        self.btn_nav_inicio.clicked.connect(lambda: self.cambiar_pagina(0))
        self.btn_nav_inscripcion.clicked.connect(lambda: self.cambiar_pagina(1)) 
        self.btn_nav_pagos.clicked.connect(lambda: self.cambiar_pagina(2))
        self.btn_nav_lista_alumnos.clicked.connect(lambda: self.cambiar_pagina(3)) 
        
        # Conectar botones de admin si existen
        if hasattr(self, 'btn_nav_gestion_cursos'):
            self.btn_nav_gestion_cursos.clicked.connect(lambda: self.cambiar_pagina(4))
        if hasattr(self, 'btn_nav_gestion_usuarios'):
            self.btn_nav_gestion_usuarios.clicked.connect(lambda: self.cambiar_pagina(5))
        if hasattr(self, 'btn_nav_config'):
            self.btn_nav_config.clicked.connect(lambda: self.cambiar_pagina(8))
           
        
        self.btn_logout.clicked.connect(self.cerrar_sesion)

        # Establecer p√°gina inicial
        self.cambiar_pagina(0)

    def crear_barra_superior(self):
        """Crea la barra de informaci√≥n superior."""
        widget = QWidget()
        widget.setObjectName("topBar")
        widget.setFixedHeight(50)
        layout = QHBoxLayout(widget)
        layout.setContentsMargins(15, 5, 15, 5)

        icon_usuario = QLabel("üë§")
        icon_usuario.setFont(QFont("Arial", 16))
        icon_usuario.setObjectName("topBarIcon") 

        info_layout = QVBoxLayout()
        info_layout.setSpacing(0)
        self.lbl_usuario_top = QLabel(f"Usuario: {self.full_username} ({self.user_role})") 
        self.lbl_usuario_top.setObjectName("topBarUser")

        # ELIMINADAS LAS ETIQUETAS DE FECHA Y HORA
        
        info_layout.addWidget(self.lbl_usuario_top)

        layout.addWidget(icon_usuario)
        layout.addLayout(info_layout)

        layout.addStretch()

        # Icono de logout 
        self.btn_logout = QPushButton("üö™")
        self.btn_logout.setObjectName("topBarButton")
        self.btn_logout.setToolTip("Cerrar Sesi√≥n")

        layout.addWidget(self.btn_logout)

        return widget


    def crear_panel_navegacion(self):
        """Crea el panel de navegaci√≥n izquierdo."""
        panel = QWidget()
        panel.setObjectName("navBar")
        panel.setFixedWidth(200)
        layout = QVBoxLayout(panel)
        layout.setContentsMargins(0, 10, 0, 10)
        layout.setSpacing(5)

        # Contenedor para el bot√≥n de Men√∫
        menu_frame = QFrame()
        menu_layout = QVBoxLayout(menu_frame)
        menu_layout.setContentsMargins(0, 0, 0, 0)
        
        # Bot√≥n de Inicio (siempre visible)
        self.btn_nav_inicio = QPushButton("üè†  Inicio")
        self.btn_nav_inicio.setObjectName("navButton")
        menu_layout.addWidget(self.btn_nav_inicio)
        
        # Bot√≥n Men√∫ que abrir√° el QMenu
        self.btn_menu = QPushButton("‚ò∞ Men√∫")
        self.btn_menu.setObjectName("navButton")
        self.btn_menu.clicked.connect(self.show_navigation_menu)
        menu_layout.addWidget(self.btn_menu)
        
        layout.addWidget(menu_frame)
        
        # Spacer para empujar el men√∫ hacia arriba y el de Configuraci√≥n hacia abajo
        spacer = QSpacerItem(20, 40, QSizePolicy.Policy.Minimum, QSizePolicy.Policy.Expanding)
        layout.addItem(spacer)

        # Lista completa de botones (solo se usan para el QMenu y el QStackedWidget)
        self.btn_nav_inscripcion = QPushButton("üìù  Nueva Inscripci√≥n")
        self.btn_nav_pagos = QPushButton("üíµ  Registro de Pagos")
        self.btn_nav_lista_alumnos = QPushButton("üë•  Lista de Alumnos") 
        self.btn_nav_gestion_cursos = QPushButton("üìö  Gestionar Cursos")
        self.btn_nav_gestion_usuarios = QPushButton("üë§  Gestionar Usuarios")
        self.btn_nav_config = QPushButton("‚öôÔ∏è  Configuraci√≥n")
        
        self.nav_buttons = [
            self.btn_nav_inicio, 
            self.btn_nav_inscripcion, 
            self.btn_nav_pagos,
            self.btn_nav_lista_alumnos,
            self.btn_nav_gestion_cursos,
            self.btn_nav_gestion_usuarios,
            self.btn_nav_config
        ]
        
        # Asegurarse de que solo se muestren Inicio y Men√∫
        self.btn_nav_inscripcion.setVisible(False)
        self.btn_nav_pagos.setVisible(False)
        self.btn_nav_lista_alumnos.setVisible(False)
        self.btn_nav_gestion_cursos.setVisible(False)
        self.btn_nav_gestion_usuarios.setVisible(False)
        self.btn_nav_config.setVisible(False)
        
        # Aplicar el mismo ObjectName a todos los botones para el estilo
        for btn in self.nav_buttons:
            if btn: 
                btn.setObjectName("navButton")

        return panel

    def show_navigation_menu(self):
        """Muestra el men√∫ contextual con las opciones de navegaci√≥n."""
        menu = QMenu(self)
        
        # Acciones principales
        menu.addAction("üìù Nueva Inscripci√≥n", lambda: self.cambiar_pagina(1))
        menu.addAction("üíµ Registro de Pagos", lambda: self.cambiar_pagina(2))
        menu.addAction("üë• Lista de Alumnos", lambda: self.cambiar_pagina(3))
        
        # Secci√≥n de Administraci√≥n (solo si es Admin)
        if self.permisos.get('is_admin'): # O usar permisos espec√≠ficos
            menu.addSeparator()
            menu.addAction("üìö Gestionar Cursos", lambda: self.cambiar_pagina(4))
            menu.addAction("üë§ Gestionar Usuarios", lambda: self.cambiar_pagina(5))
            menu.addAction("üìñ Gestionar Materias", lambda: self.cambiar_pagina(6))
            menu.addAction("üìä Asignar Calificaciones", lambda: self.cambiar_pagina(7))
            menu.addSeparator()
            menu.addAction("‚öôÔ∏è Configuraci√≥n", lambda: self.cambiar_pagina(8))
            
        # Mostrar el men√∫ justo debajo del bot√≥n "Men√∫"
        # Usamos mapToGlobal para obtener la posici√≥n global del bot√≥n
        # Nota: Necesitas importar QPoint
        try:
            point = self.btn_menu.mapToGlobal(QPoint(0, self.btn_menu.height()))
            menu.exec(point)
        except AttributeError:
             # Fallback si QPoint no est√° definido o hay error de widget
             menu.exec(self.mapToGlobal(QPoint(0, self.height() / 2)))


    def crear_pagina_inicio(self):
        """Crea la p√°gina de bienvenida con accesos directos."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout = QVBoxLayout(widget)
        layout.setContentsMargins(25, 25, 25, 25)
        layout.setSpacing(20)

        lbl_bienvenida = QLabel(f"¬°¬°BIENVENIDO(A), {self.full_username}!!")
        lbl_bienvenida.setObjectName("welcomeTitle")
        lbl_bienvenida.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(lbl_bienvenida)

        lbl_accesos = QLabel("Accesos directos")
        lbl_accesos.setObjectName("shortcutsTitle")
        layout.addWidget(lbl_accesos)

        # Contenedor de accesos directos
        layout_accesos = QHBoxLayout()
        layout_accesos.setSpacing(30)

        # "Nueva Inscripci√≥n" va a p√°gina 1 (formulario)
        btn_sc_inscribir = self.crear_boton_acceso("üìù", "Nueva Inscripci√≥n", lambda: self.cambiar_pagina(1))
        # "Registrar Pago" va a p√°gina 2
        btn_sc_pagar = self.crear_boton_acceso("üíµ", "Registrar Pago", lambda: self.cambiar_pagina(2))
        # "Consultar Alumnos" va a p√°gina 3 (lista alumnos)
        btn_sc_gestionar = self.crear_boton_acceso("üë•", "Consultar Alumnos", lambda: self.cambiar_pagina(3))
        
        layout_accesos.addWidget(btn_sc_inscribir)
        layout_accesos.addWidget(btn_sc_pagar)
        layout_accesos.addWidget(btn_sc_gestionar)
        
        # --- A√ëADIR ACCESOS DE ADMIN ---
        if self.permisos.get('can_manage_courses') or self.permisos.get('is_admin'):
            btn_sc_cursos = self.crear_boton_acceso("üìö", "Gestionar Cursos", lambda: self.cambiar_pagina(4))
            layout_accesos.addWidget(btn_sc_cursos)
        if self.permisos.get('can_manage_users') or self.permisos.get('is_admin'):
            btn_sc_usuarios = self.crear_boton_acceso("üë§", "Gestionar Usuarios", lambda: self.cambiar_pagina(5))
            layout_accesos.addWidget(btn_sc_usuarios)
            
        layout_accesos.addStretch()

        layout.addLayout(layout_accesos)
        layout.addStretch()
        return widget

    def crear_boton_acceso(self, icono, texto, on_click):
        """Crea un bot√≥n de acceso directo (icono + texto)."""
        widget = QWidget()
        widget.setObjectName("shortcutButton")
        layout = QVBoxLayout(widget)

        btn = QPushButton(icono)
        btn.setObjectName("shortcutIcon")
        btn.setFixedSize(100, 100)
        btn.clicked.connect(on_click)

        lbl = QLabel(texto)
        lbl.setAlignment(Qt.AlignmentFlag.AlignCenter)
        lbl.setObjectName("shortcutLabel")

        layout.addWidget(btn)
        layout.addWidget(lbl)

        return widget

    def cambiar_pagina(self, index):
        """Cambia la p√°gina visible en el QStackedWidget."""

        # Resetear estilos de todos los botones principales
        for btn in self.nav_buttons:
            if btn: 
                btn.setProperty("selected", False)
                self.style().polish(btn)

        # Mapeo del √≠ndice de p√°gina a bot√≥n y carga de datos
        boton_activo = None
        if index == 0: 
            self.stacked_widget.setCurrentIndex(0)
            boton_activo = self.btn_nav_inicio
        elif index == 1: 
            self.stacked_widget.setCurrentIndex(1)
            boton_activo = self.btn_nav_inscripcion
            self.cargar_combo_curso_registro() 
        elif index == 2: 
            self.stacked_widget.setCurrentIndex(2)
            boton_activo = self.btn_nav_pagos
            self.cargar_tabla_inscripciones_pagos() 
        elif index == 3: 
            self.stacked_widget.setCurrentIndex(3)
            boton_activo = self.btn_nav_lista_alumnos
            self.cargar_tabla_alumnos() 
            self.cargar_cursos_para_filtro() 
        elif index == 4: 
             if self.permisos.get('can_manage_courses') or self.permisos.get('is_admin'):
                self.stacked_widget.setCurrentIndex(4)
                # ... (resto del c√≥digo) ...
        elif index == 5: 
            if self.permisos.get('can_manage_users') or self.permisos.get('is_admin'):
                self.stacked_widget.setCurrentIndex(5)
                # ... (resto del c√≥digo) ...
        elif index == 6: 
            if self.permisos.get('can_manage_subjects') or self.permisos.get('is_admin'):
                self.stacked_widget.setCurrentIndex(6)
                # ... (resto del c√≥digo) ...
        elif index == 7: 
            if self.permisos.get('can_assign_grades') or self.permisos.get('is_admin'):
                self.stacked_widget.setCurrentIndex(7)
                # ... (resto del c√≥digo) ...
        elif index == 8:
            if self.permisos.get('can_access_settings') or self.permisos.get('is_admin'):
                self.stacked_widget.setCurrentIndex(8)
                # ... (resto del c√≥digo) ...
                
        # Poner estilo seleccionado al bot√≥n activo (si aplica)
        if boton_activo:
            boton_activo.setProperty("selected", True)
            self.style().polish(boton_activo)


    def cerrar_sesion(self):
        """Cierra la sesi√≥n y vuelve al login."""
        self.logout_solicitado = True
        self.close()

    # ---- P√ÅGINA 1: NUEVA INSCRIPCI√ìN (Formulario Detallado) ----
    def crear_pagina_nueva_inscripcion(self):
        """Crea la interfaz para la p√°gina de NUEVA INSCRIPCI√ìN (Formulario detallado)."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_principal = QVBoxLayout(widget) 
        layout_principal.setContentsMargins(15, 15, 15, 15)

        scroll_area = QScrollArea() 
        scroll_area.setWidgetResizable(True)

        # Widget contenedor para el layout dentro del scroll
        scroll_content_widget = QWidget()
        layout_nuevo_alumno = QVBoxLayout(scroll_content_widget) 

        # -- Grupo Datos del Alumno --
        group_alumno = QGroupBox("Datos del Alumno")
        form_alumno = QFormLayout(group_alumno)
        self.entry_al_ap_paterno = QLineEdit()
        self.entry_al_ap_materno = QLineEdit()
        self.entry_al_nombres = QLineEdit()
        self.entry_al_escuela_procedencia = QLineEdit()
        self.entry_al_escuela_ingresar = QLineEdit()
        self.entry_al_edad = QLineEdit() 
        self.entry_al_telefono = QLineEdit()
        self.entry_al_email = QLineEdit()
        self.combo_al_turno = QComboBox()
        self.combo_al_turno.addItems(["Matutino", "Vespertino"])

        self.combo_curso_registro = QComboBox() 
        self.combo_tipo_pago_registro = QComboBox() 
        self.lbl_costo_total_registro = QLabel("$ 0.00") 
        self.lbl_costo_total_registro.setStyleSheet("font-weight: bold; color: #4CAF50; font-size: 11pt;")

        self.check_autoriza_salida = QCheckBox("Autoriza que el alumno se retire solo del plantel")
        self.check_imprimir_poliza = QCheckBox("Imprimir P√≥liza de Garant√≠a y T√©rminos y Condiciones") 

        form_alumno.addRow("Apellido Paterno:", self.entry_al_ap_paterno)
        form_alumno.addRow("Apellido Materno:", self.entry_al_ap_materno)
        form_alumno.addRow("Nombre(s):", self.entry_al_nombres)
        form_alumno.addRow("Escuela de Procedencia:", self.entry_al_escuela_procedencia)
        form_alumno.addRow("Escuela a Ingresar:", self.entry_al_escuela_ingresar)
        form_alumno.addRow("Edad:", self.entry_al_edad)
        form_alumno.addRow("Tel√©fono (Alumno):", self.entry_al_telefono)
        form_alumno.addRow("Correo Electr√≥nico:", self.entry_al_email)
        form_alumno.addRow("Turno:", self.combo_al_turno)
        form_alumno.addRow("Curso a Inscribir:", self.combo_curso_registro)
        form_alumno.addRow("Plan de Pago:", self.combo_tipo_pago_registro)
        form_alumno.addRow("Costo Total:", self.lbl_costo_total_registro)
        form_alumno.addRow("", self.check_autoriza_salida) 
        form_alumno.addRow("", self.check_imprimir_poliza) 
        layout_nuevo_alumno.addWidget(group_alumno)
    
        # Conectar se√±ales
        self.combo_curso_registro.currentIndexChanged.connect(self.actualizar_opciones_pago)
        self.combo_tipo_pago_registro.currentIndexChanged.connect(self.actualizar_costo_total_label)


        # -- Grupo Datos del Tutor --
        group_tutor = QGroupBox("Datos del Padre o Tutor")
        form_tutor = QFormLayout(group_tutor)
        self.entry_tutor_ap_paterno = QLineEdit()
        self.entry_tutor_ap_materno = QLineEdit()
        self.entry_tutor_nombres = QLineEdit()
        self.entry_tutor_telefono = QLineEdit()

        form_tutor.addRow("Apellido Paterno:", self.entry_tutor_ap_paterno)
        form_tutor.addRow("Apellido Materno:", self.entry_tutor_ap_materno)
        form_tutor.addRow("Nombre(s):", self.entry_tutor_nombres)
        form_tutor.addRow("Tel√©fono (Tutor):", self.entry_tutor_telefono)
        layout_nuevo_alumno.addWidget(group_tutor)

        # -- Grupo Domicilio del Tutor --
        group_domicilio = QGroupBox("Domicilio del Tutor")
        form_domicilio = QFormLayout(group_domicilio)
        self.entry_dom_calle = QLineEdit()
        self.entry_dom_num_ext = QLineEdit()
        self.entry_dom_num_int = QLineEdit()
        self.entry_dom_colonia = QLineEdit()
        self.entry_dom_municipio = QLineEdit()
        self.entry_dom_estado = QLineEdit()
        self.entry_dom_cp = QLineEdit()

        form_domicilio.addRow("Calle:", self.entry_dom_calle)
        form_domicilio.addRow("N√∫mero Exterior:", self.entry_dom_num_ext)
        form_domicilio.addRow("N√∫mero Interior:", self.entry_dom_num_int)
        form_domicilio.addRow("Colonia:", self.entry_dom_colonia)
        form_domicilio.addRow("Municipio:", self.entry_dom_municipio)
        form_domicilio.addRow("Estado:", self.entry_dom_estado)
        form_domicilio.addRow("C√≥digo Postal:", self.entry_dom_cp)
        layout_nuevo_alumno.addWidget(group_domicilio)

        # -- Grupo Contactos de Emergencia --
        group_emergencia = QGroupBox("Contactos de Emergencia")
        layout_emergencia = QVBoxLayout(group_emergencia)

        # Contacto 1
        layout_emerg_1 = QFormLayout()
        self.entry_emerg_1_nombre = QLineEdit()
        self.entry_emerg_1_telefono = QLineEdit()
        self.entry_emerg_1_parentesco = QLineEdit()
        layout_emerg_1.addRow("Nombre Completo 1:", self.entry_emerg_1_nombre)
        layout_emerg_1.addRow("Tel√©fono 1:", self.entry_emerg_1_telefono)
        layout_emerg_1.addRow("Parentesco 1:", self.entry_emerg_1_parentesco)
        layout_emergencia.addLayout(layout_emerg_1)

        # Contacto 2
        layout_emerg_2 = QFormLayout()
        self.entry_emerg_2_nombre = QLineEdit()
        self.entry_emerg_2_telefono = QLineEdit()
        self.entry_emerg_2_parentesco = QLineEdit()
        layout_emerg_2.addRow("Nombre Completo 2:", self.entry_emerg_2_nombre)
        layout_emerg_2.addRow("Tel√©fono 2:", self.entry_emerg_2_telefono)
        layout_emerg_2.addRow("Parentesco 2:", self.entry_emerg_2_parentesco)
        layout_emergencia.addLayout(layout_emerg_2)

        layout_nuevo_alumno.addWidget(group_emergencia)

        # Bot√≥n de Guardar e Imprimir
        self.btn_guardar_alumno = QPushButton("Imprimir Ficha de Inscripci√≥n")
        self.btn_guardar_alumno.setObjectName("primaryButton")
        self.btn_guardar_alumno.clicked.connect(self.registrar_alumno_e_inscribir)
        layout_nuevo_alumno.addWidget(self.btn_guardar_alumno)

        layout_nuevo_alumno.addStretch() 

        # Establecer el widget con el layout en el scroll area
        scroll_area.setWidget(scroll_content_widget)

        # A√±adir el scroll area al layout principal de la p√°gina
        layout_principal.addWidget(scroll_area)

        
        return widget

    # ---- P√ÅGINA 2: REGISTRO DE PAGOS ----
    def crear_pagina_pagos(self):
        """Crea la interfaz para la p√°gina de registro de pagos."""
        main_layout = QHBoxLayout()
        widget = QWidget()
        widget.setObjectName("contentPage")
        widget.setContentsMargins(15, 15, 15, 15) 

        # Lado izquierdo: Registrar Pago
        left_panel = QGroupBox("Registrar Nuevo Pago")
        left_layout = QFormLayout()
        
        # --- ELIMINADO EL CAMPO DE B√öSQUEDA ---
        
        # El combo box ahora es la lista filtrada por la entrada de b√∫squeda
        self.combo_inscripcion_pago = QComboBox()
        self.combo_inscripcion_pago.setPlaceholderText("--- Seleccione una inscripci√≥n ---")
        
        self.lbl_pago_total = QLabel("$ 0.00")
        self.lbl_pago_pagado = QLabel("$ 0.00")
        self.lbl_pago_pendiente = QLabel("$ 0.00")

        self.lbl_pago_pendiente.setStyleSheet("font-weight: bold; color: #D32F2F;")
        self.lbl_pago_pagado.setStyleSheet("color: #4CAF50;")

        self.spin_monto_pago = QDoubleSpinBox()
        self.spin_monto_pago.setRange(0.01, 100000.0)
        self.spin_monto_pago.setPrefix("$ ")

        self.combo_metodo_pago = QComboBox()
        self.combo_metodo_pago.addItems(["Efectivo", "Transferencia", "Tarjeta de D√©bito", "Tarjeta de Cr√©dito"])

        self.btn_registrar_pago = QPushButton("Registrar Pago")
        self.btn_registrar_pago.setObjectName("primaryButton") 

        # Se usa el QComboBox est√°ndar como √∫nica forma de selecci√≥n
        left_layout.addRow(QLabel("Inscripci√≥n (Alumno - Curso):"), self.combo_inscripcion_pago)
        left_layout.addRow(QLabel("Monto Total:"), self.lbl_pago_total)
        left_layout.addRow(QLabel("Monto Pagado:"), self.lbl_pago_pagado)
        left_layout.addRow(QLabel("Saldo Pendiente:"), self.lbl_pago_pendiente)
        left_layout.addRow(QLabel("Monto a Pagar:"), self.spin_monto_pago)
        left_layout.addRow(QLabel("M√©todo de Pago:"), self.combo_metodo_pago)
        left_layout.addRow(self.btn_registrar_pago)
        left_panel.setLayout(left_layout)

        # Lado derecho: Historial de Pagos de la Inscripci√≥n
        right_panel = QGroupBox("Historial de Pagos")
        right_layout = QVBoxLayout()
        self.tabla_historial_pagos = QTableWidget(0, 3)
        self.tabla_historial_pagos.setHorizontalHeaderLabels(["Fecha", "Monto", "M√©todo"])
        self.tabla_historial_pagos.horizontalHeader().setStretchLastSection(True)
        self.tabla_historial_pagos.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        right_layout.addWidget(self.tabla_historial_pagos)
        right_panel.setLayout(right_layout)

        main_layout.addWidget(left_panel, 1)
        main_layout.addWidget(right_panel, 2)
        widget.setLayout(main_layout)

        # Conexiones
        self.combo_inscripcion_pago.currentIndexChanged.connect(self.actualizar_detalles_pago)
        self.btn_registrar_pago.clicked.connect(self.registrar_pago)
        
        self.cargar_cache_inscripciones() 

        return widget

    # ---- P√ÅGINA 3: LISTA DE ALUMNOS ----
    def crear_pagina_lista_alumnos(self):
        """Crea la interfaz para la p√°gina que muestra la lista de alumnos."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        # Layout principal horizontal: Tabla | Expediente
        layout_principal = QHBoxLayout(widget)
        layout_principal.setContentsMargins(15, 15, 15, 15)
        layout_principal.setSpacing(15)

        # Panel Izquierdo: Tabla de Alumnos
        group_tabla = QGroupBox("Lista de Alumnos Registrados")
        layout_tabla = QVBoxLayout(group_tabla)

        # --- NUEVO: FILTRO DE CURSO ---
        filter_layout = QHBoxLayout()
        filter_label = QLabel("Filtrar por Curso:")
        self.combo_filtro_curso = QComboBox()
        self.combo_filtro_curso.setMinimumWidth(250)
        
        filter_layout.addWidget(filter_label)
        filter_layout.addWidget(self.combo_filtro_curso)
        filter_layout.addStretch()
        layout_tabla.addLayout(filter_layout)
        # --- FIN NUEVO: FILTRO DE CURSO ---
        
        self.tabla_alumnos = QTableWidget(0, 6) # Modificado a 6 columnas: ID, Nombre, ApellidoP, ApellidoM, Email, Curso
        self.tabla_alumnos.setHorizontalHeaderLabels(["ID", "Nombre(s)", "Ap. Paterno", "Ap. Materno", "Email", "Curso Inscrito"])
        self.tabla_alumnos.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.tabla_alumnos.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        self.tabla_alumnos.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.tabla_alumnos.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.tabla_alumnos.itemSelectionChanged.connect(self.mostrar_expediente_alumno)

        layout_tabla.addWidget(self.tabla_alumnos)
        layout_principal.addWidget(group_tabla, 2) 

        # Panel Derecho: Expediente y Bot√≥n
        panel_derecho = QWidget()
        layout_derecho = QVBoxLayout(panel_derecho)
        layout_derecho.setContentsMargins(0,0,0,0) 

        group_expediente = QGroupBox("Expediente del Alumno")
        layout_expediente = QVBoxLayout(group_expediente)
        self.expediente_texto = QTextEdit()
        self.expediente_texto.setReadOnly(True)
        self.expediente_texto.setObjectName("expedienteDisplay") 
        layout_expediente.addWidget(self.expediente_texto)

        self.btn_dar_baja = QPushButton("Dar de Baja Alumno Seleccionado")
        self.btn_dar_baja.setObjectName("deleteButton") 
        self.btn_dar_baja.clicked.connect(self.dar_baja_alumno)
        self.btn_generar_boleta = QPushButton("Generar Boleta de Calificaciones")
        self.btn_generar_boleta.setObjectName("primaryButton")
        self.btn_generar_boleta.clicked.connect(self.generar_boleta_pdf)

        layout_derecho.addWidget(group_expediente)
        layout_derecho.addWidget(self.btn_dar_baja)
        layout_derecho.addWidget(self.btn_generar_boleta)

        layout_principal.addWidget(panel_derecho, 1) 

        # Conectar el filtro
        self.combo_filtro_curso.currentIndexChanged.connect(self.filtrar_alumnos_por_curso)

        return widget

    # ---- P√ÅGINA 4: GESTIONAR CURSOS ----
    def crear_pagina_gestion_usuarios(self):
        """Crea la interfaz para la p√°gina de gesti√≥n de usuarios."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_main = QHBoxLayout(widget)
        layout_main.setContentsMargins(15, 15, 15, 15)

        # Panel Izquierdo: Formulario de Usuario
        panel_usuario_form = QGroupBox("Registrar / Editar Usuario")
        layout_form = QVBoxLayout(panel_usuario_form)
        
        form_usuario = QFormLayout()
        self.entry_usr_nombre = QLineEdit()
        self.entry_usr_telefono = QLineEdit()
        self.entry_usr_email = QLineEdit()
        
        form_usuario.addRow(QLabel("Nombre Completo:"), self.entry_usr_nombre)
        form_usuario.addRow(QLabel("Tel√©fono:"), self.entry_usr_telefono)
        form_usuario.addRow(QLabel("Correo Electr√≥nico:"), self.entry_usr_email)
        
        layout_form.addLayout(form_usuario)

        # --- INICIO DE MODIFICACI√ìN: A√±adir CheckBoxes de Permisos ---
        
        # Definir los permisos (texto_amigable, clave_json)
        self.permisos_map = [
            ("Registrar Alumnos", "can_register_students"),
            ("Registrar Pagos", "can_register_payments"),
            ("Ver Lista Alumnos", "can_view_all_students"),
            ("Gestionar Cursos", "can_manage_courses"),
            ("Gestionar Materias", "can_manage_subjects"),
            ("Asignar Calificaciones", "can_assign_grades"),
            ("Gestionar Usuarios", "can_manage_users"),
            ("Ver Configuraci√≥n", "can_access_settings"),
            ("ES ADMINISTRADOR (Acceso Total)", "is_admin"),
        ]
        
        self.permisos_checkboxes = {} # Diccionario para guardar los checkboxes

        group_permisos = QGroupBox("Permisos del Usuario")
        layout_permisos = QGridLayout(group_permisos)

        for i, (texto, clave) in enumerate(self.permisos_map):
            chk = QCheckBox(texto)
            self.permisos_checkboxes[clave] = chk
            layout_permisos.addWidget(chk, i, 0)

        layout_form.addWidget(group_permisos)
        # --- FIN DE MODIFICACI√ìN ---

        # Botones de acci√≥n del formulario
        self.btn_guardar_usuario = QPushButton("Guardar Usuario")
        self.btn_guardar_usuario.setObjectName("primaryButton")
        self.btn_guardar_usuario.clicked.connect(self.guardar_usuario) 

        self.btn_limpiar_form_usuario = QPushButton("Limpiar Formulario")
        self.btn_limpiar_form_usuario.setObjectName("secondaryButton") 
        self.btn_limpiar_form_usuario.clicked.connect(self.limpiar_campos_usuario)

        self.btn_cambiar_password = QPushButton("Cambiar Contrase√±a")
        self.btn_cambiar_password.setObjectName("secondaryButton") 
        self.btn_cambiar_password.clicked.connect(self.cambiar_password_usuario)
        self.btn_cambiar_password.setVisible(False) 

        layout_botones_form = QHBoxLayout()
        layout_botones_form.addWidget(self.btn_guardar_usuario)
        layout_botones_form.addWidget(self.btn_limpiar_form_usuario)
        
        layout_form.addLayout(layout_botones_form)
        layout_form.addWidget(self.btn_cambiar_password)
        layout_form.addStretch() 
        
        # Panel Derecho: Tabla de Usuarios
        panel_usuario_tabla = QGroupBox("Lista de Usuarios")
        layout_usuario_tabla = QVBoxLayout(panel_usuario_tabla)
        # --- MODIFICADO: Quitar columna 'Rol' ---
        self.tabla_usuarios = QTableWidget(0, 3)
        self.tabla_usuarios.setHorizontalHeaderLabels(["ID (No. Empleado)", "Nombre", "Email"])
        self.tabla_usuarios.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.tabla_usuarios.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        self.tabla_usuarios.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.tabla_usuarios.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.tabla_usuarios.itemSelectionChanged.connect(self.seleccionar_usuario_para_edicion)
        
        self.btn_eliminar_usuario = QPushButton("Eliminar Usuario Seleccionado")
        self.btn_eliminar_usuario.setObjectName("deleteButton") 
        self.btn_eliminar_usuario.clicked.connect(self.dar_baja_usuario)

        layout_usuario_tabla.addWidget(self.tabla_usuarios)
        layout_usuario_tabla.addWidget(self.btn_eliminar_usuario)

        layout_main.addWidget(panel_usuario_form)
        layout_main.addWidget(panel_usuario_tabla, 1) 
        
        return widget
    
    # ---- P√ÅGINA 4: GESTIONAR CURSOS ----
    def crear_pagina_gestion_cursos(self):
        """Crea la interfaz para la p√°gina de gesti√≥n de cursos."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_main = QHBoxLayout(widget)
        layout_main.setContentsMargins(15, 15, 15, 15)

        # Panel Izquierdo: Formulario de Cursos
        panel_cursos_form = QGroupBox("Gesti√≥n de Cursos")
        layout_form = QVBoxLayout(panel_cursos_form)
        
        form_cursos = QFormLayout()
        self.entry_cur_nombre = QLineEdit()
        self.spin_costo_exhibicion = QDoubleSpinBox()
        self.spin_costo_exhibicion.setRange(0.0, 100000.0)
        self.spin_costo_exhibicion.setPrefix("$ ")
        self.spin_costo_sem_15 = QDoubleSpinBox()
        self.spin_costo_sem_15.setRange(0.0, 100000.0)
        self.spin_costo_sem_15.setPrefix("$ ")
        self.spin_costo_sem_12 = QDoubleSpinBox() 
        self.spin_costo_sem_12.setRange(0.0, 100000.0)
        self.spin_costo_sem_12.setPrefix("$ ")
        self.spin_costo_mensual_3 = QDoubleSpinBox()
        self.spin_costo_mensual_3.setRange(0.0, 100000.0)
        self.spin_costo_mensual_3.setPrefix("$ ")
        
        form_cursos.addRow(QLabel("Nombre del Curso:"), self.entry_cur_nombre)
        form_cursos.addRow(QLabel("Costo (Exhibici√≥n √önica):"), self.spin_costo_exhibicion)
        form_cursos.addRow(QLabel("Costo Total (15 Semanas):"), self.spin_costo_sem_15)
        form_cursos.addRow(QLabel("Costo Total (12 Semanas):"), self.spin_costo_sem_12) 
        form_cursos.addRow(QLabel("Costo Total (3 Meses):"), self.spin_costo_mensual_3)
        
        self.btn_guardar_curso = QPushButton("Guardar Curso")
        self.btn_guardar_curso.setObjectName("primaryButton")
        self.btn_guardar_curso.clicked.connect(self.guardar_curso)

        self.btn_limpiar_form_curso = QPushButton("Limpiar Formulario")
        self.btn_limpiar_form_curso.setObjectName("secondaryButton")
        self.btn_limpiar_form_curso.clicked.connect(self.limpiar_campos_curso)

        layout_botones_form = QHBoxLayout()
        layout_botones_form.addWidget(self.btn_guardar_curso)
        layout_botones_form.addWidget(self.btn_limpiar_form_curso)

        layout_form.addLayout(form_cursos)
        layout_form.addLayout(layout_botones_form)
        layout_form.addStretch()

        
        # Panel Derecho: Tabla de Cursos
        panel_cursos_tabla = QGroupBox("Lista de Cursos")
        layout_cursos_tabla = QVBoxLayout(panel_cursos_tabla)
        self.tabla_cursos = QTableWidget(0, 6) 
        self.tabla_cursos.setHorizontalHeaderLabels(["ID", "Curso", "Exhibici√≥n", "Sem 15", "Sem 12", "Mensual 3"]) 
        self.tabla_cursos.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.tabla_cursos.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        self.tabla_cursos.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.tabla_cursos.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.tabla_cursos.itemSelectionChanged.connect(self.seleccionar_curso_para_edicion)
        
        self.btn_eliminar_curso = QPushButton("Eliminar Curso Seleccionado")
        self.btn_eliminar_curso.setObjectName("deleteButton") 
        self.btn_eliminar_curso.clicked.connect(self.dar_baja_curso)

        layout_cursos_tabla.addWidget(self.tabla_cursos)
        layout_cursos_tabla.addWidget(self.btn_eliminar_curso)

        layout_main.addWidget(panel_cursos_form)
        layout_main.addWidget(panel_cursos_tabla, 1) 
        
        return widget
    
        
    # ---- P√ÅGINA 5: GESTIONAR USUARIOS (NUEVA CON EDICI√ìN) ----
    # ---- P√ÅGINA 5: GESTIONAR USUARIOS (NUEVA CON PERMISOS) ----
    def crear_pagina_gestion_usuarios(self):
        """Crea la interfaz para la p√°gina de gesti√≥n de usuarios."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_main = QHBoxLayout(widget)
        layout_main.setContentsMargins(15, 15, 15, 15)

        # Panel Izquierdo: Formulario de Usuario
        panel_usuario_form = QGroupBox("Registrar / Editar Usuario")
        layout_form = QVBoxLayout(panel_usuario_form)
        
        form_usuario = QFormLayout()
        self.entry_usr_nombre = QLineEdit()
        self.entry_usr_telefono = QLineEdit()
        self.entry_usr_email = QLineEdit()
        
        form_usuario.addRow(QLabel("Nombre Completo:"), self.entry_usr_nombre)
        form_usuario.addRow(QLabel("Tel√©fono:"), self.entry_usr_telefono)
        form_usuario.addRow(QLabel("Correo Electr√≥nico:"), self.entry_usr_email)
        
        layout_form.addLayout(form_usuario)

        # --- INICIO DE MODIFICACI√ìN: A√±adir CheckBoxes de Permisos ---
        
        # Definir los permisos (texto_amigable, clave_json)
        self.permisos_map = [
            ("Registrar Alumnos", "can_register_students"),
            ("Registrar Pagos", "can_register_payments"),
            ("Ver Lista Alumnos", "can_view_all_students"),
            ("Gestionar Cursos", "can_manage_courses"),
            ("Gestionar Materias", "can_manage_subjects"),
            ("Asignar Calificaciones", "can_assign_grades"),
            ("Gestionar Usuarios", "can_manage_users"),
            ("Ver Configuraci√≥n", "can_access_settings"),
            ("ES ADMINISTRADOR (Acceso Total)", "is_admin"),
        ]
        
        self.permisos_checkboxes = {} # Diccionario para guardar los checkboxes

        group_permisos = QGroupBox("Permisos del Usuario")
        layout_permisos = QGridLayout(group_permisos)

        for i, (texto, clave) in enumerate(self.permisos_map):
            chk = QCheckBox(texto)
            self.permisos_checkboxes[clave] = chk
            layout_permisos.addWidget(chk, i, 0)

            if clave == 'is_admin':
                chk.toggled.connect(self.toggle_all_permissions)

        layout_form.addWidget(group_permisos)
        # --- FIN DE MODIFICACI√ìN ---

        # Botones de acci√≥n del formulario
        self.btn_guardar_usuario = QPushButton("Guardar Usuario")
        self.btn_guardar_usuario.setObjectName("primaryButton")
        self.btn_guardar_usuario.clicked.connect(self.guardar_usuario) 

        self.btn_limpiar_form_usuario = QPushButton("Limpiar Formulario")
        self.btn_limpiar_form_usuario.setObjectName("secondaryButton") 
        self.btn_limpiar_form_usuario.clicked.connect(self.limpiar_campos_usuario)

        self.btn_cambiar_password = QPushButton("Cambiar Contrase√±a")
        self.btn_cambiar_password.setObjectName("secondaryButton") 
        self.btn_cambiar_password.clicked.connect(self.cambiar_password_usuario)
        self.btn_cambiar_password.setVisible(False) 

        layout_botones_form = QHBoxLayout()
        layout_botones_form.addWidget(self.btn_guardar_usuario)
        layout_botones_form.addWidget(self.btn_limpiar_form_usuario)
        
        layout_form.addLayout(layout_botones_form)
        layout_form.addWidget(self.btn_cambiar_password)
        layout_form.addStretch() 
        
        # Panel Derecho: Tabla de Usuarios
        panel_usuario_tabla = QGroupBox("Lista de Usuarios")
        layout_usuario_tabla = QVBoxLayout(panel_usuario_tabla)
        # --- MODIFICADO: Quitar columna 'Rol' ---
        self.tabla_usuarios = QTableWidget(0, 3)
        self.tabla_usuarios.setHorizontalHeaderLabels(["ID (No. Empleado)", "Nombre", "Email"])
        self.tabla_usuarios.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.tabla_usuarios.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        self.tabla_usuarios.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.tabla_usuarios.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.tabla_usuarios.itemSelectionChanged.connect(self.seleccionar_usuario_para_edicion)
        
        self.btn_eliminar_usuario = QPushButton("Eliminar Usuario Seleccionado")
        self.btn_eliminar_usuario.setObjectName("deleteButton") 
        self.btn_eliminar_usuario.clicked.connect(self.dar_baja_usuario)

        layout_usuario_tabla.addWidget(self.tabla_usuarios)
        layout_usuario_tabla.addWidget(self.btn_eliminar_usuario)

        layout_main.addWidget(panel_usuario_form)
        layout_main.addWidget(panel_usuario_tabla, 1) 
        
        return widget
    
    # ---- (P√ÅGINA 6: GESTIONAR MATERIAS - Esta debe estar aqu√≠) ----
    def crear_pagina_gestion_materias(self):
        """Crea la interfaz para a√±adir o quitar materias a un curso."""
        # ... (Aseg√∫rate de que esta funci√≥n est√© presente) ...
        # (El c√≥digo de esta funci√≥n no se muestra para abreviar,
        #  pero debe estar en tu archivo entre crear_pagina_gestion_usuarios
        #  y crear_pagina_gestion_calificaciones)
        pass # Reemplaza 'pass' con el c√≥digo de la funci√≥n si la borraste
    
    # ---- (P√ÅGINA 7: ASIGNAR CALIFICACIONES - Esta debe estar aqu√≠) ----
    def crear_pagina_gestion_calificaciones(self):
        """Crea la interfaz para asignar calificaciones a los alumnos."""
        # ... (El c√≥digo de esta funci√≥n debe estar aqu√≠) ...
        pass # Reemplaza 'pass' con el c√≥digo de la funci√≥n si la borraste
        
    # ---- (P√ÅGINA 8: CONFIGURACI√ìN - Esta debe estar aqu√≠) ----
    def crear_pagina_configuracion(self):
        """Crea la interfaz para la p√°gina de configuraci√≥n."""
        # ... (El c√≥digo de esta funci√≥n debe estar aqu√≠) ...
        pass # Reemplaza 'pass' con el c√≥digo de la funci√≥n si la borraste


    # --- L√ìGICA DE GESTI√ìN DE USUARIOS (ACTUALIZADA) ---

    def guardar_usuario(self):
        """Guarda un usuario nuevo o actualiza uno existente."""
        if not all(hasattr(self, w) for w in ['entry_usr_nombre', 'entry_usr_email', 'permisos_checkboxes']):
            return 

        nombre = self.entry_usr_nombre.text().strip()
        telefono = self.entry_usr_telefono.text().strip()
        email = self.entry_usr_email.text().strip()
        
        if not nombre or not email:
            mostrar_error("Nombre Completo y Correo Electr√≥nico son obligatorios.")
            return
            
        # --- INICIO DE MODIFICACI√ìN: Construir diccionario de permisos ---
        permisos_dict = {}
        for clave, checkbox in self.permisos_checkboxes.items():
            permisos_dict[clave] = checkbox.isChecked()
        
        # Convertir a JSON
        permisos_json = json.dumps(permisos_dict)
        # --- FIN DE MODIFICACI√ìN ---
            
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                
                if self.usuario_seleccionado_id is None:
                    # --- CREAR NUEVO USUARIO ---
                    password = secrets.token_hex(4) 
                    cursor.execute("""
                    INSERT INTO usuarios (nombre_completo, telefono, email, permisos, password)
                    VALUES (?, ?, ?, ?, ?)
                    """, (nombre, telefono, email, permisos_json, password))
                    user_id = cursor.lastrowid 
                    conn.commit()
                    
                    mostrar_info(f"Usuario creado exitosamente:\n\n"
                                 f"No. de Empleado (ID): {user_id}\n"
                                 f"Usuario (Email): {email}\n"
                                 f"Contrase√±a: {password}\n\n"
                                 "Por favor, guarde esta contrase√±a. No se puede recuperar.")
                
                else:
                    # --- ACTUALIZAR USUARIO EXISTENTE ---
                    cursor.execute("""
                    UPDATE usuarios SET nombre_completo = ?, telefono = ?, email = ?, permisos = ?
                    WHERE id = ?
                    """, (nombre, telefono, email, permisos_json, self.usuario_seleccionado_id))
                    conn.commit()
                    mostrar_info(f"Usuario (ID: {self.usuario_seleccionado_id}) actualizado exitosamente.")
                         
            self.limpiar_campos_usuario()
            self.cargar_tabla_usuarios()
            
        except sqlite3.IntegrityError:
            mostrar_error("Error: Ese correo electr√≥nico ya est√° registrado.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al registrar usuario: {e}")

    def cambiar_password_usuario(self):
        """Cambia la contrase√±a del usuario seleccionado."""
        if self.usuario_seleccionado_id is None:
            mostrar_error("No hay ning√∫n usuario seleccionado.")
            return
        
        # --- A√ëADIDO: Proteger al Admin ID 1 ---
        if self.usuario_seleccionado_id == 1:
            mostrar_error("No se puede cambiar la contrase√±a del Administrador principal desde aqu√≠.")
            return

        nueva_pass, ok = QInputDialog.getText(self, "Cambiar Contrase√±a",
                                              "Ingrese la nueva contrase√±a:", QLineEdit.EchoMode.Password)
        
        if ok and nueva_pass:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("UPDATE usuarios SET password = ? WHERE id = ?", (nueva_pass, self.usuario_seleccionado_id))
                    conn.commit()
                mostrar_info("Contrase√±a actualizada exitosamente.")
            except sqlite3.Error as e:
                mostrar_error(f"Error al cambiar la contrase√±a: {e}")
        elif ok and not nueva_pass:
            mostrar_error("La contrase√±a no puede estar vac√≠a.")

    def seleccionar_usuario_para_edicion(self):
        """Carga los datos del usuario seleccionado en el formulario de edici√≥n."""
        selected_items = self.tabla_usuarios.selectedItems()
        if not selected_items:
            self.limpiar_campos_usuario() 
            return

        selected_row = self.tabla_usuarios.currentRow()
        
        if selected_row < 0:
             self.limpiar_campos_usuario()
             return
             
        user_id_item = self.tabla_usuarios.item(selected_row, 0)
        if not user_id_item: return

        try:
            user_id = int(user_id_item.text())
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM usuarios WHERE id = ?", (user_id,))
                datos = cursor.fetchone()

            if datos:
                self.usuario_seleccionado_id = user_id
                self.entry_usr_nombre.setText(datos['nombre_completo'])
                self.entry_usr_telefono.setText(datos['telefono'])
                self.entry_usr_email.setText(datos['email'])
                
                # --- INICIO DE MODIFICACI√ìN: Cargar permisos ---
                try:
                    permisos_dict = json.loads(datos['permisos'])
                except json.JSONDecodeError:
                    permisos_dict = {} # Fallback

                # Asignar el estado de los checkboxes
                for clave, checkbox in self.permisos_checkboxes.items():
                    checkbox.setChecked(permisos_dict.get(clave, False))
                # --- FIN DE MODIFICACI√ìN ---
                
                self.btn_guardar_usuario.setText("Actualizar Usuario")

                is_admin = permisos_dict.get('is_admin', False)
                
                # Proteger al Admin ID 1
                if user_id == 1:
                    self.btn_cambiar_password.setVisible(False)
                    self.toggle_all_permissions(True) # Deshabilita todo
                else:
                    self.btn_cambiar_password.setVisible(True)
                    self.toggle_all_permissions(is_admin)

        except Exception as e:
            mostrar_error(f"Error al cargar datos de usuario: {e}")
            self.limpiar_campos_usuario()

    def dar_baja_usuario(self):
        """Elimina un usuario seleccionado de la BD."""
        
        # --- L√≥gica de selecci√≥n mejorada ---
        user_id_a_eliminar = None
        nombre_seleccionado = ""
        
        selected_items = self.tabla_usuarios.selectedItems()
        if selected_items and self.tabla_usuarios.currentRow() >= 0:
            selected_row = self.tabla_usuarios.currentRow()
            user_id_item = self.tabla_usuarios.item(selected_row, 0)
            nombre_item = self.tabla_usuarios.item(selected_row, 1)
            if user_id_item:
                user_id_a_eliminar = int(user_id_item.text())
                nombre_seleccionado = nombre_item.text()
        else:
             mostrar_error("Por favor, seleccione un usuario de la lista para eliminar.")
             return
        # --- Fin l√≥gica de selecci√≥n ---

        # Protecci√≥n para el admin ID 1 y para no borrarse a s√≠ mismo
        if user_id_a_eliminar == 1:
            mostrar_error("No se puede eliminar al administrador principal (ID 1).")
            return
            
        if self.username == self.tabla_usuarios.item(self.tabla_usuarios.currentRow(), 2).text():
            mostrar_error("No puede eliminarse a s√≠ mismo.")
            return

        reply = QMessageBox.question(self, "Confirmar Eliminaci√≥n",
                                     f"¬øEst√° seguro que desea eliminar al usuario:\n\n{nombre_seleccionado} (ID: {user_id_a_eliminar})?\n\nEsta acci√≥n no se puede deshacer.",
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.Cancel)

        if reply == QMessageBox.StandardButton.Yes:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("DELETE FROM usuarios WHERE id = ?", (user_id_a_eliminar,))
                    conn.commit()
                
                mostrar_info(f"Usuario {nombre_seleccionado} eliminado exitosamente.")
                self.limpiar_campos_usuario()
                self.cargar_tabla_usuarios()

            except sqlite3.Error as e:
                mostrar_error(f"Error al eliminar usuario: {e}")

            
    def limpiar_campos_usuario(self):
        """Limpia el formulario de gesti√≥n de usuarios y resetea el modo a 'Guardar'."""
        try:
            if hasattr(self, 'entry_usr_nombre'):
                self.entry_usr_nombre.clear()
                self.entry_usr_telefono.clear()
                self.entry_usr_email.clear()
                
                # --- INICIO DE MODIFICACI√ìN: Limpiar y HABILITAR checkboxes ---
                if hasattr(self, 'permisos_checkboxes'):
                    for checkbox in self.permisos_checkboxes.values():
                        checkbox.setChecked(False)
                        checkbox.setEnabled(True) # Asegurarse de que est√©n habilitados
                # --- FIN DE MODIFICACI√ìN ---
                
                self.usuario_seleccionado_id = None
                self.btn_guardar_usuario.setText("Guardar Usuario")
                self.btn_cambiar_password.setVisible(False)
                self.tabla_usuarios.clearSelection()
        except AttributeError:
            pass 

    def cargar_tabla_usuarios(self):
        """Carga la lista de usuarios (empleados) en la QTableWidget."""
        try: 
            if hasattr(self, 'tabla_usuarios'):
                self.tabla_usuarios.setRowCount(0)
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    # --- MODIFICADO: Quitar 'rol' ---
                    cursor.execute("SELECT id, nombre_completo, email FROM usuarios ORDER BY nombre_completo")
                    usuarios = cursor.fetchall()

                    self.tabla_usuarios.setRowCount(len(usuarios))
                    for row, usuario in enumerate(usuarios):
                        self.tabla_usuarios.setItem(row, 0, QTableWidgetItem(str(usuario['id'])))
                        self.tabla_usuarios.setItem(row, 1, QTableWidgetItem(usuario['nombre_completo']))
                        self.tabla_usuarios.setItem(row, 2, QTableWidgetItem(usuario['email']))
        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar tabla de usuarios: {e}")
        except AttributeError:
            pass
    
    # ---- P√ÅGINA 6: GESTIONAR MATERIAS ----
    def crear_pagina_gestion_materias(self):
        """Crea la interfaz para a√±adir o quitar materias a un curso."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_main = QHBoxLayout(widget)
        layout_main.setContentsMargins(15, 15, 15, 15)

        # Panel Izquierdo: Selecci√≥n de Curso
        panel_izq = QGroupBox("Seleccionar Curso")
        layout_izq = QVBoxLayout(panel_izq)
        
        self.combo_curso_materias = QComboBox()
        self.tabla_materias = QTableWidget(0, 2)
        self.tabla_materias.setHorizontalHeaderLabels(["ID", "Nombre de la Materia"])
        self.tabla_materias.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.Stretch)
        self.tabla_materias.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.tabla_materias.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)

        layout_izq.addWidget(QLabel("Curso:"))
        layout_izq.addWidget(self.combo_curso_materias)
        layout_izq.addWidget(self.tabla_materias)
        
        layout_main.addWidget(panel_izq, 1)

        # Panel Derecho: A√±adir/Eliminar Materias
        panel_der = QGroupBox("A√±adir/Eliminar Materia")
        layout_der = QFormLayout(panel_der)
        layout_der.setSpacing(10)

        self.entry_nombre_materia = QLineEdit()
        self.btn_anadir_materia = QPushButton("A√±adir Materia al Curso")
        self.btn_anadir_materia.setObjectName("primaryButton")
        
        self.btn_eliminar_materia = QPushButton("Eliminar Materia Seleccionada")
        self.btn_eliminar_materia.setObjectName("deleteButton")
        
        layout_der.addRow(QLabel("Nombre Nueva Materia:"), self.entry_nombre_materia)
        layout_der.addRow(self.btn_anadir_materia)
        layout_der.addRow(self.btn_eliminar_materia)
        
        layout_main.addWidget(panel_der)
        
        # Conexiones
        self.combo_curso_materias.currentIndexChanged.connect(self.cargar_tabla_materias)
        self.btn_anadir_materia.clicked.connect(self.anadir_materia)
        self.btn_eliminar_materia.clicked.connect(self.eliminar_materia)

        return widget

    def cargar_combo_cursos_materias(self):
        """Carga los cursos en el combo de la p√°g. de gesti√≥n de materias."""
        try:
            if not hasattr(self, 'combo_curso_materias'): return
            self.combo_curso_materias.clear()
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT id, nombre_curso FROM cursos ORDER BY nombre_curso")
                cursos = cursor.fetchall()
            
            self.combo_curso_materias.addItem("--- Seleccione un Curso ---", userData=None)
            for curso in cursos:
                self.combo_curso_materias.addItem(curso['nombre_curso'], userData=curso['id'])
        except Exception as e:
            mostrar_error(f"Error al cargar cursos para materias: {e}")

    def cargar_tabla_materias(self):
        """Carga las materias del curso seleccionado en la tabla."""
        try:
            if not hasattr(self, 'tabla_materias'): return
            self.tabla_materias.setRowCount(0)
            curso_id = self.combo_curso_materias.currentData()
            if not curso_id: return

            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT id, nombre_materia FROM materias WHERE curso_id = ? ORDER BY nombre_materia", (curso_id,))
                materias = cursor.fetchall()
            
            self.tabla_materias.setRowCount(len(materias))
            for row, materia in enumerate(materias):
                self.tabla_materias.setItem(row, 0, QTableWidgetItem(str(materia['id'])))
                self.tabla_materias.setItem(row, 1, QTableWidgetItem(materia['nombre_materia']))
        
        except Exception as e:
            mostrar_error(f"Error al cargar tabla de materias: {e}")

    def anadir_materia(self):
        curso_id = self.combo_curso_materias.currentData()
        nombre_materia = self.entry_nombre_materia.text().strip()
        
        if not curso_id or not nombre_materia:
            mostrar_error("Debe seleccionar un curso y escribir un nombre para la materia.")
            return
            
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("INSERT INTO materias (curso_id, nombre_materia) VALUES (?, ?)", (curso_id, nombre_materia))
                conn.commit()
            
            self.entry_nombre_materia.clear()
            self.cargar_tabla_materias() # Recargar la lista
        except Exception as e:
            mostrar_error(f"Error al a√±adir materia: {e}")

    def eliminar_materia(self):
        selected_items = self.tabla_materias.selectedItems()
        if not selected_items:
            mostrar_error("Seleccione una materia de la tabla para eliminar.")
            return
        
        materia_id = int(self.tabla_materias.item(self.tabla_materias.currentRow(), 0).text())
        
        reply = QMessageBox.question(self, "Confirmar Eliminaci√≥n",
                                     "¬øSeguro que desea eliminar esta materia?\nEsto eliminar√° tambi√©n todas las calificaciones asociadas a ella.",
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
        
        if reply == QMessageBox.StandardButton.Yes:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    # Gracias a "ON DELETE CASCADE" en la tabla calificaciones,
                    # SQLite borrar√° autom√°ticamente las calificaciones asociadas.
                    cursor.execute("DELETE FROM materias WHERE id = ?", (materia_id,))
                    conn.commit()
                self.cargar_tabla_materias()
            except Exception as e:
                mostrar_error(f"Error al eliminar materia: {e}")

    # ---- P√ÅGINA 7: ASIGNAR CALIFICACIONES ----
    def crear_pagina_gestion_calificaciones(self):
        """Crea la interfaz para asignar calificaciones a los alumnos."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_main = QHBoxLayout(widget)
        layout_main.setContentsMargins(15, 15, 15, 15)

        # Panel Izquierdo: Selecci√≥n de Curso y Alumno
        panel_izq = QGroupBox("Selecci√≥n")
        layout_izq = QVBoxLayout(panel_izq)
        
        self.combo_curso_calif = QComboBox()
        self.lista_alumnos_calif = QListWidget()
        
        layout_izq.addWidget(QLabel("1. Seleccione el Curso:"))
        layout_izq.addWidget(self.combo_curso_calif)
        layout_izq.addWidget(QLabel("2. Seleccione el Alumno:"))
        layout_izq.addWidget(self.lista_alumnos_calif)
        layout_main.addWidget(panel_izq, 1)

        # Panel Derecho: Tabla de Calificaciones
        panel_der = QGroupBox("Calificaciones del Alumno")
        layout_der = QVBoxLayout(panel_der)
        
        # --- INICIO DE MODIFICACI√ìN: A√±adir selector de parcial ---
        selector_layout = QHBoxLayout()
        selector_layout.addWidget(QLabel("Seleccionar Parcial:"))
        self.combo_parcial_select = QComboBox()
        self.combo_parcial_select.addItems(["Primer Parcial", "Segundo Parcial"])
        selector_layout.addWidget(self.combo_parcial_select)
        selector_layout.addStretch()
        layout_der.addLayout(selector_layout)
        # --- FIN DE MODIFICACI√ìN ---

        self.tabla_calificaciones = QTableWidget(0, 4) # ID_Materia (oculto), Materia, Calificaci√≥n, Observaciones
        self.tabla_calificaciones.setHorizontalHeaderLabels(["ID_Materia", "Materia", "Calificaci√≥n (0-10)", "Observaciones"])
        self.tabla_calificaciones.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.Stretch)
        self.tabla_calificaciones.horizontalHeader().setSectionResizeMode(3, QHeaderView.ResizeMode.Stretch)
        self.tabla_calificaciones.hideColumn(0) # Ocultamos la columna ID
        self.tabla_calificaciones.setEditTriggers(QTableWidget.EditTrigger.DoubleClicked) # Permitir edici√≥n
        
        self.btn_guardar_calificaciones = QPushButton("Guardar Calificaciones")
        self.btn_guardar_calificaciones.setObjectName("primaryButton")
        
        layout_der.addWidget(self.tabla_calificaciones)
        layout_der.addWidget(self.btn_guardar_calificaciones)
        layout_main.addWidget(panel_der, 2)
        
        # Conexiones
        self.combo_curso_calif.currentIndexChanged.connect(self.cargar_alumnos_para_calificar)
        self.lista_alumnos_calif.currentItemChanged.connect(self.cargar_tabla_calificaciones)
        self.btn_guardar_calificaciones.clicked.connect(self.guardar_calificaciones)
        
        # --- INICIO DE MODIFICACI√ìN: Conectar el nuevo ComboBox ---
        # (A√±adimos un lambda para que llame a la funci√≥n de recarga)
        self.combo_parcial_select.currentIndexChanged.connect(lambda: self.cargar_tabla_calificaciones(self.lista_alumnos_calif.currentItem(), None))
        # --- FIN DE MODIFICACI√ìN ---
        
        return widget
        
    def cargar_combo_cursos_calif(self):
        """Carga los cursos en el combo de la p√°g. de calificaciones."""
        try:
            if not hasattr(self, 'combo_curso_calif'): return
            self.combo_curso_calif.clear()
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT id, nombre_curso FROM cursos ORDER BY nombre_curso")
                cursos = cursor.fetchall()
            
            self.combo_curso_calif.addItem("--- Seleccione un Curso ---", userData=None)
            for curso in cursos:
                self.combo_curso_calif.addItem(curso['nombre_curso'], userData=curso['id'])
        except Exception as e:
            mostrar_error(f"Error al cargar cursos para calificar: {e}")

    def cargar_alumnos_para_calificar(self):
        """Carga la lista de alumnos inscritos en el curso seleccionado."""
        try:
            if not hasattr(self, 'lista_alumnos_calif'): return
            self.lista_alumnos_calif.clear()
            self.tabla_calificaciones.setRowCount(0)
            curso_id = self.combo_curso_calif.currentData()
            if not curso_id: return

            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT i.id, a.nombres, a.apellido_paterno, a.apellido_materno
                    FROM inscripciones i
                    JOIN alumnos a ON i.alumno_id = a.id
                    WHERE i.curso_id = ?
                    ORDER BY a.apellido_paterno
                """, (curso_id,))
                alumnos = cursor.fetchall()
            
            for alumno in alumnos:
                nombre_completo = f"{alumno['apellido_paterno']} {alumno['apellido_materno']}, {alumno['nombres']}"
                item = QListWidgetItem(nombre_completo)
                item.setData(Qt.ItemDataRole.UserRole, alumno['id']) # Guardamos el ID de INSCRIPCI√ìN
                self.lista_alumnos_calif.addItem(item)
        except Exception as e:
            mostrar_error(f"Error al cargar alumnos para calificar: {e}")

    def cargar_tabla_calificaciones(self, current_item, previous_item):
        """Carga las materias y las calificaciones existentes del alumno."""
        try:
            if not hasattr(self, 'tabla_calificaciones') or not current_item:
                self.tabla_calificaciones.setRowCount(0)
                return

            inscripcion_id = current_item.data(Qt.ItemDataRole.UserRole)
            curso_id = self.combo_curso_calif.currentData()
            
            # --- INICIO DE MODIFICACI√ìN: Determinar qu√© parcial cargar ---
            idx_parcial = self.combo_parcial_select.currentIndex()
            col_calif_db = f"parcial_{idx_parcial + 1}"
            col_obs_db = f"obs_{idx_parcial + 1}"
            # --- FIN DE MODIFICACI√ìN ---
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                # 1. Obtener todas las materias de ese curso
                cursor.execute("SELECT id, nombre_materia FROM materias WHERE curso_id = ?", (curso_id,))
                materias = cursor.fetchall()
                
                # 2. Obtener las calificaciones YA GUARDADAS
                # --- MODIFICADO: Seleccionar solo las columnas del parcial elegido ---
                cursor.execute(f"SELECT materia_id, {col_calif_db}, {col_obs_db} FROM calificaciones WHERE inscripcion_id = ?", (inscripcion_id,))
                
                # Mapear materia_id -> (calificacion, observacion)
                calif_guardadas = {
                    c['materia_id']: (c[col_calif_db], c[col_obs_db]) 
                    for c in cursor.fetchall()
                }

            self.tabla_calificaciones.setRowCount(len(materias))
            for row, materia in enumerate(materias):
                materia_id = materia['id']
                calif, obs = calif_guardadas.get(materia_id, (0.0, "")) # Default
                
                self.tabla_calificaciones.setItem(row, 0, QTableWidgetItem(str(materia_id)))
                self.tabla_calificaciones.setItem(row, 1, QTableWidgetItem(materia['nombre_materia']))
                self.tabla_calificaciones.setItem(row, 2, QTableWidgetItem(str(calif)))
                self.tabla_calificaciones.setItem(row, 3, QTableWidgetItem(obs))
                
                # La columna 1 (Materia) no debe ser editable
                item_materia = self.tabla_calificaciones.item(row, 1)
                item_materia.setFlags(item_materia.flags() & ~Qt.ItemFlag.ItemIsEditable)

        except Exception as e:
            mostrar_error(f"Error al cargar tabla de calificaciones: {e}")

    def guardar_calificaciones(self):
        """Guarda o actualiza las calificaciones de la tabla en la BD."""
        try:
            current_item = self.lista_alumnos_calif.currentItem()
            if not current_item:
                mostrar_error("Debe seleccionar un alumno.")
                return
            
            inscripcion_id = current_item.data(Qt.ItemDataRole.UserRole)
            
            # --- INICIO DE MODIFICACI√ìN: Determinar d√≥nde guardar ---
            idx_parcial = self.combo_parcial_select.currentIndex()
            col_calif_db = f"parcial_{idx_parcial + 1}"
            col_obs_db = f"obs_{idx_parcial + 1}"
            # --- FIN DE MODIFICACI√ìN ---
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                
                for row in range(self.tabla_calificaciones.rowCount()):
                    materia_id = int(self.tabla_calificaciones.item(row, 0).text())
                    
                    calificacion_str = self.tabla_calificaciones.item(row, 2).text()
                    try:
                        calificacion = float(calificacion_str)
                    except ValueError:
                        calificacion = 0.0
                        
                    observaciones = self.tabla_calificaciones.item(row, 3).text()
                    
                    # Usar "INSERT OR REPLACE" (UPSERT)
                    cursor.execute("SELECT id FROM calificaciones WHERE inscripcion_id = ? AND materia_id = ?", (inscripcion_id, materia_id))
                    existe = cursor.fetchone()
                    
                    if existe:
                        # Actualizar (MODIFICADO para guardar en la columna correcta)
                        query = f"""
                            UPDATE calificaciones SET {col_calif_db} = ?, {col_obs_db} = ?
                            WHERE id = ?
                        """
                        cursor.execute(query, (calificacion, observaciones, existe['id']))
                    else:
                        # Insertar (MODIFICADO para guardar en la columna correcta)
                        query = f"""
                            INSERT INTO calificaciones (inscripcion_id, materia_id, {col_calif_db}, {col_obs_db})
                            VALUES (?, ?, ?, ?)
                        """
                        cursor.execute(query, (inscripcion_id, materia_id, calificacion, observaciones))

                conn.commit()
            mostrar_info("Calificaciones guardadas exitosamente.")

        except Exception as e:
            mostrar_error(f"Error al guardar calificaciones: {e}")

    # ---- P√ÅGINA 6: CONFIGURACI√ìN (NUEVA) ----
    def crear_pagina_configuracion(self):
        """Crea la interfaz para la p√°gina de configuraci√≥n."""
        widget = QWidget()
        widget.setObjectName("contentPage")
        layout_principal = QVBoxLayout(widget)
        layout_principal.setContentsMargins(15, 15, 15, 15)
        layout_principal.setSpacing(20)
        layout_principal.setAlignment(Qt.AlignmentFlag.AlignTop) 

        # --- Grupo Apariencia ---
        group_apariencia = QGroupBox("Apariencia de la Aplicaci√≥n")
        group_apariencia.setMaximumWidth(400) 
        form_apariencia = QFormLayout(group_apariencia)

        # Combo para Tema (Claro/Oscuro)
        self.combo_tema = QComboBox()
        self.combo_tema.addItems(["Claro", "Oscuro"])
        self.combo_tema.setCurrentText(self.theme)
        self.combo_tema.currentTextChanged.connect(self.actualizar_tema)
        form_apariencia.addRow(QLabel("Tema General:"), self.combo_tema)

        # Combo para Color de Acento
        self.combo_acento = QComboBox()
        self.combo_acento.addItems(["Naranja", "Azul", "Verde"])
        self.combo_acento.setCurrentText(self.accent)
        self.combo_acento.currentTextChanged.connect(self.actualizar_tema)
        form_apariencia.addRow(QLabel("Color de Acento:"), self.combo_acento)
        
        # Placeholder para colores de logo
        lbl_colores_logo = QLabel("Pr√≥ximamente: Extraer colores del logo.")
        lbl_colores_logo.setObjectName("placeholderText")
        form_apariencia.addRow(QLabel("Colores del Logo:"), lbl_colores_logo)
        
        layout_principal.addWidget(group_apariencia)

        # --- Grupo Reloj ---
        group_reloj = QGroupBox("Configuraci√≥n de Hora")
        group_reloj.setMaximumWidth(400) 
        form_reloj = QFormLayout(group_reloj)
        
        lbl_zona_horaria = QLabel("Pr√≥ximamente: Ajuste de Zona Horaria / Formato 12h/24h.")
        lbl_zona_horaria.setObjectName("placeholderText")
        form_reloj.addRow(QLabel("Ajustes de Hora:"), lbl_zona_horaria)
        
        layout_principal.addWidget(group_reloj)

        return widget


    # --- NUEVAS FUNCIONES ---
    def cargar_cursos_para_filtro(self):
        """Carga los cursos en el combo de filtro de la p√°gina de alumnos."""
        if not hasattr(self, 'combo_filtro_curso'): return
        
        self.combo_filtro_curso.clear()
        
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT id, nombre_curso FROM cursos ORDER BY nombre_curso")
                cursos = cursor.fetchall()
                
            self.combo_filtro_curso.addItem("--- Todos los Alumnos ---", userData=None)
            
            for curso in cursos:
                # Almacenar el ID del curso como UserData
                self.combo_filtro_curso.addItem(curso['nombre_curso'], userData=curso['id'])

        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar cursos para filtro: {e}")
        except AttributeError:
            pass # Ignorar si el widget a√∫n no est√° listo

    def filtrar_alumnos_por_curso(self, index):
        """Maneja el cambio en el combo de filtro y recarga la tabla de alumnos."""
        # El UserData es el ID del curso o None para "Todos"
        curso_id = self.combo_filtro_curso.itemData(index)
        self.cargar_tabla_alumnos(curso_id=curso_id)

    def mostrar_expediente_alumno(self):
        """Muestra los detalles completos del alumno seleccionado en la tabla."""
        if not hasattr(self, 'expediente_texto'):
            return

        selected_items = self.tabla_alumnos.selectedItems()
        
        # Correcci√≥n: Limpiar el expediente si no hay elementos seleccionados
        if not selected_items or self.tabla_alumnos.currentRow() < 0:
            self.expediente_texto.clear()
            return

        # El ID se encuentra en la columna 0
        alumno_id_item = self.tabla_alumnos.item(self.tabla_alumnos.currentRow(), 0) 

        if not alumno_id_item:
            self.expediente_texto.clear()
            return

        try:
            alumno_id = int(alumno_id_item.text())
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM alumnos WHERE id = ?", (alumno_id,))
                datos = cursor.fetchone()

            if datos:
                expediente_str = f"""
                <b><u>Datos del Alumno</u></b><br>
                <b>ID:</b> {datos['id']}<br>
                <b>Nombre:</b> {datos['nombres']} {datos['apellido_paterno']} {datos['apellido_materno']}<br>
                <b>Edad:</b> {datos['edad']} a√±os<br>
                <b>Turno:</b> {datos['turno']}<br>
                <b>Tel√©fono:</b> {datos['telefono']}<br>
                <b>Email:</b> {datos['email']}<br>
                <b>Escuela Procedencia:</b> {datos['escuela_procedencia']}<br>
                <b>Escuela a Ingresar:</b> {datos['escuela_ingresar']}<br>
                <b>Autoriza Salida Solo:</b> {'S√≠' if datos['autoriza_salida_solo'] == 1 else 'No'}<br>
                <br>
                <b><u>Datos del Tutor</u></b><br>
                <b>Nombre:</b> {datos['tutor_nombres']} {datos['tutor_ap_paterno']} {datos['tutor_ap_materno']}<br>
                <b>Tel√©fono:</b> {datos['tutor_telefono']}<br>
                <br>
                <b><u>Domicilio</u></b><br>
                <b>Calle:</b> {datos['dom_calle']} <b>N¬∞ Ext:</b> {datos['dom_num_ext']} <b>N¬∞ Int:</b> {datos['dom_num_int']}<br>
                <b>Colonia:</b> {datos['dom_colonia']} <b>C.P.:</b> {datos['dom_cp']}<br>
                <b>Municipio:</b> {datos['dom_municipio']} <b>Estado:</b> {datos['dom_estado']}<br>
                <br>
                <b><u>Contactos de Emergencia</u></b><br>
                <b>1:</b> {datos['emerg_1_nombre']} ({datos['emerg_1_parentesco']}) - Tel: {datos['emerg_1_telefono']}<br>
                <b>2:</b> {datos['emerg_2_nombre']} ({datos['emerg_2_parentesco']}) - Tel: {datos['emerg_2_telefono']}<br>
                """
                self.expediente_texto.setHtml(expediente_str) 
            else:
                self.expediente_texto.setText("No se encontraron datos para el alumno seleccionado.")

        except ValueError:
            self.expediente_texto.setText("Error: ID de alumno inv√°lido.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al buscar expediente: {e}") 
            self.expediente_texto.clear()
        except Exception as e:
             mostrar_error(f"Error inesperado al mostrar expediente: {e}") 


    def dar_baja_alumno(self):
        """Elimina al alumno seleccionado de la base de datos."""
        if not hasattr(self, 'tabla_alumnos') or not hasattr(self, 'expediente_texto'):
            return

        selected_items = self.tabla_alumnos.selectedItems()
        if not selected_items:
            mostrar_error("Por favor, seleccione un alumno de la lista para dar de baja.")
            return

        selected_row = self.tabla_alumnos.currentRow()
        if selected_row < 0:
            mostrar_error("Por favor, seleccione un alumno de la lista para dar de baja.")
            return

        alumno_id_item = self.tabla_alumnos.item(selected_row, 0)
        nombre_item = self.tabla_alumnos.item(selected_row, 1) 
        ap_paterno_item = self.tabla_alumnos.item(selected_row, 2) 

        if not alumno_id_item or not nombre_item or not ap_paterno_item:
            mostrar_error("No se pudo obtener la informaci√≥n completa del alumno seleccionado.")
            return

        try:
            alumno_id = int(alumno_id_item.text())
            nombre_completo = f"{nombre_item.text()} {ap_paterno_item.text()}"

            reply = QMessageBox.question(self, "Confirmar Baja",
                                         f"¬øEst√° seguro que desea dar de baja al alumno:\n\n{nombre_completo} (ID: {alumno_id})?\n\nEsta acci√≥n eliminar√° tambi√©n todas sus inscripciones y pagos asociados. Esta acci√≥n no se puede deshacer.",
                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.Cancel)

            if reply == QMessageBox.StandardButton.Yes:
                with get_db_connection() as conn:
                    cursor = conn.cursor()

                    # 1. Obtener IDs de inscripciones del alumno
                    cursor.execute("SELECT id FROM inscripciones WHERE alumno_id = ?", (alumno_id,))
                    inscripciones_ids_tuples = cursor.fetchall() 
                    # Convertir lista de Rows a lista de IDs
                    inscripciones_ids = [row['id'] for row in inscripciones_ids_tuples]


                    # 2. Borrar pagos asociados a esas inscripciones (si hay alguna)
                    if inscripciones_ids:
                        # Crear placeholders (?) para la consulta IN
                        placeholders = ','.join('?' for _ in inscripciones_ids)
                        cursor.execute(f"DELETE FROM pagos WHERE inscripcion_id IN ({placeholders})", inscripciones_ids)

                    # 3. Borrar inscripciones del alumno
                    cursor.execute("DELETE FROM inscripciones WHERE alumno_id = ?", (alumno_id,))

                    # 4. Borrar al alumno
                    cursor.execute("DELETE FROM alumnos WHERE id = ?", (alumno_id,))

                    conn.commit()

                mostrar_info(f"Alumno {nombre_completo} (ID: {alumno_id}) dado de baja exitosamente.")
                self.cargar_tabla_alumnos() 
                self.expediente_texto.clear() 
                self.cargar_tabla_inscripciones_pagos()

        except ValueError:
            mostrar_error("Error: ID de alumno inv√°lido.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al dar de baja al alumno: {e}")
            print(f"--- SQLITE ERROR DETAILED: {e} ---") 
            traceback.print_exc()
        except Exception as e:
             mostrar_error(f"Error inesperado al dar de baja: {e}")
             print(f"--- UNEXPECTED ERROR DETAILED: {e} ---") 
             traceback.print_exc()


    # --- M√©todos de carga y registro (MODIFICADOS) ---

    def cargar_cache_inscripciones(self):
        """Carga TODAS las inscripciones (Pagadas, Parciales, Pendientes) en una cach√© local."""
        self._inscripciones_cache = []
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                # Consulta SQL modificada para INCLUIR TODAS las inscripciones, incluyendo el estado 'Pagado'.
                query = """
                SELECT
                    i.id, i.monto_total, i.monto_pagado, i.estado,
                    a.nombres, a.apellido_paterno, a.apellido_materno,
                    c.nombre_curso
                FROM inscripciones i
                JOIN alumnos a ON i.alumno_id = a.id
                LEFT JOIN cursos c ON i.curso_id = c.id
                ORDER BY a.apellido_paterno, c.nombre_curso
                """
                cursor.execute(query)
                inscripciones = cursor.fetchall()
                
            for inscripcion in inscripciones:
                # Calcular el saldo pendiente y crear el texto de visualizaci√≥n
                total = inscripcion['monto_total']
                pagado = inscripcion['monto_pagado']
                pendiente = total - pagado
                estado = inscripcion['estado']
                
                # Formato del texto: APELLIDO, NOMBRE - CURSO (Estado o Pendiente)
                if estado == 'Pagado':
                    status_text = "(Pagado)"
                elif estado == 'Pendiente':
                    status_text = f"(Pendiente: ${pendiente:.2f})"
                else: # Parcial
                    status_text = f"(Parcial: ${pendiente:.2f})"
                
                texto_completo = f"{inscripcion['apellido_paterno']} {inscripcion['apellido_materno']}, {inscripcion['nombres']} - {inscripcion['nombre_curso']} {status_text}"
                
                self._inscripciones_cache.append({
                    'id': inscripcion['id'],
                    'data': (inscripcion['id'], total, pagado),
                    'display_text': texto_completo,
                    'search_keys': texto_completo.lower() # Texto para b√∫squeda r√°pida
                })
        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar la cach√© de inscripciones: {e}")
            
        self.actualizar_combo_desde_cache()
    
    # ELIMINADO: La funci√≥n de b√∫squeda se elimina si el campo de b√∫squeda ya no est√°
    # def buscar_inscripcion(self, search_term):
    #     """Filtra el QComboBox de inscripciones usando la cach√© local."""
    #     search_term = search_term.lower().strip()
        
    #     if not search_term:
    #         self.actualizar_combo_desde_cache(self._inscripciones_cache)
    #         return

    #     filtered_results = [
    #         item for item in self._inscripciones_cache
    #         if search_term in item['search_keys']
    #     ]
        
    #     self.actualizar_combo_desde_cache(filtered_results)
    
    def actualizar_combo_desde_cache(self, items_to_display=None):
        """
        Rellena el QComboBox con los resultados filtrados o toda la cach√©.
        """
        if items_to_display is None:
            items_to_display = self._inscripciones_cache
            
        self.combo_inscripcion_pago.blockSignals(True) # Evitar que dispare currentIndexChanged
        self.combo_inscripcion_pago.clear()
        self.combo_inscripcion_pago.addItem("--- Seleccione una inscripci√≥n ---", userData=None)
        
        for item in items_to_display:
            self.combo_inscripcion_pago.addItem(item['display_text'], userData=item['data'])
            
        self.combo_inscripcion_pago.blockSignals(False)
        self.actualizar_detalles_pago() # Para limpiar los detalles si no hay selecci√≥n


    def cargar_tabla_inscripciones_pagos(self):
        """Recarga la cach√© de inscripciones y actualiza el combo."""
        # Esta funci√≥n ahora solo llama a cargar_cache_inscripciones
        self.cargar_cache_inscripciones()


    def actualizar_detalles_pago(self):
        """Actualiza los labels y la tabla de historial cuando se selecciona una inscripci√≥n."""
        try: 
            if hasattr(self, 'combo_inscripcion_pago'):
                data = self.combo_inscripcion_pago.currentData()

                if not data:
                    if hasattr(self, 'lbl_pago_total'): self.lbl_pago_total.setText("$ 0.00")
                    if hasattr(self, 'lbl_pago_pagado'): self.lbl_pago_pagado.setText("$ 0.00")
                    if hasattr(self, 'lbl_pago_pendiente'): self.lbl_pago_pendiente.setText("$ 0.00")
                    if hasattr(self, 'spin_monto_pago'): self.spin_monto_pago.setValue(0.0)
                    if hasattr(self, 'tabla_historial_pagos'): self.tabla_historial_pagos.setRowCount(0)
                    
                    if hasattr(self, 'spin_monto_pago'): self.spin_monto_pago.setEnabled(False)
                    if hasattr(self, 'btn_registrar_pago'): self.btn_registrar_pago.setEnabled(False)
                    
                    return

                insc_id, total, pagado = data
                pendiente = total - pagado
                
                # Deshabilitar el monto a pagar si ya est√° saldado
                if pendiente <= 0.001:
                    self.spin_monto_pago.setValue(0.00)
                    self.spin_monto_pago.setEnabled(False)
                    self.btn_registrar_pago.setEnabled(False)
                else:
                    self.spin_monto_pago.setValue(max(0.01, pendiente))
                    self.spin_monto_pago.setEnabled(True)
                    self.btn_registrar_pago.setEnabled(True)


                if hasattr(self, 'lbl_pago_total'): self.lbl_pago_total.setText(f"$ {total:.2f}")
                if hasattr(self, 'lbl_pago_pagado'): self.lbl_pago_pagado.setText(f"$ {pagado:.2f}")
                if hasattr(self, 'lbl_pago_pendiente'): self.lbl_pago_pendiente.setText(f"$ {pendiente:.2f}")

                # Cargar historial de pagos
                self.cargar_historial_pagos(insc_id)
        except AttributeError:
             pass 

    def cargar_historial_pagos(self, inscripcion_id):
        """Rellena la tabla con el historial de pagos de una inscripci√≥n."""
        try: 
            if hasattr(self, 'tabla_historial_pagos'):
                self.tabla_historial_pagos.setRowCount(0)
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("""
                    SELECT fecha_pago, monto, metodo_pago
                    FROM pagos
                    WHERE inscripcion_id = ?
                    ORDER BY fecha_pago DESC
                    """, (inscripcion_id,))

                    pagos = cursor.fetchall()

                    self.tabla_historial_pagos.setRowCount(len(pagos))
                    for row, pago in enumerate(pagos): 
                        self.tabla_historial_pagos.setItem(row, 0, QTableWidgetItem(pago['fecha_pago']))
                        item_monto = QTableWidgetItem(f"$ {pago['monto']:.2f}")
                        item_monto.setTextAlignment(Qt.AlignmentFlag.AlignRight | Qt.AlignmentFlag.AlignVCenter)
                        self.tabla_historial_pagos.setItem(row, 1, item_monto)
                        self.tabla_historial_pagos.setItem(row, 2, QTableWidgetItem(pago['metodo_pago']))

        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar historial de pagos: {e}")
        except AttributeError:
            pass 

    def registrar_pago(self):
        """Registra un nuevo pago en la BD."""
        data = self.combo_inscripcion_pago.currentData()
        if not data:
            mostrar_error("Debe seleccionar una inscripci√≥n.")
            return

        insc_id, monto_total, monto_pagado_actual = data
        monto_a_pagar = self.spin_monto_pago.value()

        if monto_a_pagar <= 0:
            mostrar_error("El monto a pagar debe ser mayor a cero.")
            return

        saldo_pendiente = monto_total - monto_pagado_actual
        if monto_a_pagar > saldo_pendiente + 0.001: 
             reply = QMessageBox.question(self, "Confirmar Sobrepago",
                                         f"El monto a pagar (${monto_a_pagar:.2f}) es mayor al saldo pendiente (${saldo_pendiente:.2f}).\n¬øDesea continuar?",
                                             QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
             if reply == QMessageBox.StandardButton.No:
                 return


        fecha_pago = datetime.date.today().isoformat()
        metodo_pago = self.combo_metodo_pago.currentText()

        nuevo_monto_pagado = monto_pagado_actual + monto_a_pagar
        
        # L√≥gica para determinar el nuevo estado
        if nuevo_monto_pagado >= monto_total - 0.001:
            nuevo_estado = 'Pagado'
        elif nuevo_monto_pagado > 0:
            nuevo_estado = 'Parcial'
        else:
            nuevo_estado = 'Pendiente'


        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()

                # 1. Insertar en la tabla de pagos
                cursor.execute("""
                INSERT INTO pagos (inscripcion_id, monto, fecha_pago, metodo_pago)
                VALUES (?, ?, ?, ?)
                """, (insc_id, monto_a_pagar, fecha_pago, metodo_pago))

                # 2. Actualizar la tabla de inscripciones
                cursor.execute("""
                UPDATE inscripciones
                SET monto_pagado = ?, estado = ?
                WHERE id = ?
                """, (nuevo_monto_pagado, nuevo_estado, insc_id))

                conn.commit()

                mostrar_info("Pago registrado exitosamente.")

                # Recargar todo
                self.cargar_tabla_inscripciones_pagos() 

        except sqlite3.Error as e:
            mostrar_error(f"Error al registrar el pago: {e}")

    # --- FUNCI√ìN NUEVA ---
    def actualizar_opciones_pago(self):
        """Actualiza el combo de planes de pago basado en el curso seleccionado."""
        try:
            if not hasattr(self, 'combo_tipo_pago_registro'): return 
            
            self.combo_tipo_pago_registro.clear()
            self.lbl_costo_total_registro.setText("$ 0.00")
            
            curso_id = self.combo_curso_registro.currentData()
            if not curso_id:
                self.combo_tipo_pago_registro.addItem("--- Seleccione un curso ---", userData=None)
                return
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM cursos WHERE id = ?", (curso_id,))
                curso = cursor.fetchone()
                
            if not curso:
                return
                
            self.combo_tipo_pago_registro.addItem("--- Seleccione un plan de pago ---", userData=None)
            
            # Usar Decimal para c√°lculos monetarios precisos
            quantizer = Decimal('0.01')
            
            if curso['costo_exhibicion'] > 0:
                costo = Decimal(curso['costo_exhibicion']).quantize(quantizer)
                texto = f"Una Sola Exhibici√≥n (${costo})"
                self.combo_tipo_pago_registro.addItem(texto, userData=("Exhibici√≥n √önica", float(costo), 1))

            if curso['costo_sem_15'] > 0:
                costo = Decimal(curso['costo_sem_15']).quantize(quantizer)
                pago = (costo / 15).quantize(quantizer, rounding=ROUND_HALF_UP)
                texto = f"Semanal (15 pagos de ${pago})"
                self.combo_tipo_pago_registro.addItem(texto, userData=("Semanal (15)", float(costo), 15))
              
            if curso['costo_sem_12'] > 0: 
                costo = Decimal(curso['costo_sem_12']).quantize(quantizer)
                pago = (costo / 12).quantize(quantizer, rounding=ROUND_HALF_UP) 
                texto = f"Semanal (12 pagos de ${pago})" 
                self.combo_tipo_pago_registro.addItem(texto, userData=("Semanal (12)", float(costo), 12)) 

            if curso['costo_mensual_3'] > 0:
                costo = Decimal(curso['costo_mensual_3']).quantize(quantizer)
                pago = (costo / 3).quantize(quantizer, rounding=ROUND_HALF_UP)
                texto = f"Mensual (3 pagos de ${pago})"
                self.combo_tipo_pago_registro.addItem(texto, userData=("Mensual (3)", float(costo), 3))

        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar planes de pago: {e}")
            
    # --- FUNCI√ìN NUEVA ---
    def actualizar_costo_total_label(self):
        """Actualiza el label de costo total al seleccionar un plan de pago."""
        try:
            if not hasattr(self, 'combo_tipo_pago_registro'): return
            
            data = self.combo_tipo_pago_registro.currentData()
            if data:
                plan, costo_total, num_pagos = data
                self.lbl_costo_total_registro.setText(f"$ {costo_total:.2f}")
            else:
                self.lbl_costo_total_registro.setText("$ 0.00")
        except AttributeError:
            pass 

    def cargar_combo_curso_registro(self):
        """Carga los cursos en el combo del formulario de registro."""
        try:
             if hasattr(self, 'combo_curso_registro'):
          
                current_id = self.combo_curso_registro.currentData()

                self.combo_curso_registro.clear()
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("SELECT id, nombre_curso FROM cursos ORDER BY nombre_curso")
                    cursos = cursor.fetchall()
                    self.combo_curso_registro.addItem("--- Seleccione un Curso ---", userData=None)
                 
                    found_index = -1
                    for index, curso in enumerate(cursos): 
                        user_data = curso['id']
                        self.combo_curso_registro.addItem(curso['nombre_curso'], userData=user_data)
                
                        if current_id is not None and curso['id'] == current_id:
                            found_index = index + 1

                if found_index != -1:
                    self.combo_curso_registro.setCurrentIndex(found_index)
                else:
                    self.actualizar_opciones_pago() 

        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar combo de cursos en registro: {e}")
        except AttributeError:
            pass 

    def registrar_alumno_e_inscribir(self):
        """Guarda un nuevo alumno y lo inscribe al curso seleccionado."""
        try:
            # Datos Alumno
            ap_paterno = self.entry_al_ap_paterno.text().strip()
            ap_materno = self.entry_al_ap_materno.text().strip()
            nombres = self.entry_al_nombres.text().strip()
            email = self.entry_al_email.text().strip()
            
            # --- VALIDACI√ìN ---
            if not ap_paterno or not nombres:
                mostrar_error("Apellido Paterno y Nombre(s) del alumno son obligatorios.")
                return
                
            # --- VALIDACI√ìN DE PLAN DE PAGO ---
            plan_data = self.combo_tipo_pago_registro.currentData()
            if not plan_data:
                mostrar_error("Debe seleccionar un plan de pago para inscribir al alumno.")
                return

            plan_nombre, monto_total, num_pagos = plan_data
            curso_id = self.combo_curso_registro.currentData()
            if not curso_id: 
                mostrar_error("Debe seleccionar un curso para inscribir al alumno.")
                return
                
            fecha_insc = datetime.date.today().isoformat()

        
            # Recolectar el resto de los datos
            esc_procedencia = self.entry_al_escuela_procedencia.text().strip()
            esc_ingresar = self.entry_al_escuela_ingresar.text().strip()
            edad_str = self.entry_al_edad.text().strip()
            telefono = self.entry_al_telefono.text().strip()
            turno = self.combo_al_turno.currentText()
            autoriza_salida = 1 if self.check_autoriza_salida.isChecked() else 0
            imprimir_poliza = self.check_imprimir_poliza.isChecked() 
            
            tutor_ap_paterno = self.entry_tutor_ap_paterno.text().strip()
            tutor_ap_materno = self.entry_tutor_ap_materno.text().strip()
            tutor_nombres = self.entry_tutor_nombres.text().strip()
            tutor_telefono = self.entry_tutor_telefono.text().strip()
            dom_calle = self.entry_dom_calle.text().strip()
            dom_num_int = self.entry_dom_num_int.text().strip()
            dom_num_ext = self.entry_dom_num_ext.text().strip()
            dom_colonia = self.entry_dom_colonia.text().strip()
            dom_municipio = self.entry_dom_municipio.text().strip()
            dom_estado = self.entry_dom_estado.text().strip()
            dom_cp = self.entry_dom_cp.text().strip()
            emerg_1_nombre = self.entry_emerg_1_nombre.text().strip()
            emerg_1_telefono = self.entry_emerg_1_telefono.text().strip()
            emerg_1_parentesco = self.entry_emerg_1_parentesco.text().strip()
            emerg_2_nombre = self.entry_emerg_2_nombre.text().strip()
            emerg_2_telefono = self.entry_emerg_2_telefono.text().strip()
            emerg_2_parentesco = self.entry_emerg_2_parentesco.text().strip()
            edad = int(edad_str) if edad_str.isdigit() else 0

            # --- Inserci√≥n en BD (Transacci√≥n) ---
            with get_db_connection() as conn:
                cursor = conn.cursor()

                # 1. Insertar Alumno
                cursor.execute("""
                INSERT INTO alumnos (
                    apellido_paterno, apellido_materno, nombres, escuela_procedencia,
                    escuela_ingresar, edad, telefono, email, turno,
                    tutor_ap_paterno, tutor_ap_materno, tutor_nombres, tutor_telefono,
                    dom_calle, dom_num_int, dom_num_ext, dom_colonia, dom_municipio,
                    dom_estado, dom_cp,
                    emerg_1_nombre, emerg_1_telefono, emerg_1_parentesco,
                    emerg_2_nombre, emerg_2_telefono, emerg_2_parentesco,
                    autoriza_salida_solo
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                """, (
                    ap_paterno, ap_materno, nombres, esc_procedencia,
                    esc_ingresar, edad, telefono, email, turno,
                    tutor_ap_paterno, tutor_ap_materno, tutor_nombres, tutor_telefono,
                    dom_calle, dom_num_int, dom_num_ext, dom_colonia, dom_municipio,
                    dom_estado, dom_cp,
                    emerg_1_nombre, emerg_1_telefono, emerg_1_parentesco,
                    emerg_2_nombre, emerg_2_telefono, emerg_2_parentesco,
                    autoriza_salida
                ))
                alumno_id = cursor.lastrowid

                # 2. Insertar Inscripci√≥n
                cursor.execute("""
                INSERT INTO inscripciones (alumno_id, curso_id, fecha_inscripcion, monto_total, estado, tipo_pago_seleccionado)
                VALUES (?, ?, ?, ?, 'Pendiente', ?)
                """, (alumno_id, curso_id, fecha_insc, monto_total, plan_nombre))
                inscripcion_id = cursor.lastrowid

                conn.commit()

                mostrar_info("Alumno registrado e inscrito al curso exitosamente.")

            # --- Preguntar para generar PDF ---
            reply = QMessageBox.question(self, "Generar PDF",
                                         "¬øDesea generar la ficha completa de inscripci√≥n en PDF ahora?",
                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)

            if reply == QMessageBox.StandardButton.Yes:
                self.generar_ficha_completa_pdf(inscripcion_id, imprimir_poliza) 

            self.limpiar_campos_alumno()
            self.cargar_datos_maestros() 

        except sqlite3.IntegrityError:
            mostrar_error("Error: El correo electr√≥nico ya existe o hubo un problema de integridad.")
        except ValueError:
            mostrar_error("Error: La edad debe ser un n√∫mero v√°lido.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al guardar e inscribir alumno: {e}")
        except Exception as e:
             mostrar_error(f"Error inesperado: {e}")


    def generar_ficha_completa_pdf(self, inscripcion_id, imprimir_poliza=False): 
        """Genera un PDF con todos los datos del alumno, curso y CALENDARIO DE PAGOS."""
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT
                        a.*,
                        i.id as inscripcion_id, i.fecha_inscripcion, i.monto_total, i.tipo_pago_seleccionado,
                        c.nombre_curso
                    FROM alumnos a
                    JOIN inscripciones i ON a.id = i.alumno_id
                    JOIN cursos c ON i.curso_id = c.id
                    WHERE i.id = ?
                """, (inscripcion_id,))
                datos = cursor.fetchone()

            if not datos:
                mostrar_error("No se encontraron datos completos para la ficha.")
                return

            temp_pdf = tempfile.NamedTemporaryFile(suffix=".pdf", delete=False)
            filename = temp_pdf.name
            temp_pdf.close() 

            c = canvas.Canvas(filename, pagesize=letter)
            width, height = letter
            
            # --- Estilos (Arial 12) ---
            styles = getSampleStyleSheet()
            styleN = ParagraphStyle(name='Normal_Arial', parent=styles['Normal'], fontName=FONT_NAME, fontSize=12, leading=14)
            styleH_centered = ParagraphStyle(name='Heading_Arial_Centered', parent=styles['Heading3'], fontName=FONT_BOLD_NAME, fontSize=12, alignment=TA_CENTER, spaceAfter=8)
            styleCosto = ParagraphStyle(name='Costo_Arial', parent=styles['Normal'], fontName=FONT_BOLD_NAME, fontSize=12, leading=14)
            styleSmall = ParagraphStyle(name='Small_Arial', parent=styles['Normal'], fontName=FONT_NAME, fontSize=8, leading=10)
            styleTitle = ParagraphStyle(name='Title_Arial', parent=styles['h1'], fontName=FONT_BOLD_NAME, fontSize=14, alignment=TA_CENTER, spaceAfter=16)
            
            # --- Estilos para P√≥liza (Optimizados) ---
            styleN_poliza = ParagraphStyle(name='Normal_Poliza', parent=styleN, fontName=FONT_NAME, fontSize=10, leading=12, alignment=TA_LEFT) 
            styleH_poliza = ParagraphStyle(name='Heading_Poliza', parent=styleN, fontName=FONT_BOLD_NAME, fontSize=11, leading=14, spaceBefore=10, alignment=TA_LEFT)
            styleN_terminos = ParagraphStyle(name='Normal_Terminos', parent=styleN, fontSize=11, leading=13, alignment=TA_LEFT)


            # ==================================================
            # --- P√ÅGINA 1: FICHA DE INSCRIPCI√ìN ---
            # ==================================================
            
            self.draw_watermark(c, width, height)
            self.draw_logo(c, width, height)

            # --- T√≠tulo ---
            titulo_texto = f"<b>Unidad Profesional de Asesor√≠as y Regularizaci√≥n (UPASER)<br/>Formato de Inscripci√≥n para el curso: {datos['nombre_curso']}</b>"
            title_p = Paragraph(titulo_texto, styleTitle)
            title_w, title_h = title_p.wrapOn(c, width - 2*inch, height)
            title_p.drawOn(c, inch, height - 0.75 * inch - title_h)
            current_y = height - 0.75 * inch - title_h - 16

            # --- Datos del Alumno ---
            current_y = self.draw_text_pdf(c, current_y, "Datos del Alumno", inch, styleH_centered)
            current_y = self.draw_text_pdf(c, current_y, f"Folio Alumno: {datos['id']}", inch, styleN)
            nombre_alumno_completo = f"{datos['nombres']} {datos['apellido_paterno']} {datos['apellido_materno']}"
            current_y = self.draw_text_pdf(c, current_y, f"Nombre: {nombre_alumno_completo}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Edad: {datos['edad']} a√±os | Turno: {datos['turno']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Tel√©fono: {datos['telefono']} | Email: {datos['email']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Escuela de Procedencia: {datos['escuela_procedencia']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Escuela a Ingresar: {datos['escuela_ingresar']}", inch, styleN)

            # --- Datos del Tutor ---
            current_y -= 0.15 * inch
            current_y = self.draw_text_pdf(c, current_y, "Datos del Padre o Tutor", inch, styleH_centered)
            nombre_tutor_completo = f"{datos['tutor_nombres']} {datos['tutor_ap_paterno']} {datos['tutor_ap_materno']}"
            current_y = self.draw_text_pdf(c, current_y, f"Nombre: {nombre_tutor_completo}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Tel√©fono: {datos['tutor_telefono']}", inch, styleN)

            # --- Domicilio ---
            current_y -= 0.15 * inch
            current_y = self.draw_text_pdf(c, current_y, "Domicilio", inch, styleH_centered)
            current_y = self.draw_text_pdf(c, current_y, f"Calle: {datos['dom_calle']} N¬∞ Ext: {datos['dom_num_ext']} N¬∞ Int: {datos['dom_num_int']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Colonia: {datos['dom_colonia']}, C.P. {datos['dom_cp']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Municipio: {datos['dom_municipio']}, Estado: {datos['dom_estado']}", inch, styleN)

            # --- Contactos de Emergencia ---
            current_y -= 0.15 * inch
            current_y = self.draw_text_pdf(c, current_y, "Contactos de Emergencia", inch, styleH_centered)
            current_y = self.draw_text_pdf(c, current_y, f"1. {datos['emerg_1_nombre']} ({datos['emerg_1_parentesco']}) - Tel: {datos['emerg_1_telefono']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"2. {datos['emerg_2_nombre']} ({datos['emerg_2_parentesco']}) - Tel: {datos['emerg_2_telefono']}", inch, styleN)

            # --- Datos del Curso Inscrito ---
            current_y -= 0.2 * inch
            current_y = self.draw_text_pdf(c, current_y, "Curso Inscrito", inch, styleH_centered)
            current_y = self.draw_text_pdf(c, current_y, f"Folio Inscripci√≥n a Curso: {datos['inscripcion_id']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Nombre del Curso: {datos['nombre_curso']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Plan de Pago: {datos['tipo_pago_seleccionado']}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"Costo Total: $ {datos['monto_total']:.2f}", inch, styleCosto)
            
            # --- CORRECCI√ìN: Separar Leyenda y Firma ---
            current_y = 2.5 * inch 

            # --- Autorizaci√≥n de Salida (si aplica) ---
            if datos['autoriza_salida_solo'] == 1:
                leyenda = f"Yo, {nombre_tutor_completo}, autorizo que mi hijo(a): {nombre_alumno_completo}, pueda retirarse de la instituci√≥n sin que acuda alguna persona mayor de edad a recogerlo al plantel, deslindando de toda responsabilidad a UPASER despu√©s de la hora de salida."
                current_y = self.draw_text_pdf(c, current_y + 0.2*inch, leyenda, inch, style=styleSmall) 
                
            
            # --- Firma ---
            firma_y_base = current_y - 0.5*inch 
            if datos['autoriza_salida_solo'] == 0: 
                firma_y_base = 1.5 * inch

            c.line(inch * 1.5, firma_y_base, width - (inch * 1.5), firma_y_base)
            c.setFont(FONT_NAME, 10)
            c.drawCentredString(width / 2, firma_y_base - 0.2 * inch, "Firma del Padre o Tutor")

            # ==================================================
            # --- P√ÅGINA 2: CALENDARIO DE PAGOS ---
            # ==================================================
            c.showPage() 
            self.draw_watermark(c, width, height)
            self.draw_logo(c, width, height)
            
            current_y = height - 1.5 * inch 

            current_y = self.draw_text_pdf(c, current_y, "Calendario de Pagos", inch, styleH_centered)
            
            plan_nombre = datos['tipo_pago_seleccionado']
            monto_total = Decimal(str(datos['monto_total']))
            fecha_inicio = datetime.date.fromisoformat(datos['fecha_inscripcion'])
            
            calendario_data = [["No. de Pago", "Fecha L√≠mite de Pago", "Monto"]]
            
            num_pagos = 1
            monto_pago = monto_total
            
            if plan_nombre == "Semanal (15)":
                num_pagos = 15
                monto_pago = (monto_total / 15).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)
            elif plan_nombre == "Semanal (12)": 
                num_pagos = 12
                monto_pago = (monto_total / 12).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)
            elif plan_nombre == "Mensual (3)":
                num_pagos = 3
                monto_pago = (monto_total / 3).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)
            
            monto_acumulado = Decimal('0.00')
            for i in range(num_pagos):
                fecha_pago = fecha_inicio
                if plan_nombre.startswith("Semanal"):
                    fecha_pago = fecha_inicio + datetime.timedelta(weeks=i)
                elif plan_nombre.startswith("Mensual"):
                    mes = fecha_inicio.month + i
                    a√±o = fecha_inicio.year + (mes - 1) // 12
                    mes = (mes - 1) % 12 + 1
                    dia = min(fecha_inicio.day, [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][mes])
                    if mes == 2 and dia == 28 and ((a√±o % 4 == 0 and a√±o % 100 != 0) or (a√±o % 400 == 0)):
                        dia = 29
                    fecha_pago = datetime.date(a√±o, mes, dia)

                
                monto_actual = monto_pago
                if i == num_pagos - 1:
                    monto_actual = monto_total - monto_acumulado
                    
                calendario_data.append([
                    str(i+1), 
                    fecha_pago.strftime("%Y-%m-%d"), 
                    f"$ {monto_actual:.2f}"
                ])
                monto_acumulado += monto_actual
            
            # Dibujar la tabla del calendario
            tabla_calendario = Table(calendario_data, colWidths=[1*inch, 2.5*inch, 2*inch])
            tabla_calendario.setStyle(TableStyle([
                ('BACKGROUND', (0,0), (-1,0), colors.grey),
                ('TEXTCOLOR', (0,0), (-1,0), colors.whitesmoke),
                ('ALIGN', (0,0), (-1,-1), 'CENTER'),
                ('FONTNAME', (0,0), (-1,0), FONT_BOLD_NAME),
                ('FONTNAME', (0,1), (-1,-1), FONT_NAME),
                ('FONTSIZE', (0,0), (-1,-1), 10),
                ('BOTTOMPADDING', (0,0), (-1,0), 6),
                
                ('BACKGROUND', (0,1), (-1,-1), colors.whitesmoke),
                ('GRID', (0,0), (-1,-1), 1, colors.black),
                ('ALIGN', (2,1), (2,-1), 'RIGHT'), 
            ]))

            w_tabla, h_tabla = tabla_calendario.wrapOn(c, width - 2*inch, height)
            if current_y - h_tabla < inch:
                self.draw_watermark(c, width, height)
                c.showPage()
                self.draw_watermark(c, width, height)
                self.draw_logo(c, width, height)
                current_y = height - inch
            
            tabla_calendario.drawOn(c, inch, current_y - h_tabla)
            current_y -= (h_tabla + 10)
            
            # --- FIN P√ÅGINA 2 ---
            
            # ==================================================
            # --- P√ÅGINAS 3 y 4: P√ìLIZA Y T√âRMINOS (Opcional) ---
            # ==================================================
            if imprimir_poliza:
                
                # --- P√ÅGINA 3: P√ìLIZA DE GARANT√çA ---
                c.showPage()
                self.draw_watermark(c, width, height)
                self.draw_logo(c, width, height)
                
                # Definir un Frame que ocupe la p√°gina, dejando m√°rgenes y espacio para firmas
                frame_poliza = Frame(inch, 2.5*inch, width - 2*inch, height - 4*inch, id='polizaFrame', leftPadding=0, topPadding=0, rightPadding=0, bottomPadding=0)
                
                story_poliza = []
                story_poliza.append(Paragraph("P√ìLIZA DE GARANT√çA", styleH_centered))
                story_poliza.append(Spacer(1, 0.2*inch))
                
                
                story_poliza.append(Paragraph("<b>DERECHOS</b>", styleH_poliza))
                story_poliza.append(Paragraph("a) Recibir sus clases conforme lo se√±ale su horario y fecha de evaluaci√≥n.", styleN_poliza))
                story_poliza.append(Paragraph("b) Conocer anticipadamente temarios, formas de trabajo y criterios de evaluaci√≥n de cada una de las asignaturas.", styleN_poliza))
                story_poliza.append(Paragraph("c) Ser tratado por sus docentes y autoridades educativas con cortes√≠a, respeto y amabilidad.", styleN_poliza))
                story_poliza.append(Spacer(1, 0.15*inch))
                
                story_poliza.append(Paragraph("<b>OBLIGACIONES</b>", styleH_poliza))
                story_poliza.append(Paragraph("a) Asistir a sus clases conforme al horario establecido, teniendo como margen de tiempo 10 min. Despu√©s de haber iniciado la clase, dos retardos equivalen a una falta.", styleN_poliza))
                story_poliza.append(Paragraph("b) Respetar el tiempo de receso otorgado (30 min.).", styleN_poliza))
                story_poliza.append(Paragraph("c) Ser respetuoso con sus compa√±eros, docentes y personal en general.", styleN_poliza))
                story_poliza.append(Paragraph("d) Mantener orden y disciplina.", styleN_poliza))
                story_poliza.append(Paragraph("e) Cumplir con tareas e investigaciones encomendados.", styleN_poliza))
                story_poliza.append(Paragraph("f) Conservar y cuidar la instituci√≥n.", styleN_poliza))
                story_poliza.append(Paragraph("g) Cumplir en tiempo y forma con los pagos estipulados.", styleN_poliza))
                story_poliza.append(Paragraph("<i>El incumplimiento de cualquiera de las obligaciones es motivo de la perdida de garant√≠a.</i>", styleN_poliza))
                story_poliza.append(Spacer(1, 0.15*inch))

                story_poliza.append(Paragraph("<b>ANULACI√ìN DE LA GARANT√çA</b>", styleH_poliza))
                story_poliza.append(Paragraph("‚Ä¢ Tener menos del 90% de asistencias, tomando en cuenta que por d√≠a se pueden ver una o m√°s clases; lo que equivale a una falta por materia.", styleN_poliza))
                story_poliza.append(Paragraph("‚Ä¢ Tener menos del 90% en entregas de tareas y actividades asignadas por el docente.", styleN_poliza))
                story_poliza.append(Paragraph("‚Ä¢ No a ver liquidado el total del curso antes de que finalice el mismo.", styleN_poliza))
                story_poliza.append(Paragraph("‚Ä¢ Tener menos de 80% en las evaluaciones que se har√°n por parte de UPASER.", styleN_poliza))
                story_poliza.append(Spacer(1, 0.15*inch))
                
                story_poliza.append(Paragraph("<b>NOTA.</b> El alumno podr√° solicitar su garant√≠a siempre y cuando cumpla con los requisitos antes mencionados.", styleN_poliza))
                story_poliza.append(Spacer(1, 0.15*inch))

                story_poliza.append(Paragraph("<b>CLAUSULA PARA USO DE MARTKETING</b>", styleH_poliza))
                story_poliza.append(Paragraph("El alumno autoriza expresamente a UPASER a captar, reproducir y utilizar su imagen, nombre y/o voz a trav√©s de fotograf√≠as, grabaciones de video o cualquier otro medio audiovisual, con fines exclusivamente publicitarios, institucionales, informativos y/o acad√©micos relacionados con las actividades de la instituci√≥n.", styleN_poliza))
                story_poliza.append(Paragraph("Dicha autorizaci√≥n se concede de manera gratuita, sin limitaci√≥n territorial ni temporal, y comprende su difusi√≥n en medios digitales, electr√≥nicos y redes sociales oficiales de UPASER, as√≠ como en cualquier otra plataforma en l√≠nea utilizada por la instituci√≥n.", styleN_poliza))

                # Construir la historia en el Frame
                frame_poliza.addFromList(story_poliza, c)
                
                # Dibujar firmas al final
                self.draw_double_signature(c, 2 * inch) 
                
                # --- P√ÅGINA 4: T√âRMINOS Y CONDICIONES ---
                c.showPage()
                self.draw_watermark(c, width, height)
                self.draw_logo(c, width, height)
                current_y = height - 1.5 * inch 
                
                # Definir un Frame que ocupe la p√°gina, dejando m√°rgenes y espacio para firmas
                frame_terminos = Frame(inch, 2.5*inch, width - 2*inch, height - 4*inch, id='terminosFrame', leftPadding=0, topPadding=0, rightPadding=0, bottomPadding=0)
                
                story_terminos = []
                story_terminos.append(Paragraph("T√âRMINOS Y CONDICIONES", styleH_centered))
                story_terminos.append(Spacer(1, 0.2*inch))
                
                story_terminos.append(Paragraph("Es de suma importancia leer cuidadosamente este apartado antes de iniciar tu curso, para que conozcas tus derechos y obligaciones como alumno UPASER.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("La Unidad Profesional de Asesor√≠a y Regularizaci√≥n (UPASER) tiene como garant√≠a que el alumno se quede en sus primeras 5 opciones que seleccione en el concurso ECOEMS/103 Municipios/EXAMEN DE INGRESO A UNIVERSIDAD (UNAM, IPN, UAM, UAEMex, ETC), asegurando que nuestro curso es competente bajo nuestro m√©todo de ense√±anza.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("Antes de efectuar el pago, el usuario deber√° aceptar la Pol√≠tica de Privacidad, una vez confirmado el pago del curso seleccionado por el aspirante este no podr√° solicitar reembolso.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("<b>I. Clases:</b> Est√°n sujetas a modificaciones, UPASER se reserva el derecho de cancelar o cambiar cualquier clase, se les notificara a los alumnos o participantes cualquier cambio a trav√©s de los grupos de WhatsApp oficiales. UPASER esta obligado a reponer la clase cancelada, si este fuera el caso.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("<b>II. Comportamiento:</b> UPASER se reserva el derecho de retirar a cualquier persona registrada en el curso, cuyo comportamiento sea considerado inapropiado, por parte de UPASER o sus docentes. En estas circunstancias UPASER no reembolsara ninguna tarifa.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("<b>III. Plazo para registrarse:</b> Estamos contentos de apoyar a nuestros alumnos con el proceso de registro en las plataformas oficiales COMIPEMS/103 MUNICIPIOS, sin embargo, es responsabilidad total del aspirante. En caso de que el aspirante no se registre en las fechas que la convocatoria este abierta no habr√° ning√∫n tipo de reembolso por el pago efectuado al curso de capacitaci√≥n.", styleN_terminos))
                story_terminos.append(Spacer(1, 0.2*inch))
                story_terminos.append(Paragraph("<b>IV. Talleres opcionales:</b> UPASER programara talleres a lo largo del curso de capacitaci√≥n, estos talleres son considerados un plus CON COSTO para cualquier alumno UPASER.", styleN_terminos))

                # Construir la historia en el Frame
                frame_terminos.addFromList(story_terminos, c)
                
            
                # Dibujar firmas al final
                self.draw_double_signature(c, 2 * inch) 
            
            # --- FIN DEL BLOQUE 'if imprimir_poliza' ---

            c.save()

            # --- ABRIR EL PDF ---
            self._temp_pdf_files.append(filename)
            url = QUrl.fromLocalFile(filename)
            QDesktopServices.openUrl(url)

            mostrar_info(f"Ficha PDF generada y abierta.")

        except Exception as e:
            mostrar_error(f"Error al generar o abrir PDF completo: {e}\n{traceback.format_exc()}")
    
    def generar_boleta_pdf(self):
        """Genera la boleta de calificaciones en PDF para el alumno seleccionado."""
        
        # 1. Obtener el Alumno ID seleccionado de la tabla
        selected_items = self.tabla_alumnos.selectedItems()
        if not selected_items or self.tabla_alumnos.currentRow() < 0:
            mostrar_error("Por favor, seleccione un alumno de la lista.")
            return

        try:
            alumno_id = int(self.tabla_alumnos.item(self.tabla_alumnos.currentRow(), 0).text())
        except Exception:
            mostrar_error("No se pudo obtener el ID del alumno seleccionado.")
            return
            
        inscripcion_id_seleccionada = None
        curso_nombre_seleccionado = ""
        
        # --- INICIO DE MODIFICACI√ìN: Cambiar a 2 parciales + Promedio Final ---
        parciales = ["Primer Parcial", "Segundo Parcial", "Promedio Final"]
        parcial_elegido, ok = QInputDialog.getItem(self, "Seleccionar Boleta",
                                                     "¬øQu√© boleta desea generar?",
                                                     parciales, 0, False)
        
        if not ok or not parcial_elegido:
            return # El usuario cancel√≥
        
        # Determinar columnas de la DB
        col_calif_db = ""
        col_obs_db = ""
        
        if parcial_elegido == "Primer Parcial":
            idx_parcial = 0
            col_calif_db = "parcial_1"
            col_obs_db = "obs_1"
        elif parcial_elegido == "Segundo Parcial":
            idx_parcial = 1
            col_calif_db = "parcial_2"
            col_obs_db = "obs_2"
        # Si es "Promedio Final", dejamos las variables vac√≠as por ahora
        # --- FIN DE MODIFICACI√ìN ---

        try:
            # 2. Verificar inscripciones del alumno
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT i.id, c.nombre_curso 
                    FROM inscripciones i
                    JOIN cursos c ON i.curso_id = c.id
                    WHERE i.alumno_id = ?
                """, (alumno_id,))
                inscripciones = cursor.fetchall()

            if not inscripciones:
                mostrar_error("Este alumno no est√° inscrito en ning√∫n curso.")
                return
            
            if len(inscripciones) == 1:
                inscripcion_id_seleccionada = inscripciones[0]['id']
                curso_nombre_seleccionado = inscripciones[0]['nombre_curso']
            else:
                nombres_cursos = [i['nombre_curso'] for i in inscripciones]
                curso_elegido, ok = QInputDialog.getItem(self, "Seleccionar Curso",
                                                         "Este alumno est√° en varios cursos. ¬øDe cu√°l desea generar la boleta?",
                                                         nombres_cursos, 0, False)
                if ok and curso_elegido:
                    for insc in inscripciones:
                        if insc['nombre_curso'] == curso_elegido:
                            inscripcion_id_seleccionada = insc['id']
                            curso_nombre_seleccionado = insc['nombre_curso']
                            break
                else:
                    return

            if not inscripcion_id_seleccionada:
                mostrar_error("No se pudo seleccionar una inscripci√≥n v√°lida.")
                return

            # 3. Obtener todos los datos para el PDF
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM alumnos WHERE id = ?", (alumno_id,))
                datos_alumno = cursor.fetchone()
                
                # --- INICIO DE MODIFICACI√ìN: L√≥gica para Promedio Final ---
                if parcial_elegido == "Promedio Final":
                    query = """
                        SELECT m.nombre_materia, c.parcial_1, c.parcial_2, c.obs_1, c.obs_2 
                        FROM calificaciones c
                        JOIN materias m ON c.materia_id = m.id
                        WHERE c.inscripcion_id = ?
                        ORDER BY m.nombre_materia
                    """
                    cursor.execute(query, (inscripcion_id_seleccionada,))
                else:
                    # L√≥gica original para parcial individual
                    query = f"""
                        SELECT m.nombre_materia, c.{col_calif_db} AS calificacion, c.{col_obs_db} AS observaciones 
                        FROM calificaciones c
                        JOIN materias m ON c.materia_id = m.id
                        WHERE c.inscripcion_id = ?
                        ORDER BY m.nombre_materia
                    """
                    cursor.execute(query, (inscripcion_id_seleccionada,))
                
                calificaciones = cursor.fetchall()
                # --- FIN DE MODIFICACI√ìN ---

            if not datos_alumno:
                mostrar_error("Error fatal: No se encontraron los datos del alumno.")
                return

            # 4. Generar el PDF
            temp_pdf = tempfile.NamedTemporaryFile(suffix=".pdf", delete=False)
            filename = temp_pdf.name
            temp_pdf.close() 

            c = canvas.Canvas(filename, pagesize=letter)
            width, height = letter
            
            styles = getSampleStyleSheet()
            styleN = ParagraphStyle(name='Normal_Arial', parent=styles['Normal'], fontName=FONT_NAME, fontSize=12, leading=14)
            styleH_centered = ParagraphStyle(name='Heading_Arial_Centered', parent=styles['Heading3'], fontName=FONT_BOLD_NAME, fontSize=12, alignment=TA_CENTER, spaceAfter=8)
            styleTitle = ParagraphStyle(name='Title_Arial', parent=styles['h1'], fontName=FONT_BOLD_NAME, fontSize=14, alignment=TA_CENTER, spaceAfter=16)

            self.draw_watermark(c, width, height)
            self.draw_logo(c, width, height)

            # T√≠tulo (MODIFICADO)
            titulo_texto = f"<b>Unidad Profesional de Asesor√≠as y Regularizaci√≥n (UPASER)<br/>Boleta de Calificaciones: {parcial_elegido.upper()}</b>"
            title_p = Paragraph(titulo_texto, styleTitle)
            title_w, title_h = title_p.wrapOn(c, width - 2*inch, height)
            title_p.drawOn(c, inch, height - 0.75 * inch - title_h)
            current_y = height - 0.75 * inch - title_h - 16

            # Datos
            nombre_alumno_completo = f"{datos_alumno['nombres']} {datos_alumno['apellido_paterno']} {datos_alumno['apellido_materno']}"
            current_y = self.draw_text_pdf(c, current_y, f"<b>Alumno:</b> {nombre_alumno_completo}", inch, styleN)
            current_y = self.draw_text_pdf(c, current_y, f"<b>Curso:</b> {curso_nombre_seleccionado}", inch, styleN)
            current_y -= 0.25 * inch

            # --- INICIO DE MODIFICACI√ìN: Columnas din√°micas para Promedio ---
            if parcial_elegido == "Promedio Final":
                data_tabla = [["Materia", "Parcial 1", "Parcial 2", "Promedio"]]
                colWidths = [3*inch, 1.5*inch, 1.5*inch, 1.5*inch]
            else:
                data_tabla = [["Materia", "Calificaci√≥n", "Observaciones"]]
                colWidths = [2.5*inch, 1.5*inch, 2.5*inch]
            # --- FIN DE MODIFICACI√ìN ---
            
            total_promedio_final = 0.0
            num_materias = 0

            if calificaciones:
                for calif in calificaciones:
                    # --- INICIO DE MODIFICACI√ìN: L√≥gica de llenado de tabla ---
                    if parcial_elegido == "Promedio Final":
                        p1 = calif['parcial_1']
                        p2 = calif['parcial_2']
                        promedio_materia = (p1 + p2) / 2.0
                        data_tabla.append([
                            Paragraph(calif['nombre_materia'], styleN),
                            f"{p1:.1f}",
                            f"{p2:.1f}",
                            f"{promedio_materia:.1f}"
                        ])
                        total_promedio_final += promedio_materia
                        num_materias += 1
                    else:
                        # L√≥gica original
                        data_tabla.append([
                            Paragraph(calif['nombre_materia'], styleN),
                            f"{calif['calificacion']:.1f}",
                            Paragraph(calif['observaciones'], styleN)
                        ])
                        total_promedio_final += calif['calificacion']
                        num_materias += 1
                    # --- FIN DE MODIFICACI√ìN ---
            else:
                # L√≥gica original adaptada
                if parcial_elegido == "Promedio Final":
                     data_tabla.append(["(Sin materias asignadas)", "", "", ""])
                else:
                     data_tabla.append(["(Sin materias asignadas)", "", ""])

            tabla_calif = Table(data_tabla, colWidths=colWidths)
            
            # --- INICIO DE MODIFICACI√ìN: Estilo din√°mico ---
            if parcial_elegido == "Promedio Final":
                table_style = TableStyle([
                    ('BACKGROUND', (0,0), (-1,0), colors.grey),
                    ('TEXTCOLOR', (0,0), (-1,0), colors.whitesmoke),
                    ('ALIGN', (0,0), (-1,-1), 'CENTER'),
                    ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
                    ('FONTNAME', (0,0), (-1,0), FONT_BOLD_NAME),
                    ('FONTNAME', (0,1), (-1,-1), FONT_NAME),
                    ('FONTSIZE', (0,0), (-1,-1), 10),
                    ('BOTTOMPADDING', (0,0), (-1,0), 6),
                    ('BACKGROUND', (0,1), (-1,-1), colors.whitesmoke),
                    ('GRID', (0,0), (-1,-1), 1, colors.black),
                    ('ALIGN', (0,1), (0,-1), 'LEFT'), # Materias a la izquierda
                ])
            else:
                 table_style = TableStyle([
                    ('BACKGROUND', (0,0), (-1,0), colors.grey),
                    ('TEXTCOLOR', (0,0), (-1,0), colors.whitesmoke),
                    ('ALIGN', (0,0), (-1,-1), 'CENTER'),
                    ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
                    ('FONTNAME', (0,0), (-1,0), FONT_BOLD_NAME),
                    ('FONTNAME', (0,1), (-1,-1), FONT_NAME),
                    ('FONTSIZE', (0,0), (-1,-1), 10),
                    ('BOTTOMPADDING', (0,0), (-1,0), 6),
                    ('BACKGROUND', (0,1), (-1,-1), colors.whitesmoke),
                    ('GRID', (0,0), (-1,-1), 1, colors.black),
                    ('ALIGN', (0,1), (0,-1), 'LEFT'), # Materias a la izquierda
                    ('ALIGN', (2,1), (2,-1), 'LEFT'), # Observaciones a la izquierda
                ])
            tabla_calif.setStyle(table_style)
            # --- FIN DE MODIFICACI√ìN ---
            
            w_tabla, h_tabla = tabla_calif.wrapOn(c, width - 2*inch, height)
            x_centered = (width - w_tabla) / 2.0
            tabla_calif.drawOn(c, x_centered, current_y - h_tabla)
            current_y -= (h_tabla + 0.25 * inch)

            # Promedio (MODIFICADO)
            promedio_final = (total_promedio_final / num_materias) if num_materias > 0 else 0.0
            
            # --- INICIO DE MODIFICACI√ìN: T√≠tulo del promedio ---
            promedio_titulo = f"PROMEDIO {parcial_elegido.upper()}"
            if parcial_elegido == "Promedio Final":
                promedio_titulo = "PROMEDIO GENERAL"
                
            current_y = self.draw_text_pdf(c, current_y, f"<b>{promedio_titulo}: {promedio_final:.2f}</b>", inch, styleN)
            # --- FIN DE MODIFICACI√ìN ---
            
            # Firma
            firma_y_base = 2 * inch
            c.line(inch * 2.5, firma_y_base, width - (inch * 2.5), firma_y_base)
            c.setFont(FONT_NAME, 10)
            c.drawCentredString(width / 2, firma_y_base - 0.2 * inch, "Control Escolar UPASER")

            # Guardar y abrir
            c.save()
            self._temp_pdf_files.append(filename)
            url = QUrl.fromLocalFile(filename)
            QDesktopServices.openUrl(url)

        except Exception as e:
            mostrar_error(f"Error al generar boleta PDF: {e}\n{traceback.format_exc()}")

    def limpiar_archivos_temporales(self):
        """Elimina los archivos PDF temporales creados."""
        print("Limpiando archivos PDF temporales...")
        for filepath in self._temp_pdf_files:
            try:
                if os.path.exists(filepath):
                    os.remove(filepath)
                    print(f"Eliminado: {filepath}")
            except Exception as e:
                print(f"Error al eliminar archivo temporal {filepath}: {e}")


    def limpiar_campos_alumno(self):
        """Limpia todos los campos del formulario de registro de alumno."""
        # Alumno
        self.entry_al_ap_paterno.clear()
        self.entry_al_ap_materno.clear()
        self.entry_al_nombres.clear()
        self.entry_al_escuela_procedencia.clear()
        self.entry_al_escuela_ingresar.clear()
        self.entry_al_edad.clear()
        self.entry_al_telefono.clear()
        self.entry_al_email.clear()
        self.combo_al_turno.setCurrentIndex(0)
        self.combo_curso_registro.setCurrentIndex(0) 
        self.check_autoriza_salida.setChecked(False)
        self.check_imprimir_poliza.setChecked(False) 
        # Tutor
        self.entry_tutor_ap_paterno.clear()
        self.entry_tutor_ap_materno.clear()
        self.entry_tutor_nombres.clear()
        self.entry_tutor_telefono.clear()
        # Domicilio
        self.entry_dom_calle.clear()
        self.entry_dom_num_int.clear()
        self.entry_dom_num_ext.clear()
        self.entry_dom_colonia.clear()
        self.entry_dom_municipio.clear()
        self.entry_dom_estado.clear()
        self.entry_dom_cp.clear()
        # Emergencia
        self.entry_emerg_1_nombre.clear()
        self.entry_emerg_1_telefono.clear()
        self.entry_emerg_1_parentesco.clear()
        self.entry_emerg_2_nombre.clear()
        self.entry_emerg_2_telefono.clear()
        self.entry_emerg_2_parentesco.clear()

    def cargar_tabla_alumnos(self, curso_id=None):
        """
        Carga la lista de alumnos en la QTableWidget. 
        Si se proporciona un curso_id, filtra por ese curso.
        """
        try: 
            if not hasattr(self, 'tabla_alumnos'): return

            self.tabla_alumnos.setRowCount(0)
            self.expediente_texto.clear()
            
            # --- Consulta SQL modificada para obtener el nombre del curso ---
            query = """
            SELECT 
                a.id, a.nombres, a.apellido_paterno, a.apellido_materno, a.email, c.nombre_curso 
            FROM 
                alumnos a
            LEFT JOIN inscripciones i ON a.id = i.alumno_id
            LEFT JOIN cursos c ON i.curso_id = c.id
            """
            params = []
            
            if curso_id is not None:
                query += " WHERE i.curso_id = ?"
                params.append(curso_id)

            query += " ORDER BY a.apellido_paterno"
            # --- Fin Consulta SQL ---
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute(query, tuple(params))
                alumnos = cursor.fetchall()

            self.tabla_alumnos.setRowCount(len(alumnos))
            for row, alumno in enumerate(alumnos):
                curso_nombre = alumno['nombre_curso'] if alumno['nombre_curso'] else "No Inscrito"
                
                self.tabla_alumnos.setItem(row, 0, QTableWidgetItem(str(alumno['id'])))
                self.tabla_alumnos.setItem(row, 1, QTableWidgetItem(alumno['nombres']))
                self.tabla_alumnos.setItem(row, 2, QTableWidgetItem(alumno['apellido_paterno']))
                self.tabla_alumnos.setItem(row, 3, QTableWidgetItem(alumno['apellido_materno']))
                self.tabla_alumnos.setItem(row, 4, QTableWidgetItem(alumno['email']))
                self.tabla_alumnos.setItem(row, 5, QTableWidgetItem(curso_nombre)) # Nueva Columna

        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar tabla de alumnos: {e}")
        except AttributeError:
            pass 

    def registrar_curso(self):
        """DEPRECADO: Usar guardar_curso."""
        self.guardar_curso()

    def guardar_curso(self):
        """Guarda un nuevo curso o actualiza uno existente."""
        if not all(hasattr(self, w) for w in ['entry_cur_nombre', 'spin_costo_exhibicion', 'spin_costo_sem_15', 'spin_costo_sem_12', 'spin_costo_mensual_3']):
            return 

        nombre = self.entry_cur_nombre.text().strip()
        costo_exhibicion = self.spin_costo_exhibicion.value()
        costo_sem_15 = self.spin_costo_sem_15.value()
        costo_sem_12 = self.spin_costo_sem_12.value() 
        costo_mensual_3 = self.spin_costo_mensual_3.value()

        if not nombre:
            mostrar_error("El nombre del curso es obligatorio.")
            return
        if costo_exhibicion == 0 and costo_sem_15 == 0 and costo_sem_12 == 0 and costo_mensual_3 == 0: 
            mostrar_error("Debe definir al menos un plan de costo para el curso.")
            return

        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                if self.curso_seleccionado_id is None:
                    # --- CREAR NUEVO CURSO ---
                    cursor.execute("""
                    INSERT INTO cursos (nombre_curso, costo_exhibicion, costo_sem_15, costo_sem_12, costo_mensual_3)
                    VALUES (?, ?, ?, ?, ?)
                    """, (nombre, costo_exhibicion, costo_sem_15, costo_sem_12, costo_mensual_3)) 
                    mostrar_info("Curso guardado exitosamente.")
                else:
                    # --- ACTUALIZAR CURSO EXISTENTE ---
                    cursor.execute("""
                    UPDATE cursos SET nombre_curso = ?, costo_exhibicion = ?, costo_sem_15 = ?, costo_sem_12 = ?, costo_mensual_3 = ?
                    WHERE id = ?
                    """, (nombre, costo_exhibicion, costo_sem_15, costo_sem_12, costo_mensual_3, self.curso_seleccionado_id))
                    mostrar_info(f"Curso (ID: {self.curso_seleccionado_id}) actualizado exitosamente.")
                
                conn.commit()

            self.limpiar_campos_curso()
            self.cargar_datos_maestros() 

        except sqlite3.IntegrityError:
            mostrar_error("Error: El nombre del curso ya existe.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al guardar curso: {e}")

    def limpiar_campos_curso(self):
        """Limpia el formulario de cursos y resetea el modo a 'Guardar'."""
        try: 
            if hasattr(self, 'entry_cur_nombre'):
                self.entry_cur_nombre.clear()
                self.spin_costo_exhibicion.setValue(0.0)
                self.spin_costo_sem_15.setValue(0.0)
                self.spin_costo_sem_12.setValue(0.0) 
                self.spin_costo_mensual_3.setValue(0.0)
                
                self.curso_seleccionado_id = None
                self.btn_guardar_curso.setText("Guardar Curso")
                self.tabla_cursos.clearSelection()
        except AttributeError:
            pass 

    def seleccionar_curso_para_edicion(self):
        """Carga los datos del curso seleccionado en el formulario de edici√≥n."""
        selected_items = self.tabla_cursos.selectedItems()
        if not selected_items:
            self.limpiar_campos_curso()
            return

        selected_row = self.tabla_cursos.currentRow()
        if selected_row < 0:
             self.limpiar_campos_curso()
             return
            
        curso_id_item = self.tabla_cursos.item(selected_row, 0)
        if not curso_id_item: return

        try:
            curso_id = int(curso_id_item.text())
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM cursos WHERE id = ?", (curso_id,))
                datos = cursor.fetchone()

            if datos:
                self.curso_seleccionado_id = curso_id
                self.entry_cur_nombre.setText(datos['nombre_curso'])
                self.spin_costo_exhibicion.setValue(datos['costo_exhibicion'])
                self.spin_costo_sem_15.setValue(datos['costo_sem_15'])
                self.spin_costo_sem_12.setValue(datos['costo_sem_12'])
                self.spin_costo_mensual_3.setValue(datos['costo_mensual_3'])
                
                self.btn_guardar_curso.setText("Actualizar Curso")

        except Exception as e:
            mostrar_error(f"Error al cargar datos de curso: {e}")
            self.limpiar_campos_curso()
            
    def dar_baja_curso(self):
        """Elimina un curso seleccionado de la BD."""
        selected_items = self.tabla_cursos.selectedItems()
        if not selected_items:
            mostrar_error("Por favor, seleccione un curso de la lista para eliminar.")
            return
        
        selected_row = self.tabla_cursos.currentRow()
        if selected_row < 0: return
        
        curso_id_item = self.tabla_cursos.item(selected_row, 0)
        nombre_curso_item = self.tabla_cursos.item(selected_row, 1)
        if not curso_id_item: return
        
        curso_id = int(curso_id_item.text())
        nombre_curso = nombre_curso_item.text()
        
        # --- VERIFICACI√ìN DE ALUMNOS INSCRITOS ---
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT COUNT(id) as count FROM inscripciones WHERE curso_id = ?", (curso_id,))
                conteo = cursor.fetchone()
        
            if conteo['count'] > 0:
                mostrar_error(f"No se puede eliminar el curso '{nombre_curso}' porque tiene {conteo['count']} alumno(s) inscrito(s).")
                return

            # Si no hay alumnos, proceder a eliminar
            reply = QMessageBox.question(self, "Confirmar Eliminaci√≥n",
                                         f"¬øEst√° seguro que desea eliminar al curso:\n\n{nombre_curso} (ID: {curso_id})?\n\nEsta acci√≥n no se puede deshacer.",
                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.Cancel)

            if reply == QMessageBox.StandardButton.Yes:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("DELETE FROM cursos WHERE id = ?", (curso_id,))
                    conn.commit()
                
                mostrar_info(f"Curso '{nombre_curso}' eliminado exitosamente.")
                self.limpiar_campos_curso()
                self.cargar_datos_maestros()

        except sqlite3.Error as e:
            mostrar_error(f"Error al eliminar curso: {e}")
        except Exception as e:
             mostrar_error(f"Error inesperado: {e}")


    def cargar_tabla_cursos(self):
        """Carga la lista de cursos en la QTableWidget."""
        try: 
            if hasattr(self, 'tabla_cursos'):
                self.tabla_cursos.setRowCount(0)
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("SELECT * FROM cursos ORDER BY nombre_curso")
                    cursos = cursor.fetchall()

                    self.tabla_cursos.setRowCount(len(cursos))
            for row, curso in enumerate(cursos):
                        self.tabla_cursos.setItem(row, 0, QTableWidgetItem(str(curso['id'])))
                        self.tabla_cursos.setItem(row, 1, QTableWidgetItem(curso['nombre_curso']))
                        self.tabla_cursos.setItem(row, 2, QTableWidgetItem(f"$ {curso['costo_exhibicion']:.2f}"))
                        self.tabla_cursos.setItem(row, 3, QTableWidgetItem(f"$ {curso['costo_sem_15']:.2f}"))
                        self.tabla_cursos.setItem(row, 4, QTableWidgetItem(f"$ {curso['costo_sem_12']:.2f}")) 
                        self.tabla_cursos.setItem(row, 5, QTableWidgetItem(f"$ {curso['costo_mensual_3']:.2f}"))
                   
                        # Alinear costos a la derecha
                        for col in range(2, 6):
                            item = self.tabla_cursos.item(row, col)
                            if item:
                                item.setTextAlignment(Qt.AlignmentFlag.AlignRight | Qt.AlignmentFlag.AlignVCenter)
                                
        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar tabla de cursos: {e}")
        except AttributeError:
            pass 

    def registrar_nuevo_usuario(self):
        """DEPRECADO: Usar guardar_usuario."""
        self.guardar_usuario() 

    def guardar_usuario(self):
        """Guarda un usuario nuevo o actualiza uno existente."""
        if not all(hasattr(self, w) for w in ['entry_usr_nombre', 'entry_usr_email', 'permisos_checkboxes']):
            return 

        nombre = self.entry_usr_nombre.text().strip()
        telefono = self.entry_usr_telefono.text().strip()
        email = self.entry_usr_email.text().strip()
        
        if not nombre or not email:
            mostrar_error("Nombre Completo y Correo Electr√≥nico son obligatorios.")
            return
            
        # --- INICIO DE MODIFICACI√ìN: Construir diccionario de permisos ---
        permisos_dict = {}
        for clave, checkbox in self.permisos_checkboxes.items():
            permisos_dict[clave] = checkbox.isChecked()
        
        # Convertir a JSON
        permisos_json = json.dumps(permisos_dict)
        # --- FIN DE MODIFICACI√ìN ---
            
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                
                if self.usuario_seleccionado_id is None:
                    # --- CREAR NUEVO USUARIO ---
                    password = secrets.token_hex(4) 
                    cursor.execute("""
                    INSERT INTO usuarios (nombre_completo, telefono, email, permisos, password)
                    VALUES (?, ?, ?, ?, ?)
                    """, (nombre, telefono, email, permisos_json, password))
                    user_id = cursor.lastrowid 
                    conn.commit()
                    
                    mostrar_info(f"Usuario creado exitosamente:\n\n"
                                 f"No. de Empleado (ID): {user_id}\n"
                                 f"Usuario (Email): {email}\n"
                                 f"Contrase√±a: {password}\n\n"
                                 "Por favor, guarde esta contrase√±a. No se puede recuperar.")
                
                else:
                    # --- ACTUALIZAR USUARIO EXISTENTE ---
                    cursor.execute("""
                    UPDATE usuarios SET nombre_completo = ?, telefono = ?, email = ?, permisos = ?
                    WHERE id = ?
                    """, (nombre, telefono, email, permisos_json, self.usuario_seleccionado_id))
                    conn.commit()
                    mostrar_info(f"Usuario (ID: {self.usuario_seleccionado_id}) actualizado exitosamente.")
                         
            self.limpiar_campos_usuario()
            self.cargar_tabla_usuarios()
            
        except sqlite3.IntegrityError:
            mostrar_error("Error: Ese correo electr√≥nico ya est√° registrado.")
        except sqlite3.Error as e:
            mostrar_error(f"Error al registrar usuario: {e}")

    def cambiar_password_usuario(self):
        """Cambia la contrase√±a del usuario seleccionado."""
        if self.usuario_seleccionado_id is None:
            mostrar_error("No hay ning√∫n usuario seleccionado.")
            return

        nueva_pass, ok = QInputDialog.getText(self, "Cambiar Contrase√±a",
                                              "Ingrese la nueva contrase√±a:", QLineEdit.EchoMode.Password)
        
        if ok and nueva_pass:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("UPDATE usuarios SET password = ? WHERE id = ?", (nueva_pass, self.usuario_seleccionado_id))
                    conn.commit()
                mostrar_info("Contrase√±a actualizada exitosamente.")
            except sqlite3.Error as e:
                mostrar_error(f"Error al cambiar la contrase√±a: {e}")
        elif ok and not nueva_pass:
            mostrar_error("La contrase√±a no puede estar vac√≠a.")

    def seleccionar_usuario_para_edicion(self):
        """Carga los datos del usuario seleccionado en el formulario de edici√≥n."""
        selected_items = self.tabla_usuarios.selectedItems()
        if not selected_items:
            self.limpiar_campos_usuario() 
            return

        selected_row = self.tabla_usuarios.currentRow()
        
        if selected_row < 0:
             self.limpiar_campos_usuario()
             return
             
        user_id_item = self.tabla_usuarios.item(selected_row, 0)
        if not user_id_item: return

        try:
            user_id = int(user_id_item.text())
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM usuarios WHERE id = ?", (user_id,))
                datos = cursor.fetchone()

            if datos:
                self.usuario_seleccionado_id = user_id
                self.entry_usr_nombre.setText(datos['nombre_completo'])
                self.entry_usr_telefono.setText(datos['telefono'])
                self.entry_usr_email.setText(datos['email'])
                
                # --- INICIO DE MODIFICACI√ìN: Cargar permisos ---
                try:
                    permisos_dict = json.loads(datos['permisos'])
                except json.JSONDecodeError:
                    permisos_dict = {} # Fallback

                # Asignar el estado de los checkboxes
                for clave, checkbox in self.permisos_checkboxes.items():
                    checkbox.setChecked(permisos_dict.get(clave, False))
                # --- FIN DE MODIFICACI√ìN ---
                
                self.btn_guardar_usuario.setText("Actualizar Usuario")
                
                # Proteger al Admin ID 1
                if user_id == 1:
                    self.btn_cambiar_password.setVisible(False)
                else:
                    self.btn_cambiar_password.setVisible(True)

        except Exception as e:
            mostrar_error(f"Error al cargar datos de usuario: {e}")
            self.limpiar_campos_usuario()

    def dar_baja_usuario(self):
        """Elimina un usuario seleccionado de la BD."""
        if self.usuario_seleccionado_id is None:
            selected_items = self.tabla_usuarios.selectedItems()
            if not selected_items:
                mostrar_error("Por favor, seleccione un usuario de la lista para eliminar.")
                return
            selected_row = self.tabla_usuarios.currentRow()
            if selected_row < 0: return
            user_id_item = self.tabla_usuarios.item(selected_row, 0)
            nombre_item = self.tabla_usuarios.item(selected_row, 1)
            email_item = self.tabla_usuarios.item(selected_row, 2)
            if not user_id_item: return
            
            self.usuario_seleccionado_id = int(user_id_item.text())
            nombre_seleccionado = nombre_item.text()
            email_seleccionado = email_item.text()
        else:
            nombre_seleccionado = self.entry_usr_nombre.text()
            email_seleccionado = self.entry_usr_email.text()

            
        # Protecci√≥n para el admin ID 1 y para no borrarse a s√≠ mismo
        if self.usuario_seleccionado_id == 1:
            mostrar_error("No se puede eliminar al administrador principal (ID 1).")
            return
            
        if email_seleccionado == self.username:
            mostrar_error("No puede eliminarse a s√≠ mismo.")
            return

        reply = QMessageBox.question(self, "Confirmar Eliminaci√≥n",
                                     f"¬øEst√° seguro que desea eliminar al usuario:\n\n{nombre_seleccionado} (ID: {self.usuario_seleccionado_id})?\n\nEsta acci√≥n no se puede deshacer.",
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.Cancel)

        if reply == QMessageBox.StandardButton.Yes:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("DELETE FROM usuarios WHERE id = ?", (self.usuario_seleccionado_id,))
                    conn.commit()
                
                mostrar_info(f"Usuario {nombre_seleccionado} eliminado exitosamente.")
                self.limpiar_campos_usuario()
                self.cargar_tabla_usuarios()

            except sqlite3.Error as e:
                mostrar_error(f"Error al eliminar usuario: {e}")

            
    def limpiar_campos_usuario(self):
        """Limpia el formulario de gesti√≥n de usuarios y resetea el modo a 'Guardar'."""
        try:
            if hasattr(self, 'entry_usr_nombre'):
                self.entry_usr_nombre.clear()
                self.entry_usr_telefono.clear()
                self.entry_usr_email.clear()
                
                # --- INICIO DE MODIFICACI√ìN: Limpiar checkboxes ---
                if hasattr(self, 'permisos_checkboxes'):
                    for checkbox in self.permisos_checkboxes.values():
                        checkbox.setChecked(False)
                        checkbox.setEnabled(True)
                # --- FIN DE MODIFICACI√ìN ---
                
                self.usuario_seleccionado_id = None
                self.btn_guardar_usuario.setText("Guardar Usuario")
                self.btn_cambiar_password.setVisible(False)
                self.tabla_usuarios.clearSelection()
        except AttributeError:
            pass
    
    def toggle_all_permissions(self, is_admin_checked):
        """
        Se llama cuando el checkbox 'ES ADMINISTRADOR' cambia.
        Habilita/deshabilita y marca/desmarca todos los dem√°s permisos.
        """
        if not hasattr(self, 'permisos_checkboxes'):
            return # Salir si los checkboxes no est√°n listos

        for clave, checkbox in self.permisos_checkboxes.items():
            if clave == 'is_admin':
                continue # No te deshabilites a ti mismo

            # Si 'is_admin' est√° marcado, deshabilita y marca los otros
            checkbox.setEnabled(not is_admin_checked)
            checkbox.setChecked(is_admin_checked)

    def cargar_tabla_usuarios(self):
        """Carga la lista de usuarios (empleados) en la QTableWidget."""
        try: 
            if hasattr(self, 'tabla_usuarios'):
                self.tabla_usuarios.setRowCount(0)
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    # --- MODIFICADO: Quitar 'rol' ---
                    cursor.execute("SELECT id, nombre_completo, email FROM usuarios ORDER BY nombre_completo")
                    usuarios = cursor.fetchall()

                    self.tabla_usuarios.setRowCount(len(usuarios))
                    for row, usuario in enumerate(usuarios):
                        self.tabla_usuarios.setItem(row, 0, QTableWidgetItem(str(usuario['id'])))
                        self.tabla_usuarios.setItem(row, 1, QTableWidgetItem(usuario['nombre_completo']))
                        self.tabla_usuarios.setItem(row, 2, QTableWidgetItem(usuario['email']))
        except sqlite3.Error as e:
            mostrar_error(f"Error al cargar tabla de usuarios: {e}")
        except AttributeError:
            pass

    def cargar_datos_maestros(self):
        """Funci√≥n central para recargar todos los datos."""
        if hasattr(self, 'cargar_tabla_alumnos'):
            self.cargar_tabla_alumnos()
        if hasattr(self, 'cargar_tabla_cursos'):
            self.cargar_tabla_cursos()
        if hasattr(self, 'cargar_combo_curso_registro'):
            self.cargar_combo_curso_registro()
        if hasattr(self, 'cargar_tabla_inscripciones_pagos'):
            self.cargar_tabla_inscripciones_pagos()
        if hasattr(self, 'cargar_tabla_usuarios') and self.user_role == "Administrador":
            self.cargar_tabla_usuarios()
        
        if hasattr(self, 'cargar_cursos_para_filtro'): 
            self.cargar_cursos_para_filtro()
        if self.user_role == "Administrador":
            if hasattr(self, 'cargar_combo_cursos_materias'): self.cargar_combo_cursos_materias()
            if hasattr(self, 'cargar_combo_cursos_calif'): self.cargar_combo_cursos_calif()


    # --- NUEVAS FUNCIONES DE TEMA ---
    def cargar_configuracion_tema(self):
        """Carga la configuraci√≥n de tema desde CONFIG_FILE."""
        try:
            if os.path.exists(CONFIG_FILE):
                with open(CONFIG_FILE, 'r') as f:
                    config = json.load(f)
                    theme = config.get("theme", "Claro")
                    accent = config.get("accent", "Naranja")
                    return theme, accent
        except Exception as e:
            print(f"Error al cargar configuraci√≥n: {e}")
        return "Claro", "Naranja" 

    def guardar_configuracion_tema(self):
        """Guarda la configuraci√≥n actual en CONFIG_FILE."""
        try:
            config = {
                "theme": self.theme,
                "accent": self.accent
            }
            with open(CONFIG_FILE, 'w') as f:
                json.dump(config, f, indent=4)
        except Exception as e:
            print(f"Error al guardar configuraci√≥n: {e}")

    def actualizar_tema(self):
        """Se llama cuando un combo de configuraci√≥n cambia."""
        self.theme = self.combo_tema.currentText()
        self.accent = self.combo_acento.currentText()
        self.aplicar_estilo_actual()
        self.guardar_configuracion_tema()

    def aplicar_estilo_actual(self):
        """Aplica el stylesheet combinado a la aplicaci√≥n."""
        
        # --- INICIO DE CORRECCI√ìN ---
        # 1. Asignar la propiedad 'style' din√°micamente a la VentanaPrincipal (self)
        # Esto permite que los selectores QSS como QWidget[style="dark"] funcionen.
        theme_name = "claro" if self.theme == "Claro" else "dark"
        self.setProperty("style", theme_name)
        
        # 2. Cargar el QSS
        stylesheet = get_full_stylesheet(self.theme, self.accent)
        
        # 3. Aplicar el QSS a toda la aplicaci√≥n
        app.setStyleSheet(stylesheet)

        # 4. "Pulir" la ventana para forzar que se reapliquen los estilos
        # basados en la nueva propiedad 'style' que acabamos de poner.
        self.style().unpolish(self)
        self.style().polish(self)
        # --- FIN DE CORRECCI√ìN ---


# ---- HOJAS DE ESTILO (QSS) ----

def get_accent_stylesheet(accent_name):
    """Retorna el QSS para un color de acento espec√≠fico."""
    if accent_name == "Azul":
        return f"""
            /* Se establece el color de acento para hover/select */
            :root {{
                --accent-color: #0d6efd;
            }}
            #navBar {{ 
                /* Se usa un fondo neutro para el men√∫ */
                background-color: transparent;
            }}
            #navButton {{
                color: #555555; /* Texto gris neutro en claro */
                margin: 5px 10px;
                border-radius: 8px; /* Mac: Esquinas suaves */
                background-color: transparent;
                padding-left: 20px; /* Alineaci√≥n del texto */
                
            }}
            #navButton:hover {{ 
                background-color: rgba(13, 110, 253, 0.1); 
                color: #0d6efd; 
            }}
            #navButton[selected="true"] {{ 
                background-color: rgba(13, 110, 253, 0.2); 
                color: #0d6efd;
                font-weight: 600; /* Mac: Font semi-bold */
                border-left: none; /* Mac: Eliminar borde lateral, usar solo el fondo */
            }}
            QGroupBox::title {{ color: #0a58ca; }}
            QHeaderView::section {{ background-color: #0d6efd; border: 1px solid #0a58ca; }}
            #topBar {{ background-color: #0a58ca; }}
            
            /* Ajustes en Modo Oscuro */
            QWidget[style="dark"] #navButton {{ color: #E0E0E0; }}
            QWidget[style="dark"] #navButton:hover {{ 
                background-color: rgba(13, 110, 253, 0.2); 
                color: #0d6efd; 
            }}
            QWidget[style="dark"] #navButton[selected="true"] {{ 
                background-color: rgba(13, 110, 253, 0.3); 
                color: #0d6efd;
                border-left: none;
            }}
        """
    elif accent_name == "Verde":
        return f"""
            :root {{
                --accent-color: #198754;
            }}
            #navBar {{ 
                background-color: transparent;
            }}
            #navButton {{
                color: #555555; 
                margin: 5px 10px;
                border-radius: 8px;
                background-color: transparent;
                padding-left: 20px;
            }}
            #navButton:hover {{ 
                background-color: rgba(25, 135, 84, 0.1); 
                color: #198754; 
            }}
            #navButton[selected="true"] {{ 
                background-color: rgba(25, 135, 84, 0.2); 
                color: #198754;
                font-weight: 600;
                border-left: none;
            }}
            QGroupBox::title {{ color: #146c43; }}
            QHeaderView::section {{ background-color: #198754; border: 1px solid #146c43; }}
            #topBar {{ background-color: #146c43; }}
            
            /* Ajustes en Modo Oscuro */
            QWidget[style="dark"] #navButton {{ color: #E0E0E0; }}
            QWidget[style="dark"] #navButton:hover {{ 
                background-color: rgba(25, 135, 84, 0.2); 
                color: #198754; 
            }}
            QWidget[style="dark"] #navButton[selected="true"] {{ 
                background-color: rgba(25, 135, 84, 0.3); 
                color: #198754;
                border-left: none;
            }}
        """
    # Default (Naranja)
    return f"""
        :root {{
            --accent-color: #FFA726;
        }}
        #navBar {{ 
            background-color: transparent;
        }}
        #navButton {{
            color: #555555; 
            margin: 5px 10px;
            border-radius: 8px;
            background-color: transparent;
            padding-left: 20px;
        }}
        #navButton:hover {{ 
            background-color: rgba(255, 167, 38, 0.1); 
            color: #E65100;
        }}
        #navButton[selected="true"] {{ 
            background-color: rgba(255, 167, 38, 0.2); 
            color: #E65100;
            font-weight: 600;
            border-left: none;
        }}
        QGroupBox::title {{ color: #E65100; }}
        QHeaderView::section {{ background-color: #FFA726; border: 1px solid #E65100; }}
        #topBar {{ background-color: #E65100; }} /* Se usa un color m√°s profundo */

        /* Ajustes en Modo Oscuro */
        QWidget[style="dark"] #navButton {{ color: #E0E0E0; }}
        QWidget[style="dark"] #navButton:hover {{ 
            background-color: rgba(255, 167, 38, 0.2); 
            color: #FFA726; 
        }}
        QWidget[style="dark"] #navButton[selected="true"] {{ 
            background-color: rgba(255, 167, 38, 0.3); 
            color: #FFA726;
            border-left: none;
        }}
    """

style_sheet_light = """
    /* --- Tema Claro (Base) --- */
    QWidget {
        background-color: #FFFFFF;
        color: #333333;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 10pt;
    }
    
    /* CORRECCI√ìN CR√çTICA: Fuerza el color del texto a blanco para asegurar legibilidad sobre el fondo de acento saturado */
    #topBar QLabel, #topBarUser, #topBarLabel, #topBarIcon { 
        color: #FFFFFF; 
        font-size: 9pt; 
    }
    #topBarUser { font-weight: bold; font-size: 10pt; }
    #topBarButton { background-color: transparent;
        color: #FFFFFF; border: none; font-size: 16pt; padding: 5px; }
    #topBarButton:hover { background-color: rgba(255, 255, 255, 0.1); }
    
    #navBar { background-color: #F8F8F8; } /* Fondo m√°s claro para el men√∫ */
    
    /* Reglas base del bot√≥n de navegaci√≥n (para ambos modos, los colores se aplican con el accent) */
    #navButton { 
        border: none; 
        padding: 15px 10px; 
        font-size: 11pt; 
        text-align: left; 
        padding-left: 20px;
        font-weight: normal; 
    }
    
    #mainContentArea, #contentPage { background-color: #FFFFFF; }
    QScrollArea { border: none; background-color: #FFFFFF; }
    #welcomeTitle { font-size: 24pt; font-weight: bold; color: #333333; }
    #shortcutsTitle { font-size: 16pt;
        font-weight: bold; color: #555555; padding-bottom: 5px; }
    #shortcutButton { 
        border: 1px solid #E0E0E0;
        background-color: #FFFFFF; 
        border-radius: 12px;
        padding: 15px;
        /* Sombra Sutil y Profesional */
        box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.05), 0px 1px 2px rgba(0, 0, 0, 0.1);
    }
    #shortcutIcon { 
        background-color: #F0F0F0; /* Fondo m√°s limpio para el √≠cono */
        border: none; 
        border-radius: 8px; /* Menos redondeado */
        font-size: 36pt; /* √çcono un poco m√°s peque√±o, m√°s elegante */
        padding: 10px;
    }
    #shortcutIcon:hover { background-color: #E0E0E0; }
    #shortcutLabel { font-size: 11pt; font-weight: bold; color: #333333; }
    QGroupBox { background-color: #F9F9F9; border: 1px solid #E0E0E0; border-radius: 6px; margin-top: 10px; padding: 10px; }
    QGroupBox::title { subcontrol-origin: margin; subcontrol-position: top left; padding: 0 10px 0 10px; font-size: 12pt; font-weight: bold; }
    QLabel { color: #333333; }
    QLineEdit, QComboBox, QDoubleSpinBox { background-color: #FFFFFF; color: #333333;
        border: 1px solid #C0C0C0; border-radius: 4px; padding: 5px; min-height: 20px; }
    QComboBox QAbstractItemView { background-color: #FFFFFF; color: #333333; }
    QCheckBox { color: #333333; font-size: 9pt; }
    QCheckBox::indicator { width: 16px; height: 16px; }
    QCheckBox::indicator:unchecked { border: 1px solid #C0C0C0; background-color: #FFFFFF; border-radius: 3px; }
    QCheckBox::indicator:checked { 
            background-color: #007ACC;
            border: 1px solid #007ACC;
            image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="none" stroke="%23FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 8l3 3l7-7"/></svg>');
        }
    #expedienteDisplay { background-color: #FDFDFD; border: 1px solid #E0E0E0; font-family: Consolas, monospace; font-size: 9pt; }
    #deleteButton { background-color: #D32F2F; color: #FFFFFF; border: none; border-radius: 4px; padding: 10px 20px; font-weight: bold;
        font-size: 10pt; margin-top: 10px; }
    #deleteButton:hover { background-color: #E53935; }
    #deleteButton:pressed { background-color: #B71C1C; }
    #secondaryButton { background-color: #607D8B; color: #FFFFFF; border: none; border-radius: 4px; padding: 10px 20px; font-weight: bold;
        font-size: 10pt; }
    #secondaryButton:hover { background-color: #546E7A; }
    QPushButton#primaryButton { background-color: #007ACC; color: #FFFFFF; border: none; border-radius: 4px; padding: 10px 20px; font-weight: bold; font-size: 11pt; min-height: 25px; }
    QPushButton#primaryButton:hover { background-color: #0099E6; }
    QPushButton#primaryButton:pressed { background-color: #005F99; }
    QTableWidget { background-color: #FFFFFF; color: #333333; gridline-color: #E0E0E0; border: 1px solid #C0C0C0; selection-color: #333333; }
    QHeaderView::section { color: #FFFFFF; padding: 6px; font-weight: bold; }
    QMessageBox { background-color: #FFFFFF; }
    #placeholderText { font-style: italic; color: #888888; }
"""

style_sheet_dark = """
    /* --- Tema Oscuro (Base) --- */
    QWidget {
        background-color: #2D2D2D; /* Gris oscuro para mayor contraste */
        color: #E0E0E0;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 10pt;
    }

    #topBar QLabel, #topBarUser, #topBarLabel, #topBarIcon { 
        color: #FFFFFF;
        font-size: 9pt; 
    }
    #topBarUser { font-weight: 600; font-size: 11pt; } 
    #topBarButton { background-color: transparent;
        color: #FFFFFF; border: none; font-size: 16pt; padding: 5px; }
    #topBarButton:hover { background-color: #3A3A3A; }
    
    #navBar { background-color: #3A3A3A; } /* Fondo del men√∫ ligeramente m√°s claro para contraste */
    
    /* Reglas base del bot√≥n de navegaci√≥n */
    #navButton { 
        border: none; 
        padding: 15px 10px; 
        font-size: 11pt; 
        text-align: left; 
        padding-left: 20px;
        font-weight: normal;
        border-radius: 8px; /* Esquinas redondeadas */
        margin: 5px 8px; /* Margen para flotar */
    }

    #mainContentArea, #contentPage { background-color: #2D2D2D; }
    QScrollArea { border: none; background-color: #2D2D2D; }
    #welcomeTitle { font-size: 24pt; font-weight: 600; color: #E0E0E0; }
    #shortcutsTitle { font-size: 16pt;
        font-weight: 500; color: #C0C0C0; padding-bottom: 5px; }
    #shortcutButton { 
        border: 1px solid #4D4D4D;
        background-color: #3A3A3A; /* Fondo de botones de acceso */
        border-radius: 12px;
        padding: 15px;
    }
    #shortcutIcon { 
        background-color: #4A4A4A; /* Fondo m√°s limpio para el √≠cono */
        border: none;
        border-radius: 8px;
        font-size: 36pt; 
        padding: 10px;
    }
    #shortcutIcon:hover { background-color: #5A5A5A; }
    QGroupBox { background-color: #3A3A3A; border: 1px solid #4D4D4D; border-radius: 8px; margin-top: 10px; padding: 10px; }
    QGroupBox::title { subcontrol-origin: margin; subcontrol-position: top left; padding: 0 10px 0 10px; font-size: 12pt; font-weight: 600; }
    QLabel { color: #E0E0E0; }
    QLineEdit, QComboBox, QDoubleSpinBox { background-color: #4A4A4A; color: #E0E0E0;
        border: 1px solid #4D4D4D; border-radius: 6px; padding: 5px; min-height: 20px; }
    QLineEdit:focus, QComboBox:focus, QDoubleSpinBox:focus { border: 1px solid #707070; }
    QComboBox QAbstractItemView { background-color: #4A4A4A; color: #E0E0E0; selection-background-color: #5A5A5A; }
    QCheckBox { color: #E0E0E0; font-size: 9pt; }
    QCheckBox::indicator { width: 16px; height: 16px; }
    QCheckBox::indicator:unchecked { border: 1px solid #4D4D4D; background-color: #3A3A3A; border-radius: 3px; }
    QCheckBox::indicator:checked { 
            background-color: #007ACC;
            border: 1px solid #007ACC;
            image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="none" stroke="%23FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 8l3 3l7-7"/></svg>');
        }
    #expedienteDisplay { background-color: #3A3A3A; border: 1px solid #4D4D4D; font-family: Consolas, monospace; font-size: 9pt; }
    #deleteButton { background-color: #D32F2F; color: #FFFFFF; border: none; border-radius: 6px; padding: 10px 20px; font-weight: 600; font-size: 10pt; margin-top: 10px; }
    #deleteButton:hover { background-color: #E53935; }
    #deleteButton:pressed { background-color: #B71C1C; }
    #secondaryButton { background-color: #607D8B; color: #FFFFFF; border: none; border-radius: 6px; padding: 10px 20px; font-weight: 600; font-size: 10pt; }
    QPushButton#primaryButton { background-color: #007ACC; color: #FFFFFF; border: none; border-radius: 6px; padding: 10px 20px; font-weight: 600; font-size: 11pt; min-height: 25px; }
    QPushButton#primaryButton:hover { background-color: #0099E6; }
    QPushButton#primaryButton:pressed { background-color: #005F99; }
    QTableWidget { background-color: #3A3A3A; color: #E0E0E0; gridline-color: #4D4D4D; border: 1px solid #4D4D4D; selection-background-color: #5A5A5A; selection-color: #E0E0E0; }
    QHeaderView::section { color: #FFFFFF; padding: 6px; font-weight: 600; border: 1px solid #4D4D4D; }
    QMessageBox { background-color: #3A3A3A; color: #E0E0E0; }
    #placeholderText { font-style: italic; color: #888888; }
"""

def get_full_stylesheet(theme, accent):
    """Combina el tema base (claro/oscuro) con el color de acento."""
    base_style = style_sheet_light if theme == "Claro" else style_sheet_dark
    accent_style = get_accent_stylesheet(accent)
    return base_style + accent_style


# ---- Punto de Entrada de la Aplicaci√≥n (CON BUCLE DE SESI√ìN) ----
if __name__ == '__main__':

    try:
        # 1. Asegurar que la DB est√© inicializada
        inicializar_db()
        
        app = QApplication(sys.argv)
        
        login_exitoso = True
        window = None # Definir window fuera del bucle

        while login_exitoso:
            # 1. Iniciar la pantalla de Login
            login_window = LoginScreen()
            login_window.show()
            app.exec() 

            # Si el usuario cerr√≥ el login sin autenticarse, salimos del bucle
            if not login_window.accept_login:
                login_exitoso = False
                continue 

            # 2. Si el login fue exitoso, obtener usuario y mostrar ventana principal
            username = login_window.username
            full_username = login_window.full_username
            user_role = login_window.user_role # Obtener el ROL
            permisos_dict = login_window.permisos_dict
            
            window = VentanaPrincipal(username, full_username, user_role, permisos_dict)
            window.showMaximized() 

            app.exec() 

            # 3. Cuando la app principal se cierra, revisamos si fue por "Cerrar Sesi√≥n"
            if not window.logout_solicitado:
                login_exitoso = False 

        # --- Limpiar archivos temporales al salir del bucle principal ---
        if window and hasattr(window, '_temp_pdf_files'): 
            window.limpiar_archivos_temporales()

        sys.exit(0) 

    except Exception as e:
        # Captura de error final por si algo falla en la inicializaci√≥n
        print(f"--- ERROR FATAL: {e} ---")
        error_info = traceback.format_exc()

        with open("error_log.txt", "w", encoding="utf-8") as f:
            f.write("Ha ocurrido un error fatal al iniciar la aplicaci√≥n:\n\n")
            f.write(error_info)

        # Mostrar el error en una ventana emergente simple si es posible
        try:
            error_dialog = QMessageBox()
            error_dialog.setIcon(QMessageBox.Icon.Critical)
            error_dialog.setWindowTitle("Error Fatal")
            error_dialog.setText(f"Error fatal al iniciar:\n{e}\n\nConsulte 'error_log.txt' para detalles.")
            error_dialog.exec()
        except:
            pass

        sys.exit(1)
